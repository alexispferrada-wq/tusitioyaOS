<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Aexon LeadGen Pro - Powered by Kimi AI üöÄ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes subirAguja { from { stroke-dashoffset: 126; } }
        @keyframes subirAgujaRotacion { from { transform: rotate(-90deg); } to { transform: var(--target-rotation); } }
        @keyframes floatIcon { 0%, 100% { transform: translateY(0); opacity: 0.6; } 50% { transform: translateY(-10px); opacity: 1; } }
        
        /* Animaciones del men√∫ de perfil */
        #user-menu-dropdown {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        #user-menu-dropdown.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        #user-menu-dropdown:not(.hidden) {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="top"></div>

    <!-- Script de bloqueo inmediato - evita acceso directo sin login -->
    <script>
        (function() {
            const currentUser = localStorage.getItem('saas_user');
            if (!currentUser) {
                // No hay sesi√≥n: mostrar solo login
                document.documentElement.style.visibility = 'hidden';
                document.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                    document.documentElement.style.visibility = 'visible';
                });
            }
        })();
    </script>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[500] flex items-center justify-center" style="display: flex;">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 shadow-inner">
                    <i class="fas fa-lock"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Aexon<span class="text-blue-500">LeadGen</span></h1>
                <p class="text-gray-500 text-sm mt-1">Ingresa tus credenciales de acceso</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Usuario</label>
                    <input type="text" id="login-user" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="ej: alexisferrada">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Contrase√±a</label>
                    <input type="password" id="login-pass" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key === 'Enter') App.auth.login()">
                </div>
                <button onclick="App.auth.login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-[1.02] mt-2">
                    Ingresar al Sistema
                </button>
            </div>
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">¬øNo tienes cuenta? <a href="#" class="text-blue-500 hover:underline font-bold">Obt√©n 20 cr√©ditos gratis</a></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden hidden" style="display: none;">
        <aside class="w-64 bg-gray-900 text-white flex flex-col">
            <div class="h-16 flex items-center justify-center border-b border-gray-800">
                <h1 class="text-xl font-bold tracking-wider">Aexon<span class="text-blue-500">LeadGen</span></h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="javascript:void(0)" id="nav-wizard" onclick="App.navegacion.ir('wizard')" class="flex items-center gap-3 px-4 py-3 bg-blue-600 rounded-lg text-white font-medium shadow-lg transition">
                    <i class="fas fa-magic"></i> Asistente Wizard
                </a>
                <a href="javascript:void(0)" id="nav-buscador" onclick="App.navegacion.ir('buscador')" class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-radar"></i> Buscador IA
                </a>
                <a href="javascript:void(0)" id="nav-database" onclick="App.navegacion.ir('database')" class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-database"></i> Base de Datos
                </a>
                <a href="javascript:void(0)" id="nav-entrenar" onclick="App.navegacion.ir('entrenar')" class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-robot"></i> Entrenar Modelos
                </a>
                
                <div class="pt-4 mt-4 border-t border-gray-800" id="menu-admin">
                    <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest px-4 mb-2">Administraci√≥n</p>
                    <a href="javascript:void(0)" id="nav-usuarios" onclick="App.navegacion.ir('usuarios')" class="flex items-center gap-3 px-4 py-3 text-yellow-400 hover:bg-gray-800 hover:text-yellow-300 rounded-lg transition">
                        <i class="fas fa-users-cog"></i> Gesti√≥n Usuarios
                    </a>
                </div>

                <a href="javascript:void(0)" id="nav-config" onclick="App.navegacion.ir('config')" class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-cog"></i> Configuraci√≥n
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800 flex justify-between items-center">
                <p class="text-xs text-gray-500 text-center">Aexon Software Solutions</p>
                <button onclick="App.auth.logout()" class="text-xs text-red-400 hover:text-red-500 font-bold" title="Cerrar Sesi√≥n"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-y-auto">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 z-10">
                <h2 class="text-xl font-semibold text-gray-800" id="header-titulo">Orquestador de Prospecci√≥n</h2>
                <div class="flex items-center gap-4">
                    <select id="global-model-selector" class="bg-gray-50 border border-gray-300 text-gray-700 text-xs font-bold rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                        <option value="kimi-moonshot-v1-8k">üöÄ Kimi AI - Cerebro Tusitioya</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (Google)</option>
                        <option value="groq-llama-3.3-70b-versatile">Llama 3.3 70B (Groq)</option>
                        <option value="groq-llama-3.1-8b-instant">Llama 3.1 8B (R√°pido)</option>
                    </select>
                    <div id="subscription-badge" class="bg-purple-100 text-purple-800 text-xs font-bold px-3 py-1.5 rounded-full border border-purple-200 flex items-center gap-2 cursor-pointer hover:bg-purple-200 transition-colors" onclick="document.getElementById('modal-creditos').classList.remove('hidden')">
                        <i class="fas fa-coins text-yellow-500"></i> <span id="creditos-restantes">--</span> Cr√©ditos
                        <span class="bg-white/50 text-[9px] px-1 rounded ml-1">Recargar</span>
                    </div>
                    
                    <!-- Badge Kimi AI activo -->
                    <div id="kimi-badge" class="hidden bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-xs font-bold px-3 py-1.5 rounded-full border border-purple-400 flex items-center gap-2 shadow-lg shadow-purple-500/30">
                        <i class="fas fa-rocket"></i> üß† Kimi AI Activo
                    </div>
                    
                    <!-- Men√∫ de Perfil de Usuario -->
                    <div class="relative" id="user-menu-container">
                        <button onclick="App.perfil.toggleMenu()" class="flex items-center gap-2 hover:bg-gray-100 rounded-full p-1 pr-3 transition-colors border border-transparent hover:border-gray-200">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold uppercase shadow-sm">
                                <span id="user-initial">U</span>
                            </div>
                            <span id="user-name-display" class="text-sm font-medium text-gray-700 hidden md:block">Usuario</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                        </button>
                        
                        <!-- Dropdown del Perfil -->
                        <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50 transform origin-top-right transition-all">
                            <!-- Info del Usuario -->
                            <div class="px-4 py-3 border-b border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-lg uppercase">
                                        <span id="user-initial-menu">U</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p id="user-fullname" class="text-sm font-bold text-gray-900 truncate">Usuario</p>
                                        <p id="user-email" class="text-xs text-gray-500 truncate">usuario@email.com</p>
                                        <span id="user-plan-badge" class="inline-flex items-center gap-1 mt-1 px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-600">
                                            <i class="fas fa-crown text-yellow-500"></i> Plan Piloto
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stats R√°pidos -->
                            <div class="px-4 py-2 bg-gray-50 border-b border-gray-100">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-500">Cr√©ditos Disponibles</span>
                                    <span id="user-credits-menu" class="text-sm font-bold text-purple-600">0</span>
                                </div>
                            </div>
                            
                            <!-- Opciones del Men√∫ -->
                            <div class="py-1">
                                <button onclick="App.perfil.comprarCreditos()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-purple-50 hover:text-purple-700 flex items-center gap-3 transition-colors">
                                    <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">Comprar Cr√©ditos</span>
                                        <span class="text-[10px] text-gray-400">Recarga tu saldo</span>
                                    </div>
                                </button>
                                
                                <button onclick="App.perfil.verMiPerfil()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 flex items-center gap-3 transition-colors">
                                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">Mi Perfil</span>
                                        <span class="text-[10px] text-gray-400">Editar informaci√≥n</span>
                                    </div>
                                </button>
                                
                                <button onclick="App.navegacion.ir('config')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-3 transition-colors">
                                    <div class="w-8 h-8 rounded-lg bg-gray-100 text-gray-600 flex items-center justify-center">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">Configuraci√≥n</span>
                                        <span class="text-[10px] text-gray-400">Preferencias del sistema</span>
                                    </div>
                                </button>
                            </div>
                            
                            <!-- Divider -->
                            <div class="border-t border-gray-100 my-1"></div>
                            
                            <!-- Cerrar Sesi√≥n -->
                            <button onclick="App.auth.logout()" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition-colors">
                                <div class="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center">
                                    <i class="fas fa-sign-out-alt"></i>
                                </div>
                                <span class="font-medium">Cerrar Sesi√≥n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <div class="p-8 space-y-6">
                
                <div id="view-wizard" class="view-section block">
                    <div class="max-w-3xl mx-auto">
                        <div id="step-1" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden flex flex-col h-[600px] transition-all duration-500">
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white shadow-lg">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-white">Vicente - Tu Estratega</h3>
                                        <p class="text-xs text-blue-100 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> En l√≠nea</p>
                                    </div>
                                </div>
                                <button onclick="App.wizard.finalizarManual()" class="hidden text-xs bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg transition-colors" id="btn-finalizar-wizard" title="Generar estrategias">
                                    Generar estrategias <i class="fas fa-forward ml-1"></i>
                                </button>
                            </div>

                            <div id="wizard-chat-messages" class="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-50/50">
                                </div>
                            
                            <!-- Resumen en vivo de lo que entiende la IA -->
                            <div id="wizard-progress" class="hidden px-4 py-3 bg-blue-50 border-t border-blue-100">
                                <p class="text-xs text-blue-600 font-bold mb-2"><i class="fas fa-brain mr-1"></i> Lo que entiendo hasta ahora:</p>
                                <div class="flex flex-wrap gap-2">
                                    <span id="prog-producto" class="hidden px-2 py-1 bg-white border border-blue-200 rounded text-xs text-gray-700"><i class="fas fa-box text-blue-500 mr-1"></i><span class="font-medium">Producto:</span> <span class="val"></span></span>
                                    <span id="prog-publico" class="hidden px-2 py-1 bg-white border border-purple-200 rounded text-xs text-gray-700"><i class="fas fa-users text-purple-500 mr-1"></i><span class="font-medium">P√∫blico:</span> <span class="val"></span></span>
                                    <span id="prog-ubicacion" class="hidden px-2 py-1 bg-white border border-green-200 rounded text-xs text-gray-700"><i class="fas fa-map-marker-alt text-green-500 mr-1"></i><span class="font-medium">Ubicaci√≥n:</span> <span class="val"></span></span>
                                </div>
                            </div>

                            <div class="p-4 bg-white border-t border-gray-100">
                                <div class="relative">
                                    <input type="text" id="wizard-chat-input" placeholder="Escribe tu respuesta aqu√≠..." class="w-full pl-4 pr-12 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm transition-all" onkeypress="if(event.key === 'Enter') App.wizard.enviarMensaje()">
                                    <button onclick="App.wizard.enviarMensaje()" class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white w-10 rounded-lg flex items-center justify-center transition-colors"><i class="fas fa-paper-plane"></i></button>
                                </div>
                                <p class="text-xs text-gray-400 mt-2 text-center">Presiona Enter para enviar ¬∑ S√© espec√≠fico para mejores resultados</p>
                            </div>
                        </div>

                        <div id="step-2" class="hidden bg-white rounded-2xl shadow-lg border border-gray-200 p-16 text-center">
                            <div class="relative w-24 h-24 mx-auto mb-8">
                                <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                                <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                                <i class="fas fa-brain absolute inset-0 flex items-center justify-center text-blue-500 text-2xl animate-pulse"></i>
                            </div>
                            
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Escaneando Ecosistema Digital...</h3>
                            <p class="text-gray-500 mb-8">La IA est√° buscando patrones en:</p>

                            <div class="flex justify-center gap-8 text-3xl">
                                <div class="flex flex-col items-center gap-2" style="animation: floatIcon 2s infinite ease-in-out;">
                                    <i class="fab fa-google text-red-500"></i>
                                    <span class="text-[10px] font-bold text-gray-400">Google</span>
                                </div>
                                <div class="flex flex-col items-center gap-2" style="animation: floatIcon 2s infinite ease-in-out 0.5s;">
                                    <i class="fab fa-facebook text-blue-600"></i>
                                    <span class="text-[10px] font-bold text-gray-400">Facebook</span>
                                </div>
                                <div class="flex flex-col items-center gap-2" style="animation: floatIcon 2s infinite ease-in-out 1s;">
                                    <i class="fab fa-instagram text-pink-500"></i>
                                    <span class="text-[10px] font-bold text-gray-400">Instagram</span>
                                </div>
                            </div>
                        </div>

                        <div id="step-3" class="hidden space-y-6">
                            <div class="text-center mb-8">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-3xl shadow-lg mx-auto mb-4">
                                    üöÄ
                                </div>
                                <h2 class="text-2xl font-bold text-gray-900">3 Estrategias para Conquistar tu Mercado</h2>
                                <p id="wizard-context-text" class="text-gray-500 mt-2">Elige la que mejor se adapte a tu estilo de venta:</p>
                            </div>
                            <div id="wizard-cards" class="space-y-4">
                                </div>
                            <div class="text-center mt-6">
                                <button onclick="App.wizard.reset()" class="text-gray-400 hover:text-gray-600 text-sm font-medium">
                                    <i class="fas fa-comments mr-1"></i> Volver al Chat
                                </button>
                            </div>
                        </div>

                        <div id="step-4" class="hidden bg-white rounded-2xl shadow-xl border border-blue-100 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-blue-100 uppercase tracking-wider mb-1">üöÄ Misi√≥n Seleccionada</p>
                                    <h3 id="wizard-selected-niche" class="text-xl font-bold text-white">...</h3>
                                </div>
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white shadow-lg">
                                    <i class="fas fa-rocket text-xl"></i>
                                </div>
                            </div>
                            <div class="p-8 space-y-6">
                                <div class="space-y-4">
                                    <label class="flex items-center p-4 border border-gray-200 rounded-xl cursor-pointer hover:border-blue-300 hover:bg-blue-50/30 transition-all group">
                                        <input type="checkbox" id="wizard-save-template" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300" onchange="document.getElementById('template-name-group').classList.toggle('hidden')">
                                        <div class="ml-3">
                                            <span class="block text-sm font-bold text-gray-800 group-hover:text-blue-700">üíæ Guardar como Plantilla R√°pida</span>
                                            <span class="block text-xs text-gray-500">Para reutilizar esta configuraci√≥n en el futuro.</span>
                                        </div>
                                    </label>
                                    
                                    <div id="template-name-group" class="hidden pl-8">
                                        <label class="block text-xs font-bold text-gray-500 mb-1">Nombre de la Plantilla</label>
                                        <input type="text" id="wizard-template-name" placeholder="Ej: Seguros - Reci√©n Nacidos" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                    </div>
                                </div>

                                <button onclick="App.wizard.guardarYSalir()" class="w-full bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 transition-all transform hover:scale-[1.01] flex items-center justify-center gap-2">
                                    <i class="fas fa-save"></i> Guardar en B√≥veda e Ir al Buscador
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-buscador" class="view-section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Ejecutar Estrategia Guardada</h3>
                            <div>
                                <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 mr-2"><i class="fas fa-shield-alt"></i> Cobro Seguro: Solo descontamos si es v√°lido</span>
                                <button onclick="App.navegacion.ir('wizard')" class="text-sm text-blue-600 hover:underline font-medium">
                                    <i class="fas fa-plus-circle"></i> Crear nueva estrategia
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona una f√≥rmula de tu b√≥veda:</label>
                                <select id="select-estrategia" onchange="App.prospector.seleccionarEstrategia()" class="w-full rounded-xl border-gray-300 border p-4 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 text-lg font-medium shadow-sm transition-all">
                                    <option value="" disabled selected>-- Cargar estrategia desde el Wizard --</option>
                                    </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad de Leads:</label>
                                <select id="select-cantidad" class="w-full rounded-xl border-gray-300 border p-4 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 text-lg font-medium shadow-sm transition-all">
                                    <option value="5">5 (R√°pido)</option>
                                    <option value="10" selected>10 (Est√°ndar)</option>
                                    <option value="20">20 (Profundo)</option>
                                    <option value="50">50 (Masivo)</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Segmentaci√≥n / Prompt de B√∫squeda (Editable):</label>
                                <textarea id="txt-estrategia-prompt" rows="2" class="w-full rounded-xl border-gray-300 border p-3 focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm shadow-sm transition-all resize-none font-mono text-slate-600" placeholder="Selecciona una estrategia para ver su prompt..."></textarea>
                            </div>
                        </div>

                        <button onclick="App.prospector.ejecutarEstrategia()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 text-lg">
                            <i class="fas fa-play"></i> Ejecutar B√∫squeda de Clientes
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Resultados en Tiempo Real</h3>
                            <span id="resultado-consumo" class="text-xs font-bold text-gray-400"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-center">Calidad IA</th>
                                        <th class="px-6 py-3">Negocio</th>
                                        <th class="px-6 py-3">WhatsApp</th>
                                        <th class="px-6 py-3 text-center">Costo</th>
                                        <th class="px-6 py-3 text-center">Auditor√≠a</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-resultados">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-database" class="view-section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <p class="text-xs font-bold text-blue-500 uppercase tracking-wider">Total Registros</p>
                                <p id="db-total-registros" class="text-3xl font-black text-blue-700 mt-1">0</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <p class="text-xs font-bold text-purple-500 uppercase tracking-wider">Saldo Actual</p>
                                <p id="db-saldo-actual" class="text-3xl font-black text-purple-700 mt-1">--</p>
                                <p class="text-[10px] text-purple-400 font-bold">Cr√©ditos Disponibles</p>
                            </div>
                            <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex flex-col justify-center">
                                <p class="text-xs font-bold text-emerald-700 mb-2"><i class="fa-solid fa-shield-heart mr-1"></i> Garant√≠a de Calidad</p>
                                <p class="text-[10px] text-emerald-800 leading-relaxed text-justify">
                                    Usamos IA para validar contactos. Si reportas un n√∫mero inv√°lido, ayudas a entrenar al sistema. <span class="font-bold">Solo cada lead v√°lido descont√≥ un cr√©dito de tu plan.</span>
                                </p>
                            </div>
                        </div>

                        <!-- PANEL DE BLACKLIST / AUDITOR√çA -->
                        <div class="bg-red-50 rounded-xl border border-red-200 p-4 mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-shield-alt text-red-500"></i>
                                    <h3 class="font-bold text-red-800">Sistema de Auditor√≠a & Blacklist</h3>
                                </div>
                                <button onclick="App.auditoria.toggleBlacklistPanel()" class="text-xs bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg font-bold transition-colors">
                                    <i class="fas fa-eye"></i> Ver Blacklist
                                </button>
                            </div>
                            <p class="text-xs text-red-600">
                                Cuando encuentres un lead inv√°lido, usa el bot√≥n <b>"Auditar"</b> en los resultados. 
                                La IA evaluar√° el contacto y si es inv√°lido, <b>se devolver√° tu cr√©dito</b> y se agregar√° a la blacklist compartida.
                            </p>
                            
                            <!-- Panel expandible de blacklist -->
                            <div id="blacklist-panel" class="hidden mt-4 border-t border-red-200 pt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-red-700">N√∫meros Invalidados por Auditor√≠a</h4>
                                    <span id="blacklist-count-display" class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                                </div>
                                <div class="bg-white rounded-lg border border-red-100 max-h-48 overflow-y-auto">
                                    <table class="w-full text-xs">
                                        <thead class="bg-red-50 text-red-700">
                                            <tr>
                                                <th class="px-3 py-2 text-left">Tel√©fono</th>
                                                <th class="px-3 py-2 text-left">Negocio</th>
                                                <th class="px-3 py-2 text-left">Raz√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody id="blacklist-table-body" class="divide-y divide-red-100">
                                            <tr><td colspan="3" class="px-3 py-2 text-center text-gray-400">Cargando...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <div class="flex gap-3 w-full md:w-auto">
                                <select id="filter-estrategia" onchange="App.database.aplicarFiltros()" class="bg-white border border-gray-300 text-gray-700 text-xs font-bold rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none shadow-sm">
                                    <option value="all">Todas las Estrategias</option>
                                </select>
                                <select id="filter-fecha" onchange="App.database.aplicarFiltros()" class="bg-white border border-gray-300 text-gray-700 text-xs font-bold rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none shadow-sm">
                                    <option value="all">Cualquier Fecha</option>
                                    <option value="hoy">Hoy</option>
                                    <option value="semana">Esta Semana</option>
                                    <option value="mes">Este Mes</option>
                                </select>
                            </div>
                            <button onclick="App.database.cargar()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 transition-colors">
                                <i class="fa-solid fa-rotate"></i> Refrescar
                            </button>
                        </div>

                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-3">Fecha</th>
                                        <th class="px-6 py-3">Estrategia (Nicho)</th>
                                        <th class="px-6 py-3">Prospecto</th>
                                        <th class="px-6 py-3">Contacto</th>
                                        <th class="px-6 py-3 text-center">Calidad</th>
                                        <th class="px-6 py-3 text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-database" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-center text-xs text-gray-400">
                            Mostrando <span id="db-count-visible" class="font-bold text-gray-600">0</span> registros.
                        </div>
                    </div>
                </div>

                <div id="view-entrenar" class="view-section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center text-xl">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Entrenamiento de Estrategias</h3>
                                <p class="text-sm text-gray-500">Afina las instrucciones y mensajes que la IA utiliza para tus nichos.</p>
                            </div>
                        </div>

                        <div class="mt-8 mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">1. Selecciona la Estrategia a entrenar:</label>
                            <select id="entrenar-select-estrategia" onchange="App.entrenar.cargarDatosEstrategia()" class="w-full rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-purple-500 outline-none bg-white font-medium shadow-sm transition-all cursor-pointer">
                                <option value="" disabled selected>-- Cargando b√≥veda de estrategias... --</option>
                            </select>
                        </div>

                        <div id="entrenar-prompts-container" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            <div class="bg-blue-50/50 rounded-xl border border-blue-100 p-5 flex flex-col hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-blue-800"><i class="fas fa-radar text-blue-500 mr-2"></i>Instrucci√≥n de B√∫squeda</h4>
                                    <span class="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wider">Scraper IA</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">El par√°metro exacto que usa el radar para encontrar clientes.</p>
                                <textarea id="entrenar-prompt-busqueda" rows="6" class="w-full flex-1 rounded-lg border border-blue-200 p-3 text-sm font-mono text-gray-700 focus:ring-2 focus:ring-blue-400 outline-none resize-none mb-4 shadow-inner leading-relaxed"></textarea>
                                <div class="flex gap-2">
                                    <button onclick="App.entrenar.regenerar('busqueda')" class="flex-1 bg-white border border-blue-300 text-blue-600 hover:bg-blue-50 font-bold py-2 rounded-lg text-xs transition-colors flex items-center justify-center gap-1"><i class="fas fa-wand-magic-sparkles"></i> Potenciar con IA</button>
                                    <button onclick="App.entrenar.guardar('busqueda')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-xs shadow-md transition-colors flex items-center justify-center gap-1"><i class="fas fa-save"></i> Guardar Filtro</button>
                                </div>
                            </div>

                            <div class="bg-green-50/50 rounded-xl border border-green-100 p-5 flex flex-col hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-green-800"><i class="fab fa-whatsapp text-green-500 mr-2"></i>Script de Contacto</h4>
                                    <span class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wider">Rompehielos</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">El mensaje persuasivo que se enviar√° al WhatsApp del prospecto.</p>
                                <textarea id="entrenar-prompt-mensaje" rows="6" class="w-full flex-1 rounded-lg border border-green-200 p-3 text-sm font-mono text-gray-700 focus:ring-2 focus:ring-green-400 outline-none resize-none mb-4 shadow-inner leading-relaxed"></textarea>
                                <div class="flex gap-2">
                                    <button onclick="App.entrenar.regenerar('mensaje')" class="flex-1 bg-white border border-green-300 text-green-600 hover:bg-green-50 font-bold py-2 rounded-lg text-xs transition-colors flex items-center justify-center gap-1"><i class="fas fa-wand-magic-sparkles"></i> Mejorar con IA</button>
                                    <button onclick="App.entrenar.guardar('mensaje')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-xs shadow-md transition-colors flex items-center justify-center gap-1"><i class="fas fa-save"></i> Guardar Texto</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-usuarios" class="view-section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Clientes (SaaS)</h3>
                                <p class="text-xs text-gray-500">Controla los cr√©ditos y planes de tus usuarios.</p>
                            </div>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-700"><i class="fas fa-user-plus"></i> Nuevo Cliente</button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3">Usuario / Empresa</th>
                                        <th class="px-6 py-3">Plan Actual</th>
                                        <th class="px-6 py-3">Cr√©ditos</th>
                                        <th class="px-6 py-3">Estado</th>
                                        <th class="px-6 py-3 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 font-bold text-gray-800">
                                            alexisferrada <br><span class="text-xs text-gray-400 font-normal">admin@aexon.cl</span>
                                        </td>
                                        <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-[10px] font-bold uppercase">Master Admin</span></td>
                                        <td class="px-6 py-4 font-mono font-bold text-gray-700">Ilimitado</td>
                                        <td class="px-6 py-4"><span class="text-green-500"><i class="fas fa-circle text-[10px]"></i> Activo</span></td>
                                        <td class="px-6 py-4 text-right">
                                            <button class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 font-bold text-gray-800">
                                            seguros_juan <br><span class="text-xs text-gray-400 font-normal">juan@seguros.cl</span>
                                        </td>
                                        <td class="px-6 py-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold uppercase">Freemium</span></td>
                                        <td class="px-6 py-4 font-mono font-bold text-orange-500">0 / 20</td>
                                        <td class="px-6 py-4"><span class="text-red-500"><i class="fas fa-circle text-[10px]"></i> Sin Cr√©ditos</span></td>
                                        <td class="px-6 py-4 text-right">
                                            <button class="text-blue-500 hover:underline text-xs font-bold mr-2">Recargar</button>
                                            <button class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VISTA: MI PERFIL -->
                <div id="view-perfil" class="view-section hidden">
                    <div class="max-w-4xl mx-auto space-y-6">
                        <!-- Header del Perfil -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                            <div class="flex items-center gap-6">
                                <div class="relative">
                                    <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg">
                                        <span id="perfil-avatar">U</span>
                                    </div>
                                    <button onclick="App.perfil.cambiarAvatar()" class="absolute bottom-0 right-0 w-8 h-8 bg-gray-800 hover:bg-gray-700 text-white rounded-full flex items-center justify-center text-xs shadow-md transition-colors" title="Cambiar avatar">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-2xl font-bold text-gray-800" id="perfil-nombre">Usuario</h2>
                                    <p class="text-gray-500" id="perfil-email">usuario@email.com</p>
                                    <div class="flex items-center gap-3 mt-2">
                                        <span id="perfil-plan-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">
                                            <i class="fas fa-crown mr-1"></i> Plan Piloto
                                        </span>
                                        <span class="text-sm text-gray-400">|</span>
                                        <span class="text-sm text-gray-600">
                                            <i class="fas fa-coins text-yellow-500 mr-1"></i>
                                            <span id="perfil-creditos">0</span> cr√©ditos
                                        </span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Miembro desde</p>
                                    <p class="text-sm font-medium text-gray-700" id="perfil-fecha">Enero 2025</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Informaci√≥n de Cuenta -->
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <i class="fas fa-user-circle text-blue-500"></i> Informaci√≥n de Cuenta
                                    </h3>
                                    <button onclick="App.perfil.habilitarEdicion('cuenta')" class="text-sm text-blue-600 hover:text-blue-700 font-medium" id="btn-editar-cuenta">
                                        <i class="fas fa-edit mr-1"></i> Editar
                                    </button>
                                </div>
                                
                                <div class="space-y-4" id="form-cuenta">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Nombre de Usuario</label>
                                        <input type="text" id="perfil-input-usuario" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all" value="" disabled>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Email</label>
                                        <input type="email" id="perfil-input-email" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all" value="" disabled>
                                        <p class="text-xs text-gray-400 mt-1" id="email-status"></p>
                                    </div>
                                    <div id="btn-guardar-cuenta" class="hidden">
                                        <button onclick="App.perfil.guardarCuenta()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors">
                                            <i class="fas fa-save mr-2"></i> Guardar Cambios
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Seguridad - Cambiar Contrase√±a -->
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-6">
                                    <i class="fas fa-shield-alt text-green-500"></i> Seguridad
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                                        <div class="flex items-start gap-3">
                                            <i class="fas fa-lightbulb text-yellow-500 mt-1"></i>
                                            <div>
                                                <p class="text-sm font-medium text-yellow-800">Consejo de seguridad</p>
                                                <p class="text-xs text-yellow-600 mt-1">Usa al menos 8 caracteres, incluyendo n√∫meros y s√≠mbolos para mayor seguridad.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Contrase√±a Actual</label>
                                        <div class="relative">
                                            <input type="password" id="perfil-pass-actual" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 pr-10 outline-none focus:ring-2 focus:ring-green-500 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                            <button onclick="App.perfil.togglePassword('perfil-pass-actual')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Nueva Contrase√±a</label>
                                        <div class="relative">
                                            <input type="password" id="perfil-pass-nueva" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 pr-10 outline-none focus:ring-2 focus:ring-green-500 transition-all" placeholder="M√≠nimo 8 caracteres">
                                            <button onclick="App.perfil.togglePassword('perfil-pass-nueva')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="mt-2 h-1 bg-gray-200 rounded-full overflow-hidden">
                                            <div id="password-strength" class="h-full w-0 bg-red-500 transition-all duration-300"></div>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1" id="password-hint">Ingresa una contrase√±a</p>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Confirmar Nueva Contrase√±a</label>
                                        <input type="password" id="perfil-pass-confirmar" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-green-500 transition-all" placeholder="Repite la contrase√±a">
                                    </div>
                                    <button onclick="App.perfil.cambiarPassword()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-colors">
                                        <i class="fas fa-lock mr-2"></i> Actualizar Contrase√±a
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Notificaciones -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-6">
                                <i class="fas fa-bell text-orange-500"></i> Preferencias de Notificaciones
                            </h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800">Notificaciones por Email</p>
                                            <p class="text-xs text-gray-500">Recibe res√∫menes semanales de tus leads</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notif-email" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-coins"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800">Alertas de Cr√©ditos Bajos</p>
                                            <p class="text-xs text-gray-500">Notif√≠came cuando tenga menos de 50 cr√©ditos</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notif-creditos" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800">Reportes de Progreso</p>
                                            <p class="text-xs text-gray-500">Resumen mensual de leads generados</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notif-reportes" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <button onclick="App.perfil.guardarNotificaciones()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-6 rounded-xl transition-colors">
                                    <i class="fas fa-save mr-2"></i> Guardar Preferencias
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Compras -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-receipt text-indigo-500"></i> Historial de Compras
                                </h3>
                                <button onclick="App.perfil.exportarHistorial()" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                                    <i class="fas fa-download mr-1"></i> Exportar
                                </button>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 rounded-l-lg">Fecha</th>
                                            <th class="px-4 py-3">Plan/Recarga</th>
                                            <th class="px-4 py-3">Cr√©ditos</th>
                                            <th class="px-4 py-3">Monto</th>
                                            <th class="px-4 py-3 rounded-r-lg">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historial-compras">
                                        <!-- Se carga din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="historial-vacio" class="text-center py-8 text-gray-400">
                                <i class="fas fa-shopping-cart text-4xl mb-2 opacity-30"></i>
                                <p>No hay compras registradas a√∫n</p>
                            </div>
                        </div>

                        <!-- Zona de Peligro -->
                        <div class="bg-red-50 rounded-2xl border border-red-200 p-6">
                            <h3 class="text-lg font-bold text-red-800 flex items-center gap-2 mb-4">
                                <i class="fas fa-exclamation-triangle"></i> Zona de Peligro
                            </h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-red-700">Eliminar mi cuenta</p>
                                    <p class="text-sm text-red-600">Esta acci√≥n no se puede deshacer. Perder√°s todos tus cr√©ditos y datos.</p>
                                </div>
                                <button onclick="App.perfil.confirmarEliminarCuenta()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition-colors">
                                    Eliminar Cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: CONFIGURACI√ìN DEL SISTEMA -->
                <div id="view-config" class="view-section hidden">
                    <div class="max-w-4xl mx-auto space-y-6">
                        <!-- Configuraci√≥n General -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-6">
                                <i class="fas fa-cog text-blue-500"></i> Configuraci√≥n General
                            </h3>
                            
                            <div class="space-y-6">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div>
                                        <p class="font-medium text-gray-800">Modelo de IA Predeterminado</p>
                                        <p class="text-xs text-gray-500">Modelo usado por defecto en b√∫squedas</p>
                                    </div>
                                    <select id="config-modelo-default" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                        <option value="groq-llama-3.3-70b-versatile">Llama 3.3 70B</option>
                                        <option value="groq-llama-3.1-8b-instant">Llama 3.1 8B (R√°pido)</option>
                                    </select>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div>
                                        <p class="font-medium text-gray-800">Resultados por B√∫squeda</p>
                                        <p class="text-xs text-gray-500">Cantidad predeterminada de leads a buscar</p>
                                    </div>
                                    <select id="config-resultados-default" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="5">5 leads</option>
                                        <option value="10" selected>10 leads</option>
                                        <option value="20">20 leads</option>
                                        <option value="50">50 leads</option>
                                    </select>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div>
                                        <p class="font-medium text-gray-800">Tema de la Interfaz</p>
                                        <p class="text-xs text-gray-500">Modo claro u oscuro (pr√≥ximamente)</p>
                                    </div>
                                    <span class="text-xs text-gray-400 bg-gray-200 px-3 py-1 rounded-full">Pr√≥ximamente</span>
                                </div>
                            </div>
                        </div>

                        <!-- API Keys (Solo Admin) -->
                        <div id="config-api-keys" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-6">
                                <i class="fas fa-key text-yellow-500"></i> API Keys <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">Admin Only</span>
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Gemini API Key</label>
                                    <div class="relative">
                                        <input type="password" id="config-api-gemini" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 pr-20 font-mono text-sm" value="AIzaSyA...obc" readonly>
                                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                            <button onclick="App.config.toggleApiVisibility('config-api-gemini')" class="p-2 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Configurada desde variables de entorno</p>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Groq API Key</label>
                                    <div class="relative">
                                        <input type="password" id="config-api-groq" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 pr-20 font-mono text-sm" value="gsk_rl...bk" readonly>
                                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                            <button onclick="App.config.toggleApiVisibility('config-api-groq')" class="p-2 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Database URL</label>
                                    <div class="relative">
                                        <input type="password" id="config-api-db" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 pr-20 font-mono text-sm text-ellipsis overflow-hidden" value="postgresql://..." readonly>
                                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                            <button onclick="App.config.toggleApiVisibility('config-api-db')" class="p-2 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logs del Sistema -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-terminal text-gray-500"></i> Logs del Sistema
                                </h3>
                                <button onclick="App.config.limpiarLogs()" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-trash mr-1"></i> Limpiar
                                </button>
                            </div>
                            <div class="bg-gray-900 rounded-xl p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto" id="system-logs">
                                <p>[INFO] Sistema iniciado correctamente</p>
                                <p>[INFO] Conexi√≥n a base de datos establecida</p>
                                <p>[INFO] Modelo Gemini 2.0 Flash activo</p>
                                <p>[INFO] Usuario autenticado: <span id="log-username">-</span></p>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Sistema -->
                        <div class="bg-gray-50 rounded-2xl border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Informaci√≥n del Sistema</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="bg-white p-3 rounded-lg border border-gray-100">
                                    <p class="text-gray-400 text-xs">Versi√≥n</p>
                                    <p class="font-bold text-gray-800">v1.0.0</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100">
                                    <p class="text-gray-400 text-xs">Entorno</p>
                                    <p class="font-bold text-gray-800">Producci√≥n</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100">
                                    <p class="text-gray-400 text-xs">Node.js</p>
                                    <p class="font-bold text-gray-800">v24.12.0</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100">
                                    <p class="text-gray-400 text-xs">Base de Datos</p>
                                    <p class="font-bold text-green-600"><i class="fas fa-check-circle mr-1"></i>Conectada</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button onclick="App.config.reiniciarApp()" class="bg-red-100 hover:bg-red-200 text-red-700 font-bold py-3 px-6 rounded-xl transition-colors">
                                <i class="fas fa-redo mr-2"></i> Reiniciar App
                            </button>
                            <button onclick="App.config.guardarConfiguracion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                                <i class="fas fa-save mr-2"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-creditos" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-5xl w-full p-8 text-center relative overflow-hidden">
            <button onclick="document.getElementById('modal-creditos').classList.add('hidden')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-xl"><i class="fas fa-times"></i></button>
            
            <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-4 animate-bounce">
                <i class="fas fa-battery-empty"></i>
            </div>
            <h2 class="text-3xl font-black text-gray-800">¬°Tu radar se qued√≥ sin energ√≠a!</h2>
            <p class="text-gray-500 mt-2 mb-8 text-lg">Elige un plan para desbloquear m√°s leads validados y seguir cerrando ventas.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border border-gray-200 rounded-2xl p-6 text-left hover:border-gray-300 transition-colors">
                    <h3 class="text-xl font-bold text-gray-800">Plan Piloto</h3>
                    <p class="text-gray-500 text-sm mb-4 h-10">Prueba la potencia del sistema antes de comprometerte.</p>
                    <p class="text-4xl font-black mb-1">$14.990<span class="text-base font-medium text-gray-500"> CLP</span></p>
                    <p class="text-xs font-bold text-gray-400 mb-6 uppercase tracking-wider">Pago √önico</p>
                    <ul class="space-y-3 text-sm mb-8 text-gray-600">
                        <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> <b>350 Cr√©ditos</b> (Leads V√°lidos)</li>
                        <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Vigencia de 30 d√≠as</li>
                    </ul>
                    <button onclick="App.suscripcion.recargar(350)" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-xl transition">Comprar Piloto</button>
                </div>

                <div class="border-2 border-blue-500 rounded-2xl p-6 text-left relative transform scale-105 shadow-xl bg-white">
                    <span class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white text-[10px] font-black uppercase tracking-widest px-4 py-1.5 rounded-full shadow-md">M√°s Popular</span>
                    <h3 class="text-2xl font-black text-blue-600">Profesional</h3>
                    <p class="text-gray-500 text-sm mb-4 h-10">El est√°ndar para ejecutivos de ventas y corredores.</p>
                    <p class="text-4xl font-black text-gray-900 mb-1">$69.990<span class="text-base font-medium text-gray-500"> CLP</span></p>
                    <p class="text-xs font-bold text-blue-400 mb-6 uppercase tracking-wider">Suscripci√≥n Mensual</p>
                    <ul class="space-y-3 text-sm mb-8 text-gray-700">
                        <li class="flex items-center gap-2"><i class="fas fa-check-circle text-blue-500 text-lg"></i> <b class="text-base">2.000 Cr√©ditos / mes</b></li>
                        <li class="flex items-center gap-2"><i class="fas fa-check-circle text-blue-500 text-lg"></i> Playbooks IA y Plantillas</li>
                    </ul>
                    <button onclick="App.suscripcion.recargar(2000)" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg transition-transform hover:scale-[1.02]">Suscribirse Ahora</button>
                </div>

                <div class="border border-gray-200 rounded-2xl p-6 text-left hover:border-gray-300 transition-colors bg-slate-50">
                    <h3 class="text-xl font-bold text-gray-800">Growth / Agencia</h3>
                    <p class="text-gray-500 text-sm mb-4 h-10">Para call centers o equipos de 3 a 5 vendedores.</p>
                    <p class="text-4xl font-black mb-1">$149.900<span class="text-base font-medium text-gray-500"> CLP</span></p>
                    <p class="text-xs font-bold text-gray-400 mb-6 uppercase tracking-wider">Suscripci√≥n Mensual</p>
                    <ul class="space-y-3 text-sm mb-8 text-gray-600">
                        <li class="flex items-center gap-2"><i class="fas fa-check-circle text-purple-500"></i> <b>6.000 Cr√©ditos / mes</b></li>
                        <li class="flex items-center gap-2"><i class="fas fa-check-circle text-purple-500"></i> Conexi√≥n API (HubSpot)</li>
                    </ul>
                    <button onclick="App.suscripcion.recargar(6000)" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl transition">Contactar Ventas</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const App = {
            init: function() {
                // Autenticaci√≥n B√°sica - Bloqueo de acceso directo
                const currentUser = localStorage.getItem('saas_user');
                const loginScreen = document.getElementById('login-screen');
                const appContainer = document.getElementById('app-container');
                
                if (!currentUser) {
                    // No hay sesi√≥n: mostrar login, ocultar app
                    loginScreen.style.display = 'flex';
                    loginScreen.classList.remove('hidden');
                    appContainer.style.display = 'none';
                    appContainer.classList.add('hidden');
                    return; // Detener carga de la app
                } else {
                    // Sesi√≥n activa: mostrar app, ocultar login
                    loginScreen.style.display = 'none';
                    loginScreen.classList.add('hidden');
                    appContainer.style.display = 'flex';
                    appContainer.classList.remove('hidden');
                    
                    // Configurar info del usuario en el men√∫ de perfil
                    App.perfil.cargarInfoUsuario(currentUser);
                    
                    if (currentUser === 'alexisferrada') {
                        document.getElementById('menu-admin').classList.remove('hidden');
                    } else {
                        document.getElementById('menu-admin').classList.add('hidden');
                    }

                    App.suscripcion.verificar();
                    App.prospector.cargarEstrategias();
                    App.entrenar.init();
                    App.wizard.reset();
                }
            },

            auth: {
                login: () => {
                    const user = document.getElementById('login-user').value.trim();
                    const pass = document.getElementById('login-pass').value.trim();

                    if (user === 'alexisferrada' && pass === '123654') {
                        localStorage.setItem('saas_user', user);
                        if (localStorage.getItem('saas_creditos') === null) {
                            localStorage.setItem('saas_creditos', 20); // 20 cr√©ditos freemium
                        }
                        location.reload();
                    } else {
                        alert("‚ö†Ô∏è Credenciales incorrectas.");
                    }
                },
                logout: () => {
                    localStorage.removeItem('saas_user');
                    localStorage.removeItem('saas_creditos');
                    window.location.href = 'dashboard.html';
                }
            },

            navegacion: {
                ir: (vista) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    const view = document.getElementById(`view-${vista}`);
                    if(view) view.classList.remove('hidden');
                    
                    if (vista === 'database') App.database.cargar();
                    else if (vista === 'entrenar') App.entrenar.init();

                    const links = ['buscador', 'wizard', 'database', 'entrenar', 'usuarios', 'config', 'perfil'];
                    links.forEach(id => {
                        const link = document.getElementById(`nav-${id}`);
                        if(link) {
                            if(id === vista) {
                                link.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                                link.classList.remove('text-gray-400', 'hover:bg-gray-800');
                                document.getElementById('header-titulo').innerText = link.innerText.trim();
                            } else {
                                link.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                                link.classList.add('text-gray-400', 'hover:bg-gray-800');
                            }
                        }
                    });
                }
            },

            suscripcion: {
                creditos: 0,
                verificar: () => {
                    App.suscripcion.creditos = parseInt(localStorage.getItem('saas_creditos')) || 0;
                    const badge = document.getElementById('subscription-badge');
                    document.getElementById('creditos-restantes').innerText = App.suscripcion.creditos.toLocaleString('es-CL');

                    if (App.suscripcion.creditos <= 0) {
                        badge.classList.remove('bg-purple-100', 'text-purple-800', 'border-purple-200');
                        badge.classList.add('bg-red-100', 'text-red-800', 'border-red-200', 'animate-pulse');
                    } else {
                        badge.classList.add('bg-purple-100', 'text-purple-800', 'border-purple-200');
                        badge.classList.remove('bg-red-100', 'text-red-800', 'border-red-200', 'animate-pulse');
                    }
                },
                descontar: (cantidadUtilizada) => {
                    App.suscripcion.creditos -= cantidadUtilizada;
                    if (App.suscripcion.creditos < 0) App.suscripcion.creditos = 0;
                    localStorage.setItem('saas_creditos', App.suscripcion.creditos);
                    App.suscripcion.verificar();
                },
                recargar: (cantidad) => {
                    const current = parseInt(localStorage.getItem('saas_creditos')) || 0;
                    localStorage.setItem('saas_creditos', current + cantidad);
                    App.suscripcion.verificar();
                    
                    // Determinar plan y monto seg√∫n cantidad
                    let plan, monto;
                    switch(cantidad) {
                        case 350:
                            plan = 'Plan Piloto';
                            monto = 14990;
                            break;
                        case 2000:
                            plan = 'Plan Profesional';
                            monto = 69990;
                            break;
                        case 6000:
                            plan = 'Plan Growth/Agencia';
                            monto = 149900;
                            break;
                        default:
                            plan = 'Recarga Personalizada';
                            monto = Math.round(cantidad * 50); // Precio estimado
                    }
                    
                    // Registrar en historial
                    App.perfil.agregarCompra(plan, cantidad, monto);
                    
                    document.getElementById('modal-creditos').classList.add('hidden');
                    alert(`‚úÖ ¬°Pago exitoso!\n\nPlan: ${plan}\nCr√©ditos: +${cantidad.toLocaleString('es-CL')}\nMonto: $${monto.toLocaleString('es-CL')} CLP`);
                }
            },

            database: {
                datosCache: [],
                cargar: async () => {
                    const tbody = document.getElementById('tabla-database');
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-blue-500 text-2xl"></i><p class="mt-2 text-gray-500">Cargando historial...</p></td></tr>';
                    
                    try {
                        const res = await fetch('/api/prospectos');
                        const data = await res.json();
                        
                        if (!Array.isArray(data) || data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay registros en la base de datos.</td></tr>';
                            document.getElementById('db-total-registros').innerText = '0';
                            return;
                        }

                        App.database.datosCache = data;
                        document.getElementById('db-total-registros').innerText = data.length;
                        document.getElementById('db-saldo-actual').innerText = App.suscripcion.creditos;

                        const estrategias = [...new Set(data.map(p => p.categoria_nicho || 'General'))];
                        const selectEstrategia = document.getElementById('filter-estrategia');
                        selectEstrategia.innerHTML = '<option value="all">Todas las Estrategias</option>';
                        estrategias.forEach(e => {
                            selectEstrategia.innerHTML += `<option value="${e}">${e}</option>`;
                        });

                        App.database.aplicarFiltros();
                    } catch (e) {
                        console.error(e);
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar datos. Verifica la conexi√≥n con el servidor.</td></tr>';
                    }
                },
                aplicarFiltros: () => {
                    const estrategia = document.getElementById('filter-estrategia').value;
                    const fechaFiltro = document.getElementById('filter-fecha').value;
                    const tbody = document.getElementById('tabla-database');
                    
                    const hoy = new Date();
                    hoy.setHours(0,0,0,0);

                    const filtrados = App.database.datosCache.filter(p => {
                        if (estrategia !== 'all' && (p.categoria_nicho || 'General') !== estrategia) return false;
                        const fechaP = new Date(p.created_at);
                        fechaP.setHours(0,0,0,0);
                        if (fechaFiltro === 'hoy' && fechaP.getTime() !== hoy.getTime()) return false;
                        if (fechaFiltro === 'semana') {
                            const primerDiaSemana = new Date(hoy);
                            primerDiaSemana.setDate(hoy.getDate() - hoy.getDay());
                            if (fechaP < primerDiaSemana) return false;
                        }
                        if (fechaFiltro === 'mes' && (fechaP.getMonth() !== hoy.getMonth() || fechaP.getFullYear() !== hoy.getFullYear())) return false;
                        return true;
                    });

                    document.getElementById('db-count-visible').innerText = filtrados.length;

                    if (filtrados.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No se encontraron resultados.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = filtrados.map(p => {
                        const fecha = new Date(p.created_at).toLocaleDateString('es-CL', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                        let estadoBadge = '<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">Pendiente</span>';
                        if (p.estado_whatsapp === 'VALIDO') estadoBadge = '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded border border-green-200"><i class="fa-solid fa-check mr-1"></i> V√°lido</span>';
                        if (p.estado_whatsapp === 'INVALIDO') estadoBadge = '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded border border-red-200"><i class="fa-solid fa-ban mr-1"></i> Inv√°lido</span>';
                        
                        const score = p.score_calidad || 0;
                        let barColor = score >= 70 ? 'bg-green-500' : (score >= 40 ? 'bg-yellow-400' : 'bg-red-500');
                        const fonoLimpio = p.telefono ? p.telefono.replace(/\D/g, '') : '';
                        const waLink = fonoLimpio ? `https://wa.me/${fonoLimpio}` : '#';

                        return `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${fecha}</td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-bold text-gray-900">${p.categoria_nicho || 'General'}</div>
                                    <div class="text-xs text-gray-500 truncate max-w-[150px]">${p.segmento || ''}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900 mb-1">${p.negocio}</div>
                                    <div class="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100 italic">"${p.razon_seleccion || 'Sin motivo'}"</div>
                                </td>
                                <td class="px-6 py-4">
                                    ${p.telefono ? `<a href="${waLink}" target="_blank" class="flex items-center gap-1 text-sm text-gray-900 font-mono hover:text-green-600 mb-1"><i class="fa-brands fa-whatsapp"></i> ${p.telefono}</a>` : '--'}
                                </td>
                                <td class="px-6 py-4 align-middle">
                                    <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden" title="Score: ${score}%">
                                        <div class="h-full ${barColor}" style="width: ${score}%"></div>
                                        <span class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-slate-700">${score}%</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center">${estadoBadge}</td>
                            </tr>
                        `;
                    }).join('');
                }
            },

            entrenar: {
                estrategiaActivaIndex: null,
                init: () => {
                    const select = document.getElementById('entrenar-select-estrategia');
                    if(!select) return;
                    if (App.prospector.estrategiasCache.length === 0) {
                        select.innerHTML = '<option value="" disabled selected>-- No tienes estrategias guardadas --</option>';
                        return;
                    }
                    select.innerHTML = '<option value="" disabled selected>-- Elige una estrategia de tu b√≥veda --</option>';
                    App.prospector.estrategiasCache.forEach((p, index) => {
                        select.innerHTML += `<option value="${index}">üéØ ${p.nombre_plantilla}</option>`;
                    });
                },
                cargarDatosEstrategia: () => {
                    const index = document.getElementById('entrenar-select-estrategia').value;
                    if (index === "") return;
                    App.entrenar.estrategiaActivaIndex = index;
                    const estrategia = App.prospector.estrategiasCache[index];
                    if (estrategia && estrategia.playbook_data) {
                        document.getElementById('entrenar-prompt-busqueda').value = estrategia.playbook_data.instruccion_scraper_ia || '';
                        document.getElementById('entrenar-prompt-mensaje').value = estrategia.playbook_data.rompehielos_whatsapp || '';
                        document.getElementById('entrenar-prompts-container').classList.remove('hidden');
                    }
                },
                regenerar: async (tipo) => {
                    const index = App.entrenar.estrategiaActivaIndex;
                    if (index === null) return;
                    const estrategia = App.prospector.estrategiasCache[index];
                    const model = document.getElementById('global-model-selector').value;
                    
                    let promptBase = tipo === 'busqueda' 
                        ? `Act√∫a como Experto en Extracci√≥n. Mejora esta instrucci√≥n para un scraper. Nicho: ${estrategia.playbook_data.titulo_nicho}. Actual: "${document.getElementById('entrenar-prompt-busqueda').value}". Devuelve SOLO el nuevo prompt.`
                        : `Act√∫a como Copywriter B2B. Mejora este mensaje de WhatsApp. Nicho: ${estrategia.playbook_data.titulo_nicho}. Actual: "${document.getElementById('entrenar-prompt-mensaje').value}". Devuelve SOLO el nuevo mensaje sin comillas.`;
                    
                    const elementId = tipo === 'busqueda' ? 'entrenar-prompt-busqueda' : 'entrenar-prompt-mensaje';
                    const textArea = document.getElementById(elementId);
                    const originalText = textArea.value;
                    textArea.value = "ü§ñ Procesando con IA...";
                    textArea.disabled = true;
                    
                    try {
                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: promptBase, model: model })
                        });
                        const data = await res.json();
                        textArea.value = data.analisis.replace(/```/g, '').replace(/"/g, '').trim();
                    } catch (e) {
                        alert("Error al generar mejora con IA.");
                        textArea.value = originalText;
                    } finally { textArea.disabled = false; }
                },
                guardar: async (tipo) => {
                    const index = App.entrenar.estrategiaActivaIndex;
                    if (index === null) return;
                    const estrategia = App.prospector.estrategiasCache[index];
                    
                    if (tipo === 'busqueda') estrategia.playbook_data.instruccion_scraper_ia = document.getElementById('entrenar-prompt-busqueda').value;
                    else estrategia.playbook_data.rompehielos_whatsapp = document.getElementById('entrenar-prompt-mensaje').value;
                    
                    try {
                        const res = await fetch(`/api/plantillas/${estrategia.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ playbook_data: estrategia.playbook_data })
                        });
                        if(!res.ok) throw new Error("Error al guardar en BD");
                        alert("‚úÖ Datos actualizados en tu b√≥veda.");
                    } catch(e) {
                        console.error(e);
                        alert("‚ö†Ô∏è Error de conexi√≥n con backend.");
                    }
                }
            },

            prospector: {
                estrategiasCache: [],
                cargarEstrategias: async () => {
                    try {
                        const res = await fetch('/api/plantillas');
                        const data = await res.json();
                        App.prospector.estrategiasCache = data;
                        const select = document.getElementById('select-estrategia');
                        select.innerHTML = '<option value="" disabled selected>-- Selecciona una Estrategia Guardada --</option>';
                        data.forEach((p, index) => select.innerHTML += `<option value="${index}">üìÇ ${p.nombre_plantilla}</option>`);
                        App.entrenar.init();
                    } catch (e) { console.error(e); }
                },
                seleccionarEstrategia: () => {
                    const index = document.getElementById('select-estrategia').value;
                    if (index === "") return;
                    const estrategia = App.prospector.estrategiasCache[index];
                    if (estrategia && estrategia.playbook_data) {
                        document.getElementById('txt-estrategia-prompt').value = estrategia.playbook_data.instruccion_scraper_ia || estrategia.playbook_data.titulo_nicho;
                    }
                },
                ejecutarEstrategia: async () => {
                    const cantidadSolicitada = parseInt(document.getElementById('select-cantidad').value);

                    // 1. VERIFICACI√ìN DE PAYWALL ESTRAT√âGICO
                    if (App.suscripcion.creditos <= 0 || App.suscripcion.creditos < cantidadSolicitada) {
                        document.getElementById('modal-creditos').classList.remove('hidden');
                        return;
                    }

                    const index = document.getElementById('select-estrategia').value;
                    const instruccion = document.getElementById('txt-estrategia-prompt').value;
                    if (index === "" && !instruccion) return alert("Por favor selecciona una estrategia.");

                    const nichoTitulo = (index !== "" && App.prospector.estrategiasCache[index]) ? App.prospector.estrategiasCache[index].playbook_data.titulo_nicho : "B√∫squeda Personalizada";
                    const model = document.getElementById('global-model-selector').value;
                    
                    const tbody = document.getElementById('tabla-resultados');
                    const btn = document.querySelector('button[onclick="App.prospector.ejecutarEstrategia()"]');
                    const originalBtnHTML = btn.innerHTML;

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scrapeando internet...';
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-blue-600 font-bold"><i class="fas fa-radar fa-spin text-2xl mb-2"></i><br>Buscando prospectos reales en la web...</td></tr>`;
                    document.getElementById('resultado-consumo').innerText = "";
                    
                    try {
                        // Conexi√≥n Real a tu API de Backend
                        const res = await fetch('/api/buscar-leads', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ nicho: nichoTitulo, instruccion: instruccion, motor: model, cantidad: cantidadSolicitada }) 
                        });
                        const data = await res.json();

                        let validosCobrados = 0;

                        // Guardar leads en memoria para auditor√≠a
                        App.prospector.ultimosLeads = data.data;
                        
                        tbody.innerHTML = data.data.map((lead, index) => {
                            const score = lead.score_calidad || 0;
                            const rotation = (score * 1.8) - 90;
                            const rawPhone = lead.telefono || '';
                            const cleanPhone = rawPhone.replace(/\D/g, '');
                            const esValido = lead.estado_whatsapp === 'VALIDO';
                            
                            let fonoClase, cobrarBadge;

                            if (esValido) {
                                validosCobrados++;
                                fonoClase = 'text-green-600 hover:text-green-700 font-bold cursor-pointer';
                                cobrarBadge = '<span class="bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded font-bold">-1 Cr√©dito</span>';
                            } else {
                                fonoClase = 'text-gray-400 italic cursor-not-allowed';
                                cobrarBadge = '<span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded font-bold">Gratis</span>';
                            }

                            const waLink = (cleanPhone && esValido) ? `https://wa.me/${cleanPhone}` : '#';
                            const waDisplay = (cleanPhone && esValido) ? rawPhone : 'No disponible / Fijo';
                            
                            return `
                                <tr class="bg-white border-b hover:bg-gray-50 transition" id="lead-row-${index}">
                                    <td class="px-6 py-4">
                                        <div class="relative w-12 h-8 mx-auto" title="Score: ${score}%">
                                            <svg viewBox="0 0 100 60" class="w-full h-full overflow-visible">
                                                <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="8" stroke-linecap="round" />
                                                <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#22c55e" stroke-width="8" stroke-linecap="round" />
                                                <g style="transform: rotate(${rotation}deg); transform-origin: 50px 50px;">
                                                    <circle cx="50" cy="50" r="4" fill="#1f2937" />
                                                    <path d="M 50 50 L 50 15" stroke="#1f2937" stroke-width="3" stroke-linecap="round" />
                                                </g>
                                                <text x="50" y="70" text-anchor="middle" class="text-[10px] font-bold fill-gray-700">${score}%</text>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 font-medium text-gray-900">${lead.negocio}</td>
                                    <td class="px-6 py-4">
                                        <a href="${waLink}" target="_blank" class="flex items-center gap-2 ${fonoClase}">
                                            <i class="fab fa-whatsapp text-lg"></i>
                                            <span class="font-mono text-xs">${waDisplay}</span>
                                        </a>
                                    </td>
                                    <td class="px-6 py-4 text-center">${cobrarBadge}</td>
                                    <td class="px-6 py-4 text-center">
                                        ${esValido ? `
                                            <button data-lead-phone="${lead.telefono}" onclick="App.auditoria.solicitarPorTelefono('${lead.telefono}')" 
                                                class="bg-amber-100 hover:bg-amber-200 text-amber-700 text-xs font-bold px-2 py-1 rounded flex items-center gap-1 transition-colors"
                                                title="Auditar lead - Si es inv√°lido se devuelve el cr√©dito">
                                                <i class="fas fa-gavel"></i> Auditar
                                            </button>
                                        ` : '<span class="text-gray-400 text-xs">No aplica</span>'}
                                        <div id="auditoria-result-${lead.telefono}" class="mt-1 text-[10px]"></div>
                                    </td>
                                </tr>
                            `;
                        }).join('');

                        // 2. DESCONTAR CR√âDITOS REALES EN BASE A LA API
                        App.suscripcion.descontar(validosCobrados);
                        document.getElementById('resultado-consumo').innerHTML = `Se encontraron <b>${validosCobrados} v√°lidos</b>. Costo total: <span class="text-red-500 font-bold">-${validosCobrados} Cr√©ditos</span>`;

                    } catch (error) {
                        console.error(error);
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error al buscar leads. Verifica el backend.</td></tr>';
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalBtnHTML;
                    }
                }
            },

            auditoria: {
                // Nuevo m√©todo usando tel√©fono como identificador
                solicitarPorTelefono: async (telefono) => {
                    // Buscar el lead por tel√©fono en los √∫ltimos resultados
                    const lead = App.prospector.ultimosLeads.find(l => l.telefono === telefono);
                    
                    if (!lead) {
                        console.error('[AUDITOR√çA] Lead no encontrado con tel√©fono:', telefono);
                        alert('Error: Lead no encontrado. Intenta buscar nuevamente.');
                        return;
                    }
                    
                    const resultDiv = document.getElementById(`auditoria-result-${telefono}`);
                    const btn = document.querySelector(`button[data-lead-phone="${telefono}"]`);
                    
                    if (!resultDiv || !btn) {
                        console.error('[AUDITOR√çA] Elementos DOM no encontrados para:', telefono);
                        return;
                    }
                    
                    // Mostrar estado de carga
                    resultDiv.innerHTML = '<span class="text-amber-600 animate-pulse"><i class="fas fa-spinner fa-spin"></i> Auditando...</span>';
                    btn.disabled = true;
                    
                    const model = document.getElementById('global-model-selector').value;
                    
                    try {
                        console.log(`[AUDITOR√çA] Solicitando auditor√≠a para:`, lead);
                        
                        const res = await fetch('/api/auditar-lead', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ lead, modelo: model })
                        });
                        
                        const data = await res.json();
                        
                        if (!res.ok) throw new Error(data.error || 'Error en auditor√≠a');
                        
                        console.log(`[AUDITOR√çA] Resultado:`, data);
                        
                        // Mostrar resultado
                        if (data.valido) {
                            resultDiv.innerHTML = `
                                <span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> V√ÅLIDO</span>
                                <div class="text-gray-500 mt-1">${data.razon}</div>
                            `;
                            btn.innerHTML = '<i class="fas fa-check"></i> Confirmado';
                            btn.className = 'bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded cursor-default';
                        } else {
                            // MENSAJE DE AGRADECIMIENTO DESTACADO
                            resultDiv.innerHTML = `
                                <div class="border-2 border-red-200 rounded-lg p-2 mt-1 bg-red-50">
                                    <span class="text-red-600 font-bold text-sm"><i class="fas fa-times-circle"></i> INV√ÅLIDO</span>
                                    <div class="text-red-600 text-xs mt-1 font-medium">${data.razon}</div>
                                    ${data.credito_devuelto ? '<div class="text-green-600 font-bold mt-2 text-sm"><i class="fas fa-undo"></i> üí∞ ¬°CR√âDITO DEVUELTO!</div>' : ''}
                                    <div class="bg-gradient-to-r from-amber-100 to-orange-100 text-amber-800 text-[10px] mt-2 px-2 py-2 rounded-lg text-center border border-amber-200">
                                        <i class="fas fa-heart text-red-500 animate-pulse"></i> <b>¬°Gracias por alimentar nuestra IA!</b><br>
                                        <span class="text-[9px] text-amber-700">Tu feedback hace el sistema m√°s inteligente üß†‚ú®</span>
                                    </div>
                                </div>
                            `;
                            btn.innerHTML = '<i class="fas fa-ban"></i> Rechazado';
                            btn.className = 'bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded cursor-default';
                            
                            // Actualizar cr√©ditos mostrados
                            if (data.credito_devuelto) {
                                const creditosActuales = parseInt(document.getElementById('creditos-restantes').innerText.replace(/,/g, '')) || 0;
                                document.getElementById('creditos-restantes').innerText = (creditosActuales + 1).toLocaleString('es-CL');
                                App.suscripcion.creditos = creditosActuales + 1;
                            }
                        }
                        
                    } catch (error) {
                        console.error('[AUDITOR√çA] Error:', error);
                        resultDiv.innerHTML = `<span class="text-red-500"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</span>`;
                        btn.disabled = false;
                    }
                },
                
                // Cargar blacklist en la vista de base de datos
                cargarBlacklist: async () => {
                    try {
                        const res = await fetch('/api/blacklist');
                        const data = await res.json();
                        
                        if (!res.ok) throw new Error('Error cargando blacklist');
                        
                        // Actualizar contador
                        document.getElementById('blacklist-count-display').innerText = data.length;
                        
                        // Renderizar tabla
                        const tbody = document.getElementById('blacklist-table-body');
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-2 text-center text-gray-400">No hay n√∫meros en blacklist</td></tr>';
                        } else {
                            tbody.innerHTML = data.map(item => `
                                <tr class="hover:bg-red-50">
                                    <td class="px-3 py-2 font-mono text-xs">${item.telefono}</td>
                                    <td class="px-3 py-2 text-xs">${item.negocio || '-'}</td>
                                    <td class="px-3 py-2 text-xs text-red-600">${item.razon?.substring(0, 50) || 'Sin raz√≥n'}...</td>
                                </tr>
                            `).join('');
                        }
                        
                        console.log(`[BLACKLIST] ${data.length} n√∫meros cargados`);
                        return data;
                    } catch (error) {
                        console.error('[BLACKLIST] Error:', error);
                        document.getElementById('blacklist-table-body').innerHTML = 
                            `<tr><td colspan="3" class="px-3 py-2 text-center text-red-500">Error: ${error.message}</td></tr>`;
                        return [];
                    }
                },
                
                toggleBlacklistPanel: () => {
                    const panel = document.getElementById('blacklist-panel');
                    if (panel.classList.contains('hidden')) {
                        panel.classList.remove('hidden');
                        App.auditoria.cargarBlacklist();
                    } else {
                        panel.classList.add('hidden');
                    }
                }
            },

            wizard: {
                state: { rol: '', nicho: '', currentPlaybook: null, chatHistory: [] },
                reset: () => {
                    ['step-2', 'step-3', 'step-4'].forEach(id => document.getElementById(id).classList.add('hidden'));
                    document.getElementById('step-1').classList.remove('hidden');
                    App.wizard.state.chatHistory = [];
                    
                    // Resetear progreso
                    document.getElementById('wizard-progress').classList.add('hidden');
                    document.getElementById('prog-producto').classList.add('hidden');
                    document.getElementById('prog-publico').classList.add('hidden');
                    document.getElementById('prog-ubicacion').classList.add('hidden');
                    
                    const chatContainer = document.getElementById('wizard-chat-messages');
                    chatContainer.innerHTML = `
                        <div class="flex gap-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold shadow-md">üöÄ</div>
                            <div class="bg-white border border-gray-200 p-4 rounded-2xl rounded-tl-none text-sm text-gray-700 shadow-sm max-w-[85%]">
                                <p class="mb-2">¬°Hola! Soy <b>Vicente</b>, tu estratega de ventas en Aexon LeadGen. üéØ</p>
                                <p>Voy a ayudarte a encontrar los mejores clientes para tu negocio. Solo necesito entender 3 cosas:</p>
                                <ol class="mt-2 ml-4 list-decimal text-gray-600 space-y-1">
                                    <li>¬øQu√© vendes?</li>
                                    <li>¬øA qui√©n se lo vendes?</li>
                                    <li>¬øD√≥nde est√°n esos clientes?</li>
                                </ol>
                                <p class="mt-3 text-blue-600 font-medium">Empecemos: ¬øQu√© producto o servicio ofreces? üöÄ</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('wizard-chat-input').value = '';
                },
                enviarMensaje: async () => {
                    const input = document.getElementById('wizard-chat-input');
                    const msg = input.value.trim();
                    if (!msg) return;

                    const chatContainer = document.getElementById('wizard-chat-messages');
                    const model = document.getElementById('global-model-selector').value;
                    
                    chatContainer.innerHTML += `<div class="flex gap-3 justify-end"><div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none text-sm shadow-md max-w-[85%]">${msg}</div></div>`;
                    input.value = '';
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    App.wizard.state.chatHistory.push({ role: 'user', content: msg });
                    
                    // Actualizar progreso con lo que dijo el usuario
                    App.wizard.actualizarProgreso(App.wizard.state.chatHistory);

                    const loadingId = 'loading-' + Date.now();
                    chatContainer.innerHTML += `<div id="${loadingId}" class="flex gap-3"><div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center flex-shrink-0 text-sm shadow-md">üöÄ</div><div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none text-sm text-gray-500 shadow-sm flex items-center gap-2"><span class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span><span class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span></div></div>`;
                    chatContainer.scrollTop = chatContainer.scrollHeight;

                    try {
                        const res = await fetch('/api/wizard/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ history: App.wizard.state.chatHistory, model: model })
                        });
                        const data = await res.json();
                        const loader = document.getElementById(loadingId);
                        if(loader) loader.remove();

                        chatContainer.innerHTML += `<div class="flex gap-3"><div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center flex-shrink-0 text-sm shadow-md">üöÄ</div><div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none text-sm text-gray-700 shadow-sm max-w-[85%]">${data.message}</div></div>`;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        App.wizard.state.chatHistory.push({ role: 'assistant', content: data.message });
                        
                        // Actualizar barra de progreso en vivo
                        App.wizard.actualizarProgreso(App.wizard.state.chatHistory);

                        if (data.ready) setTimeout(() => App.wizard.ejecutarAnalisis(data.summary), 1500);
                    } catch (e) {
                        console.error(e);
                        const loader = document.getElementById(loadingId);
                        if(loader) loader.remove();
                        chatContainer.innerHTML += `<div class="text-center text-xs text-red-400 my-2">Error de conexi√≥n.</div>`;
                    }
                },
                ejecutarAnalisis: async (resumen) => {
                    App.wizard.state.rol = resumen;
                    document.getElementById('wizard-context-text').innerHTML = `Para: <strong>${resumen}</strong>. Elige tu ruta de ataque:`;
                    const model = document.getElementById('global-model-selector').value;
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');

                    try {
                        const res = await fetch('/api/sugerir-nichos', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ rol: resumen, model: model })
                        });
                        const data = await res.json();
                        const cardsContainer = document.getElementById('wizard-cards');
                        cardsContainer.innerHTML = data.playbooks.map((pb, index) => `
                            <div class="bg-white rounded-2xl border border-slate-200 hover:border-blue-400 hover:shadow-xl transition-all duration-300 overflow-hidden group relative">
                                <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 z-0 transition-transform group-hover:scale-110"></div>
                                <div onclick="App.wizard.toggleDetalle(${index})" class="p-6 cursor-pointer relative z-10">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform duration-300"><i class="${pb.icon || 'fas fa-bullseye'}"></i></div>
                                        <div class="flex items-center gap-2"><span class="bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider border border-green-200">Oportunidad</span><i class="fas fa-chevron-down text-slate-300 transition-transform duration-300" id="chevron-${index}"></i></div>
                                    </div>
                                    <h4 class="font-bold text-xl text-slate-800 mb-2 group-hover:text-blue-600 transition-colors">${pb.titulo_nicho}</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed mb-4">${pb.senal_de_compra}</p>
                                </div>
                                <div id="detalle-${index}" class="hidden bg-slate-50 border-t border-slate-100 p-6 space-y-5 relative z-10">
                                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><p class="text-sm text-slate-600 leading-relaxed">${pb.instruccion_scraper_ia}</p></div>
                                    <div class="bg-white p-4 rounded-xl border border-green-200 shadow-sm"><p class="text-sm text-slate-600 italic mb-3">"${pb.rompehielos_whatsapp}"</p></div>
                                    <button onclick='App.wizard.activarPlaybook(${JSON.stringify(pb).replace(/'/g, "&#39;")})' class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">üöÄ Activar esta Misi√≥n</button>
                                </div>
                            </div>
                        `).join('');
                        document.getElementById('step-2').classList.add('hidden');
                        document.getElementById('step-3').classList.remove('hidden');
                    } catch (e) { console.error(e); App.wizard.reset(); }
                },
                toggleDetalle: (index) => {
                    const detalle = document.getElementById(`detalle-${index}`);
                    const chevron = document.getElementById(`chevron-${index}`);
                    document.querySelectorAll('[id^="detalle-"]').forEach(el => { if(el.id !== `detalle-${index}`) el.classList.add('hidden'); });
                    document.querySelectorAll('[id^="chevron-"]').forEach(el => { if(el.id !== `chevron-${index}`) el.classList.remove('rotate-180'); });
                    detalle.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                },
                activarPlaybook: async (playbook) => {
                    App.wizard.state.currentPlaybook = playbook;
                    document.getElementById('wizard-selected-niche').innerText = playbook.titulo_nicho;
                    document.getElementById('step-3').classList.add('hidden');
                    document.getElementById('step-4').classList.remove('hidden');
                },
                
                actualizarProgreso: (historial) => {
                    const texto = historial.map(m => m.content.toLowerCase()).join(' ');
                    const progressDiv = document.getElementById('wizard-progress');
                    const progProducto = document.getElementById('prog-producto');
                    const progPublico = document.getElementById('prog-publico');
                    const progUbicacion = document.getElementById('prog-ubicacion');
                    
                    // Detectores m√°s precisos
                    const productos = [];
                    const publicos = [];
                    const ubicaciones = [];
                    
                    // Productos
                    if (texto.includes('seguro')) productos.push('seguros');
                    if (texto.includes('p√°gina') || texto.includes('pagina') || texto.includes('web')) productos.push('p√°ginas web');
                    if (texto.includes('consultor√≠a')) productos.push('consultor√≠a');
                    if (texto.includes('marketing')) productos.push('marketing digital');
                    if (texto.includes('software')) productos.push('software');
                    
                    // P√∫blicos
                    if (texto.includes('pyme')) publicos.push('pymes');
                    if (texto.includes('log√≠stica') || texto.includes('logistica')) publicos.push('pymes de log√≠stica');
                    if (texto.includes('doctor') || texto.includes('m√©dico')) publicos.push('doctores');
                    if (texto.includes('veterinaria')) publicos.push('veterinarias');
                    if (texto.includes('dentista')) publicos.push('dentistas');
                    if (texto.includes('trabajador')) publicos.push('trabajadores');
                    if (texto.includes('adulto')) publicos.push('adultos');
                    if (texto.includes('empresa')) publicos.push('empresas');
                    if (texto.includes('persona') && !texto.includes('personales')) publicos.push('personas');
                    
                    // Ubicaciones
                    if (texto.includes('santiago')) ubicaciones.push('Santiago');
                    if (texto.includes('providencia')) ubicaciones.push('Providencia');
                    if (texto.includes('√±u√±oa') || texto.includes('nunoa')) ubicaciones.push('√ëu√±oa');
                    if (texto.includes('las condes')) ubicaciones.push('Las Condes');
                    if (texto.includes('chile')) ubicaciones.push('Chile');
                    if (texto.includes('todo chile') || texto.includes('nacional')) ubicaciones.push('todo Chile');
                    
                    let tieneAlgo = false;
                    
                    if (productos.length > 0) {
                        progProducto.querySelector('.val').innerText = productos[0];
                        progProducto.classList.remove('hidden');
                        tieneAlgo = true;
                    } else {
                        progProducto.classList.add('hidden');
                    }
                    
                    if (publicos.length > 0) {
                        progPublico.querySelector('.val').innerText = publicos[0];
                        progPublico.classList.remove('hidden');
                        tieneAlgo = true;
                    } else {
                        progPublico.classList.add('hidden');
                    }
                    
                    if (ubicaciones.length > 0) {
                        progUbicacion.querySelector('.val').innerText = ubicaciones[0];
                        progUbicacion.classList.remove('hidden');
                        tieneAlgo = true;
                    } else {
                        progUbicacion.classList.add('hidden');
                    }
                    
                    if (tieneAlgo) {
                        progressDiv.classList.remove('hidden');
                    } else {
                        progressDiv.classList.add('hidden');
                    }
                    
                    // Si tenemos los 3, mostrar bot√≥n de avance r√°pido
                    const btnFinalizar = document.getElementById('btn-finalizar-wizard');
                    if (productos.length > 0 && publicos.length > 0 && ubicaciones.length > 0) {
                        if (btnFinalizar) {
                            btnFinalizar.classList.remove('hidden');
                            btnFinalizar.classList.add('bg-green-500', 'hover:bg-green-600');
                            btnFinalizar.innerHTML = '¬°Listo! Generar estrategias üöÄ';
                        }
                    } else {
                        if (btnFinalizar) {
                            btnFinalizar.classList.add('hidden');
                        }
                    }
                },
                
                finalizarManual: () => {
                    const historial = App.wizard.state.chatHistory;
                    const texto = historial.map(m => m.content.toLowerCase()).join(' ');
                    
                    // Detectores igual que en actualizarProgreso
                    const productos = [];
                    const publicos = [];
                    const ubicaciones = [];
                    
                    if (texto.includes('seguro')) productos.push('seguros');
                    if (texto.includes('p√°gina') || texto.includes('pagina') || texto.includes('web')) productos.push('p√°ginas web');
                    if (texto.includes('consultor√≠a')) productos.push('consultor√≠a');
                    if (texto.includes('marketing')) productos.push('marketing digital');
                    if (texto.includes('software')) productos.push('software');
                    
                    if (texto.includes('pyme')) publicos.push('pymes');
                    if (texto.includes('log√≠stica') || texto.includes('logistica')) publicos.push('pymes de log√≠stica');
                    if (texto.includes('doctor') || texto.includes('m√©dico')) publicos.push('doctores');
                    if (texto.includes('veterinaria')) publicos.push('veterinarias');
                    if (texto.includes('dentista')) publicos.push('dentistas');
                    if (texto.includes('trabajador')) publicos.push('trabajadores');
                    if (texto.includes('adulto')) publicos.push('adultos');
                    if (texto.includes('empresa')) publicos.push('empresas');
                    
                    if (texto.includes('santiago')) ubicaciones.push('Santiago');
                    if (texto.includes('providencia')) ubicaciones.push('Providencia');
                    if (texto.includes('√±u√±oa') || texto.includes('nunoa')) ubicaciones.push('√ëu√±oa');
                    if (texto.includes('las condes')) ubicaciones.push('Las Condes');
                    if (texto.includes('chile')) ubicaciones.push('Chile');
                    
                    const producto = productos[0] || 'productos';
                    const publico = publicos[0] || 'clientes';
                    const ubicacion = ubicaciones[0] || 'Chile';
                    
                    const resumen = `Vende ${producto} a ${publico} en ${ubicacion}`;
                    
                    if (confirm(`Voy a generar estrategias para:\n\n${resumen}\n\n¬øEst√° correcto?`)) {
                        App.wizard.ejecutarAnalisis(resumen);
                    }
                },
                
                guardarYSalir: async () => {
                    const playbook = App.wizard.state.currentPlaybook;
                    const nombre = document.getElementById('wizard-template-name').value || playbook.titulo_nicho;
                    try {
                        const res = await fetch('/api/guardar-plantilla', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nombre: nombre, rol: App.wizard.state.rol, nicho: playbook.titulo_nicho, playbook_data: playbook })
                        });
                        if (!res.ok) throw new Error("Error al guardar en BD");
                        alert(`‚úÖ Estrategia guardada.`);
                        App.navegacion.ir('buscador');
                        await App.prospector.cargarEstrategias(); 
                        App.wizard.reset();
                    } catch (e) { alert("‚ùå Error: Verifica tu backend."); }
                }
            },

            perfil: {
                datosUsuario: {},
                historialCompras: [],
                
                cargarInfoUsuario: (username) => {
                    const initial = username.charAt(0).toUpperCase();
                    document.getElementById('user-initial').innerText = initial;
                    document.getElementById('user-initial-menu').innerText = initial;
                    document.getElementById('user-name-display').innerText = username;
                    document.getElementById('user-fullname').innerText = username;
                    
                    // Cargar o inicializar datos del usuario
                    App.perfil.datosUsuario = JSON.parse(localStorage.getItem(`user_data_${username}`)) || {
                        email: username.includes('@') ? username : `${username}@aexon.cl`,
                        plan: username === 'alexisferrada' ? 'master' : 'piloto',
                        fechaRegistro: new Date().toISOString(),
                        notificaciones: {
                            email: true,
                            creditosBajos: true,
                            reportes: false
                        }
                    };
                    
                    const email = App.perfil.datosUsuario.email;
                    document.getElementById('user-email').innerText = email;
                    
                    // Determinar plan basado en el usuario
                    let planNombre = 'Plan Piloto';
                    let planBadgeClass = 'bg-gray-100 text-gray-600';
                    let planIcon = 'fa-crown';
                    
                    if (username === 'alexisferrada') {
                        planNombre = 'Plan Master Admin';
                        planBadgeClass = 'bg-purple-100 text-purple-600';
                        planIcon = 'fa-infinity';
                    }
                    
                    const planBadge = document.getElementById('user-plan-badge');
                    planBadge.className = `inline-flex items-center gap-1 mt-1 px-2 py-0.5 rounded-full text-[10px] font-bold ${planBadgeClass}`;
                    planBadge.innerHTML = `<i class="fas ${planIcon} text-yellow-500"></i> ${planNombre}`;
                    
                    // Actualizar cr√©ditos en el men√∫
                    const creditos = localStorage.getItem('saas_creditos') || '0';
                    document.getElementById('user-credits-menu').innerText = parseInt(creditos).toLocaleString('es-CL');
                    
                    // Cargar historial de compras
                    App.perfil.cargarHistorialCompras();
                },
                
                toggleMenu: () => {
                    const dropdown = document.getElementById('user-menu-dropdown');
                    const isHidden = dropdown.classList.contains('hidden');
                    
                    if (isHidden) {
                        const creditos = localStorage.getItem('saas_creditos') || '0';
                        document.getElementById('user-credits-menu').innerText = parseInt(creditos).toLocaleString('es-CL');
                    }
                    
                    dropdown.classList.toggle('hidden');
                },
                
                comprarCreditos: () => {
                    document.getElementById('user-menu-dropdown').classList.add('hidden');
                    document.getElementById('modal-creditos').classList.remove('hidden');
                },
                
                verMiPerfil: () => {
                    document.getElementById('user-menu-dropdown').classList.add('hidden');
                    App.perfil.cargarVistaPerfil();
                    App.navegacion.ir('perfil');
                },
                
                cargarVistaPerfil: () => {
                    const username = localStorage.getItem('saas_user');
                    const datos = App.perfil.datosUsuario;
                    const creditos = localStorage.getItem('saas_creditos') || '0';
                    
                    // Actualizar info del header
                    document.getElementById('perfil-avatar').innerText = username.charAt(0).toUpperCase();
                    document.getElementById('perfil-nombre').innerText = username;
                    document.getElementById('perfil-email').innerText = datos.email;
                    document.getElementById('perfil-creditos').innerText = parseInt(creditos).toLocaleString('es-CL');
                    
                    // Fecha de registro
                    const fechaReg = new Date(datos.fechaRegistro || Date.now());
                    document.getElementById('perfil-fecha').innerText = fechaReg.toLocaleDateString('es-CL', { 
                        month: 'long', year: 'numeric' 
                    });
                    
                    // Plan badge
                    const isAdmin = username === 'alexisferrada';
                    document.getElementById('perfil-plan-badge').innerHTML = isAdmin 
                        ? '<i class="fas fa-infinity mr-1"></i> Plan Master Admin'
                        : '<i class="fas fa-crown mr-1"></i> Plan Piloto';
                    document.getElementById('perfil-plan-badge').className = isAdmin
                        ? 'px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700'
                        : 'px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700';
                    
                    // Formulario de cuenta
                    document.getElementById('perfil-input-usuario').value = username;
                    document.getElementById('perfil-input-email').value = datos.email;
                    
                    // Notificaciones
                    document.getElementById('notif-email').checked = datos.notificaciones?.email ?? true;
                    document.getElementById('notif-creditos').checked = datos.notificaciones?.creditosBajos ?? true;
                    document.getElementById('notif-reportes').checked = datos.notificaciones?.reportes ?? false;
                    
                    // Renderizar historial
                    App.perfil.renderizarHistorial();
                },
                
                habilitarEdicion: (seccion) => {
                    const inputs = document.querySelectorAll('#form-cuenta input');
                    const btnGuardar = document.getElementById('btn-guardar-cuenta');
                    const btnEditar = document.getElementById('btn-editar-cuenta');
                    
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.classList.remove('bg-gray-50');
                        input.classList.add('bg-white');
                    });
                    
                    btnGuardar.classList.remove('hidden');
                    btnEditar.classList.add('hidden');
                },
                
                guardarCuenta: () => {
                    const username = localStorage.getItem('saas_user');
                    const nuevoEmail = document.getElementById('perfil-input-email').value.trim();
                    
                    if (!nuevoEmail || !nuevoEmail.includes('@')) {
                        alert('‚ö†Ô∏è Por favor ingresa un email v√°lido');
                        return;
                    }
                    
                    App.perfil.datosUsuario.email = nuevoEmail;
                    localStorage.setItem(`user_data_${username}`, JSON.stringify(App.perfil.datosUsuario));
                    
                    // Actualizar UI
                    document.getElementById('user-email').innerText = nuevoEmail;
                    document.getElementById('perfil-email').innerText = nuevoEmail;
                    
                    // Deshabilitar inputs
                    const inputs = document.querySelectorAll('#form-cuenta input');
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.classList.add('bg-gray-50');
                        input.classList.remove('bg-white');
                    });
                    document.getElementById('btn-guardar-cuenta').classList.add('hidden');
                    document.getElementById('btn-editar-cuenta').classList.remove('hidden');
                    
                    alert('‚úÖ Informaci√≥n actualizada correctamente');
                },
                
                togglePassword: (inputId) => {
                    const input = document.getElementById(inputId);
                    const type = input.type === 'password' ? 'text' : 'password';
                    input.type = type;
                },
                
                cambiarPassword: () => {
                    const actual = document.getElementById('perfil-pass-actual').value;
                    const nueva = document.getElementById('perfil-pass-nueva').value;
                    const confirmar = document.getElementById('perfil-pass-confirmar').value;
                    
                    // Validaciones
                    if (!actual || !nueva || !confirmar) {
                        alert('‚ö†Ô∏è Completa todos los campos');
                        return;
                    }
                    
                    if (nueva.length < 8) {
                        alert('‚ö†Ô∏è La contrase√±a debe tener al menos 8 caracteres');
                        return;
                    }
                    
                    if (nueva !== confirmar) {
                        alert('‚ö†Ô∏è Las contrase√±as nuevas no coinciden');
                        return;
                    }
                    
                    // Simulaci√≥n de cambio exitoso
                    // En producci√≥n esto ir√≠a al backend
                    alert('‚úÖ Contrase√±a actualizada correctamente. Por seguridad, deber√°s iniciar sesi√≥n nuevamente.');
                    
                    // Limpiar campos
                    document.getElementById('perfil-pass-actual').value = '';
                    document.getElementById('perfil-pass-nueva').value = '';
                    document.getElementById('perfil-pass-confirmar').value = '';
                    document.getElementById('password-strength').style.width = '0';
                    
                    // Cerrar sesi√≥n
                    setTimeout(() => App.auth.logout(), 1500);
                },
                
                guardarNotificaciones: () => {
                    const username = localStorage.getItem('saas_user');
                    
                    App.perfil.datosUsuario.notificaciones = {
                        email: document.getElementById('notif-email').checked,
                        creditosBajos: document.getElementById('notif-creditos').checked,
                        reportes: document.getElementById('notif-reportes').checked
                    };
                    
                    localStorage.setItem(`user_data_${username}`, JSON.stringify(App.perfil.datosUsuario));
                    alert('‚úÖ Preferencias de notificaciones guardadas');
                },
                
                cargarHistorialCompras: () => {
                    const username = localStorage.getItem('saas_user');
                    App.perfil.historialCompras = JSON.parse(localStorage.getItem(`historial_${username}`)) || [];
                },
                
                renderizarHistorial: () => {
                    const tbody = document.getElementById('historial-compras');
                    const vacio = document.getElementById('historial-vacio');
                    
                    if (App.perfil.historialCompras.length === 0) {
                        tbody.innerHTML = '';
                        vacio.classList.remove('hidden');
                        return;
                    }
                    
                    vacio.classList.add('hidden');
                    tbody.innerHTML = App.perfil.historialCompras.map(compra => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3 text-gray-600">${new Date(compra.fecha).toLocaleDateString('es-CL')}</td>
                            <td class="px-4 py-3 font-medium text-gray-800">${compra.plan}</td>
                            <td class="px-4 py-3 text-purple-600 font-bold">+${compra.creditos}</td>
                            <td class="px-4 py-3 text-gray-800">$${compra.monto.toLocaleString('es-CL')} CLP</td>
                            <td class="px-4 py-3"><span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold"><i class="fas fa-check mr-1"></i>Pagado</span></td>
                        </tr>
                    `).join('');
                },
                
                agregarCompra: (plan, creditos, monto) => {
                    const username = localStorage.getItem('saas_user');
                    const nuevaCompra = {
                        id: Date.now(),
                        fecha: new Date().toISOString(),
                        plan,
                        creditos,
                        monto,
                        estado: 'Pagado'
                    };
                    
                    App.perfil.historialCompras.unshift(nuevaCompra);
                    localStorage.setItem(`historial_${username}`, JSON.stringify(App.perfil.historialCompras));
                    
                    // Si est√° en la vista de perfil, actualizar
                    if (!document.getElementById('view-perfil').classList.contains('hidden')) {
                        App.perfil.renderizarHistorial();
                        App.perfil.cargarVistaPerfil();
                    }
                },
                
                exportarHistorial: () => {
                    if (App.perfil.historialCompras.length === 0) {
                        alert('No hay compras para exportar');
                        return;
                    }
                    
                    let csv = 'Fecha,Plan,Cr√©ditos,Monto,Estado\n';
                    App.perfil.historialCompras.forEach(c => {
                        csv += `${new Date(c.fecha).toLocaleDateString('es-CL')},${c.plan},${c.creditos},${c.monto},${c.estado}\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `historial_compras_${localStorage.getItem('saas_user')}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                cambiarAvatar: () => {
                    alert('üöß Funci√≥n pr√≥ximamente:\nPodr√°s subir tu foto de perfil o elegir un avatar');
                },
                
                confirmarEliminarCuenta: () => {
                    const confirmacion = prompt('‚ö†Ô∏è ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.\n\nEscribe "ELIMINAR" para confirmar:');
                    if (confirmacion === 'ELIMINAR') {
                        const username = localStorage.getItem('saas_user');
                        localStorage.removeItem(`user_data_${username}`);
                        localStorage.removeItem(`historial_${username}`);
                        localStorage.removeItem('saas_creditos');
                        localStorage.removeItem('saas_user');
                        alert('Cuenta eliminada. Redirigiendo...');
                        window.location.href = 'dashboard.html';
                    }
                },
                
                cerrarSesion: () => {
                    document.getElementById('user-menu-dropdown').classList.add('hidden');
                    App.auth.logout();
                }
            },
            
            config: {
                toggleApiVisibility: (inputId) => {
                    const input = document.getElementById(inputId);
                    input.type = input.type === 'password' ? 'text' : 'password';
                },
                
                guardarConfiguracion: () => {
                    const config = {
                        modeloDefault: document.getElementById('config-modelo-default').value,
                        resultadosDefault: document.getElementById('config-resultados-default').value
                    };
                    localStorage.setItem('app_config', JSON.stringify(config));
                    alert('‚úÖ Configuraci√≥n guardada');
                },
                
                cargarConfiguracion: () => {
                    const config = JSON.parse(localStorage.getItem('app_config')) || {};
                    if (config.modeloDefault) {
                        document.getElementById('config-modelo-default').value = config.modeloDefault;
                        document.getElementById('global-model-selector').value = config.modeloDefault;
                    }
                    if (config.resultadosDefault) {
                        document.getElementById('config-resultados-default').value = config.resultadosDefault;
                    }
                },
                
                limpiarLogs: () => {
                    document.getElementById('system-logs').innerHTML = '<p>[INFO] Logs limpiados</p>';
                },
                
                reiniciarApp: () => {
                    if (confirm('¬øReiniciar la aplicaci√≥n? Se perder√°n los datos no guardados.')) {
                        location.reload();
                    }
                }
            }
        };

        // Cerrar men√∫ al hacer click fuera
        document.addEventListener('click', (e) => {
            const menuContainer = document.getElementById('user-menu-container');
            const dropdown = document.getElementById('user-menu-dropdown');
            if (menuContainer && dropdown && !menuContainer.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', () => { 
            App.init();
            App.config.cargarConfiguracion();
            
            // Event listener para fortaleza de contrase√±a
            const passInput = document.getElementById('perfil-pass-nueva');
            if (passInput) {
                passInput.addEventListener('input', (e) => {
                    const val = e.target.value;
                    const strengthBar = document.getElementById('password-strength');
                    const hint = document.getElementById('password-hint');
                    
                    let strength = 0;
                    if (val.length >= 8) strength += 25;
                    if (val.match(/[0-9]/)) strength += 25;
                    if (val.match(/[a-z]/)) strength += 15;
                    if (val.match(/[A-Z]/)) strength += 20;
                    if (val.match(/[^a-zA-Z0-9]/)) strength += 15;
                    
                    strengthBar.style.width = strength + '%';
                    
                    if (strength < 40) {
                        strengthBar.className = 'h-full bg-red-500 transition-all duration-300';
                        hint.innerText = 'D√©bil - Agrega n√∫meros y s√≠mbolos';
                        hint.className = 'text-xs text-red-500 mt-1';
                    } else if (strength < 70) {
                        strengthBar.className = 'h-full bg-yellow-500 transition-all duration-300';
                        hint.innerText = 'Media - Buena, pero puede mejorar';
                        hint.className = 'text-xs text-yellow-600 mt-1';
                    } else {
                        strengthBar.className = 'h-full bg-green-500 transition-all duration-300';
                        hint.innerText = 'Fuerte - Excelente contrase√±a';
                        hint.className = 'text-xs text-green-600 mt-1';
                    }
                });
            }
            
            // Event listener para cambio de modelo por defecto
            const modeloSelect = document.getElementById('config-modelo-default');
            if (modeloSelect) {
                modeloSelect.addEventListener('change', (e) => {
                    document.getElementById('global-model-selector').value = e.target.value;
                });
            }
            
            // Event listener para mostrar badge de Kimi
            const globalModelSelector = document.getElementById('global-model-selector');
            const kimiBadge = document.getElementById('kimi-badge');
            if (globalModelSelector && kimiBadge) {
                const verificarKimi = () => {
                    if (globalModelSelector.value.includes('kimi')) {
                        kimiBadge.classList.remove('hidden');
                    } else {
                        kimiBadge.classList.add('hidden');
                    }
                };
                globalModelSelector.addEventListener('change', verificarKimi);
                verificarKimi(); // Verificar al cargar
            }
            
            // Forzar scroll al inicio al cargar la p√°gina
            window.scrollTo(0, 0);
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        });
        
        // Forzar scroll al inicio cuando la p√°gina termine de cargar completamente
        window.onload = function() {
            window.scrollTo(0, 0);
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        };
    </script>
</body>
</html>