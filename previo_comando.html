<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuSitioYa | Dashboard High Velocity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s infinite linear',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    },
                    colors: {
                        neon: '#00e599', // Color Neon DB
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #ecfdf5; color: #064e3b; } /* Fondo Emerald-50 y texto verde oscuro */
        
        .main-panel {
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.6);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-white {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.05); /* Sombra verdosa muy sutil */
            border: 1px solid #d1fae5; /* Borde Emerald-100 */
        }

        .circular-chart {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(#10b981 0% 0%, #e2e8f0 0% 100%);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .circular-chart::before {
            content: ""; position: absolute; width: 90px; height: 90px;
            border-radius: 50%; background: #f1f5f9;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilo Billete para Dashboard Financiero */
        #dashboard-panel {
            background-color: #f0fdf4;
            background-image: 
                radial-gradient(at 0% 0%, rgba(22, 163, 74, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(22, 163, 74, 0.1) 0px, transparent 50%),
                repeating-linear-gradient(45deg, rgba(22, 163, 74, 0.03) 0px, rgba(22, 163, 74, 0.03) 2px, transparent 2px, transparent 4px);
            border: 1px solid #86efac;
            position: relative;
        }
        #dashboard-panel::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2316a34a' fill-opacity='0.05'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }
        #dashboard-panel::after {
            content: "$";
            position: absolute;
            right: 20px;
            bottom: -35px;
            font-size: 180px;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #16a34a;
            opacity: 0.08;
            transform: rotate(-15deg);
            pointer-events: none;
            z-index: 0;
        }
        #dashboard-content, #dashboard-panel > div {
            position: relative;
            z-index: 1;
        }

        /* Animación Confeti */
        @keyframes fall {
            0% { transform: translateY(-10%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(300px) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 6px; height: 6px;
            top: -10px;
            animation: fall 3s linear forwards;
        }

        /* Modo Zen */
        body.zen-mode .zen-hidden { display: none !important; }
        body.zen-mode main { display: none !important; }
        body.zen-mode aside { width: 100%; flex: 1; justify-content: center; }
        body.zen-mode #sidebar-left { max-width: 400px; }
        body.zen-mode #sidebar-right { max-width: 300px; }
        @media (min-width: 1024px) { body.zen-mode aside { width: auto; } }

        /* Acordeón */
        .accordion-content { display: none; }
        .accordion-content.open { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* EKG Heartbeat Animation */
        @keyframes ekg-draw {
            to { stroke-dashoffset: 0; }
        }
        .ekg-line {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: ekg-draw 1.5s linear infinite;
        }

        /* Offline Background X */
        .monitor-offline-bg::after {
            content: '\f00d'; /* Font Awesome X mark */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            font-size: 5rem; /* 80px */
            color: #ef4444; /* red-500 */
            opacity: 0.08;
            pointer-events: none;
        }

        /* Filtros Conversión */
        .conversion-btn-filtro {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: #065f46; /* emerald-800 */
            transition: all 0.2s;
        }
        .conversion-btn-filtro.active { background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="min-h-screen lg:h-screen flex flex-col lg:flex-row p-2 lg:p-4 gap-4 overflow-y-auto lg:overflow-hidden font-sans text-teal-900 bg-emerald-50">

    <aside id="sidebar-left" class="w-full lg:w-[300px] flex-shrink-0 main-panel p-4 lg:p-5 z-20 transition-all duration-500 h-auto lg:h-full order-2 lg:order-1">
        
        <div class="relative mb-6 p-4 bg-white rounded-xl border border-emerald-100 shadow-sm overflow-hidden">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M1 1h2v2H1V1zm4 0h2v2H5V1zm4 0h2v2H9V1z\' fill=\'%2310b981\' fill-opacity=\'0.4\' fill-rule=\'evenodd\'/%3E%3C/svg%3E');"></div>
            <div class="relative z-10 flex justify-between items-center">
                <h1 class="text-xl font-bold text-teal-700 tracking-tight">TuSitioYa <span class="text-teal-400 text-xs font-normal">OS v2.0</span></h1>
                <button onclick="App.ui.toggleZenMode()" class="text-teal-400 hover:text-emerald-600 transition-colors" title="Activar Modo Zen">
                    <i class="fa-solid fa-spa"></i>
                </button>
            </div>
        </div>

        <div class="zen-hidden bg-teal-900 rounded-xl p-3 mb-4 shadow-lg shadow-teal-900/20 flex items-center justify-between border border-teal-800 relative overflow-hidden">
            <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
            <div class="flex items-center gap-2">
                <img src="https://avatars.githubusercontent.com/u/105096363?s=48&v=4" class="w-5 h-5 rounded-full" alt="Neon">
                <div>
                    <p class="text-[10px] font-bold text-white uppercase tracking-wider">Neon DB</p>
                    <p class="text-[9px] text-teal-200 font-mono">Serverless Postgres</p>
                </div>
            </div>
            <div class="flex items-center gap-1.5 bg-teal-800 px-2 py-1 rounded-lg border border-teal-700">
                <div id="neon-status-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span id="neon-status-text" class="text-[9px] font-bold text-emerald-400">ONLINE</span>
            </div>
        </div>

        <div class="zen-hidden bg-white rounded-2xl p-4 shadow-sm mb-4 border border-emerald-100 relative overflow-hidden group">
            <div class="absolute left-0 top-4 bottom-4 w-1 bg-teal-500 rounded-r-full"></div>
            <div class="absolute right-0 top-0 text-9xl text-teal-50 opacity-40 pointer-events-none -mr-8 -mt-8 group-hover:opacity-60 transition-opacity animate-[spin_20s_linear_infinite]"><i class="fa-solid fa-microchip"></i></div>
            <div class="pl-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-teal-600 uppercase tracking-widest">CEREBRO IA</span>
                    <div class="flex items-center gap-2">
                        <span id="ia-capacity-text" class="text-[9px] font-bold text-teal-500">0%</span>
                        <span id="ia-status-badge" class="bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1">
                            READY
                        </span>
                    </div>
                </div>
                <div class="relative mb-3">
                    <select id="model-selector" onchange="App.models.analizarEstado()" class="w-full bg-emerald-50 border border-emerald-200 text-xs font-bold text-teal-800 rounded-lg py-2 px-2 focus:ring-2 focus:ring-emerald-200 outline-none cursor-pointer appearance-none">
                        </select>
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 text-teal-500 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
                <div class="w-full bg-emerald-100 h-1 rounded-full overflow-hidden mb-1">
                    <div id="ia-capacity-bar" class="bg-teal-500 h-full w-[0%] transition-all duration-1000 ease-out"></div>
                </div>
                <p id="ia-analysis" class="text-[9px] text-teal-500 font-mono truncate">Sistema Latente...</p>
            </div>
        </div>

        <div onclick="App.ui.toggleModal('modal-blacklist', true)" class="zen-hidden bg-red-50 border border-red-100 rounded-2xl p-3 mb-4 flex items-center justify-between cursor-pointer hover:bg-red-100 transition-colors group relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: repeating-linear-gradient(45deg, #ef4444 0, #ef4444 1px, transparent 0, transparent 10px);"></div>
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-lg text-red-500 shadow-sm"><i class="fa-solid fa-ban"></i></div>
                <div>
                    <p class="text-[10px] font-bold text-red-400 uppercase">EXCEPCIONES</p>
                    <p class="text-[9px] text-red-300">Números inválidos</p>
                    <p id="blacklist-worst-model" class="text-[9px] text-red-600 font-bold mt-1 hidden"></p>
                </div>
            </div>
            <h3 class="text-2xl font-black text-red-500 group-hover:scale-110 transition-transform mr-2"><span id="blacklist-count">0</span></h3>
        </div>

        <div class="zen-hidden grid grid-cols-2 gap-2 mb-4">
            <button onclick="App.ui.toggleModal('modal-nuevo-cliente', true)" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-800 rounded-xl py-2 text-xs font-bold transition-colors flex items-center justify-center gap-1"><i class="fa-solid fa-plus"></i> Nuevo</button>
            <button onclick="App.prospectorIA.abrir()" class="bg-teal-600 hover:bg-teal-700 text-white rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-1 shadow-lg shadow-teal-500/30"><i class="fa-solid fa-wand-magic-sparkles"></i> IA</button>
        </div>

        <div class="flex-1 overflow-y-auto space-y-1 custom-scroll pr-1">
            <!-- BOTÓN DISCADOR AUTOMÁTICO -->
            <div class="mb-3 px-1">
                <button onclick="App.discador.iniciar()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white p-3 rounded-xl shadow-lg shadow-emerald-500/30 flex items-center justify-between group transition-all transform hover:scale-[1.02]">
                    <div class="flex items-center gap-2">
                        <div class="bg-white/20 p-1.5 rounded-lg"><i class="fa-solid fa-headset text-white text-xs"></i></div>
                        <div class="text-left">
                            <p class="text-[10px] font-bold text-emerald-100 uppercase tracking-wider">Modo Focus</p>
                            <p class="text-xs font-bold text-white">Iniciar Discador</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-play text-white group-hover:animate-pulse"></i>
                </button>
            </div>

            <!-- BUSCADOR GLOBAL POTENTE -->
            <div class="mb-4 px-1 sticky top-0 z-10 bg-emerald-50 pb-2 pt-1">
                <div class="relative group">
                    <input type="text" id="buscador-global" onkeyup="App.ui.buscar(this.value)" placeholder="Buscar dominio, nombre, fono..." class="w-full bg-white border border-emerald-200 rounded-xl py-2.5 pl-9 pr-3 text-xs font-bold text-teal-800 outline-none focus:ring-2 focus:ring-emerald-500/50 transition-all shadow-sm group-hover:shadow-md">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-teal-400 text-xs group-hover:text-emerald-500 transition-colors"></i>
                </div>
            </div>

            <div class="group">
                <div onclick="App.ui.toggleAccordion('nuevos')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100">
                    <div class="flex items-center gap-2"><span class="text-orange-500 text-xs">🔥</span><span class="text-xs font-bold text-teal-800">Nuevos Leads</span></div>
                    <span id="badge-nuevos" class="bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-nuevos" class="accordion-content pl-2 open ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('whatsapp_enviado')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-yellow-500 text-xs">⏳</span><span class="text-xs font-bold text-teal-800">Esperando (Enviado)</span></div>
                    <span id="badge-whatsapp_enviado" class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-whatsapp_enviado" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('seguimiento')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-blue-500 text-xs">💬</span><span class="text-xs font-bold text-teal-800">En Conversación</span></div>
                    <span id="badge-seguimiento" class="bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-seguimiento" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('sin_respuesta')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-slate-400 text-xs">👻</span><span class="text-xs font-bold text-teal-800">Sin Respuesta</span></div>
                    <span id="badge-sin_respuesta" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-sin_respuesta" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('cerrados')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-emerald-500 text-xs">🚀</span><span class="text-xs font-bold text-teal-800">Clientes Activos</span></div>
                    <span id="badge-cerrados" class="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-cerrados" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
             <div class="group">
                <div class="flex items-center justify-between p-2 rounded-lg border border-transparent opacity-70">
                    <div class="flex items-center gap-2"><span class="text-red-300 text-xs">🗑️</span><span class="text-xs font-bold text-teal-800">Descartados</span></div>
                    <span id="badge-descartados" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
            </div>
        </div>
    </aside>

    <aside id="sidebar-right" class="w-full lg:w-[260px] flex-shrink-0 main-panel flex flex-col items-center p-4 lg:p-6 text-center transition-all duration-500 h-auto lg:h-full order-3 relative">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none z-50"></div>
        <div class="zen-hidden w-full text-left mb-4">
            <h2 class="text-xl font-bold text-teal-700 tracking-tight">Información Operativa</h2>
        </div>
        <div class="zen-hidden w-full mb-6 bg-teal-900 rounded-xl p-4 border border-teal-800 shadow-lg relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-teal-500"></div>
            <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-emerald-500/10 rounded-full blur-xl group-hover:bg-emerald-500/20 transition-all"></div>
            <div class="absolute bottom-0 right-0 text-6xl text-white opacity-5 pointer-events-none -mb-2 -mr-2"><i class="fa-regular fa-clock"></i></div>
            <p class="text-[9px] text-teal-200 font-bold uppercase tracking-widest mb-1">INFO DEL RELOJ</p>
            <div id="reloj-sistema" class="text-2xl font-mono font-black text-white tracking-tight leading-none">00:00:00</div>
            <div id="fecha-sistema" class="text-[10px] text-teal-400 font-bold uppercase mt-2 border-t border-teal-800 pt-2">Cargando...</div>
        </div>

        <!-- LOGROS / TROFEOS -->
        <div class="w-full bg-white rounded-xl p-4 border border-emerald-100 shadow-sm mb-6 relative overflow-hidden text-left group">
            <div class="absolute top-0 left-0 w-1 h-full bg-yellow-400"></div>
            <div class="absolute -right-6 -top-6 text-8xl text-yellow-50 opacity-50 pointer-events-none"><i class="fa-solid fa-trophy"></i></div>
            <h3 class="text-xs font-bold text-teal-800 mb-4 uppercase tracking-wider pl-2">🏆 Sala de Trofeos</h3>
            <div id="logros-container" class="flex justify-between items-center px-2">
                <!-- JS Generated -->
            </div>
        </div>

        <div class="zen-hidden w-full text-left mt-6">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h2 class="text-lg font-bold text-teal-800">Conversión Global</h2>
                    <p class="text-[10px] text-teal-500 uppercase tracking-widest">Efectividad de Cierre</p>
                </div>
                <div id="conversion-filtros" class="flex bg-emerald-100 p-1 rounded-lg border border-emerald-200">
                    <button onclick="App.conversion.cambiarPeriodo('hoy')" class="conversion-btn-filtro active">Hoy</button>
                    <button onclick="App.conversion.cambiarPeriodo('ayer')" class="conversion-btn-filtro">Ayer</button>
                    <button onclick="App.conversion.cambiarPeriodo('semana')" class="conversion-btn-filtro">Semana</button>
                    <button onclick="App.conversion.cambiarPeriodo('mes')" class="conversion-btn-filtro">Mes</button>
                </div>
            </div>
            <div class="space-y-2">
                <div class="card-white p-3">
                    <div class="flex justify-between items-center"><span class="text-xs font-bold text-teal-600">Efectividad vs. Total Leads</span><span id="conv-vs-total" class="text-lg font-black text-emerald-600">0%</span></div>
                    <p id="conv-vs-total-detalle" class="text-[9px] text-slate-400">0 cerrados de 0 nuevos</p>
                    <div id="chart-conv-total" class="h-8 w-full mt-2"></div>
                </div>
                <div class="card-white p-3">
                    <div class="flex justify-between items-center"><span class="text-xs font-bold text-teal-600">Efectividad vs. En Conversación</span><span id="conv-vs-conversando" class="text-lg font-black text-blue-600">0%</span></div>
                    <p id="conv-vs-conversando-detalle" class="text-[9px] text-slate-400">0 cerrados de 0 en seguimiento</p>
                    <div id="chart-conv-conversando" class="h-8 w-full mt-2"></div>
                </div>
                <div class="card-white p-3">
                    <div class="flex justify-between items-center"><span class="text-xs font-bold text-teal-600">Meta Mensual de Cierres</span><span id="conv-vs-meta" class="text-lg font-black text-purple-600">0%</span></div>
                    <p id="conv-vs-meta-detalle" class="text-[9px] text-slate-400">0 cerrados de 3 este mes</p>
                    <div id="chart-conv-meta" class="h-8 w-full mt-2"></div>
                </div>
            </div>
        </div>

        <div class="zen-hidden w-full space-y-3 mt-4">
            <div class="card-white p-2 flex justify-between items-center"><span class="text-xs font-bold text-teal-600">Leads Totales</span><span id="metric-total" class="bg-emerald-100 text-emerald-700 text-xs font-black px-2 py-1 rounded-md">0</span></div>
            <div class="card-white p-2 flex justify-between items-center"><span class="text-xs font-bold text-blue-600">En Conversación</span><span id="metric-validos" class="bg-blue-100 text-blue-700 text-xs font-black px-2 py-1 rounded-md">0</span></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col gap-4 w-full h-auto lg:h-full overflow-visible lg:overflow-hidden order-1 lg:order-2">
        <div class="main-panel p-4 lg:p-6 transition-all duration-300" id="dashboard-panel">
            <div class="flex justify-between items-center cursor-pointer" onclick="App.ui.toggleDashboard()">
                <h2 class="text-xl font-bold text-blue-700 tracking-tight">Dashboard Financiero</h2>
                <i id="dashboard-chevron" class="fa-solid fa-chevron-up text-slate-400 transition-transform"></i>
            </div>
            <div id="dashboard-content" class="flex flex-col lg:flex-row gap-4 lg:gap-6 mt-4 overflow-hidden transition-all duration-300">
                <div class="card-white p-4 w-full lg:w-1/4 flex flex-col justify-between border-l-4 border-l-emerald-500 relative overflow-hidden hover:shadow-lg hover:shadow-emerald-500/30 transition-all duration-300">
                    <div class="absolute right-0 bottom-0 text-7xl text-emerald-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-chart-line"></i></div>
                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">VENTAS DEL MES</p>
                    <p id="finanza-ventas-mes" class="text-2xl font-bold text-slate-800 relative z-10">$0</p>
                    <p class="text-[9px] text-emerald-500 font-bold flex items-center gap-1"><i class="fa-solid fa-arrow-trend-up"></i> <span id="count-ventas-mes">0</span> Cierres</p>
                </div>
                <div onclick="App.ui.mostrarEntregasHoy()" class="card-white p-4 w-full lg:w-1/4 flex flex-col justify-between border-l-4 border-l-blue-500 relative overflow-hidden hover:shadow-lg hover:shadow-blue-500/30 transition-all duration-300 cursor-pointer">
                    <div class="absolute right-0 bottom-0 text-7xl text-blue-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-calendar-check"></i></div>
                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">ENTREGAS HOY</p>
                    <div class="flex items-baseline gap-1 relative z-10">
                        <p id="finanza-entregas-hoy" class="text-2xl font-bold text-slate-800">0</p>
                        <span class="text-xs text-slate-500 font-bold">Proyectos</span>
                    </div>
                    <p class="text-[9px] text-blue-400 font-bold">Por cobrar: <span id="finanza-proyeccion">$0</span></p>
                </div>
                <div class="card-white p-4 w-full lg:w-1/4 flex flex-col justify-between border-l-4 border-l-orange-500 relative overflow-hidden hover:shadow-lg hover:shadow-orange-500/30 transition-all duration-300">
                    <div class="absolute right-0 bottom-0 text-7xl text-orange-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-sack-dollar"></i></div>
                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">CAJA REAL</p>
                    <p id="finanza-caja-real" class="text-2xl font-bold text-slate-800 relative z-10">$0</p>
                    <p class="text-[9px] text-orange-400 font-bold">Recaudado este mes</p>
                </div>
                <div class="card-white p-4 w-full lg:w-1/4 flex flex-col justify-between border-l-4 border-l-purple-500 relative overflow-hidden hover:shadow-lg hover:shadow-purple-500/30 transition-all duration-300">
                    <div class="absolute right-0 bottom-0 text-7xl text-purple-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-receipt"></i></div>
                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">TICKET PROMEDIO</p>
                    <p id="finanza-ticket" class="text-2xl font-bold text-slate-800 relative z-10">$0</p>
                    <p class="text-[9px] text-purple-400 font-bold">Valor medio venta</p>
                </div>
            </div>
        </div>

        <div class="main-panel flex-1 p-6 relative flex flex-col overflow-hidden">
            <div class="absolute inset-0 opacity-30 pointer-events-none" style="background-image: linear-gradient(to right, rgba(59, 130, 246, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(59, 130, 246, 0.05) 1px, transparent 1px); background-size: 40px 40px;"></div>
            <div class="flex justify-between items-start mb-4 relative z-10">
                <div><h2 class="text-xl font-bold text-slate-800">Monitor de Proyectos</h2><p class="text-xs text-slate-500">Estado de servidores en tiempo real</p></div>
                <div class="flex items-center gap-2">
                    <button onclick="App.calendario.abrir()" class="bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50"><i class="fa-regular fa-calendar-days text-purple-500"></i> Calendario</button>
                    <button id="monitor-mute-btn" onclick="App.monitor.toggleMute()" class="bg-white text-slate-600 w-9 h-8 rounded-lg text-xs font-bold shadow-sm border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition-colors"></button>
                    <select id="monitor-intervalo" onchange="App.monitor.cambiarIntervalo(this.value)" class="bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-slate-200 focus:ring-2 focus:ring-blue-200 outline-none appearance-none cursor-pointer">
                        <option value="30000">Refresco: 30s</option>
                        <option value="60000" selected>Refresco: 1m</option>
                        <option value="120000">Refresco: 2m</option>
                        <option value="300000">Refresco: 5m</option>
                    </select>
                    <button onclick="App.monitor.checkAll()" class="bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50"><i class="fa-solid fa-arrows-rotate text-blue-500"></i> Refrescar Red</button>
                </div>
            </div>
            <div id="monitor-sites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 relative z-10 flex-1 content-start">
                <!-- Sites injected here -->
            </div>
            <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none"><i class="fa-solid fa-network-wired text-9xl"></i></div>
        </div>
    </main>

    <div id="modal-ficha-cliente" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-0 lg:p-4">
        <div class="w-full max-w-7xl bg-white rounded-none lg:rounded-3xl shadow-2xl overflow-hidden flex flex-col h-full lg:h-[95vh] border border-emerald-100">
            
            <!-- BARRA DISCADOR (SOLO VISIBLE EN MODO DISCADOR) -->
            <div id="ficha-discador-bar" class="hidden bg-emerald-600 p-2 px-6 flex justify-between items-center shadow-md z-50">
                <span class="text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2">
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div> Modo Discador Automático
                </span>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-mono text-emerald-100" id="discador-counter">1 / 10</span>
                    <button onclick="App.discador.siguiente()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-2">Saltar <i class="fa-solid fa-forward"></i></button>
                    <button onclick="App.discador.detener()" class="text-white/60 hover:text-white px-2"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
            </div>

            <div class="bg-teal-900 p-5 text-white flex justify-between items-start shrink-0">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-1">
                        <h2 id="header-negocio" class="text-2xl font-bold">...</h2>
                        <span id="header-dominio" class="bg-teal-800 text-teal-200 px-2 py-0.5 rounded text-xs font-mono">...</span>
                        <span id="header-id" class="bg-black/20 text-teal-100 px-2 py-0.5 rounded text-xs font-mono border border-teal-700/50">ID: ...</span>
                    </div>
                    <div class="flex gap-4 text-sm text-slate-400">
                        <p id="header-nombre"><i class="fa-solid fa-user mr-1"></i> ...</p>
                        <p id="header-telefono" class="font-mono"><i class="fa-brands fa-whatsapp mr-1"></i> ...</p>
                    </div>
                </div>
                
                <div id="ficha-financiera" class="hidden mr-6 text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ESTADO FINANCIERO</p>
                    <p class="text-xl font-bold text-emerald-400"><span id="ficha-pagado">$0</span> <span class="text-xs text-slate-500 font-normal">pagado</span></p>
                    <p class="text-xs text-slate-400">de <span id="ficha-total">$0</span> total</p>
                </div>

                <div class="flex items-center gap-3">
                    <span id="ficha-estado-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-teal-800 uppercase">...</span>
                    <button onclick="App.cliente.cerrarFicha()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row bg-slate-50">
                
                <!-- COLUMNA 1: DATOS, TÁCTICA Y FINANZAS (30%) -->
                <div class="w-full lg:w-[30%] p-5 border-r border-emerald-100 overflow-y-auto bg-white flex flex-col gap-5 custom-scroll">
                    
                    <!-- NUEVA SECCIÓN: ESTADO TÁCTICO -->
                    <div id="ficha-estado-tactico" class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-chess-knight"></i> Estado Táctico</h3>
                        
                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Temperatura del Lead</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="App.cliente.setTemperatura('frio')" id="btn-temp-frio" class="py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-blue-50 hover:text-blue-500 transition-all">❄️ Frío</button>
                                <button onclick="App.cliente.setTemperatura('tibio')" id="btn-temp-tibio" class="py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-orange-50 hover:text-orange-500 transition-all">🌤️ Tibio</button>
                                <button onclick="App.cliente.setTemperatura('caliente')" id="btn-temp-caliente" class="py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-red-50 hover:text-red-500 transition-all">🔥 Hot</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Notas Rápidas</label>
                            <textarea id="ficha-notas" onchange="App.cliente.actualizarCampo('notas', this.value)" rows="2" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:ring-2 focus:ring-blue-100 resize-none" placeholder="Ej: Hablar con secretaria, llamar martes..."></textarea>
                        </div>
                    </div>
                    
                    <!-- NUEVO: CONTROL DE PROYECTO (HOJA DE RUTA TÉCNICA) -->
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <h3 class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-bars-progress"></i> Control de Proyecto</h3>
                        
                        <div class="mb-3">
                            <div class="flex justify-between mb-1">
                                <label class="text-[9px] font-bold text-slate-400 uppercase">Avance General</label>
                                <span id="lbl-progreso" class="text-[10px] font-bold text-blue-600">0%</span>
                            </div>
                            <input type="range" id="ficha-progreso" min="0" max="100" step="5" oninput="document.getElementById('lbl-progreso').innerText = this.value + '%'" onchange="App.cliente.actualizarCampo('progreso', this.value)" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>

                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Fase Actual</label>
                            <select id="ficha-fase" onchange="App.cliente.actualizarCampo('fase_actual', this.value)" class="w-full bg-white border border-blue-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none font-bold">
                                <option value="Inicio del Proyecto">🚀 Inicio del Proyecto</option>
                                <option value="Infraestructura y Configuración">⚙️ Infraestructura y Configuración</option>
                                <option value="Arquitectura de Base de Datos">🗄️ Arquitectura de Base de Datos</option>
                                <option value="Diseño y Maquetación">🎨 Diseño y Maquetación</option>
                                <option value="Desarrollo Backend">🧱 Desarrollo Backend</option>
                                <option value="Integración de Contenido">📝 Integración de Contenido</option>
                                <option value="Pruebas y QA">🧪 Pruebas y QA</option>
                                <option value="Lanzamiento Final">🏁 Lanzamiento Final</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1"><i class="fa-brands fa-google-drive"></i> Carpeta Google Drive (Nube)</label>
                            <input type="text" id="ficha-drive" onchange="App.cliente.actualizarCampo('drive_link', this.value)" placeholder="https://drive.google.com/..." class="w-full bg-white border border-blue-200 rounded-lg px-2 py-1.5 text-xs text-blue-600 outline-none">
                        </div>

                        <!-- NUEVO: GENERADOR DE RUTA IA -->
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Personalización de Ruta</label>
                            <textarea id="txt-ruta-custom" rows="2" class="w-full bg-white border border-blue-200 rounded-lg px-2 py-1.5 text-xs text-slate-600 outline-none mb-2 resize-none" placeholder="Instrucciones extra o Prompt externo..."></textarea>
                            <button onclick="App.cliente.generarHojaRutaIA()" id="btn-ruta-ia" class="w-full py-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg text-[10px] font-bold shadow-md transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Generar Ruta Única con IA
                            </button>
                            <p class="text-[9px] text-slate-400 mt-1 text-center">Crea pasos específicos según el rubro o tus instrucciones.</p>
                        </div>
                    </div>

                    <!-- Bloque Financiero -->
                    <div class="bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100">
                        <h3 class="text-xs font-bold text-emerald-600 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-sack-dollar"></i> Acuerdo Comercial</h3>
                        
                        <div class="grid grid-cols-12 gap-2 mb-3">
                            <div class="col-span-5">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Valor Proyecto</label>
                                <input type="number" id="ficha-monto-total" onchange="App.cliente.actualizarCampo('monto_total', this.value)" class="w-full bg-white border border-emerald-200 rounded-lg px-2 py-2 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500/20">
                            </div>
                            <div class="col-span-4">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Mensualidad</label>
                                <input type="number" id="ficha-monto-mantencion" onchange="App.cliente.actualizarCampo('monto_mantencion', this.value); App.cliente.actualizarProyeccionMensual();" placeholder="$0" class="w-full bg-white border border-blue-200 rounded-lg px-2 py-2 text-xs font-bold text-blue-600 outline-none focus:ring-2 focus:ring-blue-500/20">
                            </div>
                            <div class="col-span-3">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Día Pago</label>
                                <input type="number" min="1" max="31" id="ficha-dia-pago" onchange="App.cliente.actualizarCampo('dia_pago', this.value); App.cliente.actualizarProyeccionMensual();" placeholder="1-30" class="w-full bg-white border border-blue-200 rounded-lg px-1 py-2 text-xs font-bold text-blue-600 text-center outline-none focus:ring-2 focus:ring-blue-500/20">
                            </div>
                        </div>

                        <div class="flex gap-2 mb-1 bg-white p-2 rounded-xl border border-emerald-100">
                            <div class="w-1/2">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Pagado (Adelanto)</label>
                                <div class="relative">
                                    <input type="number" id="ficha-monto-pagado" onchange="App.cliente.actualizarCampo('monto_pagado', this.value)" class="w-full bg-emerald-50 border border-emerald-200 rounded-lg pl-2 pr-6 py-2 text-xs font-bold text-emerald-600 outline-none focus:ring-2 focus:ring-emerald-500/20">
                                    <button onclick="document.getElementById('ficha-monto-pagado').value = ''; App.cliente.actualizarCampo('monto_pagado', 0); document.getElementById('ficha-monto-pagado').focus();" class="absolute right-1 top-1.5 text-slate-300 hover:text-red-400 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors" title="Borrar pago (Resetear)"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                            <div class="w-1/2">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Proyectado (Restante)</label>
                                <input type="text" id="ficha-saldo-pendiente" readonly class="w-full bg-slate-100 border border-slate-200 rounded-lg px-2 py-2 text-xs font-bold text-red-500 outline-none mb-1">
                                <input type="date" id="ficha-fecha-pago" onchange="App.cliente.actualizarCampo('fecha_proximo_pago', this.value)" class="w-full bg-white border border-emerald-200 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-600 outline-none focus:ring-1 focus:ring-emerald-500" title="Fecha Límite de Proyecto">
                            </div>
                        </div>

                        <!-- Proyección Mensualidad (Visual) -->
                        <div id="info-proxima-mensualidad" class="mt-2 bg-blue-50 border border-blue-100 rounded-lg p-2 flex items-center justify-center gap-2 hidden">
                            <i class="fa-solid fa-calendar-check text-blue-500"></i> <span class="text-[10px] text-blue-600 font-bold">Cobro este mes: <span id="txt-proximo-cobro" class="text-blue-800">...</span></span>
                        </div>
                    </div>

                    <!-- Bloque Contacto (AMPLIADO) -->
                    <div class="space-y-3 pb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-address-card"></i> Datos del Cliente</h3>
                            <button onclick="App.cliente.actualizarDatosContacto()" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 font-bold transition-colors">Actualizar Datos</button>
                        </div>
                        
                        <!-- Campos Básicos -->
                        <div class="grid grid-cols-1 gap-3">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Nombre Negocio</label>
                                <input type="text" id="ficha-negocio" onchange="App.cliente.actualizarCampo('negocio', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold text-slate-700 outline-none focus:border-blue-400 focus:bg-blue-50/30 transition-colors">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Nombre Contacto</label>
                                <input type="text" id="ficha-nombre" onchange="App.cliente.actualizarCampo('nombre', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:border-blue-400 focus:bg-blue-50/30 transition-colors">
                            </div>
                        </div>

                        <!-- Campos Nuevos -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">RUT / ID Fiscal</label>
                                <input type="text" id="ficha-rut" onchange="App.cliente.actualizarCampo('rut', this.value)" placeholder="12.345.678-9" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 outline-none focus:border-blue-400 focus:bg-white transition-colors">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Rubro / Industria</label>
                                <input type="text" id="ficha-rubro" onchange="App.cliente.actualizarCampo('rubro', this.value)" placeholder="Ej: Legal, Salud..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:border-blue-400 focus:bg-white transition-colors">
                            </div>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Correo Electrónico</label>
                            <input type="email" id="ficha-email" onchange="App.cliente.actualizarCampo('email', this.value)" placeholder="contacto@empresa.cl" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:border-blue-400 focus:bg-white transition-colors">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">WhatsApp</label>
                                <input type="text" id="ficha-whatsapp" onchange="App.cliente.actualizarCampo('whatsapp', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 outline-none focus:border-blue-400 focus:bg-white transition-colors">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Dominio .CL</label>
                                <input type="text" id="ficha-dominio" onchange="App.cliente.actualizarCampo('dominio', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-indigo-600 font-bold outline-none focus:border-blue-400 focus:bg-white transition-colors">
                            </div>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">URL Actual / Maps</label>
                            <div class="relative">
                                <input type="text" id="ficha-url" onchange="App.cliente.actualizarCampo('url', this.value)" placeholder="https://..." class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-3 pr-8 py-2 text-xs text-blue-500 underline cursor-pointer outline-none focus:border-blue-400 focus:bg-white transition-colors">
                                <a href="#" onclick="window.open(document.getElementById('ficha-url').value, '_blank')" class="absolute right-2 top-1.5 text-slate-400 hover:text-blue-500"><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                            </div>
                        </div>

                        <!-- SECCIÓN ENCUESTA WEB (NUEVO) -->
                        <div class="mt-4 bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xs font-bold text-indigo-800 uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-laptop-code"></i> Briefing Web</h3>
                                <span id="badge-encuesta-info" class="hidden text-[9px] bg-white text-indigo-600 px-2 py-1 rounded-lg border border-indigo-100 font-bold shadow-sm">
                                    <i class="fa-solid fa-clock-rotate-left mr-1"></i> <span id="txt-encuesta-fecha">...</span>
                                </span>
                            </div>
                            
                            <!-- GENERADOR DE LINK (NUEVO) -->
                            <div class="mb-4 bg-white p-3 rounded-xl border border-indigo-100 shadow-sm">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Link para el Cliente</label>
                                <div class="flex gap-2">
                                    <input type="text" id="link-encuesta-cliente" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 text-[10px] text-slate-600 outline-none font-mono">
                                    <button onclick="App.cliente.copiarLinkEncuesta()" class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors" title="Copiar Link"><i class="fa-regular fa-copy"></i></button>
                                    <button onclick="App.cliente.enviarEncuestaWhatsApp()" class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-600 transition-colors" title="Enviar por WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>
                                </div>
                                <p class="text-[9px] text-indigo-400 mt-1 flex items-center gap-1"><i class="fa-solid fa-share-nodes"></i> Envía este link para que llenen el formulario ellos mismos.</p>
                            </div>

                            <div class="space-y-3">
                                <!-- Campo WhatsApp Soporte (Solo visible si el cliente lo llenó) -->
                                <div id="field-whatsapp-soporte" class="hidden bg-orange-50 p-2 rounded-lg border border-orange-100 mb-2">
                                    <label class="text-[9px] font-bold text-orange-500 uppercase block mb-1">📞 Contacto Soporte (Cliente)</label>
                                    <div class="flex justify-between items-center">
                                        <span id="txt-whatsapp-soporte" class="text-xs font-mono font-bold text-slate-700">...</span>
                                        <button onclick="App.cliente.copiarSoporte()" class="text-[9px] text-orange-400 hover:text-orange-600 font-bold">Copiar</button>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">1. Objetivo Principal</label>
                                    <select id="p1_objetivo" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none">
                                        <option value="Vender productos (E-commerce)">Vender productos (E-commerce)</option>
                                        <option value="Generar Leads/Contactos">Generar Leads/Contactos</option>
                                        <option value="Presencia de Marca">Presencia de Marca</option>
                                        <option value="Blog/Noticias">Blog/Noticias</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">2. Público Objetivo</label>
                                    <input type="text" id="p2_publico" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Ej: Mujeres 25-40 años...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">3. Referentes (URLs)</label>
                                    <input type="text" id="p3_referentes" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Ej: apple.com, nike.com">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">4. Estilo Visual</label>
                                    <input type="text" id="p4_estilo" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Ej: Minimalista, oscuro...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">5. Secciones</label>
                                    <input type="text" id="p5_secciones" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Inicio, Nosotros, Contacto...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">6. Funcionalidades</label>
                                    <input type="text" id="p6_funcionalidades" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Chatbot, Reservas...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">7. Tono Comunicación</label>
                                    <select id="p7_tono" class="w-full bg-white border border-indigo-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none">
                                        <option value="Profesional y Serio">Profesional y Serio</option>
                                        <option value="Cercano y Amigable">Cercano y Amigable</option>
                                        <option value="Juvenil y Disruptivo">Juvenil y Disruptivo</option>
                                        <option value="Lujoso y Exclusivo">Lujoso y Exclusivo</option>
                                    </select>
                                </div>

                                <div class="flex gap-2 pt-2">
                                    <button onclick="App.cliente.guardarEncuestaWeb()" class="flex-1 bg-indigo-100 text-indigo-700 py-2 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors"><i class="fa-solid fa-save"></i> Guardar</button>
                                    <button onclick="App.cliente.generarPromptWeb()" id="btn-prompt-web" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition-colors shadow-md shadow-indigo-500/30"><i class="fa-solid fa-wand-magic-sparkles"></i> Crear Prompt</button>
                                </div>

                                <!-- Resultado Prompt -->
                                <div id="container-prompt-web" class="hidden mt-2">
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Prompt Generado</label>
                                    <textarea id="txt-prompt-web" rows="4" class="w-full bg-slate-800 text-green-400 font-mono text-[10px] p-2 rounded-lg mb-1" readonly></textarea>
                                    <button onclick="navigator.clipboard.writeText(document.getElementById('txt-prompt-web').value); App.ui.notificar('Copiado al portapapeles', 'Copiado', 'exito')" class="w-full text-center text-[10px] text-indigo-600 font-bold hover:underline">Copiar Prompt</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- COLUMNA 2: IA PROTAGONISTA (45%) -->
                <div class="w-full lg:w-[45%] p-5 bg-white overflow-y-auto flex flex-col border-r border-emerald-100 relative">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-teal-500"></div>
                    
                    <div class="mb-4 flex-1 flex flex-col">

                        <!-- HEADER MEJORADO -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2.5">
                                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-2 rounded-xl shadow-md shadow-emerald-500/30">
                                    <i class="fa-solid fa-brain text-base"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-bold text-emerald-800 uppercase tracking-widest block leading-tight">Análisis Táctico IA</span>
                                    <span class="text-[9px] text-emerald-500 font-mono">Selecciona una acción o analiza manualmente</span>
                                </div>
                            </div>
                            <button onclick="App.ui.configurarPrompt()" class="text-[10px] text-slate-400 hover:text-blue-600 transition-colors flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-lg border border-slate-200 hover:border-blue-200">
                                <i class="fa-solid fa-gear"></i> Config IA
                            </button>
                        </div>

                        <!-- BOTONES IA TÁCTICA (PROTAGONISTAS) -->
                        <div class="grid grid-cols-2 gap-2 mb-4">

                            <!-- Cerrar Venta -->
                            <button onclick="App.cliente.analizarConContexto('cerrar_venta', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-emerald-300 bg-gradient-to-br from-emerald-50 to-teal-50 hover:from-emerald-500 hover:to-teal-600 hover:border-emerald-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-emerald-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-emerald-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-handshake text-emerald-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-emerald-800 group-hover:text-white text-center leading-tight transition-colors">Quiero cerrar la venta</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Manejar Objeciones -->
                            <button onclick="App.cliente.analizarConContexto('manejar_objeciones', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-blue-300 bg-gradient-to-br from-blue-50 to-indigo-50 hover:from-blue-500 hover:to-indigo-600 hover:border-blue-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-blue-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-blue-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-shield-halved text-blue-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-blue-800 group-hover:text-white text-center leading-tight transition-colors">Manejar objeciones</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Cliente Probable -->
                            <button onclick="App.cliente.analizarConContexto('cliente_probable', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-purple-300 bg-gradient-to-br from-purple-50 to-violet-50 hover:from-purple-500 hover:to-violet-600 hover:border-purple-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-purple-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-purple-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-crosshairs text-purple-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-purple-800 group-hover:text-white text-center leading-tight transition-colors">Es cliente probable</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-purple-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Primer Contacto -->
                            <button onclick="App.cliente.analizarConContexto('primer_contacto', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-teal-300 bg-gradient-to-br from-teal-50 to-cyan-50 hover:from-teal-500 hover:to-cyan-600 hover:border-teal-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-teal-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-teal-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-phone-volume text-teal-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-teal-800 group-hover:text-white text-center leading-tight transition-colors">Primer contacto</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-teal-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Negociar Precio -->
                            <button onclick="App.cliente.analizarConContexto('negociar_precio', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-orange-300 bg-gradient-to-br from-orange-50 to-amber-50 hover:from-orange-500 hover:to-amber-600 hover:border-orange-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-orange-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-orange-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-tags text-orange-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-orange-800 group-hover:text-white text-center leading-tight transition-colors">Negociar precio</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-orange-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Reactivar Lead Frío -->
                            <button onclick="App.cliente.analizarConContexto('reactivar_lead', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-slate-300 bg-gradient-to-br from-slate-50 to-gray-100 hover:from-slate-600 hover:to-gray-700 hover:border-slate-600 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-slate-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-slate-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-rotate text-slate-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-slate-700 group-hover:text-white text-center leading-tight transition-colors">Reactivar lead frío</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-slate-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                        </div>

                        <!-- SEPARADOR -->
                        <div class="flex items-center gap-2 mb-3">
                            <div class="flex-1 h-px bg-slate-200"></div>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest whitespace-nowrap">o analiza la conversación manualmente</span>
                            <div class="flex-1 h-px bg-slate-200"></div>
                        </div>
                        
                        <textarea id="historial-chat-input" onpaste="App.cliente.guardarHistorialPegado(event)" class="w-full h-28 p-3 rounded-xl border border-emerald-100 text-xs focus:ring-2 focus:ring-emerald-500 outline-none resize-none bg-emerald-50/30 placeholder-emerald-300 mb-3 font-mono" placeholder="Pega aquí la conversación de WhatsApp..."></textarea>
                        
                        <button id="btn-analizar-cierre" onclick="App.cliente.analizarCierre()" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Analizar Estrategia de Cierre
                        </button>
                        
                        <div id="analysis-result" class="hidden mt-4 bg-white p-4 rounded-xl border border-emerald-100 shadow-sm text-sm text-slate-600 flex-1 overflow-y-auto"></div>
                    </div>

                </div>

                <!-- COLUMNA 3: SCRIPT Y ACCIONES (25%) -->
                <div class="w-full lg:w-[25%] p-5 overflow-y-auto flex flex-col bg-slate-50 border-l border-emerald-100">
                    
                    <!-- Script Box (Referencia) -->
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm mb-4 flex flex-col h-48">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">SCRIPT INICIAL</span>
                            <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold">Ref</span>
                        </div>
                        <textarea id="ficha-script" class="w-full flex-1 bg-slate-50 border border-slate-100 rounded-lg p-2 text-xs text-slate-500 leading-relaxed resize-none outline-none" readonly></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 gap-3 mb-auto">
                        <button onclick="App.cliente.accion('whatsapp')" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl shadow-lg shadow-green-500/30 flex items-center justify-center gap-2 transition-transform hover:scale-[1.01]">
                            <i class="fa-brands fa-whatsapp text-xl"></i>
                            <span class="text-sm font-bold">Enviar WhatsApp</span>
                        </button>
                    </div>

                    <!-- Historial de Interacciones -->
                    <div class="mt-4 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                        <div class="flex justify-between items-center px-3 py-2 border-b border-slate-100 bg-slate-50">
                            <span class="text-[10px] font-bold text-teal-600 uppercase tracking-widest flex items-center gap-1.5">
                                <i class="fa-solid fa-clock-rotate-left text-teal-400"></i> Historial
                            </span>
                            <button onclick="App.cliente.analizarCierre()" class="text-[9px] bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-1 rounded-lg font-bold hover:bg-emerald-100 transition-colors flex items-center gap-1">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Analizar IA
                            </button>
                        </div>
                        <div id="ficha-historial" class="space-y-2 p-3 max-h-52 overflow-y-auto custom-scroll">
                            <!-- Historial items injected by JS -->
                        </div>
                    </div>

                    <!-- Botones Fase Venta -->
                    <div id="acciones-venta" class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="App.cliente.accion('schedule')" class="py-3 bg-white border border-blue-200 text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-regular fa-calendar text-lg"></i>
                            <span class="text-[10px]">Agendar</span>
                        </button>
                        <button onclick="App.cliente.accion('won')" class="py-3 bg-white border border-emerald-200 text-emerald-600 font-bold rounded-xl hover:bg-emerald-50 transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-trophy text-lg"></i>
                            <span class="text-[10px]">Cerrar</span>
                        </button>
                        <button onclick="App.cliente.accion('lost')" class="py-3 bg-white border border-red-200 text-red-500 font-bold rounded-xl hover:bg-red-50 transition-colors flex flex-col items-center justify-center gap-1 col-span-2">
                            <i class="fa-solid fa-thumbs-down text-lg"></i>
                            <span class="text-[10px]">Descartar</span>
                        </button>
                    </div>

                    <!-- Botones Cliente Activo -->
                    <div id="acciones-cliente" class="hidden grid grid-cols-3 gap-2 mt-4">
                        <!-- Botón 1: Ver Sitio Web -->
                        <button onclick="App.cliente.verSitio()" class="py-3 bg-white border border-indigo-200 text-indigo-600 font-bold rounded-xl hover:bg-indigo-50 transition-colors flex flex-col items-center justify-center gap-1" title="Ver el sitio web del cliente">
                            <i class="fa-solid fa-globe text-lg"></i>
                            <span class="text-[10px]">Ver Sitio</span>
                        </button>
                        <!-- Botón Nuevo: Hoja de Ruta -->
                        <button onclick="window.open('/hoja_ruta.html?id=' + App.datos.leads[App.clienteActivoIndex].id, '_blank')" class="py-3 bg-white border border-blue-200 text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition-colors flex flex-col items-center justify-center gap-1" title="Ver Hoja de Ruta del Proyecto">
                            <i class="fa-solid fa-map-location-dot text-lg"></i>
                            <span class="text-[10px]">Hoja Ruta</span>
                        </button>
                        <!-- Botón Nuevo: Enviar Ruta WhatsApp -->
                        <button onclick="App.cliente.enviarHojaRutaWhatsApp()" class="py-3 bg-white border border-green-200 text-green-600 font-bold rounded-xl hover:bg-green-50 transition-colors flex flex-col items-center justify-center gap-1" title="Enviar Link de Hoja de Ruta por WhatsApp">
                            <i class="fa-brands fa-whatsapp text-lg"></i>
                            <span class="text-[10px]">Envío Hoja Ruta</span>
                        </button>
                        <!-- Botón 2: Renovar Plan -->
                        <button onclick="App.cliente.agregarServicio()" class="py-3 bg-white border border-emerald-200 text-emerald-600 font-bold rounded-xl hover:bg-emerald-50 transition-colors flex flex-col items-center justify-center gap-1" title="Agregar nuevo servicio">
                            <i class="fa-solid fa-cart-plus text-lg"></i>
                            <span class="text-[10px]">Agregar Servicio</span>
                        </button>
                        <!-- Botón 3: Soporte Técnico -->
                        <button onclick="App.cliente.abrirSoporteWhatsApp()" class="py-3 bg-white border border-orange-200 text-orange-500 font-bold rounded-xl hover:bg-orange-50 transition-colors flex flex-col items-center justify-center gap-1" title="Contactar por WhatsApp">
                            <i class="fa-brands fa-whatsapp text-lg"></i>
                            <span class="text-[10px]">Soporte</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-agenda" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold text-indigo-900">Agenda Predictiva</h3><p class="text-xs text-slate-400">Seguimientos para hoy</p></div><button onclick="App.ui.toggleModal('modal-agenda', false)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div id="agenda-lista" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll"></div>
        </div>
    </div>

    <div id="modal-entregas-hoy" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div><h3 class="text-xl font-bold text-blue-900">Entregas para Hoy</h3><p class="text-xs text-slate-400">Proyectos con fecha de compromiso hoy</p></div>
                <button onclick="App.ui.toggleModal('modal-entregas-hoy', false)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="entregas-hoy-lista" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll"></div>
        </div>
    </div>

    <div id="modal-calendario" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-100 text-purple-600 p-2 rounded-lg"><i class="fa-regular fa-calendar-days"></i></div>
                    <h3 class="text-xl font-bold text-slate-900">Calendario de Operaciones</h3>
                </div>
                <button onclick="App.ui.toggleModal('modal-calendario', false)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex justify-between items-center mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                <button onclick="App.calendario.cambiarMes(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-500"><i class="fa-solid fa-chevron-left"></i> Anterior</button>
                <h4 id="calendario-titulo" class="text-lg font-bold text-slate-800 capitalize">...</h4>
                <button onclick="App.calendario.cambiarMes(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-500">Siguiente <i class="fa-solid fa-chevron-right ml-1"></i></button>
            </div>

            <div class="grid grid-cols-7 gap-2 text-center mb-2">
                <div class="text-xs font-bold text-slate-400 uppercase">Domingo</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Lunes</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Martes</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Miércoles</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Jueves</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Viernes</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Sábado</div>
            </div>
            
            <div id="calendario-grid" class="grid grid-cols-7 gap-2 flex-1 overflow-y-auto custom-scroll bg-slate-50 p-2 rounded-xl border border-slate-200">
                <!-- JS Generated -->
            </div>
        </div>
    </div>

    <div id="modal-ia-generador" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[80] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl flex flex-col shadow-2xl overflow-hidden border border-slate-200 max-h-[95vh]">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <div><h3 class="text-xl font-bold text-slate-900">Prospector IA</h3></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.ui.toggleModal('modal-prospectos', true)" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-1"><i class="fa-solid fa-file-import"></i> Importar Manual</button>
                    <button onclick="App.prospectorIA.cerrar()" class="text-slate-400 hover:text-slate-600 ml-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            <div class="flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden">
                <div class="w-full lg:w-1/2 flex flex-col p-6 border-b lg:border-b-0 lg:border-r border-slate-100">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Rubro</label><input id="ia-rubro" type="text" placeholder="Ej: Dentistas..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Ciudad</label><input id="ia-ciudad" type="text" value="Santiago, Chile" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none"></div>
                    </div>
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Cantidad</label>
                        <select id="ia-cantidad" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none appearance-none">
                            <option>5</option><option>10</option><option>15</option><option>20</option><option>40</option>
                        </select>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Prompt de Prospección</label>
                        <textarea id="ia-prompt-area" rows="15" class="w-full p-4 bg-slate-100 border border-slate-200 rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-blue-500/20 flex-1"></textarea>
                    </div>
                </div>
                <div class="w-full lg:w-1/2 flex flex-col bg-slate-50 p-6">
                    <div id="ia-loading" class="hidden flex-col items-center justify-center h-full"><div class="loader ease-linear rounded-full border-4 border-t-4 border-blue-500 h-10 w-10 mb-4"></div><p class="text-sm text-slate-500 animate-pulse">Analizando...</p></div>
                    <div id="ia-results-container" class="hidden flex-1 overflow-y-auto space-y-3 custom-scroll"></div>
                    <div id="ia-empty-state" class="flex flex-col items-center justify-center h-full text-center opacity-60"><i class="fa-solid fa-magnifying-glass-location text-4xl text-slate-300 mb-3"></i><p class="text-sm text-slate-400">Define los parámetros y genera.</p></div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-white flex justify-between items-center">
                <button onclick="App.prospectorIA.copiarPrompt()" class="px-4 py-2 bg-slate-100 text-slate-600 font-bold text-xs rounded-lg hover:bg-slate-200 flex items-center gap-2"><i class="fa-regular fa-copy"></i> Copiar Prompt</button>
                <div class="flex gap-3">
                    <button onclick="App.prospectorIA.buscar()" id="btn-ia-buscar" class="px-6 py-2.5 bg-slate-900 text-white font-bold text-sm rounded-lg shadow-lg hover:bg-black flex items-center gap-2">
                        <i class="fa-solid fa-brain"></i> Analizar con <span id="ia-model-name-btn" class="font-mono text-xs">...</span>
                    </button>
                    <button onclick="App.prospectorIA.guardar()" id="btn-ia-guardar" class="hidden px-6 py-2.5 bg-emerald-500 text-white font-bold text-sm rounded-lg shadow-lg hover:bg-emerald-600">Guardar Resultados</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-cierre-venta" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-emerald-50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-emerald-800"><i class="fa-solid fa-handshake mr-2"></i> Cerrar Venta</h3>
                <button onclick="App.ui.toggleModal('modal-cierre-venta', false)" class="text-emerald-400 hover:text-emerald-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="App.cliente.confirmarCierre(event)" class="p-6 space-y-4">
                <input type="hidden" name="cliente_id" id="cierre-cliente-id">
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                    <p class="text-xs text-slate-500 font-bold uppercase">Cliente</p>
                    <p id="cierre-cliente-nombre" class="font-bold text-slate-800 text-lg">...</p>
                    <p id="cierre-cliente-dominio" class="text-xs text-slate-500 font-mono">...</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Monto Total ($)</label>
                        <input name="monto_total" type="number" required class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 font-bold text-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Abono Inicial ($)</label>
                        <input name="monto_pagado" type="number" required class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 font-bold text-emerald-600">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Comprobante de Pago</label>
                    <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center hover:bg-slate-50 transition-colors cursor-pointer relative">
                        <input type="file" name="comprobante" class="absolute inset-0 opacity-0 cursor-pointer">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-300 mb-1"></i>
                        <p class="text-xs text-slate-400 font-bold">Subir imagen o PDF</p>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 transition-all transform hover:scale-[1.02]">
                    Confirmar Venta 🚀
                </button>
            </form>
        </div>
    </div>

    <div id="modal-nuevo-cliente" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">Nuevo Lead Manual</h3>
                <button onclick="App.ui.toggleModal('modal-nuevo-cliente', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="App.cliente.guardarManual(event)" class="p-6 space-y-4 overflow-y-auto custom-scroll">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Dominio (ID Único)</label>
                    <input name="dominio" type="text" required placeholder="ejemplo.cl" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">RUT</label>
                        <input name="rut" type="text" placeholder="12.345.678-9" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Rubro</label>
                        <input name="rubro" type="text" placeholder="Ej: Legal" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Negocio</label>
                    <input name="negocio" type="text" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Dueño</label>
                    <input name="nombre" type="text" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">WhatsApp</label>
                        <input name="whatsapp" type="text" required placeholder="+569..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Email</label>
                        <input name="email" type="email" placeholder="@" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">URL / Maps</label>
                    <input name="url" type="text" placeholder="https://..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Propuesta Inicial</label>
                    <textarea name="propuesta" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20"></textarea>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all">Guardar Lead</button>
            </form>
        </div>
    </div>

    <div id="modal-blacklist" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-red-500">Ranking de Errores (Blacklist)</h3><button onclick="App.ui.toggleModal('modal-blacklist', false)"><i class="fa-solid fa-xmark text-slate-400"></i></button></div>
            
            <div class="mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Errores por Modelo</p>
                <div id="blacklist-chart" class="space-y-2"></div>
            </div>
        </div>
    </div>
    <div id="modal-prospectos" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center"><h3 class="text-xl font-bold text-slate-900">Importar Prospectos</h3><button onclick="App.ui.toggleModal('modal-prospectos', false)"><i class="fa-solid fa-xmark text-slate-400"></i></button></div>
            <div class="p-6 flex flex-col gap-4 overflow-y-auto">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Opción 1: Subir Archivo (CSV/Excel)</label>
                    <input type="file" class="w-full px-4 py-2 rounded-lg border border-slate-200 text-sm">
                </div>
                <div class="flex-1 flex flex-col">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Opción 2: Pegar Código JSON</label>
                    <textarea id="import-json-area" rows="12" placeholder='[{"nombre": "Juan", "negocio": "Panadería", "whatsapp": "+569...", "propuesta_text": "..."}]' class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-blue-500/20"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="App.ui.toggleModal('modal-prospectos', false)" class="px-6 py-2 text-slate-500 font-bold text-sm">Cancelar</button>
                <button onclick="App.importar.procesarJSON()" class="px-6 py-2 bg-emerald-500 text-white font-bold text-sm rounded-lg shadow-lg hover:bg-emerald-600 transition-all">Procesar e Importar</button>
            </div>
        </div>
    </div>

    <div id="modal-motivo-descarte" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Motivo de Descarte</h3>
                <button onclick="App.ui.toggleModal('modal-motivo-descarte', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-sm text-slate-500 mb-4">Selecciona por qué no se cerró esta venta:</p>
            <div class="space-y-2">
                <button onclick="App.cliente.confirmarDescarte('No le interesa')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>No le interesa</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
                <button onclick="App.cliente.confirmarDescarte('Presupuesto / Muy caro')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>Presupuesto / Muy caro</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
                <button onclick="App.cliente.confirmarDescarte('Ya contrató con otro')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>Ya contrató con otro</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
                <button onclick="App.cliente.confirmarDescarte('No contesta / Ilocalizable')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>No contesta / Ilocalizable</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100">
                 <button onclick="App.cliente.confirmarDescarteManual()" class="text-xs text-slate-400 hover:text-slate-600 font-bold underline w-full text-center">Escribir otro motivo...</button>
            </div>
        </div>
    </div>

    <div id="modal-notificacion" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 text-center">
            <div id="notificacion-icono" class="mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl"></div>
            <h3 id="notificacion-titulo" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="notificacion-mensaje" class="text-sm text-slate-500 mb-6 text-left" style="white-space: pre-wrap;"></p>
            <button id="notificacion-btn-ok" onclick="App.ui.cerrarNotificacion()" class="w-full py-2.5 font-bold rounded-lg text-white">OK</button>
        </div>
    </div>

    <div id="modal-confirmacion" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-amber-100 text-amber-500"><i class="fa-solid fa-question"></i></div>
            <h3 id="confirmacion-titulo" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="confirmacion-mensaje" class="text-sm text-slate-500 mb-6"></p>
            <div class="flex gap-3">
                <button id="confirmacion-btn-cancel" class="flex-1 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200">Cancelar</button>
                <button id="confirmacion-btn-ok" class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
            <h3 id="prompt-titulo" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="prompt-mensaje" class="text-sm text-slate-500 mb-4"></p>
            <input id="prompt-input" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none mb-6 focus:ring-2 focus:ring-blue-200">
            <div class="flex gap-3">
                <button id="prompt-btn-cancel" class="flex-1 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200">Cancelar</button>
                <button id="prompt-btn-ok" class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Banner de Permiso de Notificaciones -->
    <div id="notification-permission-banner" class="hidden fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg z-[150] flex items-center gap-4 border border-slate-200">
        <i class="fa-solid fa-bell text-blue-500 text-xl"></i>
        <p class="text-sm text-slate-700 font-medium">¿Activar alertas de sitios caídos?</p>
        <button onclick="App.ui.solicitarPermisoNotificaciones()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-bold">Activar</button>
        <button onclick="document.getElementById('notification-permission-banner').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">&times;</button>
    </div>

    <!-- MODAL INTERCEPTOR RESPUESTA -->
    <div id="modal-interceptor" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-blue-100 text-blue-600 animate-pulse"><i class="fa-solid fa-comments"></i></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">¿Te contestó este lead?</h3>
            <p class="text-sm text-slate-500 mb-6">Ya enviaste el mensaje anteriormente. Necesitamos actualizar el estado.</p>
            <div class="flex flex-col gap-2">
                <button onclick="App.cliente.procesarRespuesta('si')" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/30">Sí, contestó 💬</button>
                <button onclick="App.cliente.procesarRespuesta('enviado')" class="w-full py-3 bg-yellow-100 text-yellow-700 font-bold rounded-xl hover:bg-yellow-200">Solo Enviado 📩</button>
                <button onclick="App.cliente.procesarRespuesta('no')" class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200">No, eliminar 🗑️</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURACIÓN PROMPT IA -->
    <div id="modal-config-prompt" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[120] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[85vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-robot mr-2 text-blue-500"></i> Cerebro de Ventas (Prompt)</h3>
                <button onclick="App.ui.toggleModal('modal-config-prompt', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-0 flex-1 relative">
                <textarea id="config-prompt-input" class="w-full h-full p-6 text-xs font-mono text-slate-700 bg-white outline-none resize-none leading-relaxed" spellcheck="false"></textarea>
                
                <!-- Panel de Resultados de Prueba -->
                <div id="config-prompt-test-result" class="hidden absolute inset-x-0 bottom-0 h-2/5 bg-slate-900/95 backdrop-blur text-slate-300 p-4 overflow-y-auto border-t border-slate-700 transition-all z-10">
                    <div class="flex justify-between items-start mb-2 sticky top-0 bg-slate-900/95 pb-2 border-b border-slate-700">
                        <span class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest"><i class="fa-solid fa-vial"></i> Resultado de Prueba</span>
                        <button onclick="document.getElementById('config-prompt-test-result').classList.add('hidden')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="test-output" class="text-xs font-mono whitespace-pre-wrap"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                <button onclick="App.ui.probarPrompt()" class="px-4 py-2 bg-purple-100 text-purple-600 text-xs font-bold rounded-lg hover:bg-purple-200 border border-purple-200 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-flask"></i> Probar con Ejemplo
                </button>
                <div class="flex items-center gap-2">
                    <select id="config-prompt-example-select" class="bg-white border border-slate-200 text-slate-600 text-xs rounded-lg px-2 py-2 outline-none focus:ring-2 focus:ring-purple-200 cursor-pointer font-bold">
                        <option value="precio">💰 Objeción Precio</option>
                        <option value="interesado">🚀 Cliente Interesado</option>
                        <option value="enojado">😡 Cliente Enojado</option>
                    </select>
                    <button onclick="App.ui.probarPrompt()" class="px-4 py-2 bg-purple-100 text-purple-600 text-xs font-bold rounded-lg hover:bg-purple-200 border border-purple-200 transition-colors flex items-center gap-2"><i class="fa-solid fa-flask"></i> Probar</button>
                </div>
                <div class="flex gap-3">
                    <button onclick="App.ui.restaurarPrompt()" class="px-4 py-2 text-slate-500 text-xs font-bold hover:text-red-500">Restaurar Original</button>
                    <button onclick="App.ui.guardarPrompt()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-lg shadow-md">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sonido de Alerta -->
    <audio id="alert-sound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_c6cc1ee19f.mp3?filename=notification-sound-7062.mp3" preload="auto"></audio>

    <script>
        const GEMINI_MODELS = [
            // --- GROQ (VELOCIDAD EXTREMA) ---
            "groq-llama-3.3-70b-versatile",
            "groq-llama-3.1-8b-instant",
            "groq-mixtral-8x7b-32768",
            // --- OPENROUTER FREE TIER ---
            "openrouter-google/gemma-2-9b-it:free",
            "openrouter-meta-llama/llama-3.1-8b-instruct:free",
            "openrouter-mistralai/mistral-7b-instruct:free",
            "openrouter-microsoft/phi-3-mini-128k-instruct:free",
            "openrouter-huggingfaceh4/zephyr-7b-beta:free",
            "openrouter-liquid/lfm-40b:free",
            // --- GOOGLE GEMINI ---
            "gemini-2.5-flash", "gemini-2.5-pro", "gemini-2.0-flash", "gemini-2.0-flash-001",
            "gemini-2.0-flash-exp-image-generation", "gemini-2.0-flash-lite-001", "gemini-2.0-flash-lite",
            "gemini-exp-1206", "gemini-2.5-flash-preview-tts", "gemini-2.5-pro-preview-tts",
            "gemma-3-1b-it", "gemma-3-4b-it", "gemma-3-12b-it", "gemma-3-27b-it", "gemma-3n-e4b-it",
            "gemma-3n-e2b-it", "gemini-flash-latest", "gemini-flash-lite-latest", "gemini-pro-latest",
            "gemini-2.5-flash-lite", "gemini-2.5-flash-image", "gemini-2.5-flash-preview-09-2025",
            "gemini-2.5-flash-lite-preview-09-2025", "gemini-3-pro-preview", "gemini-3-flash-preview",
            "gemini-3-pro-image-preview", "nano-banana-pro-preview", "gemini-robotics-er-1.5-preview",
            "gemini-2.5-computer-use-preview-10-2025", "deep-research-pro-preview-12-2025"
        ];

        const PROMPT_TEMPLATE = `Actúa como un experto en prospección digital. Eres Alexis Ferrada de la agencia "TuSitioYa".
Tu misión es encontrar clientes REALES y VERIFICABLES mediante una búsqueda exhaustiva en fuentes públicas (Google Maps, Directorios, Redes Sociales).
OBJETIVO: Generar {cantidad} prospectos del rubro "{rubro}" en "{ciudad}".
REGLAS ESTRICTAS DE FILTRADO (OBLIGATORIO):
1. DATOS REALES: Toda la información debe ser de un negocio real y visible públicamente. NO inventes, NO alucines datos.
2. CONTACTO VÁLIDO: El WhatsApp debe ser un número de celular chileno (+56 9...). DESCARTA números fijos (2...) o números falsos/de ejemplo. Si no hay celular, descarta el prospecto.
3. UBICACIÓN: Deben estar ubicados en {ciudad}.
4. ACTIVIDAD: Prioriza negocios con reseñas recientes (idealmente de los últimos 10-30 días) para asegurar que sigan operativos.
5. RELEVANCIA: Deben tener perfil público con al menos 10 reseñas acumuladas.
Para cada prospecto, genera un JSON con: nombre, negocio, whatsapp, dominio_sugerido, rut, email, rubro, url, y "propuesta_text".
REGLAS DE ORO PARA EL MENSAJE (propuesta_text):
1. 🚫 PROHIBIDO usar "Estimado", "Estimada" o saludos formales anticuados.
2. 🚫 PROHIBIDO frases de relleno como "Espero que esté bien" o "Vi su rubro...".
3. ✅ IDENTIDAD: Eres Alexis Ferrada de TuSitioYa.
4. ✅ SALUDO: Debe ser: "Hola [Nombre] 👋, le saluda Alexis Ferrada de TuSitioYa." (O "Hola [Nombre], un gusto saludarle").
5. ✅ TONO "PSICÓLOGO": Identifica un dolor real visible en su perfil (ej: no tienen web, web caída, usan Linktree, fotos pixeladas) y ofrece la cura inmediata.
6. ✅ ESTRUCTURA VISUAL: Usa emojis para los bullets y párrafos cortos.
ESTRUCTURA DEL MENSAJE A GENERAR:
1. Saludo directo (Personalizado).
2. El Gancho (Hook): "Vi sus reseñas en Google y destacan su atención, pero noté que no tiene web/su web falla...".
3. La Solución (Dominio): "Le ofrezco asegurar hoy mismo [Dominio Sugerido]...".
4. Lista de Beneficios (4 Bullets con Emojis):
   - ✅ [Beneficio 1: Estética/Imagen]
   - ✅ [Beneficio 2: Funcionalidad]
   - ✅ [Beneficio 3: Contacto/Ventas]
   - ✅ [Beneficio 4: Propiedad del dominio .cl]
5. El Cierre (Precio y Pregunta): "Valor único: $72.000 (50% inicio / 50% entrega). ¿Le gustaría ver una demo?"
Responde SOLO con un objeto JSON que contenga una única clave "prospectos", y su valor debe ser un Array de JSON válido. No incluyas texto adicional ni explicaciones. NO DATOS SIMULADOS.`;

        const DEFAULT_ANALYSIS_PROMPT = `Actúa como Alexis Ferrada, director de ventas de "TuSitioYa". Eres experto en Neuroventas y Cialdini.
Analiza la conversación adjunta con un prospecto.

OBJETIVO: Generar una estrategia de cierre basada en psicología y detectar el rubro del negocio.

SALIDA REQUERIDA (JSON ESTRICTO):
{
  "rubro_detectado": "Rubro o nicho del negocio del cliente (Ej: Clínica Dental, Abogado, Sushi). Si no es claro, deduce el más probable.",
  "probabilidad_cierre": (Número entero 0-100),
  "resumen_una_linea": "Resumen ejecutivo de máximo 15 palabras.",
  "perfil_psicologico": "Identifica el DOLOR PRINCIPAL (Miedo a perder, Estatus, Ahorro, Seguridad) y el TIPO DE COMPRADOR (Analítico, Emocional, Asertivo).",
  "accion_sugerida": "La mejor acción táctica ahora (Ej: Enviar audio, Agendar Demo, Pedir el 50%).",
  "texto_cierre": "Script de respuesta persuasiva para WhatsApp. Usa gatillos mentales (Escasez, Autoridad o Prueba Social). Termina con una pregunta de cierre.",
  "texto_cierre_corto": "Versión resumida del script anterior. OBLIGATORIO: Texto listo para enviar, de MÁXIMO 3 LÍNEAS, directo y al grano. NO uses guiones ni placeholders."
}

NOTA: Si no hay historial suficiente, asume que es un primer contacto y sugiere una estrategia de apertura agresiva pero empática.`;

        const EXAMPLE_CONVERSATIONS = {
            precio: `[10:00] Cliente: Hola, vi su anuncio de páginas web.
[10:05] Vendedor: Hola! Sí, tenemos planes desde $72.000. Qué negocio tienes?
[10:10] Cliente: Es una pastelería. Pero ese precio es muy alto para mí ahora. Tienen algo más barato?`,
            interesado: `[09:00] Cliente: Hola, necesito una web para mi clínica dental.\n[09:05] Vendedor: Hola! Perfecto, tenemos experiencia con clínicas. ¿Buscas algo informativo o con agenda?\n[09:10] Cliente: Con agenda, me urge tenerla lista esta semana. ¿Cuánto sale y cómo pagamos?`,
            enojado: `[15:00] Cliente: Llevo 3 días esperando respuesta sobre mi soporte.\n[15:05] Vendedor: Hola, disculpa la demora. ¿Cuál era el problema?\n[15:10] Cliente: Mi web sigue caída y estoy perdiendo ventas. Si no se arregla hoy quiero la devolución.`
        };

        const EXAMPLE_CONVERSATION = EXAMPLE_CONVERSATIONS.precio;

        const App = {
            datos: { leads: [], blacklist: [] },
            tempLeads: [],
            filtroBusqueda: '', // Estado para el buscador
            clienteActivoIndex: null,

            init: async function() {
                try {
                    this.datos.blacklist = JSON.parse(localStorage.getItem('blacklist') || '[]');
                    this.ui.actualizarBlacklistCount();
                    this.models.cargarLista();
                    // Intentar cargar estado visual IA sin bloquear la app si falla
                    try { this.models.analizarEstado(); } catch(e) { console.warn("UI IA:", e); }
                    
                    // Agregamos timestamp para evitar que el navegador use caché
                    const res = await fetch(`/api/clientes?_=${new Date().getTime()}`);
                    
                    if (res.status === 404) {
                        throw new Error("Ruta API no encontrada (404).\n\n⚠️ CAUSA PROBABLE:\nNo estás ejecutando el servidor Node.js o estás usando 'Live Server'.\n\nSOLUCIÓN:\n1. Abre la terminal.\n2. Ejecuta: node server.js\n3. Entra a: http://localhost:3000");
                    }

                    if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
                    
                    const data = await res.json();
                    if (!Array.isArray(data)) throw new Error("Formato de datos inválido");

                    this.datos.leads = data.map(l => ({
                        ...l,
                        estado: this.api.mapEstado(l.estado),
                        propuesta: l.propuesta_text || '',
                        historial: l.encuesta_data?.historial || []
                    }));
                    document.getElementById('neon-status-text').innerText = "CONECTADO";
                    document.getElementById('neon-status-dot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                } catch (err) {
                    console.error("Error de conexión:", err);
                    const statusText = document.getElementById('neon-status-text');
                    if (statusText) statusText.innerText = "OFFLINE";
                    const statusDot = document.getElementById('neon-status-dot');
                    if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                    this.datos.leads = []; // Prevenir errores en renderizado
                    // Mostrar error visible al usuario para depurar
                    this.ui.notificar(err.message, "Error de Conexión", "error");
                }
                
                this.ui.renderizarListas(); // Esto ya llama a las demás actualizaciones
                this.util.iniciarReloj();
                this.monitor.init();
                this.conversion.init();

                // Listener para cerrar ficha con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modalFicha = document.getElementById('modal-ficha-cliente');
                        if (!modalFicha.classList.contains('hidden')) App.cliente.cerrarFicha();
                    }
                });
            },

            util: {
                limpiarTelefono: (fono) => {
                    if(!fono) return '';
                    // 1. Convertir a string y eliminar todo lo que no sea número
                    let limpio = String(fono).trim().replace(/\s+/g, '').replace(/\D/g, '');
                    
                    // 2. Lógica estricta para Chile (+569...)
                    if (limpio.length === 8) limpio = '569' + limpio;
                    else if (limpio.length === 9 && limpio.startsWith('9')) limpio = '56' + limpio;
                    
                    return limpio;
                },
                fechaHoy: () => new Date().toISOString().split('T')[0],
                fechaActualHistorial: () => new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                iniciarReloj: () => {
                    const update = () => {
                        const now = new Date();
                        const time = now.toLocaleTimeString('es-CL', { hour12: false });
                        const date = now.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });
                        document.getElementById('reloj-sistema').innerText = time;
                        document.getElementById('fecha-sistema').innerText = date;
                    };
                    setInterval(update, 1000);
                    update();
                }
            },

            api: {
                mapEstado: (dbEstado) => {
                    const map = {
                        'prospecto': 'nuevos',
                        'whatsapp_enviado': 'whatsapp_enviado',
                        'sin_respuesta': 'sin_respuesta',
                        'contactado': 'seguimiento',
                        'cliente': 'cerrados',
                        'no_interesado': 'descartados'
                    };
                    return map[dbEstado] || 'nuevos';
                }
            },

            models: {
                cargarLista: () => { document.getElementById('model-selector').innerHTML = GEMINI_MODELS.map(m => `<option value="${m}">${m}</option>`).join(''); },
                analizarEstado: () => {
                    const statusBadge = document.getElementById('ia-status-badge');
                    const bar = document.getElementById('ia-capacity-bar');
                    const text = document.getElementById('ia-capacity-text');
                    const analysis = document.getElementById('ia-analysis');
                    const model = document.getElementById('model-selector').value;
                    
                    // Verificación de seguridad para evitar errores de "null"
                    if (!statusBadge || !bar || !text || !analysis) return;

                    statusBadge.innerHTML = 'CONNECTING...'; statusBadge.className = "bg-slate-100 text-slate-400 px-2 py-0.5 rounded text-[9px] font-bold";
                    bar.style.width = '0%'; text.innerText = 'OFF'; analysis.innerHTML = 'Handshake...';

                    setTimeout(() => {
                        if (!statusBadge || !bar || !text || !analysis) return; // Doble verificación asíncrona
                        statusBadge.innerHTML = 'ONLINE <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>';
                        statusBadge.className = "bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1";
                        
                        if (model.includes(':free')) {
                            // Modelos gratuitos de OpenRouter
                            bar.style.width = '100%'; text.innerText = '∞';
                            analysis.innerHTML = 'Modelo Gratuito (OpenRouter)';
                        } else {
                            // Simulación para otros modelos
                            let cap = 90 + Math.floor(Math.random() * 10);
                            bar.style.width = `${cap}%`; text.innerText = `${cap}%`;
                            analysis.innerHTML = `Latencia: ${Math.floor(Math.random()*50)+10}ms.`;
                        }
                    }, 800);
                }
            },

            cliente: {
                abrir: (index, forceOpen = false) => {
                    try {
                        const lead = App.datos.leads[index];
                        if (!lead) {
                            console.error("Lead no encontrado en índice:", index);
                            return;
                        }
                        App.clienteActivoIndex = index;

                        // INTERCEPTOR: Si ya se envió whatsapp, preguntar si contestó
                        if (!forceOpen && lead.estado === 'whatsapp_enviado') {
                            App.ui.toggleModal('modal-interceptor', true);
                            return;
                        }

                        // Helper para setear texto seguro
                        const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val || ''; };
                        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };

                        // Header Ficha
                        setText('header-negocio', lead.negocio);
                        setText('header-id', `ID: ${lead.id}`);
                        setText('header-nombre', lead.nombre || 'Desconocido');
                        setText('header-telefono', lead.whatsapp);
                        setText('header-dominio', lead.dominio || 'Sin dominio');

                        // --- CARGA DE DATOS ---
                        
                        // 1. Finanzas
                        setVal('ficha-monto-total', lead.monto_total || 0);
                        setVal('ficha-monto-pagado', lead.monto_pagado || 0);
                        const saldo = Math.max(0, (lead.monto_total || 0) - (lead.monto_pagado || 0));
                        setVal('ficha-saldo-pendiente', new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(saldo));
                        setVal('ficha-fecha-pago', lead.fecha_proximo_pago ? lead.fecha_proximo_pago.split('T')[0] : '');

                        // 2. Datos Básicos
                        setVal('ficha-negocio', lead.negocio);
                        setVal('ficha-nombre', lead.nombre);
                        setVal('ficha-whatsapp', lead.whatsapp);
                        setVal('ficha-dominio', lead.dominio);
                        setVal('ficha-rut', lead.rut);

                        // 3. Datos Extendidos (Desde encuesta_data o defaults)
                        const extra = lead.encuesta_data || {};
                        setVal('ficha-email', extra.email);
                        setVal('ficha-rubro', extra.rubro);
                        setVal('ficha-url', extra.url);
                        setVal('ficha-notas', extra.notas);
                        setVal('ficha-monto-mantencion', extra.monto_mantencion);
                        setVal('ficha-dia-pago', extra.dia_pago);
                        App.cliente.actualizarProyeccionMensual();
                        
                        // 5. Datos de Proyecto (NUEVO)
                        setVal('ficha-progreso', extra.progreso || 0);
                        setText('lbl-progreso', (extra.progreso || 0) + '%');
                        setVal('ficha-fase', extra.fase_actual || 'Inicio del Proyecto');
                        setVal('ficha-drive', extra.drive_link || '');

                        // 3.1 Cargar Encuesta Web (Si existe)
                        const web = extra.respuestas_web || {};
                        
                        // Mostrar fecha y contacto si existen
                        if (extra.fecha_encuesta) {
                            document.getElementById('badge-encuesta-info').classList.remove('hidden');
                            const fecha = new Date(extra.fecha_encuesta).toLocaleDateString('es-CL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                            document.getElementById('txt-encuesta-fecha').innerText = fecha;
                        } else {
                            document.getElementById('badge-encuesta-info').classList.add('hidden');
                        }

                        if (extra.whatsapp_soporte) {
                            document.getElementById('field-whatsapp-soporte').classList.remove('hidden');
                            document.getElementById('txt-whatsapp-soporte').innerText = extra.whatsapp_soporte;
                        } else {
                            document.getElementById('field-whatsapp-soporte').classList.add('hidden');
                        }

                        setVal('p1_objetivo', web.objetivo || 'Vender productos (E-commerce)');
                        setVal('p2_publico', web.publico || '');
                        setVal('p3_referentes', web.referentes || '');
                        setVal('p4_estilo', web.estilo || '');
                        setVal('p5_secciones', web.secciones || '');
                        setVal('p6_funcionalidades', web.funcionalidades || '');
                        setVal('p7_tono', web.tono || 'Profesional y Serio');
                        // Ocultar resultado anterior
                        document.getElementById('container-prompt-web').classList.add('hidden');
                        
                        // 3.2 Generar Link de Encuesta
                        const linkEncuesta = `${window.location.origin}/encuesta.html?id=${lead.id}`;
                        setVal('link-encuesta-cliente', linkEncuesta);

                        // 4. Estado Táctico (Temperatura)
                        const temp = extra.temperatura || 'frio';
                        if (App.cliente.renderTemperatura) App.cliente.renderTemperatura(temp);

                        // Script (Columna 3 - Referencia)
                        setVal('ficha-script', lead.propuesta || 'Sin script generado.');
                        
                        // Info Financiera
                        const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
                        const fichaFinanciera = document.getElementById('ficha-financiera');
                        const fichaTactico = document.getElementById('ficha-estado-tactico');
                        const accionesVenta = document.getElementById('acciones-venta');
                        const accionesCliente = document.getElementById('acciones-cliente');

                        if (lead.estado === 'cerrados') {
                            if (fichaFinanciera) {
                                fichaFinanciera.classList.remove('hidden');
                                setText('ficha-total', formatter.format(lead.monto_total || 0));
                                setText('ficha-pagado', formatter.format(lead.monto_pagado || 0));
                            }
                            if (fichaTactico) fichaTactico.classList.add('hidden'); // Ocultar táctica en clientes cerrados
                            if (accionesVenta) accionesVenta.classList.add('hidden'); // Ocultar botones de venta
                            if (accionesCliente) accionesCliente.classList.remove('hidden'); // Mostrar botones de gestión
                        } else {
                            if (fichaFinanciera) fichaFinanciera.classList.add('hidden');
                            if (fichaTactico) fichaTactico.classList.remove('hidden'); // Mostrar táctica en prospectos
                            if (accionesVenta) accionesVenta.classList.remove('hidden'); // Mostrar botones de venta
                            if (accionesCliente) accionesCliente.classList.add('hidden'); // Ocultar botones de gestión
                        }

                        const badge = document.getElementById('ficha-estado-badge');
                        if (badge) {
                            let textoEstado = (lead.estado || '').toUpperCase();
                            let badgeClass = "bg-slate-700 text-slate-300"; 
                            
                            if (lead.estado === 'cerrados') {
                                badgeClass = "bg-green-100 text-green-700";
                                textoEstado = "CLIENTE ACTIVO";
                            }
                            else if (lead.estado === 'descartados') badgeClass = "bg-red-100 text-red-700";
                            else if (lead.estado === 'seguimiento') badgeClass = "bg-blue-100 text-blue-700";
                            else if (lead.estado === 'whatsapp_enviado') badgeClass = "bg-yellow-100 text-yellow-700";
                            else if (lead.estado === 'sin_respuesta') badgeClass = "bg-slate-100 text-slate-500";
                            
                            badge.innerText = textoEstado;
                            badge.className = `px-3 py-1 rounded-full text-xs font-bold uppercase ${badgeClass}`;
                        }
                        
                        if (this.renderizarHistorial) this.renderizarHistorial(lead);
                        
                        // Reset Analysis View
                        setVal('historial-chat-input', '');
                        const analysisResult = document.getElementById('analysis-result');
                        if (analysisResult) {
                            analysisResult.classList.add('hidden');
                            analysisResult.innerHTML = '';
                        }

                        // Configuración Discador
                        const discadorBar = document.getElementById('ficha-discador-bar');
                        if (discadorBar) {
                            if (App.discador.activo) {
                                discadorBar.classList.remove('hidden');
                                setText('discador-counter', `${App.discador.indiceActual + 1} / ${App.discador.cola.length}`);
                            } else {
                                discadorBar.classList.add('hidden');
                            }
                        }
                        
                        App.ui.toggleModal('modal-ficha-cliente', true);
                    } catch (e) {
                        console.error("Error al abrir ficha:", e);
                        App.ui.notificar("Error al abrir la ficha del cliente. Revisa la consola.", "Error", "error");
                    }
                },
                renderizarHistorial: function(lead) {
                    const histContainer = document.getElementById('ficha-historial');
                    if (!histContainer) return;
                    
                    if (lead.historial && lead.historial.length > 0) {
                        histContainer.innerHTML = lead.historial.map(h => {
                            const nota = h.nota ? h.nota.replace(/\n/g, '<br>') : '';
                            return `<div class="relative pb-4 last:pb-0"><div class="absolute top-1 -left-[13px] w-2 h-2 bg-slate-200 rounded-full border border-white"></div><p class="text-[10px] text-slate-400 font-bold mb-0.5">${h.fecha}</p><p class="text-xs text-slate-600 bg-slate-50 p-2 rounded-lg border border-slate-100">${nota}</p></div>`;
                        }).join('');
                    } else { 
                        histContainer.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-2">Sin historial.</p>'; 
                    }
                },
                _guardarEncuestaData: async function() {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    try {
                        if (!lead.encuesta_data) lead.encuesta_data = {};
                        // Make sure local history is synced to encuesta_data before saving
                        lead.encuesta_data.historial = lead.historial; 
                        
                        const payload = { cliente_id: lead.id, ...lead.encuesta_data };
                        await fetch('/api/encuesta', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });
                    } catch(e) {
                        console.error("Error guardando encuesta_data", e);
                    }
                },
                agregarNotaHistorial: async function(nota) {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];

                    if (!lead.historial) lead.historial = [];
                    lead.historial.push({ fecha: App.util.fechaActualHistorial(), nota: nota });

                    this.renderizarHistorial(lead);
                    await this._guardarEncuestaData(); // Save the whole thing
                },
                guardarHistorialPegado: async function(event) {
                    event.preventDefault();
                    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                    if (!pastedText) return;
                    document.getElementById('historial-chat-input').value = pastedText;
                    const nota = `📋 Conversación pegada:\n---\n${pastedText}`;
                    await App.cliente.agregarNotaHistorial(nota);
                    App.ui.notificar("Historial de chat guardado.", "Guardado", "exito", 1500);
                },
                renderTemperatura: (temp) => {
                    // Reset estilos
                    ['frio', 'tibio', 'caliente'].forEach(t => {
                        const btn = document.getElementById(`btn-temp-${t}`);
                        if(btn) btn.className = "py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all opacity-50";
                    });
                    
                    // Activar seleccionado
                    const activeBtn = document.getElementById(`btn-temp-${temp}`);
                    if (activeBtn) {
                        let activeClass = "";
                        if(temp === 'frio') activeClass = "bg-blue-100 text-blue-600 border-blue-200 opacity-100";
                        if(temp === 'tibio') activeClass = "bg-orange-100 text-orange-600 border-orange-200 opacity-100";
                        if(temp === 'caliente') activeClass = "bg-red-100 text-red-600 border-red-200 opacity-100";
                        activeBtn.className = `py-1.5 rounded-lg text-xs font-bold border transition-all shadow-sm transform scale-105 ${activeClass}`;
                    }
                },
                setTemperatura: (temp) => {
                    App.cliente.renderTemperatura(temp);
                    App.cliente.actualizarCampo('temperatura', temp);
                },
                actualizarCampo: async (campo, valor) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    // Campos que van en la raíz de la tabla
                    const camposRaiz = ['negocio', 'nombre', 'whatsapp', 'dominio', 'monto_total', 'monto_pagado', 'fecha_proximo_pago', 'rut'];
                    
                    if (camposRaiz.includes(campo)) {
                        // Actualizar localmente
                        lead[campo] = valor;
                        
                        // Recalcular saldo visualmente si cambian montos
                        if (campo === 'monto_total' || campo === 'monto_pagado') {
                            const total = parseInt(document.getElementById('ficha-monto-total').value) || 0;
                            const pagado = parseInt(document.getElementById('ficha-monto-pagado').value) || 0;
                            const saldo = Math.max(0, total - pagado);
                            document.getElementById('ficha-saldo-pendiente').value = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(saldo);
                        }

                        // Enviar al servidor (PUT)
                        try {
                            const body = {}; body[campo] = valor;
                            await fetch(`/api/clientes/${lead.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                            if(campo === 'negocio') document.getElementById('header-negocio').innerText = valor;
                        } catch(e) { console.error("Error guardando campo raíz", e); }

                    } else {
                        // Campos extra (Email, Rubro, URL, Temperatura, Notas) -> Guardar en encuesta_data
                        if (!lead.encuesta_data) lead.encuesta_data = {};
                        lead.encuesta_data[campo] = valor;
                        
                        // Usamos PUT para actualizar de forma segura
                        try {
                            const payload = { encuesta_data: lead.encuesta_data };
                            await fetch(`/api/clientes/${lead.id}`, { 
                                method: 'PUT', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify(payload) 
                            });
                        } catch(e) { console.error("Error guardando campo extendido", e); }
                    }
                },
                actualizarProyeccionMensual: () => {
                    const dia = parseInt(document.getElementById('ficha-dia-pago').value);
                    const monto = document.getElementById('ficha-monto-mantencion').value;
                    const container = document.getElementById('info-proxima-mensualidad');
                    const txt = document.getElementById('txt-proximo-cobro');

                    if (dia && dia > 0 && dia <= 31 && monto) {
                        const hoy = new Date();
                        // Crear fecha para este mes con el día seleccionado
                        const fechaCobro = new Date(hoy.getFullYear(), hoy.getMonth(), dia);
                        
                        const opciones = { weekday: 'long', day: 'numeric', month: 'long' };
                        txt.innerText = fechaCobro.toLocaleDateString('es-CL', opciones);
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                },
                guardarEncuestaWeb: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    const respuestas = {
                        objetivo: document.getElementById('p1_objetivo').value,
                        publico: document.getElementById('p2_publico').value,
                        referentes: document.getElementById('p3_referentes').value,
                        estilo: document.getElementById('p4_estilo').value,
                        secciones: document.getElementById('p5_secciones').value,
                        funcionalidades: document.getElementById('p6_funcionalidades').value,
                        tono: document.getElementById('p7_tono').value
                    };

                    // Actualizar localmente
                    if (!lead.encuesta_data) lead.encuesta_data = {};
                    lead.encuesta_data.respuestas_web = respuestas;

                    try {
                        await fetch(`/api/clientes/${lead.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ respuestas_web: respuestas })
                        });
                        App.ui.notificar("Briefing web guardado correctamente.", "Guardado", "exito");
                    } catch (e) {
                        console.error(e);
                        App.ui.notificar("Error al guardar briefing.", "Error", "error");
                    }
                },
                generarPromptWeb: async () => {
                    const btn = document.getElementById('btn-prompt-web');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generando...';
                    btn.disabled = true;

                    const data = App.datos.leads[App.clienteActivoIndex].encuesta_data.respuestas_web || {};
                    // Recoger valores actuales por si no se ha guardado
                    data.objetivo = document.getElementById('p1_objetivo').value;
                    data.publico = document.getElementById('p2_publico').value;
                    // ... (resto de campos se toman del DOM si se quiere ser estricto, pero asumimos guardado o uso directo)
                    
                    const prompt = `Actúa como Arquitecto de Software Senior. Crea un PROMPT TÉCNICO DETALLADO para desarrollar una Landing Page con estas características:\n\n1. Objetivo: ${document.getElementById('p1_objetivo').value}\n2. Público: ${document.getElementById('p2_publico').value}\n3. Referentes: ${document.getElementById('p3_referentes').value}\n4. Estilo: ${document.getElementById('p4_estilo').value}\n5. Secciones: ${document.getElementById('p5_secciones').value}\n6. Funcionalidades: ${document.getElementById('p6_funcionalidades').value}\n7. Tono: ${document.getElementById('p7_tono').value}\n\nSALIDA: Un prompt optimizado para que una IA de código (Cursor/Windsurf) genere el proyecto completo en HTML/Tailwind/JS.`;

                    try {
                        const res = await fetch('/api/analizar-chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ prompt: prompt }) });
                        const json = await res.json();
                        document.getElementById('txt-prompt-web').value = json.analisis;
                        document.getElementById('container-prompt-web').classList.remove('hidden');
                    } catch(e) { App.ui.notificar("Error generando prompt", "Error", "error"); }
                    
                    btn.innerHTML = originalText; btn.disabled = false;
                },
                copiarLinkEncuesta: () => {
                    const link = document.getElementById('link-encuesta-cliente');
                    link.select();
                    navigator.clipboard.writeText(link.value);
                    App.ui.notificar("Link copiado al portapapeles", "Copiado", "exito");
                },
                verSitio: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    let url = lead.dominio;
                    if (!url) {
                        App.ui.notificar("El cliente no tiene un dominio asignado.", "Sin Dominio", "error");
                        return;
                    }
                    if (!url.startsWith('http')) url = 'https://' + url;
                    window.open(url, '_blank');
                },
                abrirSoporteWhatsApp: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const fono = App.util.limpiarTelefono(lead.whatsapp);
                    if(fono) window.open(`https://wa.me/${fono}`, 'whatsapp_tab');
                    else App.ui.notificar("El cliente no tiene un número válido", "Error", "error");
                },
                agregarServicio: () => {
                    App.ui.notificar("Funcionalidad de Agregar Servicio en desarrollo.", "Próximamente", "info");
                },
                copiarSoporte: () => {
                    const txt = document.getElementById('txt-whatsapp-soporte').innerText;
                    navigator.clipboard.writeText(txt);
                    App.ui.notificar("Número copiado", "Copiado", "exito");
                },
                enviarEncuestaWhatsApp: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const link = document.getElementById('link-encuesta-cliente').value;
                    const mensaje = `Hola ${lead.nombre || ''} 👋, para avanzar con el diseño de tu web 💻, necesito que completes este breve formulario con tus preferencias: ${link}`;
                    const fono = App.util.limpiarTelefono(lead.whatsapp);
                    if(fono) window.open(`https://wa.me/${fono}?text=${encodeURIComponent(mensaje)}`, 'whatsapp_tab');
                    else App.ui.notificar("El cliente no tiene un número válido", "Error", "error");
                },
                enviarHojaRutaWhatsApp: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const link = `${window.location.origin}/hoja_ruta.html?id=${lead.id}`;
                    const mensaje = `Hola ${lead.nombre || ''} 👋, aquí tienes el enlace a tu Hoja de Ruta 🗺️ para ver el avance del proyecto en tiempo real y subir tus archivos: ${link}`;
                    const fono = App.util.limpiarTelefono(lead.whatsapp);
                    if(fono) window.open(`https://wa.me/${fono}?text=${encodeURIComponent(mensaje)}`, 'whatsapp_tab');
                    else App.ui.notificar("El cliente no tiene un número válido", "Error", "error");
                },
                generarHojaRutaIA: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const btn = document.getElementById('btn-ruta-ia');
                    const txtCustom = document.getElementById('txt-ruta-custom');
                    
                    // Feedback visual de carga
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Creando Ruta...';
                    btn.disabled = true;

                    const rubro = lead.encuesta_data?.rubro || lead.rubro || "";
                    const negocio = lead.negocio || "";
                    const instrucciones = txtCustom ? txtCustom.value.trim() : "";

                    // Validación: Si no hay nada de información
                    if (!instrucciones && !rubro && !negocio) {
                         App.ui.notificar("Faltan datos (Rubro o Instrucciones) para generar la ruta.", "Datos Insuficientes", "error");
                         btn.innerHTML = originalText;
                         btn.disabled = false;
                         return;
                    }

                    const prompt = `Actúa como Project Manager experto en desarrollo web.
                    Crea una Hoja de Ruta de 6 pasos para un proyecto web.
                    
                    DATOS DEL PROYECTO:
                    ${negocio ? `- Cliente: ${negocio}` : ''}
                    ${rubro ? `- Rubro/Industria: ${rubro}` : ''}
                    ${instrucciones ? `- INSTRUCCIONES ADICIONALES: ${instrucciones}` : ''}
                    
                    OBJETIVO: Generar un plan de trabajo técnico y visual (0% a 100%).
                    Si hay instrucciones adicionales, úsalas como prioridad para definir los pasos.
                    Si solo hay rubro, adapta los pasos estándar a ese nicho.
                    
                    FORMATO JSON ESTRICTO (Array de objetos):
                    [
                        { "titulo": "Nombre corto del paso", "rango": "0% - 15%", "descripcion": "Descripción técnica breve adaptada." },
                        ... hasta 6 pasos cubriendo del 0% al 100%
                    ]
                    
                    Solo devuelve el JSON, nada más.`;

                    try {
                        const model = document.getElementById('model-selector').value;
                        const res = await fetch('/api/analizar-chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ prompt: prompt, model: model }) });
                        const data = await res.json();
                        
                        // Limpiar JSON (a veces la IA pone markdown ```json ... ```)
                        const cleanJson = data.analisis.replace(/```json/g, '').replace(/```/g, '').trim();
                        const rutaGenerada = JSON.parse(cleanJson);

                        // Guardar en encuesta_data
                        await App.cliente.actualizarCampo('roadmap', rutaGenerada);
                        App.ui.notificar("Hoja de Ruta personalizada creada y guardada.", "Éxito IA", "exito");
                        // Limpiar campo custom
                        if(txtCustom) txtCustom.value = '';
                    } catch(e) {
                        console.error(e);
                        App.ui.notificar("Error al generar la ruta. Intenta de nuevo.", "Error IA", "error");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                },
                actualizarDatosContacto: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    const btn = document.querySelector('button[onclick="App.cliente.actualizarDatosContacto()"]');
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sincronizando...';
                    btn.disabled = true;

                    try {
                        // 1. Pedir datos frescos al servidor
                        const res = await fetch(`/api/clientes/${lead.id}`);
                        if (!res.ok) throw new Error("Error al sincronizar");
                        const freshData = await res.json();
                        
                        // 2. Actualizar modelo local y refrescar ficha
                        App.datos.leads[App.clienteActivoIndex] = {
                            ...freshData,
                            estado: App.api.mapEstado(freshData.estado),
                            propuesta: freshData.propuesta_text || ''
                        };
                        App.cliente.abrir(App.clienteActivoIndex);
                        
                        App.ui.notificar("Datos sincronizados con la nube.", "Actualizado", "exito");
                    } catch(e) {
                        console.error(e);
                        App.ui.notificar("No se pudo sincronizar.", "Error", "error");
                    } finally {
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    }
                },
                procesarRespuesta: async (accion) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    App.ui.toggleModal('modal-interceptor', false);

                    if (accion === 'si') {
                        // Cambiar a seguimiento y abrir ficha
                        lead.estado = 'seguimiento';
                        App.cliente.agregarNotaHistorial(`💬 Cliente contestó. Pasado a seguimiento.`);
                        await fetch(`/api/clientes/${lead.id}/estado`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: 'contactado' }) });
                        App.ui.renderizarListas();
                        App.cliente.abrir(App.clienteActivoIndex, true); 
                    } else if (accion === 'no') {
                        // Eliminar prospecto
                        try {
                            await fetch(`/api/clientes/${lead.id}`, { method: 'DELETE' });
                            App.datos.leads.splice(App.clienteActivoIndex, 1);
                            App.ui.renderizarListas(); 
                            App.ui.notificar("Prospecto eliminado.", "Eliminado", "info");
                            App.cliente.cerrarFicha();
                        } catch (e) {
                            App.ui.notificar("Error al eliminar.", "Error", "error");
                        }
                    } else if (accion === 'enviado') {
                        // Mantener en enviado y abrir ficha
                        App.cliente.abrir(App.clienteActivoIndex, true);
                    }
                },
                cerrarFicha: () => { if(App.discador.activo) App.discador.detener(); App.ui.toggleModal('modal-ficha-cliente', false); App.clienteActivoIndex = null; },
                accion: async (tipo) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const fonoLimpio = App.util.limpiarTelefono(lead.whatsapp);
                    switch (tipo) {
                        case 'whatsapp':
                            if (!fonoLimpio || fonoLimpio.length < 8) {
                                App.ui.notificar("El número de teléfono no es válido para WhatsApp.", "Error de Número", "error");
                                return;
                            }
                            
                            // Lógica de Agendamiento Automático (Mañana, saltando Domingo)
                            const hoy = new Date();
                            let nextDate = new Date(hoy);
                            nextDate.setDate(hoy.getDate() + 1);
                            if (nextDate.getDay() === 0) { // 0 es Domingo
                                nextDate.setDate(nextDate.getDate() + 1); // Saltar al Lunes
                            }

                            // Actualizar Estado y Historial
                            if (lead.estado === 'nuevos' || lead.estado === 'sin_respuesta') lead.estado = 'whatsapp_enviado';
                            App.cliente.agregarNotaHistorial(`✅ WhatsApp Enviado. Esperando respuesta.`);
                            
                            // Persistencia en Segundo Plano (Sin bloquear UI)
                            fetch(`/api/clientes/${lead.id}/estado`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: 'whatsapp_enviado' }) }).catch(console.error);
                            // fetch(`/api/clientes/${lead.id}/agendar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fecha: fechaAgendada }) }).catch(console.error);

                            App.ui.renderizarListas(); // Actualizar UI inmediatamente
                            
                            // Si estamos en modo discador, avanzar automáticamente tras un breve delay
                            if (App.discador.activo) {
                                window.open(`https://wa.me/${fonoLimpio}?text=${encodeURIComponent(lead.propuesta)}`, 'whatsapp_tab');
                                setTimeout(() => App.discador.siguiente(), 1000);
                            } else {
                                window.open(`https://wa.me/${fonoLimpio}?text=${encodeURIComponent(lead.propuesta)}`, 'whatsapp_tab');
                            }
                            break;
                        case 'invalid':
                            // Eliminación directa sin confirmación
                            await fetch(`/api/clientes/${lead.id}`, { method: 'DELETE' });
                            App.datos.blacklist.push(`${lead.whatsapp} (${lead.negocio})`);
                            localStorage.setItem('blacklist', JSON.stringify(App.datos.blacklist));
                            App.datos.leads.splice(App.clienteActivoIndex, 1);
                            App.ui.actualizarBlacklistCount(); 
                            App.ui.renderizarListas(); 
                            App.cliente.cerrarFicha();
                            App.ui.notificar("Cliente eliminado y agregado a la lista negra.", "Eliminado", "exito");
                            break;
                        case 'schedule':
                            const fecha = await App.ui.prompt("Selecciona la fecha de seguimiento:", "Agendar Lead", App.util.fechaHoy(), "date");
                            if (fecha) { 
                                lead.estado = 'seguimiento'; 
                                lead.fecha_agendada = fecha; 
                                App.cliente.agregarNotaHistorial(`📅 Agendado para: ${fecha}`);
                                App.ui.notificar("Lead agendado con éxito.", "Agendado", "exito"); 
                            }
                            break;
                        case 'won':
                            // Abrir Modal de Cierre en lugar de confirmar directo
                            document.getElementById('cierre-cliente-id').value = lead.id;
                            document.getElementById('cierre-cliente-nombre').innerText = lead.negocio;
                            document.getElementById('cierre-cliente-dominio').innerText = lead.dominio || 'Sin dominio asignado';
                            // Pre-llenar montos si existen
                            document.querySelector('input[name="monto_total"]').value = lead.monto_total || 72000;
                            document.querySelector('input[name="monto_pagado"]').value = lead.monto_pagado || 0;
                            
                            App.ui.toggleModal('modal-cierre-venta', true);
                            break;
                        case 'lost':
                            App.ui.toggleModal('modal-motivo-descarte', true);
                            break;
                    }
                    App.ui.renderizarListas();
                    if (App.clienteActivoIndex !== null) App.cliente.abrir(App.clienteActivoIndex);
                },
                confirmarDescarte: async (motivo) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    lead.estado = 'descartados';
                    App.cliente.agregarNotaHistorial(`👎 Descarte: ${motivo}`);
                    
                    // Enviar al backend (guardando motivo en encuesta_data para no alterar schema)
                    try {
                        await fetch(`/api/clientes/${lead.id}/estado`, { 
                            method: 'PATCH', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ estado: 'no_interesado', motivo: motivo }) 
                        });
                    } catch(e) { console.error(e); }

                    App.ui.toggleModal('modal-motivo-descarte', false);
                    App.cliente.cerrarFicha();
                    App.ui.renderizarListas();
                    App.ui.notificar("Lead descartado y motivo registrado.", "Descarte", "info");
                },
                confirmarDescarteManual: async () => {
                    App.ui.toggleModal('modal-motivo-descarte', false);
                    const motivo = await App.ui.prompt("Ingresa el motivo del descarte:", "Descartar Lead");
                    if (motivo) {
                        App.cliente.confirmarDescarte(motivo);
                    }
                },
                confirmarCierre: async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const id = formData.get('cliente_id');
                    const montoTotal = parseInt(formData.get('monto_total'));
                    const montoPagado = parseInt(formData.get('monto_pagado'));

                    try {
                        // 1. Actualizar Montos
                        await fetch(`/api/clientes/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ monto_total: montoTotal, monto_pagado: montoPagado })
                        });

                        // 2. Cambiar Estado a 'cliente' (cerrado)
                        await fetch(`/api/clientes/${id}/estado`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ estado: 'cliente' }) // 'cliente' mapea a 'cerrados' en UI
                        });

                        // 3. Actualizar Localmente
                        const lead = App.datos.leads.find(l => l.id == id);
                        if (lead) {
                            lead.estado = 'cerrados';
                            lead.monto_total = montoTotal;
                            lead.monto_pagado = montoPagado;
                            App.cliente.agregarNotaHistorial(`🚀 VENTA CERRADA. Total: $${montoTotal} | Pagado: $${montoPagado}`);
                        }

                        App.ui.toggleModal('modal-cierre-venta', false);
                        App.cliente.cerrarFicha();
                        App.ui.renderizarListas();
                        App.ui.lanzarConfeti();
                        App.monitor.sincronizar(); // Actualizar monitor con el nuevo cliente
                        App.monitor.checkAll();    // Verificar estado inmediatamente
                        App.ui.notificar("¡Venta registrada exitosamente!", "Felicidades", "exito");
                    } catch (err) {
                        console.error(err);
                        App.ui.notificar("Error al registrar la venta.", "Error", "error");
                    }
                },
                analizarCierre: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const fonoLimpio = App.util.limpiarTelefono(lead.whatsapp);
                    
                    const btn = document.getElementById('btn-analizar-cierre');
                    const resultContainer = document.getElementById('analysis-result');
                    const inputHistorial = document.getElementById('historial-chat-input');
                    
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i> Analizando...';
                    
                    try {
                        let historialTexto = inputHistorial.value.trim();
                        
                        if (!historialTexto && lead.historial && lead.historial.length > 0) {
                            historialTexto = lead.historial.map(h => `[${h.fecha}] ${h.nota}`).join('\n');
                            inputHistorial.value = historialTexto; // Mostrar lo que se está analizando
                        } else if (!historialTexto) {
                            throw new Error("Por favor, pega la conversación en el cuadro de texto.");
                        }

                        // Obtener el prompt personalizado o el default
                        const systemPrompt = localStorage.getItem('analysis_prompt') || DEFAULT_ANALYSIS_PROMPT;
                        const fullPrompt = `${systemPrompt}\n\nCONVERSACIÓN:\n"${historialTexto}"`;

                        const model = document.getElementById('model-selector').value;
                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: fullPrompt, model: model })
                        });

                        if (!res.ok) {
                            const errorData = await res.json();
                            throw new Error(errorData.error || `Error de la API: ${res.statusText}`);
                        }

                        const data = await res.json();
                        
                        // VALIDACIÓN CRÍTICA: Si no hay análisis, lanzar error controlado
                        if (!data || !data.analisis) {
                            throw new Error("La IA no devolvió un análisis válido. Intenta con otro modelo.");
                        }

                        let analisisObj = {};
                        try { 
                            // Limpieza extra por si la IA devuelve bloques de código markdown
                            const cleanJson = data.analisis.replace(/```json/g, '').replace(/```/g, '').trim();
                            analisisObj = JSON.parse(cleanJson); 
                        } catch (e) { 
                            analisisObj = { 
                                texto_cierre: data.analisis, 
                                probabilidad_cierre: 50, 
                                resumen_una_linea: "Análisis básico (formato no JSON)",
                                perfil_psicologico: "No detectado",
                                accion_sugerida: "Responder manualmente"
                            }; 
                        }

                        const prob = analisisObj.probabilidad_cierre || 0;
                        let colorProb = 'red';
                        if(prob > 40) colorProb = 'yellow';
                        if(prob > 70) colorProb = 'emerald';

                        resultContainer.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Oportunidad de Cierre</span>
                                    <span class="text-xs font-bold text-${colorProb}-600">${prob}%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-${colorProb}-500 h-full rounded-full transition-all duration-1000" style="width: ${prob}%"></div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <div class="flex justify-between items-center mb-1">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase">RESUMEN</p>
                                        <span class="text-[9px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded font-bold uppercase tracking-wider">${analisisObj.rubro_detectado || 'General'}</span>
                                    </div>
                                    <p class="text-xs text-slate-700 font-medium leading-tight">${analisisObj.resumen_una_linea || '...'}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">PSICOLOGÍA & ESTRATEGIA</p>
                                    <p class="text-[10px] text-slate-600 mb-1">${analisisObj.perfil_psicologico || '...'}</p>
                                    <p class="text-[10px] text-blue-600 font-bold"><i class="fa-solid fa-bolt mr-1"></i> Acción: ${analisisObj.accion_sugerida || '...'}</p>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                                    <div class="flex justify-between items-center mb-2">
                                        <p class="text-[10px] font-bold text-indigo-500 uppercase">RESPUESTA DETALLADA</p>
                                        <button onclick="navigator.clipboard.writeText('${(analisisObj.texto_cierre || '').replace(/'/g, "\\'")}')" class="text-[10px] text-indigo-600 hover:text-indigo-800 font-bold"><i class="fa-regular fa-copy"></i> Copiar</button>
                                    </div>
                                    <p class="text-xs text-indigo-900 italic leading-relaxed">"${analisisObj.texto_cierre}"</p>
                                </div>
                                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                                  <div class="flex justify-between items-center mb-2">
                                        <p class="text-[10px] font-bold text-emerald-600 uppercase">RESPUESTA RÁPIDA (3 LÍNEAS)</p>
                                        <div class="flex gap-2">
                                            <button onclick="navigator.clipboard.writeText('${(analisisObj.texto_cierre_corto || '').replace(/'/g, "\\'")}')" class="text-[10px] text-emerald-600 hover:text-emerald-800 font-bold" title="Copiar"><i class="fa-regular fa-copy"></i></button>
                                            <button onclick="window.open('https://api.whatsapp.com/send?phone=${fonoLimpio}&text=${encodeURIComponent(analisisObj.texto_cierre_corto || '').replace(/'/g, '%27')}', 'whatsapp_tab')" class="text-[10px] bg-emerald-500 text-white px-2 py-1 rounded hover:bg-emerald-600 font-bold flex items-center gap-1 shadow-sm transition-transform hover:scale-105"><i class="fa-brands fa-whatsapp"></i> Enviar</button>
                                        </div>
                                    </div>
                                    <p class="text-xs text-emerald-900 italic leading-relaxed">"${analisisObj.texto_cierre_corto || '...'}"</p>
                                </div>
                            </div>
                        `;
                        
                        resultContainer.classList.remove('hidden');
                    } catch (e) {
                        App.ui.notificar(e.message || "Error al analizar el historial.", "Error IA", "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Analizar Historial';
                    }
                },

                analizarConContexto: async (tipo, btnEl) => {
                    if (App.clienteActivoIndex === null) {
                        App.ui.notificar("Abre primero la ficha de un cliente.", "Sin cliente", "error");
                        return;
                    }
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const negocio = lead.negocio || 'el negocio';
                    const nombre = lead.nombre || 'el cliente';
                    const rubro = (lead.encuesta_data && lead.encuesta_data.rubro) || 'su rubro';
                    const temperatura = (lead.encuesta_data && lead.encuesta_data.temperatura) || 'frío';
                    const historialTexto = (lead.historial && lead.historial.length > 0)
                        ? lead.historial.map(h => `[${h.fecha}] ${h.nota}`).join('\n')
                        : 'Sin historial previo de conversación.';

                    // Estado de carga en el botón
                    const originalHTML = btnEl.innerHTML;
                    btnEl.disabled = true;
                    btnEl.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-white text-base"></i><span class="text-[10px] font-bold text-white mt-0.5">Analizando...</span>`;

                    const resultContainer = document.getElementById('analysis-result');
                    resultContainer.classList.remove('hidden');
                    resultContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-8 gap-3">
                        <div class="w-8 h-8 border-4 border-emerald-200 border-t-emerald-500 rounded-full animate-spin"></div>
                        <p class="text-xs text-slate-400 animate-pulse font-bold">IA procesando estrategia...</p>
                    </div>`;

                    const prompts = {
                        cerrar_venta: `Actúa como Alexis Ferrada, director de ventas de TuSitioYa, experto en Neuroventas y técnicas de cierre.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISIÓN: Genera una estrategia de CIERRE DEFINITIVO para HOY. El cliente ya conoce el producto, necesitamos el SÍ final.

Responde SOLO en JSON estricto con estos campos exactos:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 75,
  "resumen_una_linea": "Estado actual en 15 palabras",
  "perfil_psicologico": "Tipo de comprador y dolor principal detectado",
  "accion_sugerida": "Acción táctica específica para cerrar HOY",
  "texto_cierre": "Script completo de cierre con gatillos de urgencia (escasez de cupos, oferta limitada). Incluye pregunta de cierre directa.",
  "texto_cierre_corto": "Mensaje WhatsApp de máximo 3 líneas para enviar AHORA. Directo, sin rodeos, con pregunta de cierre."
}`,

                        manejar_objeciones: `Actúa como Alexis Ferrada de TuSitioYa, experto en manejo de objeciones con técnicas de Cialdini.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISIÓN: Detecta la objeción principal del cliente y genera respuestas específicas para superarla. Si no hay historial, prepara respuestas para las 3 objeciones más comunes: precio, tiempo y competencia.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 60,
  "resumen_una_linea": "Objeción principal detectada en 15 palabras",
  "perfil_psicologico": "Tipo de objeción (Precio/Tiempo/Competencia/Desconfianza) y perfil del comprador",
  "accion_sugerida": "Técnica específica para superar la objeción (reencuadre, prueba social, garantía)",
  "texto_cierre": "Script detallado para manejar la objeción con empatía y reencuadre. Usa prueba social y casos de éxito de TuSitioYa.",
  "texto_cierre_corto": "Respuesta corta de WhatsApp (máx 3 líneas) que neutraliza la objeción y mantiene la conversación viva."
}`,

                        cliente_probable: `Actúa como Alexis Ferrada de TuSitioYa, analista de oportunidades de venta.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISIÓN: Evalúa la probabilidad real de cierre, identifica señales de compra y define el próximo paso estratégico.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 65,
  "resumen_una_linea": "Evaluación del potencial en 15 palabras",
  "perfil_psicologico": "Señales de compra detectadas y perfil de decisión (rápido/lento/analítico/emocional)",
  "accion_sugerida": "Próximo paso concreto para avanzar en el funnel (demo, propuesta, seguimiento en X días)",
  "texto_cierre": "Mensaje estratégico que avanza la conversación sin presionar. Genera curiosidad y compromiso.",
  "texto_cierre_corto": "Mensaje WhatsApp de máx 3 líneas que genera un micro-compromiso (agendar llamada, ver demo, confirmar interés)."
}`,

                        primer_contacto: `Actúa como Alexis Ferrada de TuSitioYa, experto en apertura de conversaciones de venta.
CLIENTE POTENCIAL: ${nombre} de "${negocio}" (${rubro}).
CONTEXTO: Es el primer contacto. El cliente no nos conoce aún.

MISIÓN: Genera el mensaje de apertura perfecto que genere interés inmediato, sin parecer spam ni vendedor agresivo.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "${rubro}",
  "probabilidad_cierre": 40,
  "resumen_una_linea": "Estrategia de primer contacto para ${negocio}",
  "perfil_psicologico": "Dolor probable del negocio basado en su rubro y la falta de presencia digital",
  "accion_sugerida": "Enviar mensaje de apertura personalizado con gancho específico del rubro",
  "texto_cierre": "Script completo de primer contacto: saludo personalizado, gancho con dolor específico del rubro, propuesta de valor de TuSitioYa, beneficios clave y pregunta de apertura. Tono cercano y profesional.",
  "texto_cierre_corto": "Mensaje WhatsApp de apertura de máx 3 líneas. Personalizado para ${negocio}. Termina con pregunta abierta."
}`,

                        negociar_precio: `Actúa como Alexis Ferrada de TuSitioYa, experto en negociación de valor y precios.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISIÓN: El cliente considera que el precio es alto. Genera argumentos de valor irrefutables y alternativas de pago que faciliten el cierre.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 55,
  "resumen_una_linea": "Situación de negociación en 15 palabras",
  "perfil_psicologico": "Sensibilidad al precio y motivación real de compra",
  "accion_sugerida": "Estrategia de negociación: anclar valor, ofrecer plan de pago 50/50, mostrar ROI",
  "texto_cierre": "Script de negociación que justifica el precio con ROI concreto para su rubro, compara con alternativas más caras, y ofrece el plan de pago 50% inicio / 50% entrega como ventaja. Incluye urgencia de cupos limitados.",
  "texto_cierre_corto": "Mensaje WhatsApp de máx 3 líneas que reencuadra el precio como inversión y propone el plan de pago."
}`,

                        reactivar_lead: `Actúa como Alexis Ferrada de TuSitioYa, experto en reactivación de leads fríos.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura: FRÍO (sin respuesta hace tiempo).
HISTORIAL DE CONTACTO:\n${historialTexto}

MISIÓN: El cliente dejó de responder. Genera un mensaje de reactivación que genere curiosidad y rompa el silencio sin parecer desesperado.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 30,
  "resumen_una_linea": "Situación del lead frío en 15 palabras",
  "perfil_psicologico": "Razón probable del silencio (precio, timing, olvidó, no le convenció)",
  "accion_sugerida": "Táctica de reactivación: nuevo ángulo, FOMO, novedad o pregunta directa",
  "texto_cierre": "Script de reactivación con un ángulo completamente nuevo. Puede ser: una novedad del servicio, un caso de éxito del mismo rubro, o una pregunta directa y honesta. Evita el clásico 'solo quería saber si...'",
  "texto_cierre_corto": "Mensaje WhatsApp de máx 3 líneas que rompe el silencio con curiosidad o FOMO. Sorprendente y directo."
}`
                    };

                    const titulos = {
                        cerrar_venta:       '🤝 Estrategia de Cierre',
                        manejar_objeciones: '🛡️ Manejo de Objeciones',
                        cliente_probable:   '🎯 Evaluación de Probabilidad',
                        primer_contacto:    '📞 Script de Primer Contacto',
                        negociar_precio:    '💰 Negociación de Precio',
                        reactivar_lead:     '🔄 Reactivación de Lead Frío'
                    };

                    try {
                        const systemPrompt = prompts[tipo] || prompts.cerrar_venta;
                        const model = document.getElementById('model-selector').value;

                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: systemPrompt, model: model })
                        });

                        if (!res.ok) {
                            const errorData = await res.json().catch(() => ({}));
                            throw new Error(errorData.error || `Error de la API: ${res.statusText}`);
                        }

                        const data = await res.json();
                        if (!data || !data.analisis) throw new Error("La IA no devolvió un análisis válido.");

                        let analisisObj = {};
                        try {
                            const cleanJson = data.analisis.replace(/```json/g, '').replace(/```/g, '').trim();
                            analisisObj = JSON.parse(cleanJson);
                        } catch (e) {
                            analisisObj = {
                                texto_cierre: data.analisis,
                                probabilidad_cierre: 50,
                                resumen_una_linea: "Análisis generado",
                                perfil_psicologico: "Ver texto completo abajo",
                                accion_sugerida: "Revisar respuesta de la IA"
                            };
                        }

                        const prob = parseInt(analisisObj.probabilidad_cierre) || 0;
                        let colorProb = 'red';
                        if (prob > 40) colorProb = 'yellow';
                        if (prob > 70) colorProb = 'emerald';

                        const modelShort = model.split('/').pop();

                        resultContainer.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex items-center justify-between pb-2 border-b border-slate-100">
                                    <span class="text-xs font-bold text-slate-700">${titulos[tipo] || 'Análisis IA'}</span>
                                    <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-mono">${modelShort}</span>
                                </div>

                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Probabilidad de Cierre</span>
                                    <span class="text-sm font-bold text-${colorProb}-600">${prob}%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                    <div class="bg-${colorProb}-500 h-full rounded-full transition-all duration-1000" style="width:${prob}%"></div>
                                </div>

                                <div class="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                    <div class="flex justify-between items-center mb-1">
                                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">RESUMEN</p>
                                        <span class="text-[9px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded font-bold uppercase">${analisisObj.rubro_detectado || 'General'}</span>
                                    </div>
                                    <p class="text-xs text-slate-700 font-medium leading-snug">${analisisObj.resumen_una_linea || '...'}</p>
                                </div>

                                <div class="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">PSICOLOGÍA & PERFIL</p>
                                    <p class="text-[10px] text-slate-600 leading-snug">${analisisObj.perfil_psicologico || '...'}</p>
                                </div>

                                <div class="bg-blue-50 p-2.5 rounded-lg border border-blue-100">
                                    <p class="text-[9px] font-bold text-blue-400 uppercase tracking-wider mb-1"><i class="fa-solid fa-bolt mr-1"></i>ACCIÓN SUGERIDA</p>
                                    <p class="text-[10px] text-blue-700 font-semibold leading-snug">${analisisObj.accion_sugerida || '...'}</p>
                                </div>

                                <div class="bg-emerald-50 p-2.5 rounded-lg border border-emerald-100">
                                    <p class="text-[9px] font-bold text-emerald-500 uppercase tracking-wider mb-1.5"><i class="fa-solid fa-comment-dots mr-1"></i>SCRIPT COMPLETO</p>
                                    <p class="text-[10px] text-slate-700 leading-relaxed whitespace-pre-wrap">${analisisObj.texto_cierre || '...'}</p>
                                </div>

                                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-3 rounded-xl shadow-md shadow-emerald-500/20">
                                    <div class="flex items-center justify-between mb-1.5">
                                        <p class="text-[9px] font-bold text-emerald-100 uppercase tracking-wider"><i class="fa-brands fa-whatsapp mr-1"></i>MENSAJE WHATSAPP</p>
                                        <button onclick="navigator.clipboard.writeText(this.closest('.bg-gradient-to-br').querySelector('p.text-white').innerText).then(()=>App.ui.notificar('Copiado al portapapeles','OK','exito'))" class="text-[9px] bg-white/20 hover:bg-white/30 text-white px-2 py-0.5 rounded font-bold transition-colors flex items-center gap-1">
                                            <i class="fa-solid fa-copy"></i> Copiar
                                        </button>
                                    </div>
                                    <p class="text-white text-xs font-medium leading-relaxed whitespace-pre-wrap">${analisisObj.texto_cierre_corto || '...'}</p>
                                </div>
                            </div>`;

                    } catch (err) {
                        resultContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-6 gap-2 text-center">
                            <i class="fa-solid fa-triangle-exclamation text-red-400 text-2xl"></i>
                            <p class="text-xs font-bold text-red-600">Error al analizar</p>
                            <p class="text-[10px] text-slate-400">${err.message}</p>
                        </div>`;
                        App.ui.notificar(err.message || "Error al analizar.", "Error IA", "error");
                    } finally {
                        btnEl.disabled = false;
                        btnEl.innerHTML = originalHTML;
                    }
                },

                guardarManual: async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const rut = formData.get('rut');

                    // Validación de RUT Duplicado
                    if (rut && App.datos.leads.some(l => l.rut === rut)) {
                        App.ui.notificar("El RUT ingresado ya existe en la base de datos.", "RUT Duplicado", "error");
                        return;
                    }

                    const nuevoLead = {
                        negocio: formData.get('negocio'),
                        nombre: formData.get('nombre'),
                        whatsapp: formData.get('whatsapp'),
                        propuesta_text: formData.get('propuesta'),
                        monto_total: 72000,
                        dominio: formData.get('dominio').toLowerCase(),
                        rut: rut,
                        email: formData.get('email'),
                        rubro: formData.get('rubro'),
                        url: formData.get('url')
                    };

                    try {
                        const res = await fetch('/api/clientes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(nuevoLead)
                        });
                        
                        if (res.ok) {
                            const leadGuardado = await res.json();
                            leadGuardado.estado = 'nuevos';
                            leadGuardado.propuesta = leadGuardado.propuesta_text || 'Cliente creado manualmente.';
                            
                            // 1. Agregar al inicio de la lista
                            App.datos.leads.unshift(leadGuardado);
                            // 2. Renderizar para que aparezca en el DOM
                            App.ui.renderizarListas();
                            // 3. Cerrar modal de creación
                            App.ui.toggleModal('modal-nuevo-cliente', false);
                            // 4. ABRIR LA FICHA INMEDIATAMENTE (Índice 0 porque hicimos unshift)
                            App.cliente.abrir(0);
                            e.target.reset();
                        }
                    } catch (err) {
                        console.error("Error guardando lead manual:", err);
                        App.ui.notificar("No se pudo guardar el lead. Revisa tu conexión a internet.", "Error de Red", "error");
                    }
                }
            },
            
            discador: {
                activo: false,
                cola: [],
                indiceActual: 0,
                iniciar: () => {
                    // Filtrar leads AGENDADOS (con fecha de seguimiento)
                    // Ordenados por fecha (los más antiguos/urgentes primero)
                    App.discador.cola = App.datos.leads
                        .filter(l => l.fecha_agendada && l.estado !== 'descartados' && l.estado !== 'cerrados')
                        .sort((a, b) => new Date(a.fecha_agendada) - new Date(b.fecha_agendada));

                    if (App.discador.cola.length === 0) {
                        App.ui.notificar("No hay leads agendados para procesar.", "Discador", "info");
                        return;
                    }
                    App.discador.activo = true;
                    App.discador.indiceActual = 0;
                    App.discador.cargarActual();
                },
                cargarActual: () => {
                    if (App.discador.indiceActual >= App.discador.cola.length) {
                        App.discador.detener();
                        App.ui.notificar("¡Has terminado la lista de agendados!", "Discador Finalizado", "exito");
                        return;
                    }
                    const lead = App.discador.cola[App.discador.indiceActual];
                    const realIndex = App.datos.leads.indexOf(lead);
                    App.cliente.abrir(realIndex);
                },
                siguiente: () => {
                    App.discador.indiceActual++;
                    App.discador.cargarActual();
                },
                detener: () => {
                    App.discador.activo = false;
                    App.ui.toggleModal('modal-ficha-cliente', false);
                }
            },

            agenda: {
                abrir: () => {
                    const lista = document.getElementById('agenda-lista');
                    lista.innerHTML = '';
                    const agendados = App.datos.leads.filter(l => l.estado === 'seguimiento');
                    if (agendados.length === 0) { lista.innerHTML = '<div class="text-center py-10 text-slate-400">Nada pendiente hoy.</div>'; } 
                    else {
                        agendados.forEach((lead) => {
                            const realIndex = App.datos.leads.indexOf(lead);
                            const item = document.createElement('div');
                            item.className = "bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm mb-2";
                            item.innerHTML = `<div><h4 class="font-bold text-slate-800">${lead.negocio}</h4><p class="text-xs text-blue-500 font-bold">${lead.fecha_agendada ? '📅 '+lead.fecha_agendada : 'En contacto'}</p></div><button onclick="App.cliente.abrir(${realIndex})" class="px-4 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg">Ver</button>`;
                            lista.appendChild(item);
                        });
                    }
                    App.ui.toggleModal('modal-agenda', true);
                }
            },

            calendario: {
                fechaActual: new Date(),
                abrir: () => {
                    App.calendario.fechaActual = new Date();
                    App.calendario.renderizar();
                    App.ui.toggleModal('modal-calendario', true);
                },
                cambiarMes: (delta) => {
                    App.calendario.fechaActual.setMonth(App.calendario.fechaActual.getMonth() + delta);
                    App.calendario.renderizar();
                },
                renderizar: () => {
                    const fecha = App.calendario.fechaActual;
                    const mes = fecha.getMonth();
                    const anio = fecha.getFullYear();
                    
                    const opciones = { month: 'long', year: 'numeric' };
                    document.getElementById('calendario-titulo').innerText = fecha.toLocaleDateString('es-ES', opciones);

                    const grid = document.getElementById('calendario-grid');
                    grid.innerHTML = '';

                    const primerDia = new Date(anio, mes, 1);
                    const ultimoDia = new Date(anio, mes + 1, 0);
                    const diasEnMes = ultimoDia.getDate();
                    const diaInicio = primerDia.getDay(); 

                    for (let i = 0; i < diaInicio; i++) {
                        grid.innerHTML += `<div class="bg-slate-100/50 rounded-lg min-h-[80px]"></div>`;
                    }

                    for (let dia = 1; dia <= diasEnMes; dia++) {
                        const fechaStr = `${anio}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                        const leadsDia = App.datos.leads.filter(l => l.fecha_agendada === fechaStr);
                        
                        let contenidoLeads = '';
                        if (leadsDia.length > 0) {
                            contenidoLeads = leadsDia.map(l => {
                                const realIndex = App.datos.leads.indexOf(l);
                                return `<div onclick="App.cliente.abrir(${realIndex})" class="text-[9px] bg-purple-100 text-purple-700 px-1 py-0.5 rounded mb-1 truncate cursor-pointer hover:bg-purple-200 font-bold border border-purple-200" title="${l.negocio}">${l.negocio}</div>`;
                            }).join('');
                        }

                        const esHoy = new Date().toISOString().split('T')[0] === fechaStr ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50' : 'border-slate-200 bg-white';

                        grid.innerHTML += `
                            <div class="border ${esHoy} rounded-lg p-1 min-h-[80px] flex flex-col transition-all hover:shadow-md">
                                <span class="text-xs font-bold text-slate-400 mb-1 text-right block pr-1">${dia}</span>
                                <div class="flex-1 overflow-y-auto custom-scroll space-y-1">
                                    ${contenidoLeads}
                                </div>
                            </div>
                        `;
                    }
                }
            },

            prospectorIA: {
                abrir: () => {
                    document.getElementById('ia-prompt-area').value = PROMPT_TEMPLATE;
                    const modelName = document.getElementById('model-selector').value;
                    document.getElementById('ia-model-name-btn').innerText = modelName;

                    App.ui.toggleModal('modal-ia-generador', true);
                    document.getElementById('ia-empty-state').classList.remove('hidden');
                    document.getElementById('ia-results-container').classList.add('hidden');
                    document.getElementById('ia-results-container').innerHTML = '';
                    document.getElementById('ia-loading').classList.add('hidden');
                    document.getElementById('btn-ia-guardar').classList.add('hidden');
                    App.tempLeads = [];
                },
                cerrar: () => App.ui.toggleModal('modal-ia-generador', false),
                copiarPrompt: () => {
                    const promptArea = document.getElementById('ia-prompt-area');
                    let finalPrompt = promptArea.value;
                    const rubro = document.getElementById('ia-rubro').value || 'negocios';
                    const ciudad = document.getElementById('ia-ciudad').value || 'Chile';
                    const cantidad = document.getElementById('ia-cantidad').value || 5;
                    finalPrompt = finalPrompt.replace(/{rubro}/g, rubro).replace(/{ciudad}/g, ciudad).replace(/{cantidad}/g, cantidad);
                    navigator.clipboard.writeText(finalPrompt).then(() => App.ui.notificar('El prompt de prospección ha sido copiado.', 'Copiado', 'exito'));
                },
                renderResultados: () => {
                    const container = document.getElementById('ia-results-container');
                    if (App.tempLeads.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-400 text-xs py-4">Sin resultados.</p>';
                        return;
                    }
                    container.innerHTML = App.tempLeads.map((l, index) => `
                        <div class="bg-white p-3 rounded border border-slate-200 mb-2 shadow-sm flex justify-between items-center group hover:border-red-200 transition-colors">
                            <div class="flex-1">
                                <p class="font-bold text-sm text-slate-700">${l.negocio}</p>
                                <p class="text-xs text-slate-500 font-mono">${l.whatsapp}</p>
                            </div>
                            <button onclick="App.prospectorIA.marcarInvalido(${index})" class="text-slate-300 hover:text-red-500 transition-colors p-2" title="Número no válido (Agregar a Excepciones)">
                                <i class="fa-solid fa-ban"></i>
                            </button>
                        </div>
                    `).join('');
                },
                marcarInvalido: (index) => {
                    const lead = App.tempLeads[index];
                    if (!lead) return;
                    
                    // Agregar a blacklist
                    const modelInfo = lead._model ? ` | Model: ${lead._model}` : '';
                    App.datos.blacklist.push(`${lead.whatsapp} (${lead.negocio})${modelInfo}`);
                    localStorage.setItem('blacklist', JSON.stringify(App.datos.blacklist));
                    App.ui.actualizarBlacklistCount();
                    
                    // Remover de tempLeads
                    App.tempLeads.splice(index, 1);
                    
                    // Re-renderizar
                    App.prospectorIA.renderResultados();
                    // Eliminación silenciosa para mayor velocidad (sin modal)
                },
                buscar: async () => {
                    const rubro = document.getElementById('ia-rubro').value;
                    if (!rubro) return App.ui.notificar("Debes especificar un rubro para iniciar la búsqueda.", "Campo Requerido", "error");

                    document.getElementById('ia-empty-state').classList.add('hidden');
                    document.getElementById('ia-loading').classList.remove('hidden');
                    document.getElementById('ia-loading').style.display = 'flex';
                    document.getElementById('ia-results-container').classList.add('hidden');

                    const ciudad = document.getElementById('ia-ciudad').value;
                    const cantidad = document.getElementById('ia-cantidad').value;
                    const model = document.getElementById('model-selector').value;
                    let prompt = document.getElementById('ia-prompt-area').value;
                    prompt = prompt.replace(/{rubro}/g, rubro).replace(/{ciudad}/g, ciudad).replace(/{cantidad}/g, cantidad);

                    try {
                        const res = await fetch('/api/prospectar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt, ciudad, model })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Error en el servidor');

                        // 1. Deduplicar resultados de la IA (por si alucina repetidos)
                        const uniqueData = [];
                        const seen = new Set();
                        data.forEach(l => {
                            const fonoLimpio = App.util.limpiarTelefono(l.whatsapp);
                            if (fonoLimpio && !seen.has(fonoLimpio)) {
                                seen.add(fonoLimpio);
                                l.whatsapp = '+' + fonoLimpio; // Formato visual +569...
                                uniqueData.push(l);
                            }
                        });

                        // Asignar modelo a los resultados
                        uniqueData.forEach(l => l._model = model);

                        // Filtrar leads que ya están en la blacklist
                        const leadsLimpios = uniqueData.filter(l => !App.datos.blacklist.some(blItem => l.whatsapp && blItem.includes(l.whatsapp.replace('+','')))); // Comparar sin el + si es necesario
                        const invalidos = uniqueData.length - leadsLimpios.length;

                        App.tempLeads = leadsLimpios;

                        // --- ANÁLISIS RÁPIDO ---
                        const total = uniqueData.length;
                        
                        App.ui.notificar(`Total Únicos: ${total}\nEn Blacklist: ${invalidos}\nDisponibles: ${leadsLimpios.length}`, "Reporte IA", "info");
                        setTimeout(() => App.ui.cerrarNotificacion(), 2000); // 2 segundos para leer
                        // --- FIN ANÁLISIS ---

                        App.prospectorIA.renderResultados();
                        document.getElementById('ia-results-container').classList.remove('hidden');
                        document.getElementById('btn-ia-guardar').classList.remove('hidden');
                    } catch (e) {
                        App.ui.notificar(e.message, "Error de la IA", "error");
                        document.getElementById('ia-empty-state').classList.remove('hidden');
                    } finally {
                        document.getElementById('ia-loading').classList.add('hidden');
                        document.getElementById('ia-loading').style.display = 'none';
                    }
                },
                guardar: async () => {
                    if (App.tempLeads.length === 0) return App.ui.notificar("No se encontraron prospectos para guardar.", "Vacío", "error");

                    // 1. Filtrar Blacklist
                    let leadsParaProcesar = App.tempLeads.filter(l => !App.datos.blacklist.some(blItem => l.whatsapp && blItem.includes(l.whatsapp.replace('+',''))));
                    
                    // 2. Verificar duplicados por DOMINIO
                    const leadsNuevos = [];
                    const leadsExistentes = [];

                    for (const l of leadsParaProcesar) {
                        const existe = App.datos.leads.find(dbLead => dbLead.dominio && l.dominio_sugerido && dbLead.dominio.toLowerCase() === l.dominio_sugerido.toLowerCase());
                        if (existe) {
                            leadsExistentes.push({ nuevo: l, original: existe });
                        } else {
                            leadsNuevos.push(l);
                        }
                    }

                    if (leadsNuevos.length === 0 && leadsExistentes.length === 0) {
                        return App.ui.notificar("No hay prospectos nuevos para guardar.", "Filtrado", "error");
                    }

                    // 3. Manejo de Duplicados
                    let actualizarDuplicados = false;
                    if (leadsExistentes.length > 0) {
                        actualizarDuplicados = await App.ui.confirmar(`Se encontraron ${leadsExistentes.length} dominios ya registrados.\n\n¿Deseas ACTUALIZAR sus datos con la nueva información de la IA?`, "Duplicados Detectados");
                        
                        if (actualizarDuplicados) {
                            for (const item of leadsExistentes) {
                                try {
                                    await fetch(`/api/clientes/${item.original.id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            ...item.nuevo, // Enviar todos los datos nuevos
                                            dominio: item.nuevo.dominio_sugerido // Mapear correctamente
                                        })
                                    });
                                } catch (e) { console.error(e); }
                            }
                        }
                    }

                    if (leadsNuevos.length === 0) { App.prospectorIA.cerrar(); return await App.init(); }

                    if (!await App.ui.confirmar(`¿Guardar ${leadsNuevos.length} nuevos prospectos?`)) return;
                    
                    await fetch('/api/prospectos/bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prospects: leadsNuevos, ciudad: document.getElementById('ia-ciudad').value })
                    });
                    
                    // 5. Finalizar
                    App.prospectorIA.cerrar();
                    await App.init(); // Recargar todo al final
                }
            },

            importar: {
                procesarJSON: async () => {
                    const area = document.getElementById('import-json-area');
                    const raw = area.value.trim();
                    if (!raw) return App.ui.notificar("El área de texto está vacía. Pega el código JSON para importar.", "Campo Vacío", "error");

                    try {
                        const data = JSON.parse(raw);
                        const prospects = Array.isArray(data) ? data : (data.prospectos || []);
                        
                        if (prospects.length === 0) throw new Error("No se encontraron prospectos en el JSON.");

                        // 1. Filtrar Blacklist (Igual que IA)
                        let leadsParaProcesar = prospects.filter(l => !App.datos.blacklist.some(blItem => l.whatsapp && blItem.includes(l.whatsapp)));
                        const descartadosBlacklist = prospects.length - leadsParaProcesar.length;

                        // 2. Verificar duplicados por DOMINIO
                        const leadsNuevos = [];
                        const leadsExistentes = [];

                        for (const l of leadsParaProcesar) {
                            // Normalizar dominio si existe
                            const dom = l.dominio_sugerido || l.dominio || '';
                            const existe = App.datos.leads.find(dbLead => dbLead.dominio && dom && dbLead.dominio.toLowerCase() === dom.toLowerCase());
                            if (existe) {
                                leadsExistentes.push({ nuevo: l, original: existe });
                            } else {
                                leadsNuevos.push(l);
                            }
                        }

                        if (leadsNuevos.length === 0 && leadsExistentes.length === 0) {
                            return App.ui.notificar(`Todos los prospectos (${descartadosBlacklist}) fueron descartados por estar en la Lista Negra.`, "Filtrado Estricto", "error");
                        }

                        // 3. Manejo de Duplicados
                        let actualizarDuplicados = false;
                        if (leadsExistentes.length > 0) {
                            actualizarDuplicados = await App.ui.confirmar(`Se encontraron ${leadsExistentes.length} dominios ya registrados en la importación.\n\n¿Deseas ACTUALIZAR sus datos?`, "Duplicados Detectados");
                            
                            if (actualizarDuplicados) {
                                for (const item of leadsExistentes) {
                                    try {
                                        await fetch(`/api/clientes/${item.original.id}`, {
                                            method: 'PUT',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ 
                                                ...item.nuevo, 
                                                dominio: item.nuevo.dominio_sugerido || item.nuevo.dominio 
                                            })
                                        });
                                    } catch (e) { console.error(e); }
                                }
                                App.ui.notificar(`${leadsExistentes.length} clientes actualizados.`, "Actualización", "exito");
                            }
                        }

                        if (leadsNuevos.length === 0) {
                            area.value = '';
                            App.ui.toggleModal('modal-prospectos', false);
                            return await App.init();
                        }

                        let msg = `¿Importar ${leadsNuevos.length} nuevos prospectos?`;
                        if (descartadosBlacklist > 0) msg += `\n(Se omitieron ${descartadosBlacklist} por Lista Negra)`;

                        if (await App.ui.confirmar(msg)) {
                            const res = await fetch('/api/prospectos/bulk', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ prospects: leadsNuevos, ciudad: 'Importación Manual' })
                            });
                            const responseData = await res.json();

                            if (res.ok) {
                                App.ui.notificar(responseData.message || `${leadsLimpios.length} prospectos fueron importados.`, "Importación Completa", "exito");
                                area.value = '';
                                App.ui.toggleModal('modal-prospectos', false);
                                await App.init(); // Recargar la lista desde la DB
                            } else {
                                let errorMessage = responseData.error || 'Error del servidor al importar.';
                                if (responseData.detalles) {
                                    const detallesFormateados = responseData.detalles.map(d => `-> ${d.prospecto}: ${d.error}`).join('\n');
                                    errorMessage += `\n\nDetalles:\n${detallesFormateados}`;
                                }
                                throw new Error(errorMessage);
                            }
                        }
                    } catch (e) {
                        App.ui.notificar(e.message, "Error al Procesar JSON", "error");
                    }
                }
            },

            monitor: {
                staticSites: [
                    { url: 'www.entradasya.cl', name: 'EntradasYa', status: 'pending' },
                    { url: 'www.turbopos.cl', name: 'TurboPOS', status: 'pending' },
                    { url: 'https://tusitioya.onrender.com/', name: 'TuSitioYa App', status: 'pending' }
                ],
                sites: [],
                timerId: null,
                alertasSilenciadas: false,
                init: () => {
                    const guardado = localStorage.getItem('monitorIntervalo') || '60000';
                    document.getElementById('monitor-intervalo').value = guardado;

                    App.ui.verificarPermisoNotificaciones();
    
                    const muted = localStorage.getItem('monitorAlertsMuted') === 'true';
                    App.monitor.alertasSilenciadas = muted;
                    App.monitor.actualizarBotonMute();

                    App.monitor.sincronizar();
                    App.monitor.checkAll();
                    App.monitor.cambiarIntervalo(guardado, true);
                },
                toggleMute: () => {
                    App.monitor.alertasSilenciadas = !App.monitor.alertasSilenciadas;
                    localStorage.setItem('monitorAlertsMuted', App.monitor.alertasSilenciadas);
                    App.monitor.actualizarBotonMute();
                    const estado = App.monitor.alertasSilenciadas ? 'silenciadas' : 'activadas';
                    App.ui.notificar(`Alertas del monitor ${estado}.`, "Monitor", "info");
                },
                actualizarBotonMute: () => {
                    const btn = document.getElementById('monitor-mute-btn');
                    if (!btn) return;
                    if (App.monitor.alertasSilenciadas) {
                        btn.innerHTML = '<i class="fa-solid fa-bell-slash"></i>';
                        btn.title = "Activar alertas";
                        btn.classList.add('text-red-500', 'bg-red-50');
                    } else {
                        btn.innerHTML = '<i class="fa-solid fa-bell"></i>';
                        btn.title = "Silenciar alertas";
                        btn.classList.remove('text-red-500', 'bg-red-50');
                    }
                },
                cambiarIntervalo: (ms, silent = false) => {
                    if (App.monitor.timerId) clearInterval(App.monitor.timerId);
                    
                    const milisegundos = parseInt(ms);
                    App.monitor.timerId = setInterval(App.monitor.checkAll, milisegundos);
                    localStorage.setItem('monitorIntervalo', milisegundos);
                    
                    if (!silent) {
                        const texto = milisegundos < 60000 ? `${milisegundos/1000}s` : `${milisegundos/60000}m`;
                        App.ui.notificar(`Intervalo de refresco cambiado a ${texto}.`, "Monitor", "info");
                    }
                },
                sincronizar: () => {
                    // Obtener clientes activos con dominio
                    const clientesActivos = App.datos.leads.filter(l => l.estado === 'cerrados' && l.dominio);
                    const sitiosClientes = clientesActivos.map(c => ({
                        url: c.dominio,
                        name: c.negocio,
                        status: 'pending'
                    }));

                    // Preservar estado de sitios ya chequeados para no reiniciar a 'pending' visualmente
                    const estadoActual = new Map(App.monitor.sites.map(s => [s.url, s.status]));
                    
                    App.monitor.sites = [...App.monitor.staticSites, ...sitiosClientes].map(s => ({
                        ...s,
                        status: estadoActual.get(s.url) || 'pending'
                    }));
                    
                    App.monitor.render();
                },
                render: () => {
                    const container = document.getElementById('monitor-sites-list');
                    if (!container) return;
                    container.innerHTML = App.monitor.sites.map(site => {
                        let statusClass = 'bg-slate-100 border-slate-200 text-slate-400';
                        let statusVisual = '<i class="fa-solid fa-circle-notch fa-spin text-lg mb-1"></i>';
                        let statusLabel = 'Verificando...';
                        let extraCardClass = '';

                        if (site.status === 'online') {
                            statusClass = 'bg-emerald-50 border-emerald-200 text-emerald-600';
                            statusVisual = `
                                <svg width="40" height="24" viewBox="0 0 40 24" class="mb-1">
                                    <path class="ekg-line" d="M0 12 H 5 L 10 6 L 15 18 L 20 12 H 25 L 30 9 L 35 15 L 40 12" stroke="#10b981" stroke-width="2" fill="none"/>
                                </svg>
                            `;
                            statusLabel = 'ONLINE';
                        } else if (site.status === 'offline') {
                            statusClass = 'bg-red-50 border-red-200 text-red-600';
                            statusVisual = '<i class="fa-solid fa-circle-xmark text-lg mb-1"></i>';
                            statusLabel = 'OFFLINE';
                            extraCardClass = 'monitor-offline-bg';
                        }
                        return `
                            <div class="relative p-3 rounded-xl border ${statusClass} flex items-center justify-between shadow-sm bg-white/80 backdrop-blur-sm transition-all hover:scale-[1.02] ${extraCardClass}">
                                <div class="flex items-center gap-3 min-w-0">
                                    <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center shadow-sm border border-slate-100 text-slate-600 flex-shrink-0">
                                        <i class="fa-solid fa-globe"></i>
                                    </div>
                                    <div class="overflow-hidden">
                                        <h4 class="font-bold text-xs text-slate-700 truncate">${site.name}</h4>
                                        <a href="${site.url.startsWith('http') ? site.url : 'https://' + site.url}" target="_blank" class="text-[9px] text-slate-400 hover:text-blue-500 truncate block">${site.url}</a>
                                    </div>
                                </div>
                                <div class="text-right pl-2 flex-shrink-0 flex flex-col items-end">
                                    ${statusVisual}
                                    <p class="text-[8px] font-black tracking-widest">${statusLabel}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                },
                checkAll: async () => {
                    const ahora = new Date();
                    const hora = ahora.getHours();
                    const esNoche = hora >= 22 || hora < 8; // 10 PM a 8 AM

                    for (let i = 0; i < App.monitor.sites.length; i++) {
                        const site = App.monitor.sites[i];
                        const oldStatus = site.status;
                        const snoozeKey = `snooze_${site.url}`;

                        // Lógica de Snooze/Recordatorio
                        const lastSnooze = localStorage.getItem(snoozeKey);
                        if (lastSnooze) {
                            const tresHoras = 3 * 60 * 60 * 1000;
                            if (Date.now() - parseInt(lastSnooze) > tresHoras) {
                                if (!esNoche && oldStatus === 'offline') {
                                    const title = `⏰ Recordatorio: Sitio Caído`;
                                    const body = `El sitio "${site.name}" sigue OFFLINE.`;
                                    if (Notification.permission === 'granted') {
                                        new Notification(title, { body: body, icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>' });
                                    }
                                    localStorage.setItem(snoozeKey, Date.now().toString()); // Actualizar timestamp
                                }
                            }
                        }

                        try {
                            const res = await fetch('/api/check-site', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: site.url })
                            });
                            const data = await res.json();
                            const newStatus = data.status;
                            App.monitor.sites[i].status = newStatus;

                            if (oldStatus !== 'offline' && newStatus === 'offline') {
                                App.monitor.notificarCaida(site);
                            }
                            if (oldStatus === 'offline' && newStatus === 'online') {
                                localStorage.removeItem(snoozeKey);
                            }

                        } catch (e) {
                            const newStatus = 'offline';
                            if (oldStatus !== 'offline') {
                                App.monitor.notificarCaida(site);
                            }
                            App.monitor.sites[i].status = newStatus;
                        }
                    }
                    App.monitor.render(); // Renderizar una vez al final
                },
                notificarCaida: (site) => {
                    if (App.monitor.alertasSilenciadas) {
                        const snoozeKey = `snooze_${site.url}`;
                        if (!localStorage.getItem(snoozeKey)) {
                            localStorage.setItem(snoozeKey, Date.now().toString());
                            console.log(`Sitio ${site.name} caído. Alertas silenciadas, iniciando snooze.`);
                        }
                        return;
                    }

                    const title = `🚨 ¡Sitio Caído!`;
                    const body = `El sitio "${site.name}" (${site.url}) está OFFLINE.`;
                    
                    if (Notification.permission === 'granted') {
                        new Notification(title, { body: body, icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>' });
                    }

                    const sound = document.getElementById('alert-sound');
                    if (sound) {
                        sound.play().catch(e => console.warn("No se pudo reproducir el sonido de alerta:", e));
                    }
                }
            },

            conversion: {
                periodo: 'hoy',
                init: function() {
                    this.render();
                },
                cambiarPeriodo: function(nuevoPeriodo) {
                    this.periodo = nuevoPeriodo;
                    document.querySelectorAll('#conversion-filtros button').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`#conversion-filtros button[onclick="App.conversion.cambiarPeriodo('${nuevoPeriodo}')"]`).classList.add('active');
                    this.render();
                },
                render: function() {
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    let startDate, endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);

                    switch (this.periodo) {
                        case 'hoy': startDate = hoy; break;
                        case 'ayer':
                            startDate = new Date(hoy); startDate.setDate(hoy.getDate() - 1);
                            endDate = new Date(hoy); endDate.setDate(hoy.getDate() - 1); endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'semana':
                            startDate = new Date(hoy);
                            const diaSemana = hoy.getDay();
                            const diff = hoy.getDate() - diaSemana + (diaSemana === 0 ? -6 : 1);
                            startDate.setDate(diff);
                            break;
                        case 'mes':
                            startDate = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                            break;
                    }

                    const leadsPeriodo = App.datos.leads.filter(l => l.created_at && new Date(l.created_at) >= startDate && new Date(l.created_at) <= endDate);
                    const nuevosEnPeriodo = leadsPeriodo.length;
                    const cerradosEnPeriodo = leadsPeriodo.filter(l => l.estado === 'cerrados').length;

                    const efectividadTotal = (nuevosEnPeriodo > 0) ? Math.round((cerradosEnPeriodo / nuevosEnPeriodo) * 100) : 0;
                    document.getElementById('conv-vs-total').innerText = `${efectividadTotal}%`;
                    document.getElementById('conv-vs-total-detalle').innerText = `${cerradosEnPeriodo} cerrados de ${nuevosEnPeriodo} nuevos`;

                    const poolCualificado = leadsPeriodo.filter(l => l.estado === 'seguimiento' || l.estado === 'cerrados').length;
                    const efectividadConversando = (poolCualificado > 0) ? Math.round((cerradosEnPeriodo / poolCualificado) * 100) : 0;
                    document.getElementById('conv-vs-conversando').innerText = `${efectividadConversando}%`;
                    document.getElementById('conv-vs-conversando-detalle').innerText = `${cerradosEnPeriodo} cerrados de ${poolCualificado} cualificados`;

                    const mesActual = new Date().getMonth(); const anioActual = new Date().getFullYear();
                    const metaMes = 3 + (mesActual - 1); // Meta 3 para Febrero (mes 1), 4 para Marzo, etc.
                    const cerradosEsteMes = App.datos.leads.filter(l => l.estado === 'cerrados' && l.created_at && new Date(l.created_at).getMonth() === mesActual && new Date(l.created_at).getFullYear() === anioActual).length;
                    const efectividadMeta = (metaMes > 0) ? Math.round((cerradosEsteMes / metaMes) * 100) : 0;
                    document.getElementById('conv-vs-meta').innerText = `${efectividadMeta}%`;
                    document.getElementById('conv-vs-meta-detalle').innerText = `${cerradosEsteMes} cerrados de ${metaMes} este mes`;

                    // --- TENDENCIAS (Últimos 7 días) ---
                    const last7Days = Array.from({length: 7}, (_, i) => {
                        const d = new Date();
                        d.setDate(d.getDate() - (6 - i));
                        return d;
                    });

                    const trendTotal = [];
                    const trendConversando = [];
                    const trendMeta = [];

                    last7Days.forEach(date => {
                        const dateStr = date.toLocaleDateString(); 
                        const startOfDay = new Date(date); startOfDay.setHours(0,0,0,0);
                        const endOfDay = new Date(date); endOfDay.setHours(23,59,59,999);

                        const createdCount = App.datos.leads.filter(l => {
                            const cDate = new Date(l.created_at);
                            return cDate >= startOfDay && cDate <= endOfDay;
                        }).length;

                        const closedCount = App.datos.leads.filter(l => l.estado === 'cerrados' && l.historial && l.historial.some(h => h.nota.includes('VENTA CERRADA') && h.fecha.includes(dateStr))).length;
                        
                        const contactedCount = App.datos.leads.filter(l => l.historial && l.historial.some(h => (h.nota.includes('WhatsApp Enviado') || h.nota.includes('Agendado')) && h.fecha.includes(dateStr))).length;

                        // 1. Efectividad Total (Cerrados / Creados)
                        trendTotal.push(createdCount > 0 ? Math.round((closedCount / createdCount) * 100) : 0);

                        // 2. Efectividad Conversación (Cerrados / Contactados)
                        trendConversando.push(contactedCount > 0 ? Math.round((closedCount / contactedCount) * 100) : 0);

                        // 3. Meta (Volumen de Ventas Diario)
                        trendMeta.push(closedCount);
                    });

                    App.ui.renderSparkline('chart-conv-total', trendTotal, '#10b981');
                    App.ui.renderSparkline('chart-conv-conversando', trendConversando, '#3b82f6');
                    App.ui.renderSparkline('chart-conv-meta', trendMeta, '#9333ea');
                }
            },

            conversion: {
                periodo: 'hoy',
                init: function() {
                    this.render();
                },
                cambiarPeriodo: function(nuevoPeriodo) {
                    this.periodo = nuevoPeriodo;
                    document.querySelectorAll('#conversion-filtros button').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`#conversion-filtros button[onclick="App.conversion.cambiarPeriodo('${nuevoPeriodo}')"]`).classList.add('active');
                    this.render();
                },
                render: function() {
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    let startDate, endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);

                    switch (this.periodo) {
                        case 'hoy': startDate = hoy; break;
                        case 'ayer':
                            startDate = new Date(hoy); startDate.setDate(hoy.getDate() - 1);
                            endDate = new Date(hoy); endDate.setDate(hoy.getDate() - 1); endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'semana':
                            startDate = new Date(hoy);
                            const diaSemana = hoy.getDay();
                            const diff = hoy.getDate() - diaSemana + (diaSemana === 0 ? -6 : 1);
                            startDate.setDate(diff);
                            break;
                        case 'mes':
                            startDate = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                            break;
                    }

                    const leadsPeriodo = App.datos.leads.filter(l => l.created_at && new Date(l.created_at) >= startDate && new Date(l.created_at) <= endDate);
                    const nuevosEnPeriodo = leadsPeriodo.length;
                    const cerradosEnPeriodo = leadsPeriodo.filter(l => l.estado === 'cerrados').length;

                    const efectividadTotal = (nuevosEnPeriodo > 0) ? Math.round((cerradosEnPeriodo / nuevosEnPeriodo) * 100) : 0;
                    const elTotal = document.getElementById('conv-vs-total');
                    elTotal.innerText = `${efectividadTotal}%`;
                    // Alerta visual si es menor al 3%
                    if (efectividadTotal < 3) elTotal.className = "text-lg font-black text-red-500";
                    else elTotal.className = "text-lg font-black text-emerald-600";
                    
                    document.getElementById('conv-vs-total-detalle').innerText = `${cerradosEnPeriodo} cerrados de ${nuevosEnPeriodo} nuevos`;

                    const poolCualificado = leadsPeriodo.filter(l => l.estado === 'seguimiento' || l.estado === 'cerrados').length;
                    const efectividadConversando = (poolCualificado > 0) ? Math.round((cerradosEnPeriodo / poolCualificado) * 100) : 0;
                    document.getElementById('conv-vs-conversando').innerText = `${efectividadConversando}%`;
                    document.getElementById('conv-vs-conversando-detalle').innerText = `${cerradosEnPeriodo} cerrados de ${poolCualificado} cualificados`;

                    const mesActual = new Date().getMonth(); const anioActual = new Date().getFullYear();
                    const metaMes = 3 + (mesActual - 1); // Meta 3 para Febrero (mes 1), 4 para Marzo, etc.
                    const cerradosEsteMes = App.datos.leads.filter(l => l.estado === 'cerrados' && l.created_at && new Date(l.created_at).getMonth() === mesActual && new Date(l.created_at).getFullYear() === anioActual).length;
                    const efectividadMeta = (metaMes > 0) ? Math.round((cerradosEsteMes / metaMes) * 100) : 0;
                    document.getElementById('conv-vs-meta').innerText = `${efectividadMeta}%`;
                    document.getElementById('conv-vs-meta-detalle').innerText = `${cerradosEsteMes} cerrados de ${metaMes} este mes`;
                }
            },

            logros: {
                hitos: [
                    { id: 'first_blood', cantidad: 1, icono: 'fa-medal', color: 'text-amber-600', titulo: 'Primera Venta' },
                    { id: 'bronze', cantidad: 5, icono: 'fa-trophy', color: 'text-orange-400', titulo: 'Vendedor Bronce' },
                    { id: 'silver', cantidad: 10, icono: 'fa-trophy', color: 'text-slate-400', titulo: 'Vendedor Plata' },
                    { id: 'gold', cantidad: 20, icono: 'fa-trophy', color: 'text-yellow-400', titulo: 'Vendedor Oro' },
                    { id: 'diamond', cantidad: 50, icono: 'fa-gem', color: 'text-blue-400', titulo: 'Leyenda' }
                ],
                verificar: () => {
                    const ventas = App.datos.leads.filter(l => l.estado === 'cerrados').length;
                    const container = document.getElementById('logros-container');
                    if(!container) return;
                    
                    container.innerHTML = App.logros.hitos.map(hito => {
                        const desbloqueado = ventas >= hito.cantidad;
                        const opacity = desbloqueado ? 'opacity-100 scale-110' : 'opacity-20 grayscale';
                        return `<div class="flex flex-col items-center gap-1 group/icon relative" title="${hito.titulo} (${hito.cantidad} ventas)"><i class="fa-solid ${hito.icono} ${hito.color} text-xl transition-all duration-500 ${opacity}"></i>${desbloqueado ? '<div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>' : ''}</div>`;
                    }).join('');
                    
                    const lastCount = parseInt(localStorage.getItem('last_sales_count') || 0);
                    if (ventas > lastCount) {
                        const newUnlock = App.logros.hitos.find(h => h.cantidad === ventas);
                        if (newUnlock) {
                            App.ui.notificar(`¡Has desbloqueado: ${newUnlock.titulo}!`, "🏆 Logro Desbloqueado", "exito");
                            App.ui.lanzarConfeti();
                        }
                        localStorage.setItem('last_sales_count', ventas);
                    }
                }
            },

            ui: {
                toggleAccordion: (id) => { document.getElementById(`list-${id}`).classList.toggle('open'); },
                toggleModal: (id, show) => { const el = document.getElementById(id); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); },
                actualizarBlacklistCount: () => {
                    document.getElementById('blacklist-count').innerText = App.datos.blacklist.length;
                    const elExcepciones = document.getElementById('metric-excepciones');
                    if (elExcepciones) elExcepciones.innerText = App.datos.blacklist.length;
                    
                    // Calcular peor modelo
                    const modelCounts = {};
                    App.datos.blacklist.forEach(item => {
                        if (item.includes('| Model:')) {
                            const model = item.split('| Model:')[1].trim();
                            modelCounts[model] = (modelCounts[model] || 0) + 1;
                        }
                    });
                    
                    let worstModel = '';
                    let maxCount = 0;
                    for (const [model, c] of Object.entries(modelCounts)) {
                        if (c > maxCount) { maxCount = c; worstModel = model; }
                    }
                    
                    const worstEl = document.getElementById('blacklist-worst-model');
                    if (worstModel) { worstEl.innerText = `Peor: ${worstModel} (${maxCount})`; worstEl.classList.remove('hidden'); } else { worstEl.classList.add('hidden'); }

                },
                mostrarEntregasHoy: () => {
                    const hoyISO = new Date().toISOString().split('T')[0];
                    const lista = document.getElementById('entregas-hoy-lista');
                    lista.innerHTML = '';
                    
                    const entregas = App.datos.leads.filter(l => {
                        const fechaEntrega = l.fecha_proximo_pago ? l.fecha_proximo_pago.split('T')[0] : null;
                        return l.estado === 'cerrados' && fechaEntrega === hoyISO;
                    });

                    if (entregas.length === 0) {
                        lista.innerHTML = '<div class="text-center py-10 text-slate-400">No hay entregas programadas para hoy.</div>';
                    } else {
                        entregas.forEach((lead) => {
                            const realIndex = App.datos.leads.indexOf(lead);
                            const deuda = Math.max(0, (lead.monto_total || 0) - (lead.monto_pagado || 0));
                            const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
                            
                            const item = document.createElement('div');
                            item.className = "bg-white p-4 rounded-xl border border-blue-100 flex justify-between items-center shadow-sm mb-2 hover:border-blue-300 transition-colors";
                            item.innerHTML = `
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm">${lead.negocio}</h4>
                                    <p class="text-xs text-slate-500">${lead.nombre || 'Sin contacto'}</p>
                                    <p class="text-[10px] font-bold text-red-500 mt-1">Por cobrar: ${formatter.format(deuda)}</p>
                                </div>
                                <button onclick="App.cliente.abrir(${realIndex}); App.ui.toggleModal('modal-entregas-hoy', false);" class="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg hover:bg-blue-100">Ver Ficha</button>
                            `;
                            lista.appendChild(item);
                        });
                    }
                    App.ui.toggleModal('modal-entregas-hoy', true);
                },
                buscar: (termino) => {
                    App.filtroBusqueda = termino.toLowerCase().trim();
                    App.ui.renderizarListas();
                },
                renderizarListas: () => {
                    const estados = ['nuevos', 'whatsapp_enviado', 'sin_respuesta', 'seguimiento', 'cerrados']; // 'descartados' y 'agendados' se manejan diferente
                    const contadores = { nuevos: 0, whatsapp_enviado: 0, sin_respuesta: 0, seguimiento: 0, agendados: 0, cerrados: 0, descartados: 0 };
                    
                    // Limpiar contenedores
                    estados.forEach(id => {
                        const el = document.getElementById(`list-${id}`);
                        if(el) el.innerHTML = '';
                    });

                    // Filtrar leads según búsqueda
                    const leadsFiltrados = App.datos.leads.filter(lead => {
                        if (!App.filtroBusqueda) return true;
                        const term = App.filtroBusqueda;
                        // Búsqueda potente: concatena todo para buscar
                        const dataString = `${lead.negocio} ${lead.nombre} ${lead.whatsapp} ${lead.dominio || ''}`.toLowerCase();
                        return dataString.includes(term);
                    });

                    leadsFiltrados.forEach((lead) => {
                        // IMPORTANTE: Usamos el índice original para que al hacer click abra el lead correcto
                        const originalIndex = App.datos.leads.indexOf(lead);

                        // Determinar estado UI
                        let estadoUI = lead.estado || 'nuevos';
                        if (!contadores.hasOwnProperty(estadoUI)) estadoUI = 'nuevos';

                        // Contar agendados para métricas, pero visualmente se quedan en su estado original (ej: seguimiento)
                        if (lead.fecha_agendada) {
                            contadores.agendados++;
                        }

                        if (contadores[estadoUI] !== undefined) {
                            contadores[estadoUI]++;
                            
                            let extraInfo = '<i class="fa-solid fa-chevron-right text-[9px] text-slate-400"></i>';
                            if (lead.fecha_agendada && estadoUI === 'agendados') extraInfo = `<span class="text-[9px] font-bold text-purple-500 bg-purple-50 px-1 rounded">${lead.fecha_agendada.slice(5)}</span>`;
                            
                            const itemHTML = `<div onclick="App.cliente.abrir(${originalIndex})" class="p-3 mb-2 bg-white border border-emerald-100 rounded-xl hover:shadow-md hover:border-emerald-300 transition-all cursor-pointer group flex justify-between items-center"><div><span class="block text-xs font-bold text-slate-800 group-hover:text-teal-600 truncate max-w-[150px]">${lead.negocio}</span><span class="text-[9px] text-slate-500 font-mono">${lead.whatsapp}</span><span class="block text-[9px] text-teal-400 font-bold truncate max-w-[140px]">${lead.dominio || ''}</span></div>${extraInfo}</div>`;
                            const listEl = document.getElementById(`list-${estadoUI}`);
                            if(listEl) listEl.insertAdjacentHTML('beforeend', itemHTML);
                        }
                    });
                    
                    // Actualizar badges (incluyendo descartados que no tiene lista)
                    Object.keys(contadores).forEach(key => { 
                        const el = document.getElementById(`badge-${key}`); 
                        if(el) el.innerText = contadores[key]; 
                    });
                    
                    document.getElementById('metric-total').innerText = App.datos.leads.length;
                    document.getElementById('metric-validos').innerText = contadores.seguimiento + contadores.agendados; 

                    // Si hay búsqueda activa, abrir automáticamente los acordeones que tengan resultados
                    if (App.filtroBusqueda !== '') {
                        estados.forEach(id => {
                            if (contadores[id] > 0) {
                                document.getElementById(`list-${id}`).classList.add('open');
                            }
                        });
                    }

                    App.ui.actualizarMetas();
                    App.ui.actualizarFinanzas();
                    App.conversion.render();
                    App.logros.verificar();
                },
                actualizarMetas: () => {
                    const hoyISO = new Date().toISOString().split('T')[0];
                    const hoyLocale = new Date().toLocaleDateString();
                    
                    // 1. Leads Nuevos Hoy
                    const leadsHoy = App.datos.leads.filter(l => l.created_at && l.created_at.startsWith(hoyISO)).length;
                    const metaLeads = 10; // Meta configurable
                    
                    const elMetaLeadsActual = document.getElementById('meta-leads-actual');
                    if (elMetaLeadsActual) {
                        elMetaLeadsActual.innerText = leadsHoy;
                        document.getElementById('meta-leads-total').innerText = metaLeads;
                        document.getElementById('barra-meta-leads').style.width = `${Math.min((leadsHoy/metaLeads)*100, 100)}%`;
                    }

                    // 2. Ventas Hoy (Estado 'cerrados' y (creado hoy O historial venta hoy))
                    let ventasHoy = 0;
                    App.datos.leads.forEach(l => {
                        if (l.estado === 'cerrados') {
                            const ventaEnHistorial = l.historial && l.historial.some(h => h.nota.includes('VENTA CERRADA') && h.fecha.includes(hoyLocale));
                            const creadoYcerradoHoy = l.created_at && l.created_at.startsWith(hoyISO);
                            if (ventaEnHistorial || creadoYcerradoHoy) ventasHoy++;
                        }
                    });
                    
                    const metaVentas = 3; // Meta configurable
                    const elMetaVentasActual = document.getElementById('meta-ventas-actual');
                    if (elMetaVentasActual) {
                        elMetaVentasActual.innerText = ventasHoy;
                        document.getElementById('meta-ventas-total').innerText = metaVentas;
                        document.getElementById('barra-meta-ventas').style.width = `${Math.min((ventasHoy/metaVentas)*100, 100)}%`;
                    }

                    // Verificar si se cumplieron ambas metas para lanzar confeti
                    if (leadsHoy >= metaLeads && ventasHoy >= metaVentas) {
                        App.ui.lanzarConfeti();
                    }
                },
                actualizarFinanzas: () => {
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    const hoyISO = hoy.toISOString().split('T')[0];
                    const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });

                    let totalVentasMes = 0; // Total Contratado (Mes)
                    let totalRecaudadoMes = 0; // Total Pagado (Mes)
                    let totalProyeccion = 0; // Deuda Acumulada (Global)
                    let totalHistoricoVentas = 0;
                    let countVentasMes = 0;
                    let countHistoricoVentas = 0;
                    let countEntregasHoy = 0;

                    App.datos.leads.forEach(l => {
                        const montoTotal = Number(l.monto_total) || 0;
                        const montoPagado = Number(l.monto_pagado) || 0;
                        const deuda = Math.max(0, montoTotal - montoPagado);

                        const fechaCreacion = new Date(l.created_at || new Date());
                        const esMesActual = fechaCreacion.getMonth() === mesActual && fechaCreacion.getFullYear() === anioActual;
                        const fechaEntrega = l.fecha_proximo_pago ? l.fecha_proximo_pago.split('T')[0] : null;

                        if (l.estado === 'cerrados') {
                            // Proyección (Deuda Global - Pasa de mes)
                            totalProyeccion += deuda;

                            // Entregas Hoy
                            if (fechaEntrega === hoyISO) {
                                countEntregasHoy++;
                            }

                            // Métricas del Mes
                            if (esMesActual) {
                                totalVentasMes += montoTotal;
                                totalRecaudadoMes += montoPagado;
                                countVentasMes++;
                            }
                            // Ticket Promedio
                            totalHistoricoVentas += montoTotal;
                            countHistoricoVentas++;
                        }
                    });

                    document.getElementById('finanza-ventas-mes').innerText = formatter.format(totalVentasMes);
                    document.getElementById('count-ventas-mes').innerText = countVentasMes;
                    document.getElementById('finanza-proyeccion').innerText = formatter.format(totalProyeccion);
                    document.getElementById('finanza-entregas-hoy').innerText = countEntregasHoy;
                    document.getElementById('finanza-caja-real').innerText = formatter.format(totalRecaudadoMes);
                    document.getElementById('finanza-ticket').innerText = formatter.format(countHistoricoVentas > 0 ? totalHistoricoVentas / countHistoricoVentas : 0);
                },
                lanzarConfeti: () => {
                    const container = document.getElementById('confetti-container');
                    if (!container || container.children.length > 0) return; // Evitar spam

                    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                    for (let i = 0; i < 40; i++) {
                        const el = document.createElement('div');
                        el.className = 'confetti';
                        el.style.left = Math.random() * 100 + '%';
                        el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        el.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        el.style.animationDelay = (Math.random() * 1) + 's';
                        container.appendChild(el);
                    }
                    // Limpiar después de la animación
                    setTimeout(() => { container.innerHTML = ''; }, 5000);
                },
                renderSparkline: (id, data, color) => {
                    const container = document.getElementById(id);
                    if (!container) return;
                    
                    const width = 100;
                    const height = 30;
                    const max = Math.max(...data, 1);
                    const min = 0;
                    
                    const points = data.map((val, i) => {
                        const x = (i / (data.length - 1)) * width;
                        const y = height - ((val - min) / (max - min)) * height;
                        return `${x},${y}`;
                    }).join(' ');

                    container.innerHTML = `<svg viewBox="0 0 ${width} ${height}" class="w-full h-full overflow-visible"><polyline fill="none" stroke="${color}" stroke-width="2" points="${points}" stroke-linecap="round" stroke-linejoin="round" vector-effect="non-scaling-stroke" /><circle cx="${points.split(' ').pop().split(',')[0]}" cy="${points.split(' ').pop().split(',')[1]}" r="3" fill="${color}" /></svg>`;
                },
                notificar: (mensaje, titulo = "Notificación", tipo = "info") => {
                    const modal = document.getElementById('modal-notificacion');
                    document.getElementById('notificacion-titulo').innerText = titulo;
                    document.getElementById('notificacion-mensaje').innerText = mensaje;
                    const iconoContainer = document.getElementById('notificacion-icono');
                    const btn = document.getElementById('notificacion-btn-ok');
                    
                    let icono, color;
                    switch(tipo) {
                        case 'exito': icono = '<i class="fa-solid fa-check"></i>'; color = 'emerald'; break;
                        case 'error': icono = '<i class="fa-solid fa-xmark"></i>'; color = 'red'; break;
                        default: icono = '<i class="fa-solid fa-info"></i>'; color = 'blue';
                    }
                    iconoContainer.innerHTML = icono;
                    iconoContainer.className = `mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-${color}-100 text-${color}-500`;
                    btn.className = `w-full py-2.5 font-bold rounded-lg text-white bg-${color}-500 hover:bg-${color}-600`;
                    
                    modal.classList.remove('hidden');
                },
                cerrarNotificacion: () => {
                    document.getElementById('modal-notificacion').classList.add('hidden');
                },
                confirmar: (mensaje, titulo = "¿Estás seguro?") => {
                    return new Promise((resolve) => {
                        const modal = document.getElementById('modal-confirmacion');
                        document.getElementById('confirmacion-titulo').innerText = titulo;
                        document.getElementById('confirmacion-mensaje').innerText = mensaje;
                        
                        const btnOk = document.getElementById('confirmacion-btn-ok');
                        const btnCancel = document.getElementById('confirmacion-btn-cancel');

                        const cleanup = () => {
                            btnOk.removeEventListener('click', okListener);
                            btnCancel.removeEventListener('click', cancelListener);
                        };

                        const okListener = () => { modal.classList.add('hidden'); cleanup(); resolve(true); };
                        const cancelListener = () => { modal.classList.add('hidden'); cleanup(); resolve(false); };

                        btnOk.addEventListener('click', okListener, { once: true });
                        btnCancel.addEventListener('click', cancelListener, { once: true });

                        modal.classList.remove('hidden');
                    });
                },
                prompt: (mensaje, titulo = "Ingresar Dato", defaultValue = "", type = "text") => {
                    return new Promise((resolve) => {
                        const modal = document.getElementById('modal-prompt');
                        document.getElementById('prompt-titulo').innerText = titulo;
                        document.getElementById('prompt-mensaje').innerText = mensaje;
                        const input = document.getElementById('prompt-input');
                        input.type = type;
                        input.value = defaultValue;
                        
                        const btnOk = document.getElementById('prompt-btn-ok');
                        const btnCancel = document.getElementById('prompt-btn-cancel');

                        const cleanup = () => { btnOk.removeEventListener('click', okListener); btnCancel.removeEventListener('click', cancelListener); };
                        const okListener = () => { modal.classList.add('hidden'); cleanup(); resolve(input.value); };
                        const cancelListener = () => { modal.classList.add('hidden'); cleanup(); resolve(null); };

                        btnOk.addEventListener('click', okListener, { once: true });
                        btnCancel.addEventListener('click', cancelListener, { once: true });

                        modal.classList.remove('hidden');
                        input.focus(); 
                        if (type === 'text') input.select();
                    });
                },
                toggleDashboard: () => {
                    const content = document.getElementById('dashboard-content');
                    const icon = document.getElementById('dashboard-chevron');
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden'); content.classList.add('flex'); icon.classList.remove('rotate-180');
                    } else {
                        content.classList.add('hidden'); content.classList.remove('flex'); icon.classList.add('rotate-180');
                    }
                },
                verificarPermisoNotificaciones: () => {
                    if (!("Notification" in window)) {
                        console.warn("Este navegador no soporta notificaciones de escritorio.");
                        return;
                    }
                    if (Notification.permission === 'default') {
                        document.getElementById('notification-permission-banner').classList.remove('hidden');
                    }
                },
                solicitarPermisoNotificaciones: () => {
                    Notification.requestPermission().then(permission => {
                        document.getElementById('notification-permission-banner').classList.add('hidden');
                        if (permission === 'granted') {
                            App.ui.notificar("¡Genial! Recibirás alertas de sitios caídos.", "Notificaciones Activadas", "exito");
                        } else {
                            App.ui.notificar("No se han activado las notificaciones.", "Permiso Denegado", "info");
                        }
                    });
                },
                toggleZenMode: () => {
                    document.body.classList.toggle('zen-mode');
                }
                ,
                configurarPrompt: () => {
                    const currentPrompt = localStorage.getItem('analysis_prompt') || DEFAULT_ANALYSIS_PROMPT;
                    document.getElementById('config-prompt-input').value = currentPrompt;
                    App.ui.toggleModal('modal-config-prompt', true);
                },
                guardarPrompt: () => {
                    const newPrompt = document.getElementById('config-prompt-input').value;
                    localStorage.setItem('analysis_prompt', newPrompt);
                    App.ui.toggleModal('modal-config-prompt', false);
                    App.ui.notificar("Prompt de IA actualizado correctamente.", "Guardado", "exito");
                },
                restaurarPrompt: () => {
                    document.getElementById('config-prompt-input').value = DEFAULT_ANALYSIS_PROMPT;
                },
                probarPrompt: async () => {
                    const promptInput = document.getElementById('config-prompt-input').value;
                    const resultContainer = document.getElementById('config-prompt-test-result');
                    const output = document.getElementById('test-output');
                    const selectedExample = document.getElementById('config-prompt-example-select').value;
                    
                    resultContainer.classList.remove('hidden');
                    output.innerHTML = '<span class="animate-pulse text-yellow-400">⏳ Enviando a IA para análisis...</span>';
                    
                    try {
                        const fullPrompt = `${promptInput}\n\nCONVERSACIÓN DE EJEMPLO:\n"${EXAMPLE_CONVERSATIONS[selectedExample]}"`;
                        const model = document.getElementById('model-selector').value;
                        
                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: fullPrompt, model: model })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) throw new Error(data.error);
                        
                        // Intentar formatear JSON para que se vea bonito
                        try {
                            const json = JSON.parse(data.analisis.replace(/```json/g, '').replace(/```/g, '').trim());
                            output.innerHTML = `<span class="text-emerald-400">${JSON.stringify(json, null, 2)}</span>`;
                        } catch (e) {
                            output.innerText = data.analisis;
                        }
                    } catch (e) {
                        output.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
