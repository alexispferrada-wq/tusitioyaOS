<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuSitioYa | Dashboard High Velocity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüöÄ%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s infinite linear',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    },
                    colors: {
                        neon: '#00e599', // Color Neon DB
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #f0fdfa; color: #134e4a; } /* Fondo Teal-50 y texto Teal-900 para menor fatiga */
        
        .main-panel {
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.6);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-white {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.1); /* Sombra Teal suave */
            border: 1px solid #d1fae5; /* Borde Emerald-100 */
        }

        .circular-chart {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(#10b981 0% 0%, #e2e8f0 0% 100%);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .circular-chart::before {
            content: ""; position: absolute; width: 90px; height: 90px;
            border-radius: 50%; background: #f1f5f9;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilo Billete para Dashboard Financiero */
        #dashboard-panel {
            background-color: #f0fdf4;
            background-image: 
                radial-gradient(at 0% 0%, rgba(22, 163, 74, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(22, 163, 74, 0.1) 0px, transparent 50%),
                repeating-linear-gradient(45deg, rgba(22, 163, 74, 0.03) 0px, rgba(22, 163, 74, 0.03) 2px, transparent 2px, transparent 4px);
            border: 1px solid #86efac;
            position: relative;
        }
        #dashboard-panel::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2316a34a' fill-opacity='0.05'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }
        #dashboard-panel::after {
            content: "$";
            position: absolute;
            right: 20px;
            bottom: -35px;
            font-size: 180px;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #16a34a;
            opacity: 0.08;
            transform: rotate(-15deg);
            pointer-events: none;
            z-index: 0;
        }
        #dashboard-content, #dashboard-panel > div {
            position: relative;
            z-index: 1;
        }

        /* Animaci√≥n Confeti */
        @keyframes fall {
            0% { transform: translateY(-10%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(300px) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 6px; height: 6px;
            top: -10px;
            animation: fall 3s linear forwards;
        }

        /* Modo Zen */
        body.zen-mode .zen-hidden { display: none !important; }
        body.zen-mode main { display: none !important; }
        body.zen-mode aside { width: 100%; flex: 1; justify-content: center; }
        body.zen-mode #sidebar-left { max-width: 400px; }
        body.zen-mode #sidebar-right { max-width: 300px; }
        @media (min-width: 1024px) { body.zen-mode aside { width: auto; } }

        /* Acorde√≥n */
        .accordion-content { display: none; }
        .accordion-content.open { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* EKG Heartbeat Animation */
        @keyframes ekg-draw {
            to { stroke-dashoffset: 0; }
        }
        .ekg-line {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: ekg-draw 1.5s linear infinite;
        }

        /* Offline Background X */
        .monitor-offline-bg::after {
            content: '\f00d'; /* Font Awesome X mark */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            font-size: 5rem; /* 80px */
            color: #ef4444; /* red-500 */
            opacity: 0.08;
            pointer-events: none;
        }

        /* Filtros Conversi√≥n */
        .conversion-btn-filtro {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: #065f46; /* emerald-800 */
            transition: all 0.2s;
        }
        .conversion-btn-filtro.active { background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T55WN1QVJB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-T55WN1QVJB');
    </script>
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '907889322166113');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=907889322166113&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body class="min-h-screen lg:h-screen flex flex-col lg:flex-row p-2 lg:p-4 gap-4 overflow-y-auto lg:overflow-hidden font-sans text-teal-900 bg-emerald-50">
    <div id="top"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[9999] bg-gradient-to-br from-teal-900 via-teal-800 to-emerald-900 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md mx-4 relative overflow-hidden">
            <!-- Decoraci√≥n -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 via-teal-500 to-emerald-600"></div>
            <div class="absolute -right-10 -top-10 w-32 h-32 bg-emerald-100 rounded-full opacity-50"></div>
            <div class="absolute -left-10 -bottom-10 w-24 h-24 bg-teal-100 rounded-full opacity-50"></div>
            
            <div class="relative z-10">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg mb-4">
                        <i class="fa-solid fa-rocket text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-teal-800 mb-1">TuSitioYa OS</h1>
                    <p class="text-sm text-teal-500">Sistema de Gesti√≥n High Velocity</p>
                </div>

                <form onsubmit="App.auth.login(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-teal-600 uppercase tracking-wider mb-2">Usuario</label>
                        <div class="relative">
                            <input type="text" id="login-user" 
                                class="w-full bg-emerald-50 border-2 border-emerald-100 rounded-xl py-3 px-4 text-teal-800 font-bold focus:border-emerald-400 focus:ring-0 outline-none transition-colors"
                                placeholder="tu-usuario" autocomplete="off" value="alexisferrada">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-emerald-400"><i class="fa-solid fa-user"></i></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-teal-600 uppercase tracking-wider mb-2">Contrase√±a de Acceso</label>
                        <div class="relative">
                            <input type="password" id="login-password" 
                                class="w-full bg-emerald-50 border-2 border-emerald-100 rounded-xl py-3 px-4 text-teal-800 font-bold focus:border-emerald-400 focus:ring-0 outline-none transition-colors"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-emerald-400">
                                <i class="fa-solid fa-lock"></i>
                            </div>
                        </div>
                        <p id="login-error" class="text-red-500 text-xs mt-2 hidden"><i class="fa-solid fa-circle-exclamation mr-1"></i> Usuario o contrase√±a incorrectos</p>
                    </div>

                    <button type="submit" 
                        class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fa-solid fa-arrow-right-to-bracket mr-2"></i> Ingresar al Sistema
                    </button>
                </form>

                <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                    <p class="text-[10px] text-slate-400">Acceso exclusivo para administradores</p>
                </div>
            </div>
        </div>
    </div>

    <aside id="sidebar-left" class="w-full lg:w-[300px] flex-shrink-0 main-panel p-4 lg:p-5 z-20 transition-all duration-500 h-auto lg:h-full order-2 lg:order-1">
        
        <div class="relative mb-6 p-4 bg-white rounded-xl border border-emerald-100 shadow-sm overflow-hidden">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M1 1h2v2H1V1zm4 0h2v2H5V1zm4 0h2v2H9V1z\' fill=\'%2310b981\' fill-opacity=\'0.4\' fill-rule=\'evenodd\'/%3E%3C/svg%3E');"></div>
            <div class="relative z-10 flex justify-between items-center">
                <h1 class="text-xl font-bold text-teal-700 tracking-tight">TuSitioYa <span class="text-teal-400 text-xs font-normal">OS v2.0</span></h1>
                <div class="flex items-center gap-2">
                    <button onclick="App.auth.logout()" class="text-red-400 hover:text-red-600 transition-colors" title="Cerrar Sesi√≥n">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                    <button onclick="App.ui.toggleZenMode()" class="text-teal-400 hover:text-emerald-600 transition-colors" title="Activar Modo Zen">
                        <i class="fa-solid fa-spa"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="zen-hidden bg-teal-900 rounded-xl p-3 mb-4 shadow-lg shadow-teal-900/20 flex items-center justify-between border border-teal-800 relative overflow-hidden">
            <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
            <div class="flex items-center gap-2">
                <img src="https://avatars.githubusercontent.com/u/105096363?s=48&v=4" class="w-5 h-5 rounded-full" alt="Neon">
                <div>
                    <p class="text-[10px] font-bold text-white uppercase tracking-wider">Neon DB</p>
                    <p class="text-[9px] text-teal-200 font-mono">Serverless Postgres</p>
                </div>
            </div>
            <div class="flex items-center gap-1.5 bg-teal-800 px-2 py-1 rounded-lg border border-teal-700">
                <div id="neon-status-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span id="neon-status-text" class="text-[9px] font-bold text-emerald-400">ONLINE</span>
            </div>
        </div>

        <div class="zen-hidden bg-white rounded-2xl p-4 shadow-sm mb-4 border border-emerald-100 relative overflow-hidden group">
            <div class="absolute left-0 top-4 bottom-4 w-1 bg-teal-500 rounded-r-full"></div>
            <div class="absolute right-0 top-0 text-9xl text-teal-50 opacity-40 pointer-events-none -mr-8 -mt-8 group-hover:opacity-60 transition-opacity animate-[spin_20s_linear_infinite]"><i class="fa-solid fa-microchip"></i></div>
            <div class="pl-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-teal-600 uppercase tracking-widest">üöÄ KIMI AI - CEREBRO TUSITIOYA</span>
                    <div class="flex items-center gap-2">
                        <span id="ia-capacity-text" class="text-[9px] font-bold text-teal-500">0%</span>
                        <span id="ia-status-badge" class="bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1">
                            READY
                        </span>
                    </div>
                </div>
                <div class="relative mb-3">
                    <select id="model-selector" onchange="App.models.analizarEstado()" class="w-full bg-emerald-50 border border-emerald-200 text-xs font-bold text-teal-800 rounded-lg py-2 px-2 focus:ring-2 focus:ring-emerald-200 outline-none cursor-pointer appearance-none">
                        </select>
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 text-teal-500 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
                <div class="w-full bg-emerald-100 h-1 rounded-full overflow-hidden mb-1">
                    <div id="ia-capacity-bar" class="bg-teal-500 h-full w-[0%] transition-all duration-1000 ease-out"></div>
                </div>
                <p id="ia-analysis" class="text-[9px] text-teal-500 font-mono truncate">Sistema Latente...</p>
            </div>
        </div>

        <div onclick="App.ui.toggleModal('modal-blacklist', true)" class="zen-hidden bg-red-50 border border-red-100 rounded-2xl p-3 mb-4 flex items-center justify-between cursor-pointer hover:bg-red-100 transition-colors group relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: repeating-linear-gradient(45deg, #ef4444 0, #ef4444 1px, transparent 0, transparent 10px);"></div>
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-lg text-red-500 shadow-sm"><i class="fa-solid fa-ban"></i></div>
                <div>
                    <p class="text-[10px] font-bold text-red-400 uppercase">EXCEPCIONES</p>
                    <p class="text-[9px] text-red-300">N√∫meros inv√°lidos</p>
                    <p id="blacklist-worst-model" class="text-[9px] text-red-600 font-bold mt-1 hidden"></p>
                </div>
            </div>
            <h3 class="text-2xl font-black text-red-500 group-hover:scale-110 transition-transform mr-2"><span id="blacklist-count">0</span></h3>
        </div>

        <div class="zen-hidden grid grid-cols-2 gap-2 mb-4">
            <button onclick="App.ui.toggleModal('modal-nuevo-cliente', true)" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-800 rounded-xl py-2 text-xs font-bold transition-colors flex items-center justify-center gap-1"><i class="fa-solid fa-plus"></i> Nuevo</button>
            <button onclick="App.prospectorIA.abrir()" class="bg-teal-600 hover:bg-teal-700 text-white rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-1 shadow-lg shadow-teal-500/30"><i class="fa-solid fa-wand-magic-sparkles"></i> IA</button>
            <button onclick="App.ui.toggleModal('modal-papelera', true); App.papelera.cargar();" class="col-span-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl py-2 text-xs font-bold transition-colors flex items-center justify-center gap-1"><i class="fa-solid fa-trash-arrow-up"></i> Papelera de Reciclaje</button>
        </div>

        <div class="flex-1 overflow-y-auto space-y-1 custom-scroll pr-1">
            <!-- BOT√ìN DISCADOR AUTOM√ÅTICO -->
            <div class="mb-3 px-1">
                <button onclick="App.discador.iniciar()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white p-3 rounded-xl shadow-lg shadow-emerald-500/30 flex items-center justify-between group transition-all transform hover:scale-[1.02]">
                    <div class="flex items-center gap-2">
                        <div class="bg-white/20 p-1.5 rounded-lg"><i class="fa-solid fa-headset text-white text-xs"></i></div>
                        <div class="text-left">
                            <p class="text-[10px] font-bold text-emerald-100 uppercase tracking-wider">Modo Focus</p>
                            <p class="text-xs font-bold text-white">Iniciar Discador <span id="btn-discador-count" class="ml-1 bg-white/20 px-1.5 py-0.5 rounded text-[10px]">0</span></p>
                        </div>
                    </div>
                    <i class="fa-solid fa-play text-white group-hover:animate-pulse"></i>
                </button>
            </div>

            <!-- BUSCADOR GLOBAL POTENTE -->
            <div class="mb-4 px-1 sticky top-0 z-10 bg-emerald-50 pb-2 pt-1">
                <div class="relative group">
                    <input type="text" id="buscador-global" onkeyup="App.ui.buscar(this.value)" onkeypress="if(event.key === 'Enter') App.ui.buscarExacto(this.value)" placeholder="Buscar dominio, nombre, fono..." class="w-full bg-white border border-emerald-200 rounded-xl py-2.5 pl-9 pr-3 text-xs font-bold text-teal-800 outline-none focus:ring-2 focus:ring-emerald-500/50 transition-all shadow-sm group-hover:shadow-md">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-teal-400 text-xs group-hover:text-emerald-500 transition-colors"></i>
                </div>
            </div>

            <div class="group">
                <div onclick="App.ui.toggleAccordion('discador')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100">
                    <div class="flex items-center gap-2"><span class="text-teal-600 text-xs">üìû</span><span class="text-xs font-bold text-teal-800">Cola Discador</span></div>
                    <span id="badge-discador" class="bg-teal-100 text-teal-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-discador" class="accordion-content pl-2 open ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('nuevos')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100">
                    <div class="flex items-center gap-2"><span class="text-emerald-500 text-xs">üå±</span><span class="text-xs font-bold text-teal-800">Nuevos Leads</span></div>
                    <span id="badge-nuevos" class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-nuevos" class="accordion-content pl-2 open ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('whatsapp_enviado')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-lime-500 text-xs">‚è≥</span><span class="text-xs font-bold text-teal-800">Esperando (Enviado)</span></div>
                    <span id="badge-whatsapp_enviado" class="bg-lime-100 text-lime-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-whatsapp_enviado" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('seguimiento')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-cyan-500 text-xs">üí¨</span><span class="text-xs font-bold text-teal-800">En Conversaci√≥n</span></div>
                    <span id="badge-seguimiento" class="bg-cyan-100 text-cyan-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-seguimiento" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('sin_respuesta')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-slate-400 text-xs">üëª</span><span class="text-xs font-bold text-teal-800">Sin Respuesta</span></div>
                    <span id="badge-sin_respuesta" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-sin_respuesta" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
            <div class="group">
                <div onclick="App.ui.toggleAccordion('cerrados')" class="flex items-center justify-between p-2 rounded-lg hover:bg-white cursor-pointer transition-colors border border-transparent hover:border-emerald-100 opacity-90">
                    <div class="flex items-center gap-2"><span class="text-green-600 text-xs">üå≥</span><span class="text-xs font-bold text-teal-800">Clientes Activos</span></div>
                    <span id="badge-cerrados" class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="list-cerrados" class="accordion-content pl-2 ml-2 border-l-2 border-emerald-100"></div>
            </div>
             <div class="group">
                <div class="flex items-center justify-between p-2 rounded-lg border border-transparent opacity-70">
                    <div class="flex items-center gap-2"><span class="text-slate-400 text-xs">üçÇ</span><span class="text-xs font-bold text-teal-800">Descartados</span></div>
                    <span id="badge-descartados" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
            </div>
        </div>
    </aside>

    <aside id="sidebar-right" class="w-full lg:w-[260px] flex-shrink-0 main-panel flex flex-col p-4 lg:p-6 transition-all duration-500 h-auto lg:h-full order-3 relative">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none z-50"></div>
        <div class="zen-hidden w-full text-left mb-2">
            <h2 class="text-xl font-bold text-teal-700 tracking-tight">Informaci√≥n Operativa</h2>
        </div>

        <!-- META MENSUAL $ (C√≠rculo de progreso) -->
        <div class="w-full bg-gradient-to-br from-teal-800 to-emerald-800 rounded-xl p-4 border border-teal-600 shadow-lg mb-3 relative overflow-hidden text-white shrink-0">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-[10px] font-bold text-teal-200 uppercase tracking-wider mb-1">Meta del Mes</h3>
                    <p class="text-2xl font-black">$<span id="meta-monto-objetivo">100.000</span></p>
                    <p class="text-[10px] text-teal-300 mt-1">Vas $<span id="meta-monto-actual">0</span></p>
                </div>
                <div class="relative w-16 h-16 flex items-center justify-center">
                    <!-- C√≠rculo de progreso SVG -->
                    <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                        <path class="text-teal-600" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3"/>
                        <path id="meta-circulo-progreso" class="text-yellow-400 transition-all duration-1000 ease-out" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                    <span id="meta-porcentaje" class="absolute text-xs font-black">0%</span>
                </div>
            </div>
            <div class="mt-3 pt-2 border-t border-teal-600/50 flex justify-between items-center">
                <span class="text-[9px] text-teal-300">Quedan <span id="meta-dias-restantes">0</span> d√≠as</span>
                <span id="meta-estado" class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-300">üî• En marcha</span>
            </div>
        </div>

        <!-- LOGROS / TROFEOS (Compacto) -->
        <div class="w-full bg-white rounded-xl p-3 border border-emerald-100 shadow-sm mb-3 relative overflow-hidden text-left group shrink-0">
            <div class="absolute top-0 left-0 w-1 h-full bg-yellow-400"></div>
            <div class="flex items-center justify-between pl-2">
                <h3 class="text-xs font-bold text-teal-800 uppercase tracking-wider">üèÜ Sala de Trofeos</h3>
                <div id="logros-container" class="flex gap-2">
                    <!-- JS Generated -->
                </div>
            </div>
        </div>
        
        <!-- √öLTIMOS MOVIMIENTOS (Expandido para ocupar el resto) -->
        <div class="zen-hidden w-full flex-1 bg-white rounded-xl p-4 border border-emerald-100 shadow-sm relative overflow-hidden flex flex-col min-h-0">
             <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2 shrink-0">
                <h3 class="text-xs font-bold text-teal-800 uppercase tracking-wider"><i class="fa-solid fa-list-ul mr-2"></i> √öltimos Movimientos</h3>
                <span class="text-[9px] bg-teal-50 text-teal-600 px-2 py-0.5 rounded-full font-bold">Hoy</span>
            </div>
            <div id="activity-log-container" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-1">
                <p class="text-[10px] text-slate-400 text-center italic mt-4">No hay movimientos recientes.</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col gap-4 w-full h-auto lg:h-full overflow-visible lg:overflow-hidden order-1 lg:order-2">
        <!-- DASHBOARD FINANCIERO -->
        <div class="main-panel p-4 lg:p-6 transition-all duration-300" id="dashboard-panel">
            <div class="flex justify-between items-center cursor-pointer mb-4" onclick="App.ui.toggleDashboard()">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-teal-700 tracking-tight">Dashboard Financiero</h2>
                    <span id="balance-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700 border border-emerald-200">Balance: $0</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="event.stopPropagation(); App.finanzas.abrirModalGasto()" class="bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-200 flex items-center gap-2 transition-colors"><i class="fa-solid fa-minus"></i> Gasto</button>
                    <i id="dashboard-chevron" class="fa-solid fa-chevron-up text-teal-400 transition-transform ml-2"></i>
                </div>
            </div>
            
            <div id="dashboard-content" class="overflow-hidden transition-all duration-300">
                <!-- RESUMEN -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
                    <div class="card-white p-4 flex flex-col justify-between border-l-4 border-l-emerald-500 relative overflow-hidden">
                        <div class="absolute right-0 bottom-0 text-7xl text-emerald-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-arrow-trend-up"></i></div>
                        <p class="text-[9px] font-bold text-emerald-600/70 uppercase tracking-wider">INGRESOS MES</p>
                        <p id="finanza-ingresos-mes" class="text-2xl font-bold text-emerald-900 relative z-10">$0</p>
                        <!-- Mini gr√°fico comparativo -->
                        <div class="mt-2 mb-1">
                            <div class="flex items-end gap-1 h-8 w-full">
                                <div id="barra-ingreso" class="bg-emerald-500 rounded-t transition-all duration-500" style="width: 50%; height: 0%"></div>
                                <div id="barra-gasto" class="bg-red-400 rounded-t transition-all duration-500" style="width: 50%; height: 0%"></div>
                            </div>
                            <div class="flex justify-between text-[8px] text-slate-400 mt-1">
                                <span class="text-emerald-600">Ingreso</span>
                                <span class="text-red-500">Gasto</span>
                            </div>
                        </div>
                        <p class="text-[9px] text-emerald-500 font-bold" id="finanza-ingresos-count">0 pagos</p>
                    </div>
                    <div class="card-white p-4 flex flex-col justify-between border-l-4 border-l-red-500 relative overflow-hidden">
                        <div class="absolute right-0 bottom-0 text-7xl text-red-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-arrow-trend-down"></i></div>
                        <p class="text-[9px] font-bold text-red-600/70 uppercase tracking-wider">GASTOS MES</p>
                        <p id="finanza-gastos-mes" class="text-2xl font-bold text-red-900 relative z-10">$0</p>
                        <p class="text-[9px] text-red-500 font-bold" id="finanza-gastos-count">0 transacciones</p>
                    </div>
                    <div class="card-white p-4 flex flex-col justify-between border-l-4 border-l-blue-500 relative overflow-hidden">
                        <div class="absolute right-0 bottom-0 text-7xl text-blue-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-scale-balanced"></i></div>
                        <p class="text-[9px] font-bold text-blue-600/70 uppercase tracking-wider">BALANCE MES</p>
                        <p id="finanza-balance-mes" class="text-2xl font-bold text-blue-900 relative z-10">$0</p>
                        <p class="text-[9px] text-blue-500 font-bold" id="finanza-balance-porcentaje">0% margen</p>
                    </div>
                    <div class="card-white p-4 flex flex-col justify-between border-l-4 border-l-purple-500 relative overflow-hidden">
                        <div class="absolute right-0 bottom-0 text-7xl text-purple-100 opacity-60 pointer-events-none -mb-2 -mr-2"><i class="fa-solid fa-piggy-bank"></i></div>
                        <p class="text-[9px] font-bold text-purple-600/70 uppercase tracking-wider">CAJA TOTAL</p>
                        <p id="finanza-caja-total" class="text-2xl font-bold text-purple-900 relative z-10">$0</p>
                        <p class="text-[9px] text-purple-500 font-bold">Acumulado hist√≥rico</p>
                    </div>
                </div>
                
                <!-- GASTOS -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- SERVICIOS -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-server text-blue-500"></i> Servicios & Infraestructura</h3>
                            <span id="total-servicios" class="text-xs font-bold text-slate-500">$0/mes</span>
                        </div>
                        <div class="p-3 border-b border-slate-100">
                            <select id="select-servicio" class="w-full p-2.5 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-blue-200 outline-none" onchange="App.finanzas.mostrarInputServicio()">
                                <option value="">-- Selecciona servicio --</option>
                                <optgroup label="Hosting"><option value="Render">Render</option><option value="Vercel">Vercel Pro</option><option value="Cloudflare">Cloudflare Pro</option><option value="Neon">Neon Database</option></optgroup>
                                <optgroup label="Dominios"><option value="NIC.cl">NIC.cl</option><option value="Namecheap">Namecheap</option></optgroup>
                                <optgroup label="IA"><option value="Kimi AI">Kimi AI</option><option value="Groq">Groq API</option><option value="Gemini">Gemini API</option><option value="OpenRouter">OpenRouter</option><option value="Copilot">GitHub Copilot</option></optgroup>
                                <option value="otro">+ Otro...</option>
                            </select>
                            <div id="input-servicio-container" class="mt-3 hidden">
                                <div class="flex gap-2">
                                    <input type="text" id="input-servicio-otro" class="flex-1 p-2 rounded-lg border border-slate-200 text-sm hidden" placeholder="Nombre...">
                                    <input type="number" id="input-servicio-monto" class="w-32 p-2 rounded-lg border border-slate-200 text-sm" placeholder="$">
                                    <button onclick="App.finanzas.agregarGastoServicio()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                        <div id="lista-servicios" class="p-3 bg-slate-50 min-h-[60px]">
                            <p class="text-xs text-slate-400 text-center italic">No hay gastos</p>
                        </div>
                    </div>
                    
                    <!-- PUBLICIDAD -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 px-4 py-3 border-b border-orange-200 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-orange-800 flex items-center gap-2"><i class="fa-solid fa-bullhorn text-orange-500"></i> Publicidad & Ads</h3>
                            <span id="total-ads" class="text-xs font-bold text-orange-600">$0/mes</span>
                        </div>
                        <div class="p-3 border-b border-orange-100">
                            <select id="select-ads" class="w-full p-2.5 rounded-lg border border-orange-200 text-sm focus:ring-2 focus:ring-orange-200 outline-none" onchange="App.finanzas.mostrarInputAds()">
                                <option value="">-- Selecciona plataforma --</option>
                                <optgroup label="Meta"><option value="Facebook Ads">Facebook Ads</option><option value="Instagram Ads">Instagram Ads</option><option value="Messenger Ads">Messenger</option></optgroup>
                                <optgroup label="Google"><option value="Google Search">Google Search</option><option value="Google Display">Display</option><option value="YouTube Ads">YouTube</option></optgroup>
                                <optgroup label="Otros"><option value="LinkedIn Ads">LinkedIn</option><option value="TikTok Ads">TikTok</option><option value="Twitter Ads">Twitter/X</option></optgroup>
                                <option value="otro">+ Otra...</option>
                            </select>
                            <div id="input-ads-container" class="mt-3 hidden">
                                <div class="flex gap-2">
                                    <input type="text" id="input-ads-otro" class="flex-1 p-2 rounded-lg border border-orange-200 text-sm hidden" placeholder="Nombre...">
                                    <input type="number" id="input-ads-monto" class="w-32 p-2 rounded-lg border border-orange-200 text-sm" placeholder="$">
                                    <button onclick="App.finanzas.agregarGastoAds()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-bold"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                        <div id="lista-ads" class="p-3 bg-orange-50 min-h-[60px]">
                            <p class="text-xs text-orange-400 text-center italic">No hay gastos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL GASTO -->
        <div id="modal-gasto" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-red-500 p-4 flex justify-between items-center">
                    <h3 class="text-white font-bold flex items-center gap-2"><i class="fa-solid fa-minus-circle"></i> Registrar Gasto</h3>
                    <button onclick="App.finanzas.cerrarModalGasto()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo</label>
                        <select id="gasto-tipo" class="w-full p-3 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-red-200 outline-none" onchange="App.finanzas.actualizarOpcionesGasto()">
                            <option value="servicio">Servicio / Infraestructura</option>
                            <option value="ads">Publicidad / Ads</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Concepto</label>
                        <select id="gasto-concepto" class="w-full p-3 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-red-200 outline-none"></select>
                        <input type="text" id="gasto-concepto-otro" class="w-full mt-2 p-3 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-red-200 outline-none hidden" placeholder="Especifica...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Monto ($)</label>
                        <input type="number" id="gasto-monto" class="w-full p-3 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-red-200 outline-none" placeholder="Ej: 2045">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                        <input type="date" id="gasto-fecha" class="w-full p-3 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-red-200 outline-none">
                    </div>
                    <button onclick="App.finanzas.guardarGasto()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-save"></i> Guardar Gasto
                    </button>
                </div>
            </div>
        </div>

        <div class="main-panel flex-1 p-6 relative flex flex-col overflow-hidden">
            <div class="absolute inset-0 opacity-30 pointer-events-none" style="background-image: linear-gradient(to right, rgba(59, 130, 246, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(59, 130, 246, 0.05) 1px, transparent 1px); background-size: 40px 40px;"></div>
            <div class="flex justify-between items-start mb-4 relative z-10">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Monitor de Proyectos</h2>
                    <p class="text-xs text-slate-500">Estado de servidores en tiempo real <span id="monitor-count" class="ml-2 text-emerald-600 font-bold"></span></p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.calendario.abrir()" class="bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50"><i class="fa-regular fa-calendar-days text-purple-500"></i> Calendario</button>
                    <button id="monitor-mute-btn" onclick="App.monitor.toggleMute()" class="bg-white text-slate-600 w-9 h-8 rounded-lg text-xs font-bold shadow-sm border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition-colors"></button>
                    <select id="monitor-intervalo" onchange="App.monitor.cambiarIntervalo(this.value)" class="bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-slate-200 focus:ring-2 focus:ring-blue-200 outline-none appearance-none cursor-pointer">
                        <option value="30000">Refresco: 30s</option>
                        <option value="60000" selected>Refresco: 1m</option>
                        <option value="120000">Refresco: 2m</option>
                        <option value="300000">Refresco: 5m</option>
                    </select>
                    <button onclick="App.monitor.checkAll()" class="bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50"><i class="fa-solid fa-arrows-rotate text-blue-500"></i> Refrescar Red</button>
                </div>
            </div>
            <div id="monitor-sites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 relative z-10 flex-1 content-start">
                <!-- Sites injected here -->
            </div>
            <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none"><i class="fa-solid fa-network-wired text-9xl"></i></div>
        </div>
    </main>

    <div id="modal-ficha-cliente" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-0 lg:p-4">
        <div class="w-full max-w-7xl bg-white rounded-none lg:rounded-3xl shadow-2xl overflow-hidden flex flex-col h-full lg:h-[95vh] border border-emerald-100">
            
            <!-- BARRA DISCADOR (SOLO VISIBLE EN MODO DISCADOR) -->
            <div id="ficha-discador-bar" class="hidden bg-emerald-600 p-2 px-6 flex justify-between items-center shadow-md z-50">
                <span class="text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2">
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div> Modo Discador Autom√°tico
                </span>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-mono text-emerald-100" id="discador-counter">1 / 10</span>
                    <span class="text-xs font-bold text-orange-200 bg-orange-900/30 px-2 py-0.5 rounded hidden" id="discador-intentos">Msg: 0</span>
                    <button onclick="App.discador.posponer()" class="bg-yellow-500/20 hover:bg-yellow-500/40 text-yellow-100 px-4 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-2 border border-yellow-500/30">Posponer 1h <i class="fa-solid fa-clock"></i></button>
                    <button onclick="App.discador.siguiente()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-2">Saltar <i class="fa-solid fa-forward"></i></button>
                    <button onclick="App.discador.detener()" class="text-white/60 hover:text-white px-2"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
            </div>

            <div class="bg-[#0f3d3e] p-5 text-white flex justify-between items-start shrink-0">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-1">
                        <h2 id="header-negocio" class="text-2xl font-bold">...</h2>
                        <span id="header-dominio" class="bg-teal-800 text-teal-200 px-2 py-0.5 rounded text-xs font-mono">...</span>
                        <span id="header-id" class="bg-black/20 text-teal-100 px-2 py-0.5 rounded text-xs font-mono border border-teal-700/50">ID: ...</span>
                    </div>
                    <div class="flex gap-4 text-sm text-slate-400">
                        <p id="header-nombre"><i class="fa-solid fa-user mr-1"></i> ...</p>
                        <p id="header-telefono" class="font-mono text-emerald-300"><i class="fa-brands fa-whatsapp mr-1"></i> ...</p>
                    </div>
                </div>
                
                <div id="ficha-financiera" class="hidden mr-6 text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ESTADO FINANCIERO</p>
                    <p class="text-xl font-bold text-emerald-400"><span id="ficha-pagado">$0</span> <span class="text-xs text-slate-500 font-normal">pagado</span></p>
                    <p class="text-xs text-slate-400">de <span id="ficha-total" class="text-slate-300">$0</span> total</p>
                </div>

                <div class="flex items-center gap-3">
                    <span id="ficha-estado-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-teal-800 uppercase">...</span>
                    <button onclick="App.cliente.cerrarFicha()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row bg-[#f8fafc]">
                
                <!-- COLUMNA 1: DATOS, T√ÅCTICA Y FINANZAS (30%) -->
                <div class="w-full lg:w-[30%] p-5 border-r border-emerald-100 overflow-y-auto bg-white/80 flex flex-col gap-5 custom-scroll">
                    
                    <!-- NUEVA SECCI√ìN: ESTADO T√ÅCTICO -->
                    <div id="ficha-estado-tactico" class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-chess-knight"></i> Estado T√°ctico</h3>
                        
                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Temperatura del Lead</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="App.cliente.setTemperatura('frio')" id="btn-temp-frio" class="py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-blue-50 hover:text-blue-500 transition-all">‚ùÑÔ∏è Fr√≠o</button>
                                <button onclick="App.cliente.setTemperatura('tibio')" id="btn-temp-tibio" class="py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-orange-50 hover:text-orange-500 transition-all">üå§Ô∏è Tibio</button>
                                <button onclick="App.cliente.setTemperatura('caliente')" id="btn-temp-caliente" class="py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-red-50 hover:text-red-500 transition-all">üî• Hot</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Notas R√°pidas</label>
                            <textarea id="ficha-notas" onfocus="App.discador.togglePausa(true)" onblur="App.discador.togglePausa(false)" onchange="App.cliente.actualizarCampo('notas', this.value)" rows="2" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:ring-2 focus:ring-blue-100 resize-none" placeholder="Ej: Hablar con secretaria, llamar martes..."></textarea>
                        </div>
                    </div>
                    
                    <!-- NUEVO: CONTROL DE PROYECTO (HOJA DE RUTA T√âCNICA) -->
                    <div class="bg-cyan-50 p-4 rounded-2xl border border-cyan-100">
                        <h3 class="text-xs font-bold text-cyan-700 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-bars-progress"></i> Control de Proyecto</h3>
                        
                        <div class="mb-3">
                            <div class="flex justify-between mb-1">
                                <label class="text-[9px] font-bold text-slate-400 uppercase">Avance General</label>
                                <span id="lbl-progreso" class="text-[10px] font-bold text-cyan-600">0%</span>
                            </div>
                            <input type="range" id="ficha-progreso" min="0" max="100" step="5" oninput="document.getElementById('lbl-progreso').innerText = this.value + '%'" onchange="App.cliente.actualizarCampo('progreso', this.value)" class="w-full h-2 bg-cyan-200 rounded-lg appearance-none cursor-pointer accent-cyan-600">
                        </div>

                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Fase Actual</label>
                            <select id="ficha-fase" onchange="App.cliente.actualizarCampo('fase_actual', this.value)" class="w-full bg-white border border-cyan-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none font-bold">
                                <option value="Inicio del Proyecto">üöÄ Inicio del Proyecto</option>
                                <option value="Infraestructura y Configuraci√≥n">‚öôÔ∏è Infraestructura y Configuraci√≥n</option>
                                <option value="Arquitectura de Base de Datos">üóÑÔ∏è Arquitectura de Base de Datos</option>
                                <option value="Dise√±o y Maquetaci√≥n">üé® Dise√±o y Maquetaci√≥n</option>
                                <option value="Desarrollo Backend">üß± Desarrollo Backend</option>
                                <option value="Integraci√≥n de Contenido">üìù Integraci√≥n de Contenido</option>
                                <option value="Pruebas y QA">üß™ Pruebas y QA</option>
                                <option value="Lanzamiento Final">üèÅ Lanzamiento Final</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1"><i class="fa-brands fa-google-drive"></i> Carpeta Google Drive (Nube)</label>
                            <input type="text" id="ficha-drive" onchange="App.cliente.actualizarCampo('drive_link', this.value)" placeholder="https://drive.google.com/..." class="w-full bg-white border border-cyan-200 rounded-lg px-2 py-1.5 text-xs text-cyan-600 outline-none">
                        </div>

                        <!-- NUEVO: GENERADOR DE RUTA IA -->
                        <div class="mt-3 pt-3 border-t border-cyan-200">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Personalizaci√≥n de Ruta</label>
                            <textarea id="txt-ruta-custom" rows="2" class="w-full bg-white border border-cyan-200 rounded-lg px-2 py-1.5 text-xs text-slate-600 outline-none mb-2 resize-none" placeholder="Instrucciones extra o Prompt externo..."></textarea>
                            <button onclick="App.cliente.generarHojaRutaIA()" id="btn-ruta-ia" class="w-full py-2 bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 text-white rounded-lg text-[10px] font-bold shadow-md transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Generar Ruta √önica con IA
                            </button>
                            <p class="text-[9px] text-slate-400 mt-1 text-center">Crea pasos espec√≠ficos seg√∫n el rubro o tus instrucciones.</p>
                        </div>
                    </div>

                    <!-- Bloque Financiero -->
                    <div class="bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100">
                        <h3 class="text-xs font-bold text-emerald-600 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-sack-dollar"></i> Acuerdo Comercial</h3>
                        
                        <div class="grid grid-cols-12 gap-2 mb-3">
                            <div class="col-span-5">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Valor Proyecto</label>
                                <input type="number" id="ficha-monto-total" onchange="App.cliente.actualizarCampo('monto_total', this.value)" class="w-full bg-white border border-emerald-200 rounded-lg px-2 py-2 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500/20">
                            </div>
                            <div class="col-span-4">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Mensualidad</label>
                                <input type="number" id="ficha-monto-mantencion" onchange="App.cliente.actualizarCampo('monto_mantencion', this.value); App.cliente.actualizarProyeccionMensual();" placeholder="$0" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-2 text-xs font-bold text-teal-600 outline-none focus:ring-2 focus:ring-teal-500/20">
                            </div>
                            <div class="col-span-3">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">D√≠a Pago</label>
                                <input type="number" min="1" max="31" id="ficha-dia-pago" onchange="App.cliente.actualizarCampo('dia_pago', this.value); App.cliente.actualizarProyeccionMensual();" placeholder="1-30" class="w-full bg-white border border-teal-200 rounded-lg px-1 py-2 text-xs font-bold text-teal-600 text-center outline-none focus:ring-2 focus:ring-teal-500/20">
                            </div>
                        </div>

                        <div class="flex gap-2 mb-1 bg-white p-2 rounded-xl border border-emerald-100">
                            <div class="w-1/2">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Pagado (Adelanto)</label>
                                <div class="relative">
                                    <input type="number" id="ficha-monto-pagado" onchange="App.cliente.actualizarCampo('monto_pagado', this.value)" class="w-full bg-emerald-50 border border-emerald-200 rounded-lg pl-2 pr-6 py-2 text-xs font-bold text-emerald-600 outline-none focus:ring-2 focus:ring-emerald-500/20">
                                    <button onclick="App.cliente.eliminarPago()" class="absolute right-1 top-1.5 text-slate-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-100 transition-colors" title="Eliminar pago"><i class="fa-solid fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <div class="w-1/2">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Proyectado (Restante)</label>
                                <input type="text" id="ficha-saldo-pendiente" readonly class="w-full bg-slate-100 border border-slate-200 rounded-lg px-2 py-2 text-xs font-bold text-red-500 outline-none mb-1">
                                <input type="date" id="ficha-fecha-pago" onchange="App.cliente.actualizarCampo('fecha_proximo_pago', this.value)" class="w-full bg-white border border-emerald-200 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-600 outline-none focus:ring-1 focus:ring-emerald-500" title="Fecha L√≠mite de Proyecto">
                            </div>
                        </div>

                        <!-- Proyecci√≥n Mensualidad (Visual) -->
                        <div id="info-proxima-mensualidad" class="mt-2 bg-teal-50 border border-teal-100 rounded-lg p-2 flex items-center justify-center gap-2 hidden">
                            <i class="fa-solid fa-calendar-check text-teal-500"></i> <span class="text-[10px] text-teal-600 font-bold">Cobro este mes: <span id="txt-proximo-cobro" class="text-teal-800">...</span></span>
                        </div>
                    </div>

                    <!-- Bloque Contacto (AMPLIADO) -->
                    <div class="space-y-3 pb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-address-card"></i> Datos del Cliente</h3>
                            <button onclick="App.cliente.actualizarDatosContacto()" class="text-[10px] bg-teal-50 text-teal-600 px-2 py-1 rounded hover:bg-teal-100 font-bold transition-colors">Actualizar Datos</button>
                        </div>
                        
                        <!-- Campos B√°sicos -->
                        <div class="grid grid-cols-1 gap-3">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Nombre Negocio</label>
                                <input type="text" id="ficha-negocio" onchange="App.cliente.actualizarCampo('negocio', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold text-slate-700 outline-none focus:border-teal-400 focus:bg-teal-50/30 transition-colors">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Nombre Contacto</label>
                                <input type="text" id="ficha-nombre" onchange="App.cliente.actualizarCampo('nombre', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:border-teal-400 focus:bg-teal-50/30 transition-colors">
                            </div>
                        </div>

                        <!-- Campos Nuevos -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">RUT / ID Fiscal</label>
                                <input type="text" id="ficha-rut" onchange="App.cliente.actualizarCampo('rut', this.value)" placeholder="12.345.678-9" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 outline-none focus:border-teal-400 focus:bg-white transition-colors">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Rubro / Industria</label>
                                <input type="text" id="ficha-rubro" onchange="App.cliente.actualizarCampo('rubro', this.value)" placeholder="Ej: Legal, Salud..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:border-teal-400 focus:bg-white transition-colors">
                            </div>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Correo Electr√≥nico</label>
                            <input type="email" id="ficha-email" onchange="App.cliente.actualizarCampo('email', this.value)" placeholder="contacto@empresa.cl" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-600 outline-none focus:border-teal-400 focus:bg-white transition-colors">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">WhatsApp</label>
                                <input type="text" id="ficha-whatsapp" onchange="App.cliente.actualizarCampo('whatsapp', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 outline-none focus:border-teal-400 focus:bg-white transition-colors">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Dominio .CL</label>
                                <input type="text" id="ficha-dominio" onchange="App.cliente.actualizarCampo('dominio', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-teal-600 font-bold outline-none focus:border-teal-400 focus:bg-white transition-colors">
                            </div>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">URL Actual / Maps</label>
                            <div class="relative">
                                <input type="text" id="ficha-url" onchange="App.cliente.actualizarCampo('url', this.value)" placeholder="https://..." class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-3 pr-8 py-2 text-xs text-teal-500 underline cursor-pointer outline-none focus:border-teal-400 focus:bg-white transition-colors">
                                <a href="#" onclick="window.open(document.getElementById('ficha-url').value, '_blank')" class="absolute right-2 top-1.5 text-slate-400 hover:text-teal-500"><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                            </div>
                        </div>

                        <!-- SECCI√ìN ENCUESTA WEB (NUEVO) -->
                        <div class="mt-4 bg-teal-50 p-4 rounded-2xl border border-teal-100">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xs font-bold text-teal-800 uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-laptop-code"></i> Briefing Web</h3>
                                <span id="badge-encuesta-info" class="hidden text-[9px] bg-white text-teal-600 px-2 py-1 rounded-lg border border-teal-100 font-bold shadow-sm">
                                    <i class="fa-solid fa-clock-rotate-left mr-1"></i> <span id="txt-encuesta-fecha">...</span>
                                </span>
                            </div>
                            
                            <!-- GENERADOR DE LINK (NUEVO) -->
                            <div class="mb-4 bg-white p-3 rounded-xl border border-teal-100 shadow-sm">
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Link para el Cliente</label>
                                <div class="flex gap-2">
                                    <input type="text" id="link-encuesta-cliente" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 text-[10px] text-slate-600 outline-none font-mono">
                                    <button onclick="App.cliente.copiarLinkEncuesta()" class="bg-teal-100 text-teal-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-teal-200 transition-colors" title="Copiar Link"><i class="fa-regular fa-copy"></i></button>
                                    <button onclick="App.cliente.enviarEncuestaWhatsApp()" class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-600 transition-colors" title="Enviar por WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>
                                </div>
                                <p class="text-[9px] text-teal-400 mt-1 flex items-center gap-1"><i class="fa-solid fa-share-nodes"></i> Env√≠a este link para que llenen el formulario ellos mismos.</p>
                            </div>

                            <div class="space-y-3">
                                <!-- Campo WhatsApp Soporte (Solo visible si el cliente lo llen√≥) -->
                                <div id="field-whatsapp-soporte" class="hidden bg-orange-50 p-2 rounded-lg border border-orange-100 mb-2">
                                    <label class="text-[9px] font-bold text-orange-500 uppercase block mb-1">üìû Contacto Soporte (Cliente)</label>
                                    <div class="flex justify-between items-center">
                                        <span id="txt-whatsapp-soporte" class="text-xs font-mono font-bold text-slate-700">...</span>
                                        <button onclick="App.cliente.copiarSoporte()" class="text-[9px] text-orange-400 hover:text-orange-600 font-bold">Copiar</button>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">1. Objetivo Principal</label>
                                    <select id="p1_objetivo" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none">
                                        <option value="Vender productos (E-commerce)">Vender productos (E-commerce)</option>
                                        <option value="Generar Leads/Contactos">Generar Leads/Contactos</option>
                                        <option value="Presencia de Marca">Presencia de Marca</option>
                                        <option value="Blog/Noticias">Blog/Noticias</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">2. P√∫blico Objetivo</label>
                                    <input type="text" id="p2_publico" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Ej: Mujeres 25-40 a√±os...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">3. Referentes (URLs)</label>
                                    <input type="text" id="p3_referentes" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Ej: apple.com, nike.com">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">4. Estilo Visual</label>
                                    <input type="text" id="p4_estilo" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Ej: Minimalista, oscuro...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">5. Secciones</label>
                                    <input type="text" id="p5_secciones" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Inicio, Nosotros, Contacto...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">6. Funcionalidades</label>
                                    <input type="text" id="p6_funcionalidades" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none" placeholder="Chatbot, Reservas...">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">7. Tono Comunicaci√≥n</label>
                                    <select id="p7_tono" class="w-full bg-white border border-teal-200 rounded-lg px-2 py-1.5 text-xs text-slate-700 outline-none">
                                        <option value="Profesional y Serio">Profesional y Serio</option>
                                        <option value="Cercano y Amigable">Cercano y Amigable</option>
                                        <option value="Juvenil y Disruptivo">Juvenil y Disruptivo</option>
                                        <option value="Lujoso y Exclusivo">Lujoso y Exclusivo</option>
                                    </select>
                                </div>

                                <div class="flex gap-2 pt-2">
                                    <button onclick="App.cliente.guardarEncuestaWeb()" class="flex-1 bg-teal-100 text-teal-700 py-2 rounded-lg text-xs font-bold hover:bg-teal-200 transition-colors"><i class="fa-solid fa-save"></i> Guardar</button>
                                    <button onclick="App.cliente.generarPromptWeb()" id="btn-prompt-web" class="flex-1 bg-teal-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-teal-700 transition-colors shadow-md shadow-teal-500/30"><i class="fa-solid fa-wand-magic-sparkles"></i> Crear Prompt</button>
                                </div>

                                <!-- Resultado Prompt -->
                                <div id="container-prompt-web" class="hidden mt-2">
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Prompt Generado</label>
                                    <textarea id="txt-prompt-web" rows="4" class="w-full bg-slate-800 text-green-400 font-mono text-[10px] p-2 rounded-lg mb-1" readonly></textarea>
                                    <button onclick="navigator.clipboard.writeText(document.getElementById('txt-prompt-web').value); App.ui.notificar('Copiado al portapapeles', 'Copiado', 'exito')" class="w-full text-center text-[10px] text-teal-600 font-bold hover:underline">Copiar Prompt</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- COLUMNA 2: IA PROTAGONISTA (45%) -->
                <div class="w-full lg:w-[45%] p-5 bg-[#f0fdfa] overflow-y-auto flex flex-col border-r border-emerald-100 relative">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-teal-500"></div>
                    
                    <div class="mb-4 flex-1 flex flex-col">

                        <!-- HEADER MEJORADO -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2.5">
                                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-2 rounded-xl shadow-md shadow-emerald-500/30">
                                    <i class="fa-solid fa-brain text-base"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-bold text-emerald-800 uppercase tracking-widest block leading-tight">An√°lisis T√°ctico IA</span>
                                    <span class="text-[9px] text-emerald-500 font-mono">Selecciona una acci√≥n o analiza manualmente</span>
                                </div>
                            </div>
                            <button onclick="App.ui.configurarPrompt()" class="text-[10px] text-slate-400 hover:text-blue-600 transition-colors flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-lg border border-slate-200 hover:border-blue-200">
                                <i class="fa-solid fa-gear"></i> Config IA
                            </button>
                        </div>

                        <!-- BOTONES IA T√ÅCTICA (PROTAGONISTAS) -->
                        <div class="grid grid-cols-2 gap-2 mb-4">

                            <!-- Cerrar Venta -->
                            <button onclick="App.cliente.analizarConContexto('cerrar_venta', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-emerald-300 bg-gradient-to-br from-emerald-50 to-teal-50 hover:from-emerald-500 hover:to-teal-600 hover:border-emerald-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-emerald-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-emerald-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-handshake text-emerald-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-emerald-800 group-hover:text-white text-center leading-tight transition-colors">Quiero cerrar la venta</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Manejar Objeciones -->
                            <button onclick="App.cliente.analizarConContexto('manejar_objeciones', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-cyan-300 bg-gradient-to-br from-cyan-50 to-sky-50 hover:from-cyan-500 hover:to-sky-600 hover:border-cyan-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-cyan-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-cyan-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-shield-halved text-cyan-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-cyan-800 group-hover:text-white text-center leading-tight transition-colors">Manejar objeciones</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-cyan-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Cliente Probable -->
                            <button onclick="App.cliente.analizarConContexto('cliente_probable', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-lime-300 bg-gradient-to-br from-lime-50 to-green-50 hover:from-lime-500 hover:to-green-600 hover:border-lime-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-lime-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-lime-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-crosshairs text-lime-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-lime-800 group-hover:text-white text-center leading-tight transition-colors">Es cliente probable</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-lime-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Primer Contacto -->
                            <button onclick="App.cliente.analizarConContexto('primer_contacto', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-teal-300 bg-gradient-to-br from-teal-50 to-cyan-50 hover:from-teal-500 hover:to-cyan-600 hover:border-teal-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-teal-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-teal-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-phone-volume text-teal-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-teal-800 group-hover:text-white text-center leading-tight transition-colors">Primer contacto</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-teal-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Negociar Precio -->
                            <button onclick="App.cliente.analizarConContexto('negociar_precio', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-amber-300 bg-gradient-to-br from-amber-50 to-yellow-50 hover:from-amber-500 hover:to-yellow-600 hover:border-amber-500 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-amber-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-amber-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-tags text-amber-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-amber-800 group-hover:text-white text-center leading-tight transition-colors">Negociar precio</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-amber-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                            <!-- Reactivar Lead Fr√≠o -->
                            <button onclick="App.cliente.analizarConContexto('reactivar_lead', this)"
                                class="ia-action-btn group relative overflow-hidden flex flex-col items-center justify-center gap-1.5 p-3.5 rounded-xl border-2 border-slate-300 bg-gradient-to-br from-slate-50 to-gray-100 hover:from-slate-600 hover:to-gray-700 hover:border-slate-600 transition-all duration-200 shadow-sm hover:shadow-lg hover:shadow-slate-500/30 hover:scale-[1.02] cursor-pointer">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles text-slate-400 group-hover:text-white text-xs transition-colors"></i>
                                    <i class="fa-solid fa-rotate text-slate-600 group-hover:text-white text-lg transition-colors"></i>
                                </div>
                                <span class="text-[11px] font-bold text-slate-700 group-hover:text-white text-center leading-tight transition-colors">Reactivar lead fr√≠o</span>
                                <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-slate-400 rounded-full animate-pulse group-hover:bg-white/70"></div>
                            </button>

                        </div>

                        <!-- SEPARADOR -->
                        <div class="flex items-center gap-2 mb-3">
                            <div class="flex-1 h-px bg-slate-200"></div>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest whitespace-nowrap">o analiza la conversaci√≥n manualmente</span>
                            <div class="flex-1 h-px bg-slate-200"></div>
                        </div>
                        
                        <textarea id="historial-chat-input" onpaste="App.cliente.guardarHistorialPegado(event)" class="w-full h-28 p-3 rounded-xl border border-emerald-100 text-xs focus:ring-2 focus:ring-emerald-500 outline-none resize-none bg-emerald-50/30 placeholder-emerald-300 mb-3 font-mono" placeholder="Pega aqu√≠ la conversaci√≥n de WhatsApp..."></textarea>
                        
                        <button id="btn-analizar-cierre" onclick="App.cliente.analizarCierre()" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Analizar Estrategia de Cierre
                        </button>
                        
                        <div id="analysis-result" class="hidden mt-4 bg-white p-4 rounded-xl border border-emerald-100 shadow-sm text-sm text-slate-600 flex-1 overflow-y-auto"></div>
                    </div>

                </div>

                <!-- COLUMNA 3: SCRIPT Y ACCIONES (25%) -->
                <div class="w-full lg:w-[25%] p-5 overflow-y-auto flex flex-col bg-white border-l border-emerald-100">
                    
                    <!-- Script Box (Referencia) -->
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm mb-4 flex flex-col h-48">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">SCRIPT INICIAL</span>
                            <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold">Ref</span>
                        </div>
                        <textarea id="ficha-script" class="w-full flex-1 bg-slate-50 border border-slate-100 rounded-lg p-2 text-xs text-slate-500 leading-relaxed resize-none outline-none" readonly></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 gap-3 mb-auto">
                        <div class="flex justify-between items-center px-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ACCI√ìN PRINCIPAL</span>
                            <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full">Intentos: <span id="ficha-intentos-count">0</span></span>
                        </div>
                        <button onclick="App.cliente.accion('whatsapp')" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl shadow-lg shadow-green-500/30 flex items-center justify-center gap-2 transition-transform hover:scale-[1.01]">
                            <i class="fa-brands fa-whatsapp text-xl"></i>
                            <span class="text-sm font-bold">Enviar WhatsApp</span>
                        </button>
                    </div>

                    <!-- Historial de Interacciones -->
                    <div class="mt-4 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                        <div class="flex justify-between items-center px-3 py-2 border-b border-slate-100 bg-slate-50">
                            <span class="text-[10px] font-bold text-teal-600 uppercase tracking-widest flex items-center gap-1.5">
                                <i class="fa-solid fa-clock-rotate-left text-teal-400"></i> Historial
                            </span>
                            <button onclick="App.cliente.analizarCierre()" class="text-[9px] bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-1 rounded-lg font-bold hover:bg-emerald-100 transition-colors flex items-center gap-1">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Analizar IA
                            </button>
                        </div>
                        <div id="ficha-historial" class="space-y-2 p-3 max-h-52 overflow-y-auto custom-scroll">
                            <!-- Historial items injected by JS -->
                        </div>
                    </div>

                    <!-- Botones Fase Venta -->
                    <div id="acciones-venta" class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="App.cliente.accion('schedule')" class="py-3 bg-white border border-cyan-200 text-cyan-600 font-bold rounded-xl hover:bg-cyan-50 transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-regular fa-calendar text-lg"></i>
                            <span class="text-[10px]">Agendar</span>
                        </button>
                        <button onclick="App.cliente.accion('won')" class="py-3 bg-white border border-emerald-200 text-emerald-600 font-bold rounded-xl hover:bg-emerald-50 transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-trophy text-lg"></i>
                            <span class="text-[10px]">Cerrar Venta</span>
                        </button>
                        <button onclick="App.cliente.accion('lost')" class="py-3 bg-white border border-red-200 text-red-500 font-bold rounded-xl hover:bg-red-50 transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-thumbs-down text-lg"></i>
                            <span class="text-[10px]">Descartar</span>
                        </button>
                        <button onclick="App.cliente.cerrarFicha()" class="py-3 bg-white border border-slate-200 text-slate-500 font-bold rounded-xl hover:bg-slate-50 transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-xmark text-lg"></i>
                            <span class="text-[10px]">Cerrar Ficha</span>
                        </button>
                    </div>

                    <!-- Botones Cliente Activo -->
                    <div id="acciones-cliente" class="hidden grid grid-cols-3 gap-2 mt-4">
                        <!-- Bot√≥n 1: Ver Sitio Web -->
                        <button onclick="App.cliente.verSitio()" class="py-3 bg-white border border-teal-200 text-teal-600 font-bold rounded-xl hover:bg-teal-50 transition-colors flex flex-col items-center justify-center gap-1" title="Ver el sitio web del cliente">
                            <i class="fa-solid fa-globe text-lg"></i>
                            <span class="text-[10px]">Ver Sitio</span>
                        </button>
                        <!-- Bot√≥n Nuevo: Hoja de Ruta -->
                        <button onclick="window.open('/hoja_ruta.html?id=' + App.datos.leads[App.clienteActivoIndex].id, '_blank')" class="py-3 bg-white border border-cyan-200 text-cyan-600 font-bold rounded-xl hover:bg-cyan-50 transition-colors flex flex-col items-center justify-center gap-1" title="Ver Hoja de Ruta del Proyecto">
                            <i class="fa-solid fa-map-location-dot text-lg"></i>
                            <span class="text-[10px]">Hoja Ruta</span>
                        </button>
                        <!-- Bot√≥n Nuevo: Enviar Ruta WhatsApp -->
                        <button onclick="App.cliente.enviarHojaRutaWhatsApp()" class="py-3 bg-white border border-green-200 text-green-600 font-bold rounded-xl hover:bg-green-50 transition-colors flex flex-col items-center justify-center gap-1" title="Enviar Link de Hoja de Ruta por WhatsApp">
                            <i class="fa-brands fa-whatsapp text-lg"></i>
                            <span class="text-[10px]">Env√≠o Hoja Ruta</span>
                        </button>
                        <!-- Bot√≥n 2: Renovar Plan -->
                        <button onclick="App.cliente.agregarServicio()" class="py-3 bg-white border border-emerald-200 text-emerald-600 font-bold rounded-xl hover:bg-emerald-50 transition-colors flex flex-col items-center justify-center gap-1" title="Agregar nuevo servicio">
                            <i class="fa-solid fa-cart-plus text-lg"></i>
                            <span class="text-[10px]">Agregar Servicio</span>
                        </button>
                        <!-- Bot√≥n 3: Soporte T√©cnico -->
                        <button onclick="App.cliente.abrirSoporteWhatsApp()" class="py-3 bg-white border border-amber-200 text-amber-500 font-bold rounded-xl hover:bg-amber-50 transition-colors flex flex-col items-center justify-center gap-1" title="Contactar por WhatsApp">
                            <i class="fa-brands fa-whatsapp text-lg"></i>
                            <span class="text-[10px]">Soporte</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-agenda" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold text-indigo-900">Agenda Predictiva</h3><p class="text-xs text-slate-400">Seguimientos para hoy</p></div><button onclick="App.ui.toggleModal('modal-agenda', false)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div id="agenda-lista" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll"></div>
            <div class="text-center font-bold pt-4 border-t border-slate-100">Leads Agendados Hoy: <span id="conteo-lead-Discador" class="text-blue-600">0</span></div>
        </div>
    </div>

    <div id="modal-entregas-hoy" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div><h3 class="text-xl font-bold text-blue-900">Entregas para Hoy</h3><p class="text-xs text-slate-400">Proyectos con fecha de compromiso hoy</p></div>
                <button onclick="App.ui.toggleModal('modal-entregas-hoy', false)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="entregas-hoy-lista" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll"></div>
        </div>
    </div>

    <div id="modal-calendario" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-100 text-purple-600 p-2 rounded-lg"><i class="fa-regular fa-calendar-days"></i></div>
                    <h3 class="text-xl font-bold text-slate-900">Calendario de Operaciones</h3>
                </div>
                <button onclick="App.ui.toggleModal('modal-calendario', false)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex justify-between items-center mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                <button onclick="App.calendario.cambiarMes(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-500"><i class="fa-solid fa-chevron-left"></i> Anterior</button>
                <h4 id="calendario-titulo" class="text-lg font-bold text-slate-800 capitalize">...</h4>
                <button onclick="App.calendario.cambiarMes(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-500">Siguiente <i class="fa-solid fa-chevron-right ml-1"></i></button>
            </div>

            <div class="grid grid-cols-7 gap-2 text-center mb-2">
                <div class="text-xs font-bold text-slate-400 uppercase">Domingo</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Lunes</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Martes</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Mi√©rcoles</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Jueves</div>
                <div class="text-xs font-bold text-slate-400 uppercase">Viernes</div>
                <div class="text-xs font-bold text-slate-400 uppercase">S√°bado</div>
            </div>
            
            <div id="calendario-grid" class="grid grid-cols-7 gap-2 flex-1 overflow-y-auto custom-scroll bg-slate-50 p-2 rounded-xl border border-slate-200">
                <!-- JS Generated -->
            </div>
        </div>
    </div>

    <div id="modal-ia-generador" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[80] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl flex flex-col shadow-2xl overflow-hidden border border-slate-200 max-h-[95vh]">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <div><h3 class="text-xl font-bold text-slate-900">Prospector IA</h3></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.ui.toggleModal('modal-prospectos', true)" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-1"><i class="fa-solid fa-file-import"></i> Importar Manual</button>
                    <button onclick="App.prospectorIA.cerrar()" class="text-slate-400 hover:text-slate-600 ml-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            <div class="flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden">
                <div class="w-full lg:w-1/2 flex flex-col p-6 border-b lg:border-b-0 lg:border-r border-slate-100">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Rubro</label><input id="ia-rubro" type="text" placeholder="Ej: Dentistas..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Ciudad</label><input id="ia-ciudad" type="text" value="Santiago, Chile" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none"></div>
                    </div>
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Cantidad</label>
                        <select id="ia-cantidad" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none appearance-none">
                            <option>5</option><option>10</option><option>15</option><option>20</option><option>40</option>
                        </select>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Prompt de Prospecci√≥n</label>
                        <textarea id="ia-prompt-area" rows="15" class="w-full p-4 bg-slate-100 border border-slate-200 rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-blue-500/20 flex-1"></textarea>
                    </div>
                </div>
                <div class="w-full lg:w-1/2 flex flex-col bg-slate-50 p-6">
                    <div id="ia-loading" class="hidden flex-col items-center justify-center h-full"><div class="loader ease-linear rounded-full border-4 border-t-4 border-blue-500 h-10 w-10 mb-4"></div><p class="text-sm text-slate-500 animate-pulse">Analizando...</p></div>
                    <div id="ia-results-container" class="hidden flex-1 overflow-y-auto space-y-3 custom-scroll"></div>
                    <div id="ia-empty-state" class="flex flex-col items-center justify-center h-full text-center opacity-60"><i class="fa-solid fa-magnifying-glass-location text-4xl text-slate-300 mb-3"></i><p class="text-sm text-slate-400">Define los par√°metros y genera.</p></div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-white flex justify-between items-center">
                <button onclick="App.prospectorIA.copiarPrompt()" class="px-4 py-2 bg-slate-100 text-slate-600 font-bold text-xs rounded-lg hover:bg-slate-200 flex items-center gap-2"><i class="fa-regular fa-copy"></i> Copiar Prompt</button>
                <div class="flex gap-3">
                    <button onclick="App.prospectorIA.buscar()" id="btn-ia-buscar" class="px-6 py-2.5 bg-slate-900 text-white font-bold text-sm rounded-lg shadow-lg hover:bg-black flex items-center gap-2">
                        <i class="fa-solid fa-brain"></i> Analizar con <span id="ia-model-name-btn" class="font-mono text-xs">...</span>
                    </button>
                    <button onclick="App.prospectorIA.guardar()" id="btn-ia-guardar" class="hidden px-6 py-2.5 bg-emerald-500 text-white font-bold text-sm rounded-lg shadow-lg hover:bg-emerald-600">Guardar Resultados</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-cierre-venta" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-emerald-50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-emerald-800"><i class="fa-solid fa-handshake mr-2"></i> Cerrar Venta</h3>
                <button onclick="App.ui.toggleModal('modal-cierre-venta', false)" class="text-emerald-400 hover:text-emerald-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="App.cliente.confirmarCierre(event)" class="p-6 space-y-4">
                <input type="hidden" name="cliente_id" id="cierre-cliente-id">
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                    <p class="text-xs text-slate-500 font-bold uppercase">Cliente</p>
                    <p id="cierre-cliente-nombre" class="font-bold text-slate-800 text-lg">...</p>
                    <p id="cierre-cliente-dominio" class="text-xs text-slate-500 font-mono">...</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Monto Total ($)</label>
                        <input name="monto_total" type="number" required class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 font-bold text-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Abono Inicial ($)</label>
                        <input name="monto_pagado" type="number" required class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 font-bold text-emerald-600">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Comprobante de Pago</label>
                    <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center hover:bg-slate-50 transition-colors cursor-pointer relative">
                        <input type="file" name="comprobante" class="absolute inset-0 opacity-0 cursor-pointer">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-300 mb-1"></i>
                        <p class="text-xs text-slate-400 font-bold">Subir imagen o PDF</p>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 transition-all transform hover:scale-[1.02]">
                    Confirmar Venta üöÄ
                </button>
            </form>
        </div>
    </div>

    <div id="modal-nuevo-cliente" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">Nuevo Lead Manual</h3>
                <button onclick="App.ui.toggleModal('modal-nuevo-cliente', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="App.cliente.guardarManual(event)" class="p-6 space-y-4 overflow-y-auto custom-scroll">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Dominio (ID √önico)</label>
                    <input name="dominio" type="text" required placeholder="ejemplo.cl" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-teal-500/20 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">RUT</label>
                        <input name="rut" type="text" placeholder="12.345.678-9" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Rubro</label>
                        <input name="rubro" type="text" placeholder="Ej: Legal" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Negocio</label>
                    <input name="negocio" type="text" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Due√±o</label>
                    <input name="nombre" type="text" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">WhatsApp</label>
                        <input name="whatsapp" type="text" required placeholder="+569..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Email</label>
                        <input name="email" type="email" placeholder="@" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">URL / Maps</label>
                    <input name="url" type="text" placeholder="https://..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Propuesta Inicial</label>
                    <textarea name="propuesta" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-teal-500/20"></textarea>
                </div>
                <button type="submit" class="w-full py-3 bg-teal-600 text-white font-bold rounded-xl shadow-lg shadow-teal-500/30 hover:bg-teal-700 transition-all">Guardar Lead</button>
            </form>
        </div>
    </div>

    <div id="modal-blacklist" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-red-500">Ranking de Errores (Blacklist)</h3><button onclick="App.ui.toggleModal('modal-blacklist', false)"><i class="fa-solid fa-xmark text-slate-400"></i></button></div>
            
            <div class="mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Errores por Modelo</p>
                <div id="blacklist-chart" class="space-y-2"></div>
            </div>
        </div>
    </div>
    <div id="modal-prospectos" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center"><h3 class="text-xl font-bold text-slate-900">Importar Prospectos</h3><button onclick="App.ui.toggleModal('modal-prospectos', false)"><i class="fa-solid fa-xmark text-slate-400"></i></button></div>
            <div class="p-6 flex flex-col gap-4 overflow-y-auto">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Opci√≥n 1: Subir Archivo (CSV/Excel)</label>
                    <input type="file" class="w-full px-4 py-2 rounded-lg border border-slate-200 text-sm">
                </div>
                <div class="flex-1 flex flex-col">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Opci√≥n 2: Pegar C√≥digo JSON</label>
                    <textarea id="import-json-area" rows="12" placeholder='[{"nombre": "Juan", "negocio": "Panader√≠a", "whatsapp": "+569...", "propuesta_text": "..."}]' class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-blue-500/20"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="App.ui.toggleModal('modal-prospectos', false)" class="px-6 py-2 text-slate-500 font-bold text-sm">Cancelar</button>
                <button onclick="App.importar.procesarJSON()" class="px-6 py-2 bg-emerald-500 text-white font-bold text-sm rounded-lg shadow-lg hover:bg-emerald-600 transition-all">Procesar e Importar</button>
            </div>
        </div>
    </div>

    <div id="modal-papelera" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-trash-can mr-2 text-slate-400"></i> Papelera de Reciclaje</h3>
                    <p class="text-xs text-slate-500">Los elementos se eliminan permanentemente despu√©s de 10 d√≠as.</p>
                </div>
                <button onclick="App.ui.toggleModal('modal-papelera', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div id="lista-papelera" class="space-y-3">
                    <p class="text-center text-slate-400 text-sm py-10">Cargando elementos eliminados...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-motivo-descarte" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Motivo de Descarte</h3>
                <button onclick="App.ui.toggleModal('modal-motivo-descarte', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-sm text-slate-500 mb-4">Selecciona por qu√© no se cerr√≥ esta venta:</p>
            <div class="space-y-2">
                <button onclick="App.cliente.confirmarDescarte('No le interesa')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>No le interesa</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
                <button onclick="App.cliente.confirmarDescarte('Presupuesto / Muy caro')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>Presupuesto / Muy caro</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
                <button onclick="App.cliente.confirmarDescarte('Ya contrat√≥ con otro')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>Ya contrat√≥ con otro</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
                <button onclick="App.cliente.confirmarDescarte('No contesta / Ilocalizable')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium rounded-xl border border-slate-100 hover:border-red-100 transition-colors flex justify-between items-center group">
                    <span>No contesta / Ilocalizable</span> <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-red-300 text-xs"></i>
                </button>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100">
                 <button onclick="App.cliente.confirmarDescarteManual()" class="text-xs text-slate-400 hover:text-slate-600 font-bold underline w-full text-center">Escribir otro motivo...</button>
            </div>
        </div>
    </div>

    <div id="modal-notificacion" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 text-center">
            <div id="notificacion-icono" class="mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl"></div>
            <h3 id="notificacion-titulo" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="notificacion-mensaje" class="text-sm text-slate-500 mb-6 text-left" style="white-space: pre-wrap;"></p>
            <button id="notificacion-btn-ok" onclick="App.ui.cerrarNotificacion()" class="w-full py-2.5 font-bold rounded-lg text-white">OK</button>
        </div>
    </div>

    <div id="modal-confirmacion" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-amber-100 text-amber-500"><i class="fa-solid fa-question"></i></div>
            <h3 id="confirmacion-titulo" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="confirmacion-mensaje" class="text-sm text-slate-500 mb-6"></p>
            <div class="flex gap-3">
                <button id="confirmacion-btn-cancel" class="flex-1 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200">Cancelar</button>
                <button id="confirmacion-btn-ok" class="flex-1 py-2.5 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
            <h3 id="prompt-titulo" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="prompt-mensaje" class="text-sm text-slate-500 mb-4"></p>
            <input id="prompt-input" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm outline-none mb-6 focus:ring-2 focus:ring-teal-200">
            <div class="flex gap-3">
                <button id="prompt-btn-cancel" class="flex-1 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200">Cancelar</button>
                <button id="prompt-btn-ok" class="flex-1 py-2.5 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Banner de Permiso de Notificaciones -->
    <div id="notification-permission-banner" class="hidden fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg z-[150] flex items-center gap-4 border border-slate-200">
        <i class="fa-solid fa-bell text-teal-500 text-xl"></i>
        <p class="text-sm text-slate-700 font-medium">¬øActivar alertas de sitios ca√≠dos?</p>
        <button onclick="App.ui.solicitarPermisoNotificaciones()" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded-lg text-sm font-bold">Activar</button>
        <button onclick="document.getElementById('notification-permission-banner').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">&times;</button>
    </div>

    <!-- MODAL INTERCEPTOR RESPUESTA -->
    <div id="modal-interceptor" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 text-center relative">
            <button onclick="App.ui.toggleModal('modal-interceptor', false)" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-teal-100 text-teal-600 animate-pulse"><i class="fa-solid fa-comments"></i></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">¬øTe contest√≥ este lead?</h3>
            <p class="text-sm text-slate-500 mb-6">Ya enviaste el mensaje anteriormente. Necesitamos actualizar el estado.</p>
            <div class="flex flex-col gap-2">
                <button onclick="App.cliente.procesarRespuesta('si')" class="w-full py-3 bg-teal-600 text-white font-bold rounded-xl hover:bg-teal-700 shadow-lg shadow-teal-500/30">S√≠, contest√≥ üí¨</button>
                <button onclick="App.cliente.procesarRespuesta('enviado')" class="w-full py-3 bg-lime-100 text-lime-700 font-bold rounded-xl hover:bg-lime-200">Solo Enviado üì©</button>
                <button onclick="App.cliente.procesarRespuesta('discador')" class="w-full py-3 bg-emerald-100 text-emerald-700 font-bold rounded-xl hover:bg-emerald-200">Mandar al Discador üìû</button>
                <button onclick="App.cliente.procesarRespuesta('no')" class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200">No, eliminar üóëÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURACI√ìN PROMPT IA -->
    <div id="modal-config-prompt" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[120] hidden flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[85vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-robot mr-2 text-teal-500"></i> Cerebro de Ventas (Prompt)</h3>
                <button onclick="App.ui.toggleModal('modal-config-prompt', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-0 flex-1 relative">
                <textarea id="config-prompt-input" class="w-full h-full p-6 text-xs font-mono text-slate-700 bg-white outline-none resize-none leading-relaxed" spellcheck="false"></textarea>
                
                <!-- Panel de Resultados de Prueba -->
                <div id="config-prompt-test-result" class="hidden absolute inset-x-0 bottom-0 h-2/5 bg-slate-900/95 backdrop-blur text-slate-300 p-4 overflow-y-auto border-t border-slate-700 transition-all z-10">
                    <div class="flex justify-between items-start mb-2 sticky top-0 bg-slate-900/95 pb-2 border-b border-slate-700">
                        <span class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest"><i class="fa-solid fa-vial"></i> Resultado de Prueba</span>
                        <button onclick="document.getElementById('config-prompt-test-result').classList.add('hidden')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="test-output" class="text-xs font-mono whitespace-pre-wrap"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                <button onclick="App.ui.probarPrompt()" class="px-4 py-2 bg-cyan-100 text-cyan-700 text-xs font-bold rounded-lg hover:bg-cyan-200 border border-cyan-200 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-flask"></i> Probar con Ejemplo
                </button>
                <div class="flex items-center gap-2">
                    <select id="config-prompt-example-select" class="bg-white border border-slate-200 text-slate-600 text-xs rounded-lg px-2 py-2 outline-none focus:ring-2 focus:ring-cyan-200 cursor-pointer font-bold">
                        <option value="precio">üí∞ Objeci√≥n Precio</option>
                        <option value="interesado">üöÄ Cliente Interesado</option>
                        <option value="enojado">üò° Cliente Enojado</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button onclick="App.ui.restaurarPrompt()" class="px-4 py-2 text-slate-500 text-xs font-bold hover:text-red-500">Restaurar Original</button>
                    <button onclick="App.ui.guardarPrompt()" class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold rounded-lg shadow-md">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sonido de Alerta (base64 beep simple) -->
    <audio id="alert-sound" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" preload="auto"></audio>

    <script>
        // üö® DETECTOR DE ERRORES GLOBAL (Para que sepas por qu√© no carga)
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes('ResizeObserver')) return; // Ignorar error benigno
            alert("‚ö†Ô∏è Error Cr√≠tico del Sistema:\n" + msg + "\nL√≠nea: " + line + "\n\nPor favor, revisa el c√≥digo o recarga.");
        };

        const GEMINI_MODELS = [
            // --- KIMI AI (CEREBRO TUSITIOYA) ---
            "kimi-moonshot-v1-8k",
            "kimi-moonshot-v1-32k",
            "kimi-moonshot-v1-128k",
            // --- GROQ (VELOCIDAD EXTREMA) ---
            "groq-llama-3.3-70b-versatile",
            "groq-llama-3.1-8b-instant",
            "groq-mixtral-8x7b-32768",
            // --- OPENROUTER FREE TIER ---
            "openrouter-google/gemma-2-9b-it:free",
            "openrouter-meta-llama/llama-3.1-8b-instruct:free",
            "openrouter-mistralai/mistral-7b-instruct:free",
            "openrouter-microsoft/phi-3-mini-128k-instruct:free",
            "openrouter-huggingfaceh4/zephyr-7b-beta:free",
            "openrouter-liquid/lfm-40b:free",
            // --- GOOGLE GEMINI ---
            "gemini-2.5-flash", "gemini-2.5-pro", "gemini-2.0-flash", "gemini-2.0-flash-001",
            "gemini-2.0-flash-exp-image-generation", "gemini-2.0-flash-lite-001", "gemini-2.0-flash-lite",
            "gemini-exp-1206", "gemini-2.5-flash-preview-tts", "gemini-2.5-pro-preview-tts",
            "gemma-3-1b-it", "gemma-3-4b-it", "gemma-3-12b-it", "gemma-3-27b-it", "gemma-3n-e4b-it",
            "gemma-3n-e2b-it", "gemini-flash-latest", "gemini-flash-lite-latest", "gemini-pro-latest",
            "gemini-2.5-flash-lite", "gemini-2.5-flash-image", "gemini-2.5-flash-preview-09-2025",
            "gemini-2.5-flash-lite-preview-09-2025", "gemini-3-pro-preview", "gemini-3-flash-preview",
            "gemini-3-pro-image-preview", "nano-banana-pro-preview", "gemini-robotics-er-1.5-preview",
            "gemini-2.5-computer-use-preview-10-2025", "deep-research-pro-preview-12-2025"
        ];

        const PROMPT_TEMPLATE = `Act√∫a como un experto en prospecci√≥n digital. Eres Alexis Ferrada de la agencia "TuSitioYa".`;
        
        // CONSTANTES FALTANTES (Agregadas para evitar errores)
        const DEFAULT_ANALYSIS_PROMPT = `Act√∫a como un experto en ventas y analiza esta conversaci√≥n.`;
        const EXAMPLE_CONVERSATIONS = {
            precio: "Cliente: Es muy caro...",
            interesado: "Cliente: Me interesa...",
            enojado: "Cliente: No me llamen m√°s..."
        };

        const App = {
            datos: { leads: [], blacklist: [] },
            tempLeads: [],
            filtroBusqueda: '', // Estado para el buscador
            clienteActivoIndex: null,

            init: async function() {
                try {
                    this.datos.blacklist = JSON.parse(localStorage.getItem('blacklist') || '[]');
                    this.ui.actualizarBlacklistCount();
                    this.models.cargarLista();
                    // Intentar cargar estado visual IA sin bloquear la app si falla
                    try { this.models.analizarEstado(); } catch(e) { console.warn("UI IA:", e); }
                    
                    // Agregamos timestamp para evitar que el navegador use cach√©
                    const res = await fetch(`/api/clientes?_=${new Date().getTime()}`);
                    
                    if (res.status === 404) {
                        throw new Error("Ruta API no encontrada (404).\n\n‚ö†Ô∏è CAUSA PROBABLE:\nNo est√°s ejecutando el servidor Node.js o est√°s usando 'Live Server'.\n\nSOLUCI√ìN:\n1. Abre la terminal.\n2. Ejecuta: node server.js\n3. Entra a: http://localhost:3000");
                    }

                    if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
                    
                    const data = await res.json();
                    if (!Array.isArray(data)) throw new Error("Formato de datos inv√°lido");

                    this.datos.leads = data.map(l => ({
                        ...l,
                        fecha_agendada: l.fecha_seguimiento, // Recuperar fecha real de la DB
                        estado: this.api.mapEstado(l.estado),
                        propuesta: l.propuesta_text || '',
                        historial: l.encuesta_data?.historial || []
                    }));

                    document.getElementById('neon-status-text').innerText = "CONECTADO";
                    document.getElementById('neon-status-dot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                } catch (err) {
                    console.error("Error de conexi√≥n:", err);
                    const statusText = document.getElementById('neon-status-text');
                    if (statusText) statusText.innerText = "OFFLINE";
                    const statusDot = document.getElementById('neon-status-dot');
                    if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                    this.datos.leads = []; // Prevenir errores en renderizado
                    // Mostrar error visible al usuario para depurar
                    this.ui.notificar(err.message, "Error de Conexi√≥n", "error");
                }
                
                this.ui.renderizarListas(); // Esto ya llama a las dem√°s actualizaciones
                if (this.finanzas) this.finanzas.actualizarDesdeClientes(); // Actualizar dashboard financiero
                this.monitor.init();
                this.movimientos.init(); // Cargar historial global desde DB
                this.monitor.sincronizar(); // Sincronizar clientes con el monitor
                this.conversion.init();
                this.auth.init(); // Inicializar sistema de autenticaci√≥n

                // Listener para cerrar ficha con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modalFicha = document.getElementById('modal-ficha-cliente');
                        if (!modalFicha.classList.contains('hidden')) App.cliente.cerrarFicha();
                    }
                });
            },

            papelera: {
                cargar: async () => {
                    const lista = document.getElementById('lista-papelera');
                    lista.innerHTML = '<p class="text-center text-slate-400 text-sm py-10"><i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...</p>';
                    try {
                        const res = await fetch('/api/papelera');
                        const data = await res.json();
                        
                        if (data.length === 0) {
                            lista.innerHTML = '<div class="text-center py-10"><i class="fa-regular fa-trash-can text-4xl text-slate-200 mb-3"></i><p class="text-slate-400 text-sm">La papelera est√° vac√≠a.</p></div>';
                            return;
                        }

                        lista.innerHTML = data.map(c => `
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div>
                                    <h4 class="font-bold text-slate-700">${c.negocio}</h4>
                                    <p class="text-xs text-slate-500">Eliminado: ${new Date(c.deleted_at).toLocaleDateString()}</p>
                                </div>
                                <button onclick="App.papelera.restaurar(${c.id})" class="px-4 py-2 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-lg hover:bg-emerald-200 transition-colors"><i class="fa-solid fa-rotate-left mr-1"></i> Restaurar</button>
                            </div>
                        `).join('');
                    } catch (e) { lista.innerHTML = '<p class="text-red-500 text-center">Error al cargar papelera.</p>'; }
                },
                restaurar: async (id) => {
                    if(!confirm('¬øRestaurar este cliente?')) return;
                    await fetch(`/api/clientes/${id}/restaurar`, { method: 'POST' });
                    App.papelera.cargar();
                    App.init(); // Recargar lista principal
                    App.ui.notificar("Cliente restaurado exitosamente.", "Restaurado", "exito");
                }
            },

            auth: {
                SESSION_KEY: 'tusitioya_session',
                
                init: function() {
                    try {
                        if (sessionStorage.getItem(App.auth.SESSION_KEY) === 'active') {
                            App.auth.mostrarApp();
                        }
                    } catch(e) { console.error(e); }
                },
                
                login: async function(e) {
                    if(e) e.preventDefault();
                    const userInput = document.getElementById('login-user');
                    const passInput = document.getElementById('login-password');
                    const error = document.getElementById('login-error');
                    const btn = e && e.target ? e.target.querySelector('button') : document.querySelector('#login-screen button');
                    
                    // Feedback visual
                    const originalText = btn ? btn.innerHTML : 'Ingresar';
                    if(btn) {
                        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verificando...';
                        btn.disabled = true;
                    }
                    
                    const username = userInput.value.trim();
                    const password = passInput.value.trim();
                    
                    // LOGIN LOCAL HARDCODEADO (bypass del servidor)
                    if (username === 'alexisferrada' && password === '123654') {
                        sessionStorage.setItem(App.auth.SESSION_KEY, 'active');
                        error.classList.add('hidden');
                        App.auth.mostrarApp();
                        passInput.value = '';
                        if(btn) {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                        return;
                    }
                    
                    try {
                        console.log("Intentando login con:", username);

                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                username: username, 
                                password: password 
                            })
                        });
                        
                        // Verificar si la respuesta es v√°lida
                        const contentType = res.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                             throw new Error(`Error del servidor (${res.status})`);
                        }

                        const data = await res.json();
                        
                        if (res.ok && data.status === 'success') {
                            sessionStorage.setItem(App.auth.SESSION_KEY, 'active');
                            error.classList.add('hidden');
                            App.auth.mostrarApp();
                            passInput.value = '';
                        } else {
                            throw new Error(data.error || 'Credenciales incorrectas');
                        }
                    } catch (err) {
                        console.error("Login error:", err);

                        error.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> ${err.message}`;
                        error.classList.remove('hidden');
                        passInput.classList.add('border-red-300');
                        setTimeout(() => passInput.classList.remove('border-red-300'), 2000);
                    } finally {
                        if(btn) {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    }
                },
                
                logout: function() {
                    sessionStorage.removeItem(App.auth.SESSION_KEY);
                    location.reload();
                },
                
                mostrarApp: function() {
                    document.getElementById('login-screen').style.display = 'none';
                    const screen = document.getElementById('login-screen');
                    if(screen) screen.style.display = 'none';
                    document.body.style.overflow = '';
                }
            },

            util: {
                limpiarTelefono: (fono) => {
                    if(!fono) return '';
                    // 1. Convertir a string y eliminar todo lo que no sea n√∫mero
                    let limpio = String(fono).trim().replace(/\s+/g, '').replace(/\D/g, '');
                    
                    // 2. L√≥gica estricta para Chile (+569...)
                    if (limpio.length === 8) limpio = '569' + limpio;
                    else if (limpio.length === 9 && limpio.startsWith('9')) limpio = '56' + limpio;
                    
                    return limpio;
                },
                fechaHoy: () => new Date().toISOString().split('T')[0],
                fechaHoraDefault: () => {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Ajuste zona horaria local
                    return now.toISOString().slice(0, 16); // Formato YYYY-MM-DDTHH:mm
                },
                fechaHoraHabilDefault: () => {
                    const now = new Date();
                    const day = now.getDay();
                    const hour = now.getHours();

                    // L√≥gica de horario h√°bil:
                    // Domingo (0) -> Lunes (+1)
                    // S√°bado (6) > 16:00 -> Lunes (+2)
                    // Lunes-Viernes (1-5) > 19:00 -> Ma√±ana (+1)
                    
                    if (day === 0) now.setDate(now.getDate() + 1);
                    else if (day === 6 && hour >= 16) now.setDate(now.getDate() + 2);
                    else if (day >= 1 && day <= 5 && hour >= 19) {
                        now.setDate(now.getDate() + 1);
                        // Si era Viernes y pas√≥ a S√°bado > 16:00 (ej: Viernes 20:00 -> S√°bado 20:00), mover a Lunes
                        if (now.getDay() === 6 && now.getHours() >= 16) now.setDate(now.getDate() + 2);
                    }

                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    return now.toISOString().slice(0, 16);
                },
                fechaActualHistorial: () => new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            },

            movimientos: {
                lista: [],
                init: async () => {
                    try {
                        const res = await fetch('/api/movimientos');
                        if (res.ok) {
                            App.movimientos.lista = await res.json();
                            App.movimientos.render();
                        }
                    } catch (e) { console.error("Error cargando movimientos", e); }
                },
                agregar: async (tipo, descripcion, monto = null) => {
                    const hora = new Date().toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit'});
                    const fecha = new Date().toLocaleDateString('es-CL', {day: '2-digit', month: 'short'});
                    
                    const mov = {
                        tipo, // 'pago', 'gasto', 'interaccion', 'venta'
                        descripcion,
                        monto,
                        fecha: `${fecha} ${hora}`
                    };
                    
                    // Guardar en DB
                    try {
                        await fetch('/api/movimientos', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(mov)
                        });
                        // Recargar lista para mostrar el ID real y orden correcto
                        App.movimientos.init();
                    } catch (e) { console.error("Error guardando movimiento", e); }
                },
                render: () => {
                    const container = document.getElementById('activity-log-container');
                    if (!container) return;
                    if (App.movimientos.lista.length === 0) {
                        container.innerHTML = '<p class="text-[10px] text-slate-400 text-center italic mt-4">No hay movimientos recientes.</p>';
                        return;
                    }
                    container.innerHTML = App.movimientos.lista.map(m => {
                        let icon = 'fa-circle', color = 'text-slate-400', bg = 'bg-slate-50';
                        if (m.tipo === 'pago') { icon = 'fa-sack-dollar'; color = 'text-emerald-500'; bg = 'bg-emerald-50'; }
                        else if (m.tipo === 'gasto') { icon = 'fa-money-bill-transfer'; color = 'text-red-500'; bg = 'bg-red-50'; }
                        else if (m.tipo === 'interaccion') { icon = 'fa-comments'; color = 'text-blue-500'; bg = 'bg-blue-50'; }
                        else if (m.tipo === 'venta') { icon = 'fa-trophy'; color = 'text-yellow-500'; bg = 'bg-yellow-50'; }
                        const montoHtml = m.monto ? `<span class="font-bold ${color} ml-auto text-[10px]">$${parseInt(m.monto).toLocaleString('es-CL')}</span>` : '';
                        return `
                            <div class="flex items-center gap-2 p-2 rounded-lg ${bg} border border-transparent hover:border-slate-200 transition-all">
                                <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center shadow-sm ${color} text-[10px]"><i class="fa-solid ${icon}"></i></div>
                                <div class="flex-1 min-w-0"><p class="text-[10px] font-bold text-slate-700 truncate">${m.descripcion}</p><p class="text-[8px] text-slate-400">${m.fecha}</p></div>
                                ${montoHtml}
                            </div>`;
                    }).join('');
                }
            },

            api: {
                mapEstado: (dbEstado) => {
                    const map = {
                        'prospecto': 'nuevos',
                        'whatsapp_enviado': 'whatsapp_enviado', // Lime
                        'sin_respuesta': 'sin_respuesta',
                        'contactado': 'seguimiento', // Cyan
                        'cliente': 'cerrados', // Green
                        'no_interesado': 'descartados',
                        'discador': 'discador'
                    };
                    return map[dbEstado] || 'nuevos';
                }
            },

            models: {
                cargarLista: () => { document.getElementById('model-selector').innerHTML = GEMINI_MODELS.map(m => `<option value="${m}">${m}</option>`).join(''); },
                analizarEstado: () => {
                    const statusBadge = document.getElementById('ia-status-badge');
                    const bar = document.getElementById('ia-capacity-bar');
                    const text = document.getElementById('ia-capacity-text');
                    const analysis = document.getElementById('ia-analysis');
                    const model = document.getElementById('model-selector').value;
                    
                    // Verificaci√≥n de seguridad para evitar errores de "null"
                    if (!statusBadge || !bar || !text || !analysis) return;

                    statusBadge.innerHTML = 'CONNECTING...'; statusBadge.className = "bg-slate-100 text-slate-400 px-2 py-0.5 rounded text-[9px] font-bold";
                    bar.style.width = '0%'; text.innerText = 'OFF'; analysis.innerHTML = 'Handshake...';

                    setTimeout(() => {
                        if (!statusBadge || !bar || !text || !analysis) return; // Doble verificaci√≥n as√≠ncrona
                        
                        // Detectar Kimi AI (Cerebro Tusitioya)
                        if (model.includes('kimi')) {
                            statusBadge.innerHTML = 'üöÄ KIMI ONLINE <div class="w-1.5 h-1.5 rounded-full bg-purple-500 animate-pulse"></div>';
                            statusBadge.className = "bg-purple-50 text-purple-600 border border-purple-100 px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1";
                            bar.style.width = '95%'; text.innerText = 'OPTIMO';
                            bar.className = "bg-purple-500 h-full transition-all duration-1000 ease-out";
                            analysis.innerHTML = 'üß† Cerebro Tusitioya Activado | Latencia: 12ms';
                        } else if (model.includes(':free')) {
                            // Modelos gratuitos de OpenRouter
                            statusBadge.innerHTML = 'ONLINE <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>';
                            statusBadge.className = "bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1";
                            bar.style.width = '100%'; text.innerText = '‚àû';
                            bar.className = "bg-teal-500 h-full transition-all duration-1000 ease-out";
                            analysis.innerHTML = 'Modelo Gratuito (OpenRouter)';
                        } else {
                            // Simulaci√≥n para otros modelos
                            statusBadge.innerHTML = 'ONLINE <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>';
                            statusBadge.className = "bg-emerald-50 text-emerald-600 border border-emerald-100 px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1";
                            let cap = 90 + Math.floor(Math.random() * 10);
                            bar.style.width = `${cap}%`; text.innerText = `${cap}%`;
                            bar.className = "bg-teal-500 h-full transition-all duration-1000 ease-out";
                            analysis.innerHTML = `Latencia: ${Math.floor(Math.random()*50)+10}ms.`;
                        }
                    }, 800);
                }
            },

            cliente: {
                abrir: (index, forceOpen = false) => {
                    try {
                        const lead = App.datos.leads[index];
                        if (!lead) {
                            console.error("Lead no encontrado en √≠ndice:", index);
                            return;
                        }
                        App.clienteActivoIndex = index;

                        // Helper para setear texto seguro
                        const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val || ''; };
                        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };

                        // Header Ficha
                        setText('header-negocio', lead.negocio);
                        setText('header-id', lead.codigo_seguimiento ? `REF: ${lead.codigo_seguimiento}` : `ID: ${lead.id}`);
                        setText('header-nombre', lead.nombre || 'Desconocido');
                        setText('header-telefono', lead.whatsapp);
                        setText('header-dominio', lead.dominio || 'Sin dominio');

                        // --- CARGA DE DATOS ---
                        
                        // 1. Finanzas
                        setVal('ficha-monto-total', lead.monto_total || 0);
                        setVal('ficha-monto-pagado', lead.monto_pagado || 0);
                        const saldo = Math.max(0, (lead.monto_total || 0) - (lead.monto_pagado || 0));
                        setVal('ficha-saldo-pendiente', new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(saldo));
                        setVal('ficha-fecha-pago', lead.fecha_proximo_pago ? lead.fecha_proximo_pago.split('T')[0] : '');

                        // 2. Datos B√°sicos
                        setVal('ficha-negocio', lead.negocio);
                        setVal('ficha-nombre', lead.nombre);
                        setVal('ficha-whatsapp', lead.whatsapp);
                        setVal('ficha-dominio', lead.dominio);
                        setVal('ficha-rut', lead.rut);

                        // 3. Datos Extendidos (Desde encuesta_data o defaults)
                        const extra = lead.encuesta_data || {};
                        setVal('ficha-email', extra.email);
                        setVal('ficha-rubro', extra.rubro);
                        setVal('ficha-url', extra.url);
                        setVal('ficha-notas', extra.notas);
                        setVal('ficha-monto-mantencion', extra.monto_mantencion);
                        setVal('ficha-dia-pago', extra.dia_pago);
                        App.cliente.actualizarProyeccionMensual();
                        
                        // 5. Datos de Proyecto (NUEVO)
                        setVal('ficha-progreso', extra.progreso || 0);
                        setText('lbl-progreso', (extra.progreso || 0) + '%');
                        setVal('ficha-fase', extra.fase_actual || 'Inicio del Proyecto');
                        setVal('ficha-drive', extra.drive_link || '');

                        // 3.1 Cargar Encuesta Web (Si existe)
                        const web = extra.respuestas_web || {};
                        
                        // Mostrar fecha y contacto si existen
                        if (extra.fecha_encuesta) {
                            document.getElementById('badge-encuesta-info').classList.remove('hidden');
                            const fecha = new Date(extra.fecha_encuesta).toLocaleDateString('es-CL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                            document.getElementById('txt-encuesta-fecha').innerText = fecha;
                        } else {
                            document.getElementById('badge-encuesta-info').classList.add('hidden');
                        }

                        if (extra.whatsapp_soporte) {
                            document.getElementById('field-whatsapp-soporte').classList.remove('hidden');
                            document.getElementById('txt-whatsapp-soporte').innerText = extra.whatsapp_soporte;
                        } else {
                            document.getElementById('field-whatsapp-soporte').classList.add('hidden');
                        }

                        setVal('p1_objetivo', web.objetivo || 'Vender productos (E-commerce)');
                        setVal('p2_publico', web.publico || '');
                        setVal('p3_referentes', web.referentes || '');
                        setVal('p4_estilo', web.estilo || '');
                        setVal('p5_secciones', web.secciones || '');
                        setVal('p6_funcionalidades', web.funcionalidades || '');
                        setVal('p7_tono', web.tono || 'Profesional y Serio');
                        // Ocultar resultado anterior
                        document.getElementById('container-prompt-web').classList.add('hidden');
                        
                        // 3.2 Generar Link de Encuesta
                        const linkEncuesta = `${window.location.origin}/encuesta.html?id=${lead.codigo_seguimiento || lead.id}`;
                        setVal('link-encuesta-cliente', linkEncuesta);

                        // 4. Estado T√°ctico (Temperatura)
                        const temp = extra.temperatura || 'frio';
                        if (App.cliente.renderTemperatura) App.cliente.renderTemperatura(temp);

                        // Script (Columna 3 - Referencia)
                        setVal('ficha-script', lead.propuesta || 'Sin script generado.');
                        
                        // Info Financiera
                        const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
                        const fichaFinanciera = document.getElementById('ficha-financiera');
                        const fichaTactico = document.getElementById('ficha-estado-tactico');
                        const accionesVenta = document.getElementById('acciones-venta');
                        const accionesCliente = document.getElementById('acciones-cliente');

                        if (lead.estado === 'cerrados') {
                            if (fichaFinanciera) {
                                fichaFinanciera.classList.remove('hidden');
                                setText('ficha-total', formatter.format(lead.monto_total || 0));
                                setText('ficha-pagado', formatter.format(lead.monto_pagado || 0));
                            }
                            if (fichaTactico) fichaTactico.classList.add('hidden'); // Ocultar t√°ctica en clientes cerrados
                            if (accionesVenta) accionesVenta.classList.add('hidden'); // Ocultar botones de venta
                            if (accionesCliente) accionesCliente.classList.remove('hidden'); // Mostrar botones de gesti√≥n
                        } else {
                            if (fichaFinanciera) fichaFinanciera.classList.add('hidden');
                            if (fichaTactico) fichaTactico.classList.remove('hidden'); // Mostrar t√°ctica en prospectos
                            if (accionesVenta) accionesVenta.classList.remove('hidden'); // Mostrar botones de venta
                            if (accionesCliente) accionesCliente.classList.add('hidden'); // Ocultar botones de gesti√≥n
                        }

                        const badge = document.getElementById('ficha-estado-badge');
                        if (badge) {
                            let textoEstado = (lead.estado || '').toUpperCase();
                            let badgeClass = "bg-slate-700 text-slate-300";
                            
                            if (lead.estado === 'cerrados') {
                                badgeClass = "bg-green-100 text-green-700";
                                textoEstado = "CLIENTE ACTIVO";
                            }
                            else if (lead.estado === 'descartados') badgeClass = "bg-red-100 text-red-700";
                            else if (lead.estado === 'seguimiento') badgeClass = "bg-cyan-100 text-cyan-700";
                            else if (lead.estado === 'whatsapp_enviado') badgeClass = "bg-lime-100 text-lime-700";
                            else if (lead.estado === 'sin_respuesta') badgeClass = "bg-slate-100 text-slate-500";
                            
                            badge.innerText = textoEstado;
                            badge.className = `px-3 py-1 rounded-full text-xs font-bold uppercase ${badgeClass}`;
                        }
                        
                        // Calcular intentos
                        const intentos = (lead.historial || []).filter(h => h.nota && (h.nota.includes('WhatsApp Enviado') || h.nota.includes('Enviado'))).length;
                        setText('ficha-intentos-count', intentos);

                        if (this.renderizarHistorial) this.renderizarHistorial(lead);
                        
                        // Reset Analysis View
                        setVal('historial-chat-input', '');
                        const analysisResult = document.getElementById('analysis-result');
                        if (analysisResult) {
                            analysisResult.classList.add('hidden');
                            analysisResult.innerHTML = '';
                        }

                        // Configuraci√≥n Discador
                        const discadorBar = document.getElementById('ficha-discador-bar');
                        if (discadorBar) {
                            if (App.discador.activo) {
                                discadorBar.classList.remove('hidden');
                                setText('discador-counter', `${App.discador.indiceActual + 1} / ${App.discador.cola.length}`);
                                
                                // Mostrar intentos de contacto previos
                                const intentos = (lead.historial || []).filter(h => h.nota && (h.nota.includes('WhatsApp Enviado') || h.nota.includes('Enviado'))).length;
                                const elIntentos = document.getElementById('discador-intentos');
                                if(elIntentos) {
                                    elIntentos.innerText = `Enviados: ${intentos}`;
                                    elIntentos.classList.remove('hidden');
                                }
                            } else {
                                discadorBar.classList.add('hidden');
                            }
                        }
                        
                        App.ui.toggleModal('modal-ficha-cliente', true);
                    } catch (e) {
                        console.error("Error al abrir ficha:", e);
                        App.ui.notificar("Error al abrir la ficha del cliente. Revisa la consola.", "Error", "error");
                    }
                },
                renderizarHistorial: function(lead) {
                    const histContainer = document.getElementById('ficha-historial');
                    if (!histContainer) return;
                    
                    if (lead.historial && lead.historial.length > 0) {
                        histContainer.innerHTML = lead.historial.map(h => {
                            const nota = h.nota ? h.nota.replace(/\n/g, '<br>') : '';
                            return `<div class="relative pb-4 last:pb-0"><div class="absolute top-1 -left-[13px] w-2 h-2 bg-slate-200 rounded-full border border-white"></div><p class="text-[10px] text-slate-400 font-bold mb-0.5">${h.fecha}</p><p class="text-xs text-slate-600 bg-slate-50 p-2 rounded-lg border border-slate-100">${nota}</p></div>`;
                        }).join('');
                    } else { 
                        histContainer.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-2">Sin historial.</p>'; 
                    }
                },
                _guardarEncuestaData: async function() {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    try {
                        if (!lead.encuesta_data) lead.encuesta_data = {};
                        // Make sure local history is synced to encuesta_data before saving
                        lead.encuesta_data.historial = lead.historial; 
                        
                        const payload = { cliente_id: lead.id, ...lead.encuesta_data };
                        await fetch('/api/encuesta', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });
                    } catch(e) {
                        console.error("Error guardando encuesta_data", e);
                    }
                },
                agregarNotaHistorial: async function(nota) {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];

                    if (!lead.historial) lead.historial = [];
                    lead.historial.push({ fecha: App.util.fechaActualHistorial(), nota: nota });

                    this.renderizarHistorial(lead);
                    await this._guardarEncuestaData(); // Save the whole thing
                },
                guardarHistorialPegado: async function(event) {
                    event.preventDefault();
                    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                    if (!pastedText) return;
                    document.getElementById('historial-chat-input').value = pastedText;
                    const nota = `üìã Conversaci√≥n pegada:\n---\n${pastedText}`;
                    await App.cliente.agregarNotaHistorial(nota);
                    App.ui.notificar("Historial de chat guardado.", "Guardado", "exito", 1500);
                },
                renderTemperatura: (temp) => {
                    // Reset estilos
                    ['frio', 'tibio', 'caliente'].forEach(t => {
                        const btn = document.getElementById(`btn-temp-${t}`);
                        if(btn) btn.className = "py-1.5 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all opacity-50";
                    });
                    
                    // Activar seleccionado
                    const activeBtn = document.getElementById(`btn-temp-${temp}`);
                    if (activeBtn) {
                        let activeClass = "";
                        if(temp === 'frio') activeClass = "bg-blue-100 text-blue-600 border-blue-200 opacity-100";
                        if(temp === 'tibio') activeClass = "bg-orange-100 text-orange-600 border-orange-200 opacity-100";
                        if(temp === 'caliente') activeClass = "bg-red-100 text-red-600 border-red-200 opacity-100";
                        activeBtn.className = `py-1.5 rounded-lg text-xs font-bold border transition-all shadow-sm transform scale-105 ${activeClass}`;
                    }
                },
                setTemperatura: (temp) => {
                    App.cliente.renderTemperatura(temp);
                    App.cliente.actualizarCampo('temperatura', temp);
                },
                actualizarCampo: async (campo, valor) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    // Campos que van en la ra√≠z de la tabla
                    const camposRaiz = ['negocio', 'nombre', 'whatsapp', 'dominio', 'monto_total', 'monto_pagado', 'fecha_proximo_pago', 'rut'];
                    
                    if (camposRaiz.includes(campo)) {
                        // Actualizar localmente
                        lead[campo] = valor;
                        
                        // Recalcular saldo visualmente si cambian montos
                        if (campo === 'monto_total' || campo === 'monto_pagado') {
                            const elTotal = document.getElementById('ficha-monto-total');
                            const elPagado = document.getElementById('ficha-monto-pagado');
                            const elSaldo = document.getElementById('ficha-saldo-pendiente');
                            
                            const total = elTotal ? (parseInt(elTotal.value) || 0) : 0;
                            const pagado = elPagado ? (parseInt(elPagado.value) || 0) : 0;
                            const saldo = Math.max(0, total - pagado);
                            if (elSaldo) elSaldo.value = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(saldo);
                            
                            // Actualizar dashboard financiero y meta mensual
                            if (App.finanzas) App.finanzas.actualizarDesdeClientes();
                            if (App.logros) App.logros.actualizarMetaMensual();
                        }

                        // Enviar al servidor (PUT)
                        try {
                            const body = {}; 
                            body[campo] = valor;
                            // Si es un pago, guardar tambi√©n la fecha
                            if (campo === 'monto_pagado' && valor > 0) {
                                body.fecha_pago = new Date().toISOString();
                                lead.fecha_pago = body.fecha_pago;
                            }
                            await fetch(`/api/clientes/${lead.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                            if(campo === 'negocio') {
                                const elHeader = document.getElementById('header-negocio');
                                if(elHeader) elHeader.innerText = valor;
                            }
                        } catch(e) { console.error("Error guardando campo ra√≠z", e); }

                    } else {
                        // Campos extra (Email, Rubro, URL, Temperatura, Notas) -> Guardar en encuesta_data
                        if (!lead.encuesta_data) lead.encuesta_data = {};
                        lead.encuesta_data[campo] = valor;
                        
                        // Usamos PUT para actualizar de forma segura
                        try {
                            const payload = { encuesta_data: lead.encuesta_data };
                            await fetch(`/api/clientes/${lead.id}`, { 
                                method: 'PUT', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify(payload) 
                            });
                        } catch(e) { console.error("Error guardando campo extendido", e); }
                    }
                },
                actualizarProyeccionMensual: () => {
                    const elDia = document.getElementById('ficha-dia-pago');
                    const elMonto = document.getElementById('ficha-monto-mantencion');
                    if(!elDia || !elMonto) return;

                    const dia = parseInt(elDia.value);
                    const monto = elMonto.value;
                    const container = document.getElementById('info-proxima-mensualidad');
                    const txt = document.getElementById('txt-proximo-cobro');

                    if (dia && dia > 0 && dia <= 31 && monto) {
                        const hoy = new Date();
                        const fechaCobro = new Date(hoy.getFullYear(), hoy.getMonth(), dia);
                        
                        const opciones = { weekday: 'long', day: 'numeric', month: 'long' };
                        if(txt) txt.innerText = fechaCobro.toLocaleDateString('es-CL', opciones);
                        if(container) container.classList.remove('hidden');
                    } else {
                        if(container) container.classList.add('hidden');
                    }
                },
                
                eliminarPago: async function() {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    const montoActual = parseInt(lead.monto_pagado) || 0;
                    if (montoActual === 0) {
                        App.ui.notificar('Este cliente no tiene pagos registrados', 'Sin pagos', 'error');
                        return;
                    }
                    
                    if (!confirm(`¬øEliminar el pago de $${montoActual.toLocaleString()}?\n\nEsta acci√≥n no se puede deshacer.`)) return;
                    
                    try {
                        // Enviar al servidor: poner monto_pagado a 0 y limpiar fecha_pago
                        await fetch(`/api/clientes/${lead.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                monto_pagado: 0,
                                fecha_pago: null
                            })
                        });
                        
                        // Actualizar localmente
                        lead.monto_pagado = 0;
                        lead.fecha_pago = null;
                        
                        // Actualizar UI
                        document.getElementById('ficha-monto-pagado').value = 0;
                        
                        // Recalcular saldo
                        const elTotal = document.getElementById('ficha-monto-total');
                        const total = elTotal ? (parseInt(elTotal.value) || 0) : 0;
                        const saldo = total;
                        const elSaldo = document.getElementById('ficha-saldo-pendiente');
                        if (elSaldo) elSaldo.value = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(saldo);
                        
                        // Agregar nota al historial
                        App.cliente.agregarNotaHistorial(`‚ùå PAGO ELIMINADO. Monto anterior: $${montoActual.toLocaleString()}`);
                        
                        // Actualizar dashboard financiero y meta mensual
                        if (App.finanzas) App.finanzas.actualizarDesdeClientes();
                        if (App.logros) App.logros.actualizarMetaMensual();
                        
                        App.ui.notificar(`Pago eliminado: $${montoActual.toLocaleString()}`, 'Pago Eliminado', 'exito');
                    } catch (e) {
                        console.error('Error eliminando pago:', e);
                        App.ui.notificar('Error al eliminar el pago', 'Error', 'error');
                    }
                },
                
                guardarEncuestaWeb: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    const respuestas = {
                        objetivo: document.getElementById('p1_objetivo').value,
                        publico: document.getElementById('p2_publico').value,
                        referentes: document.getElementById('p3_referentes').value,
                        estilo: document.getElementById('p4_estilo').value,
                        secciones: document.getElementById('p5_secciones').value,
                        funcionalidades: document.getElementById('p6_funcionalidades').value,
                        tono: document.getElementById('p7_tono').value
                    };

                    // Actualizar localmente
                    if (!lead.encuesta_data) lead.encuesta_data = {};
                    lead.encuesta_data.respuestas_web = respuestas;

                    try {
                        await fetch(`/api/clientes/${lead.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ respuestas_web: respuestas })
                        });
                        App.ui.notificar("Briefing web guardado correctamente.", "Guardado", "exito");
                    } catch (e) {
                        console.error(e);
                        App.ui.notificar("Error al guardar briefing.", "Error", "error");
                    }
                },
                generarPromptWeb: async () => {
                    const btn = document.getElementById('btn-prompt-web');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generando...';
                    btn.disabled = true;

                    const data = App.datos.leads[App.clienteActivoIndex].encuesta_data.respuestas_web || {};
                    // Recoger valores actuales por si no se ha guardado
                    data.objetivo = document.getElementById('p1_objetivo').value;
                    data.publico = document.getElementById('p2_publico').value;
                    // ... (resto de campos se toman del DOM si se quiere ser estricto, pero asumimos guardado o uso directo)
                    
                    const prompt = `Act√∫a como Arquitecto de Software Senior. Crea un PROMPT T√âCNICO DETALLADO para desarrollar una Landing Page con estas caracter√≠sticas:\n\n1. Objetivo: ${document.getElementById('p1_objetivo').value}\n2. P√∫blico: ${document.getElementById('p2_publico').value}\n3. Referentes: ${document.getElementById('p3_referentes').value}\n4. Estilo: ${document.getElementById('p4_estilo').value}\n5. Secciones: ${document.getElementById('p5_secciones').value}\n6. Funcionalidades: ${document.getElementById('p6_funcionalidades').value}\n7. Tono: ${document.getElementById('p7_tono').value}\n\nSALIDA: Un prompt optimizado para que una IA de c√≥digo (Cursor/Windsurf) genere el proyecto completo en HTML/Tailwind/JS.`;

                    try {
                        const res = await fetch('/api/analizar-chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ prompt: prompt }) });
                        const json = await res.json();
                        document.getElementById('txt-prompt-web').value = json.analisis;
                        document.getElementById('container-prompt-web').classList.remove('hidden');
                    } catch(e) { App.ui.notificar("Error generando prompt", "Error", "error"); }
                    
                    btn.innerHTML = originalText; btn.disabled = false;
                },
                copiarLinkEncuesta: () => {
                    const link = document.getElementById('link-encuesta-cliente');
                    link.select();
                    navigator.clipboard.writeText(link.value);
                    App.ui.notificar("Link copiado al portapapeles", "Copiado", "exito");
                },
                verSitio: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    let url = lead.dominio;
                    if (!url) {
                        App.ui.notificar("El cliente no tiene un dominio asignado.", "Sin Dominio", "error");
                        return;
                    }
                    if (!url.startsWith('http')) url = 'https://' + url;
                    window.open(url, '_blank');
                },
                abrirSoporteWhatsApp: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const fono = App.util.limpiarTelefono(lead.whatsapp);
                    if(fono) window.open(`https://wa.me/${fono}`, 'whatsapp_tab');
                    else App.ui.notificar("El cliente no tiene un n√∫mero v√°lido", "Error", "error");
                },
                agregarServicio: () => {
                    App.ui.notificar("Funcionalidad de Agregar Servicio en desarrollo.", "Pr√≥ximamente", "info");
                },
                copiarSoporte: () => {
                    const txt = document.getElementById('txt-whatsapp-soporte').innerText;
                    navigator.clipboard.writeText(txt);
                    App.ui.notificar("N√∫mero copiado", "Copiado", "exito");
                },
                enviarEncuestaWhatsApp: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const link = document.getElementById('link-encuesta-cliente').value;
                    const mensaje = `Hola ${lead.nombre || ''} üëã, para avanzar con el dise√±o de tu web üíª, necesito que completes este breve formulario con tus preferencias: ${link}`;
                    const fono = App.util.limpiarTelefono(lead.whatsapp);
                    if(fono) window.open(`https://wa.me/${fono}?text=${encodeURIComponent(mensaje)}`, 'whatsapp_tab');
                    else App.ui.notificar("El cliente no tiene un n√∫mero v√°lido", "Error", "error");
                },
                enviarHojaRutaWhatsApp: () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const link = `${window.location.origin}/hoja_ruta.html?id=${lead.codigo_seguimiento || lead.id}`;
                    const mensaje = `Hola ${lead.nombre || ''} üëã, aqu√≠ tienes el enlace a tu Hoja de Ruta üó∫Ô∏è para ver el avance del proyecto en tiempo real y subir tus archivos: ${link}`;
                    const fono = App.util.limpiarTelefono(lead.whatsapp);
                    if(fono) window.open(`https://wa.me/${fono}?text=${encodeURIComponent(mensaje)}`, 'whatsapp_tab');
                    else App.ui.notificar("El cliente no tiene un n√∫mero v√°lido", "Error", "error");
                },
                generarHojaRutaIA: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const btn = document.getElementById('btn-ruta-ia');
                    const txtCustom = document.getElementById('txt-ruta-custom');
                    
                    // Feedback visual de carga
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Creando Ruta...';
                    btn.disabled = true;

                    const rubro = lead.encuesta_data?.rubro || lead.rubro || "";
                    const negocio = lead.negocio || "";
                    const instrucciones = txtCustom ? txtCustom.value.trim() : "";

                    // Validaci√≥n: Si no hay nada de informaci√≥n
                    if (!instrucciones && !rubro && !negocio) {
                         App.ui.notificar("Faltan datos (Rubro o Instrucciones) para generar la ruta.", "Datos Insuficientes", "error");
                         btn.innerHTML = originalText;
                         btn.disabled = false;
                         return;
                    }

                    const prompt = `Act√∫a como Project Manager experto en desarrollo web.
                    Crea una Hoja de Ruta de 6 pasos para un proyecto web.
                    
                    DATOS DEL PROYECTO:
                    ${negocio ? `- Cliente: ${negocio}` : ''}
                    ${rubro ? `- Rubro/Industria: ${rubro}` : ''}
                    ${instrucciones ? `- INSTRUCCIONES ADICIONALES: ${instrucciones}` : ''}
                    
                    OBJETIVO: Generar un plan de trabajo t√©cnico y visual (0% a 100%).
                    Si hay instrucciones adicionales, √∫salas como prioridad para definir los pasos.
                    Si solo hay rubro, adapta los pasos est√°ndar a ese nicho.
                    
                    FORMATO JSON ESTRICTO (Array de objetos):
                    [
                        { "titulo": "Nombre corto del paso", "rango": "0% - 15%", "descripcion": "Descripci√≥n t√©cnica breve adaptada." },
                        ... hasta 6 pasos cubriendo del 0% al 100%
                    ]
                    
                    Solo devuelve el JSON, nada m√°s.`;

                    try {
                        const model = document.getElementById('model-selector').value;
                        const res = await fetch('/api/analizar-chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ prompt: prompt, model: model }) });
                        const data = await res.json();
                        
                        // Limpiar JSON (a veces la IA pone markdown ```json ... ```)
                        const cleanJson = data.analisis.replace(/```json/g, '').replace(/```/g, '').trim();
                        const rutaGenerada = JSON.parse(cleanJson);

                        // Guardar en encuesta_data
                        await App.cliente.actualizarCampo('roadmap', rutaGenerada);
                        App.ui.notificar("Hoja de Ruta personalizada creada y guardada.", "√âxito IA", "exito");
                        // Limpiar campo custom
                        if(txtCustom) txtCustom.value = '';
                    } catch(e) {
                        console.error(e);
                        App.ui.notificar("Error al generar la ruta. Intenta de nuevo.", "Error IA", "error");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                },
                actualizarDatosContacto: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    const btn = document.querySelector('button[onclick="App.cliente.actualizarDatosContacto()"]');
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sincronizando...';
                    btn.disabled = true;

                    try {
                        // 1. Pedir datos frescos al servidor
                        const res = await fetch(`/api/clientes/${lead.id}`);
                        if (!res.ok) throw new Error("Error al sincronizar");
                        const freshData = await res.json();
                        
                        // 2. Actualizar modelo local y refrescar ficha
                        App.datos.leads[App.clienteActivoIndex] = {
                            ...freshData,
                            estado: App.api.mapEstado(freshData.estado),
                            propuesta: freshData.propuesta_text || ''
                        };
                        App.cliente.abrir(App.clienteActivoIndex);
                        
                        App.ui.notificar("Datos sincronizados con la nube.", "Actualizado", "exito");
                    } catch(e) {
                        console.error(e);
                        App.ui.notificar("No se pudo sincronizar.", "Error", "error");
                    } finally {
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    }
                },
                procesarRespuesta: async (accion) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const estadoOriginal = lead.estado; // Capturar estado original para flujo inteligente
                    App.ui.toggleModal('modal-interceptor', false);

                    if (accion === 'si') {
                        // Cambiar a seguimiento y abrir ficha
                        lead.estado = 'seguimiento';
                        App.cliente.agregarNotaHistorial(`üí¨ Cliente contest√≥. Pasado a seguimiento.`);
                        await fetch(`/api/clientes/${lead.id}/estado`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: 'contactado' }) });
                        App.ui.renderizarListas();
                        App.cliente.abrir(App.clienteActivoIndex, true); 
                    } else if (accion === 'no') {
                        // Eliminar prospecto
                        try {
                            await fetch(`/api/clientes/${lead.id}`, { method: 'DELETE' });
                            App.datos.leads.splice(App.clienteActivoIndex, 1);
                            App.ui.renderizarListas(); 
                            App.ui.notificar("Prospecto movido a la papelera.", "Eliminado", "info");
                            App.cliente.cerrarFicha();
                        } catch (e) {
                            App.ui.notificar("Error al eliminar.", "Error", "error");
                        }
                    } else if (accion === 'enviado') {
                        // Mantener en enviado y abrir ficha
                        App.cliente.abrir(App.clienteActivoIndex, true);
                    } else if (accion === 'discador') {
                        const defaultDate = App.util.fechaHoraHabilDefault();
                        
                        // Formatear fecha para el mensaje amigable
                        const d = new Date(defaultDate);
                        const dias = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
                        const diaNombre = dias[d.getDay()];
                        const horaStr = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        App.ui.notificar(`El asistente de IA ha determinado moverlo para el ${diaNombre} a las ${horaStr}`, "Reprogramaci√≥n Inteligente", "info", 1000);

                        lead.estado = 'discador';
                        lead.fecha_agendada = defaultDate;
                        App.cliente.agregarNotaHistorial(`üìû Programado para discador: ${defaultDate.replace('T', ' ')}`);
                        
                        try {
                            await fetch(`/api/clientes/${lead.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ fecha_agendada: defaultDate, estado: 'discador' })
                            });
                        } catch(e) { console.error("Error guardando agenda", e); }

                        App.ui.renderizarListas();
                        
                        // Avanzar al siguiente lead autom√°ticamente tras 1 segundo
                        const currentIndex = App.clienteActivoIndex;
                        setTimeout(() => {
                            App.cliente.cerrarFicha();
                            
                            // L√≥gica de Flujo: Si est√°bamos en 'nuevos', buscar el siguiente 'nuevo'
                            if (estadoOriginal === 'nuevos') {
                                let nextIndex = -1;
                                for (let i = currentIndex + 1; i < App.datos.leads.length; i++) {
                                    if (App.datos.leads[i].estado === 'nuevos') {
                                        nextIndex = i;
                                        break;
                                    }
                                }
                                if (nextIndex !== -1) App.cliente.abrir(nextIndex);
                                else App.ui.notificar("Prospectos nuevos terminados.", "Flujo Finalizado", "exito");
                            } else {
                                // Comportamiento est√°ndar para otros estados
                                if (App.datos.leads[currentIndex + 1]) {
                                    App.cliente.abrir(currentIndex + 1);
                                }
                            }
                        }, 1000);
                    }
                },
                cerrarFicha: () => { if(App.discador.activo) App.discador.detener(); App.ui.toggleModal('modal-ficha-cliente', false); App.clienteActivoIndex = null; },
                accion: async (tipo) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const fonoLimpio = App.util.limpiarTelefono(lead.whatsapp);
                    switch (tipo) {
                        case 'whatsapp':
                            if (!fonoLimpio || fonoLimpio.length < 8) {
                                App.ui.notificar("El n√∫mero de tel√©fono no es v√°lido para WhatsApp.", "Error de N√∫mero", "error");
                                return;
                            }
                            
                            // 1. ABRIR WHATSAPP (Siempre, reutilizando pesta√±a)
                            window.open(`https://wa.me/${fonoLimpio}?text=${encodeURIComponent(lead.propuesta)}`, 'whatsapp_tab');

                            // 2. INTERCEPTOR (Siempre que sea manual)
                            // Se abre el modal para que al volver puedas gestionar el estado
                            if (!App.discador.activo) {
                                App.ui.toggleModal('modal-interceptor', true);
                            }
                            
                            // 3. Actualizar Estado (Si es nuevo)
                            if (lead.estado === 'nuevos' || lead.estado === 'sin_respuesta') lead.estado = 'whatsapp_enviado';
                            
                            // 4. Historial y Contadores
                            App.cliente.agregarNotaHistorial(`‚úÖ WhatsApp Enviado.`);
                            
                            App.movimientos.agregar('interaccion', `WhatsApp a ${lead.negocio}`);
                            const intentos = (lead.historial || []).filter(h => h.nota && (h.nota.includes('WhatsApp Enviado') || h.nota.includes('Enviado'))).length;
                            const elIntentos = document.getElementById('ficha-intentos-count');
                            if(elIntentos) elIntentos.innerText = intentos;
                            
                            // Persistencia
                            fetch(`/api/clientes/${lead.id}/estado`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: lead.estado }) }).catch(console.error);

                            App.ui.renderizarListas();
                            
                            // 5. Discador Autom√°tico (Avance)
                            if (App.discador.activo) {
                                setTimeout(() => {
                                    if (!App.discador.pausado) App.discador.siguiente();
                                }, 1000);
                            }
                            break;
                        case 'invalid':
                            // Eliminaci√≥n directa sin confirmaci√≥n
                            await fetch(`/api/clientes/${lead.id}`, { method: 'DELETE' });
                            App.datos.blacklist.push(`${lead.whatsapp} (${lead.negocio})`);
                            localStorage.setItem('blacklist', JSON.stringify(App.datos.blacklist));
                            App.datos.leads.splice(App.clienteActivoIndex, 1);
                            App.ui.actualizarBlacklistCount(); 
                            App.ui.renderizarListas(); 
                            App.cliente.cerrarFicha();
                            App.ui.notificar("Cliente movido a la papelera.", "Eliminado", "info");
                            break;
                        case 'schedule':
                            const fecha = await App.ui.prompt("Selecciona fecha y hora:", "Agendar Lead", App.util.fechaHoraDefault(), "datetime-local");
                            if (fecha) { 
                                lead.estado = 'seguimiento'; 
                                lead.fecha_agendada = fecha; 
                                App.cliente.agregarNotaHistorial(`üìÖ Agendado para: ${fecha.replace('T', ' ')}`);
                                App.ui.notificar("Lead agendado con √©xito.", "Agendado", "exito"); 
                            }
                            break;
                        case 'won':
                            // Abrir Modal de Cierre en lugar de confirmar directo
                            document.getElementById('cierre-cliente-id').value = lead.id;
                            document.getElementById('cierre-cliente-nombre').innerText = lead.negocio;
                            document.getElementById('cierre-cliente-dominio').innerText = lead.dominio || 'Sin dominio asignado';
                            // Pre-llenar montos si existen
                            document.querySelector('input[name="monto_total"]').value = lead.monto_total || 72000;
                            document.querySelector('input[name="monto_pagado"]').value = lead.monto_pagado || 0;
                            
                            App.ui.toggleModal('modal-cierre-venta', true);
                            break;
                        case 'lost':
                            App.ui.toggleModal('modal-motivo-descarte', true);
                            break;
                    }
                    App.ui.renderizarListas();
                    if (App.clienteActivoIndex !== null) App.cliente.abrir(App.clienteActivoIndex);
                },
                confirmarDescarte: async (motivo) => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    
                    lead.estado = 'descartados';
                    App.cliente.agregarNotaHistorial(`üëé Descarte: ${motivo}`);
                    
                    // Enviar al backend (guardando motivo en encuesta_data para no alterar schema)
                    try {
                        await fetch(`/api/clientes/${lead.id}/estado`, { 
                            method: 'PATCH', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ estado: 'no_interesado', motivo: motivo }) 
                        });
                    } catch(e) { console.error(e); }

                    App.ui.toggleModal('modal-motivo-descarte', false);
                    App.cliente.cerrarFicha();
                    App.ui.renderizarListas();
                    App.ui.notificar("Lead descartado y motivo registrado.", "Descarte", "info");
                },
                confirmarDescarteManual: async () => {
                    App.ui.toggleModal('modal-motivo-descarte', false);
                    const motivo = await App.ui.prompt("Ingresa el motivo del descarte:", "Descartar Lead");
                    if (motivo) {
                        App.cliente.confirmarDescarte(motivo);
                    }
                },
                confirmarCierre: async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const id = formData.get('cliente_id');
                    const montoTotal = parseInt(formData.get('monto_total'));
                    const montoPagado = parseInt(formData.get('monto_pagado'));

                    try {
                        const fechaHoy = new Date().toISOString();
                        
                        // 1. Actualizar Montos + fecha de pago
                        await fetch(`/api/clientes/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                monto_total: montoTotal, 
                                monto_pagado: montoPagado,
                                fecha_pago: fechaHoy
                            })
                        });

                        // 2. Cambiar Estado a 'cliente' (cerrado)
                        await fetch(`/api/clientes/${id}/estado`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ estado: 'cliente' }) // 'cliente' mapea a 'cerrados' en UI
                        });

                        // 3. Actualizar Localmente
                        const lead = App.datos.leads.find(l => l.id == id);
                        if (lead) {
                            lead.estado = 'cerrados';
                            lead.monto_total = montoTotal;
                            lead.monto_pagado = montoPagado;
                            lead.fecha_pago = fechaHoy;
                            App.cliente.agregarNotaHistorial(`üöÄ VENTA CERRADA. Total: $${montoTotal} | Pagado: $${montoPagado}`);
                        }

                        // 4. Actualizar Dashboard Financiero y Meta Mensual
                        if (App.finanzas) App.finanzas.actualizarDesdeClientes();
                        if (App.logros) App.logros.actualizarMetaMensual();

                        App.ui.toggleModal('modal-cierre-venta', false);
                        App.cliente.cerrarFicha();
                        App.ui.renderizarListas();
                        App.ui.lanzarConfeti();
                        App.monitor.sincronizar(); // Actualizar monitor con el nuevo cliente
                        App.monitor.checkAll();    // Verificar estado inmediatamente
                        App.ui.notificar("¬°Venta registrada exitosamente!", "Felicidades", "exito");
                    } catch (err) {
                        console.error(err);
                        App.ui.notificar("Error al registrar la venta.", "Error", "error");
                    }
                },
                analizarCierre: async () => {
                    if (App.clienteActivoIndex === null) return;
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const fonoLimpio = App.util.limpiarTelefono(lead.whatsapp);
                    
                    const btn = document.getElementById('btn-analizar-cierre');
                    const resultContainer = document.getElementById('analysis-result');
                    const inputHistorial = document.getElementById('historial-chat-input');
                    
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i> Analizando...';
                    
                    try {
                        let historialTexto = inputHistorial.value.trim();
                        
                        if (!historialTexto && lead.historial && lead.historial.length > 0) {
                            historialTexto = lead.historial.map(h => `[${h.fecha}] ${h.nota}`).join('\n');
                            inputHistorial.value = historialTexto; // Mostrar lo que se est√° analizando
                        } else if (!historialTexto) {
                            throw new Error("Por favor, pega la conversaci√≥n en el cuadro de texto.");
                        }

                        // Obtener el prompt personalizado o el default
                        const systemPrompt = `Act√∫a como Alexis Ferrada, director de ventas de "TuSitioYa". Eres experto en Neuroventas y Cialdini.
Analiza la conversaci√≥n adjunta con un prospecto.

OBJETIVO: Generar una estrategia de cierre basada en psicolog√≠a y detectar el rubro del negocio.

SALIDA REQUERIDA (JSON ESTRICTO):
{
  "rubro_detectado": "Rubro o nicho del negocio del cliente (Ej: Cl√≠nica Dental, Abogado, Sushi). Si no es claro, deduce el m√°s probable.",
  "probabilidad_cierre": (N√∫mero entero 0-100),
  "resumen_una_linea": "Resumen ejecutivo de m√°ximo 15 palabras.",
  "perfil_psicologico": "Identifica el DOLOR PRINCIPAL (Miedo a perder, Estatus, Ahorro, Seguridad) y el TIPO DE COMPRADOR (Anal√≠tico, Emocional, Asertivo).",
  "accion_sugerida": "La mejor acci√≥n t√°ctica ahora (Ej: Enviar audio, Agendar Demo, Pedir el 50%).",
  "texto_cierre": "Script de respuesta persuasiva para WhatsApp. Usa gatillos mentales (Escasez, Autoridad o Prueba Social). Termina con una pregunta de cierre.",
  "texto_cierre_corto": "Versi√≥n resumida del script anterior. OBLIGATORIO: Texto listo para enviar, de M√ÅXIMO 3 L√çNEAS, directo y al grano. NO uses guiones ni placeholders."
}

NOTA: Si no hay historial suficiente, asume que es un primer contacto y sugiere una estrategia de apertura agresiva pero emp√°tica.

CONVERSACI√ìN:
"${historialTexto}"`;
                        const fullPrompt = systemPrompt; // No se usa renderPrompt aqu√≠ porque el prompt ya est√° completo

                        const model = document.getElementById('model-selector').value;
                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: fullPrompt, model: model })
                        });

                        if (!res.ok) {
                            const errorData = await res.json();
                            throw new Error(errorData.error || `Error de la API: ${res.statusText}`);
                        }

                        const data = await res.json();
                        
                        // VALIDACI√ìN CR√çTICA: Si no hay an√°lisis, lanzar error controlado
                        if (!data || !data.analisis) {
                            throw new Error("La IA no devolvi√≥ un an√°lisis v√°lido. Intenta con otro modelo.");
                        }

                        let analisisObj = {};
                        try { 
                            // Limpieza extra por si la IA devuelve bloques de c√≥digo markdown
                            const cleanJson = data.analisis.replace(/```json/g, '').replace(/```/g, '').trim();
                            analisisObj = JSON.parse(cleanJson); 
                        } catch (e) { 
                            analisisObj = { 
                                texto_cierre: data.analisis, 
                                probabilidad_cierre: 50, 
                                resumen_una_linea: "An√°lisis b√°sico (formato no JSON)",
                                perfil_psicologico: "No detectado",
                                accion_sugerida: "Responder manualmente"
                            }; 
                        }

                        const prob = analisisObj.probabilidad_cierre || 0;
                        let colorProb = 'red';
                        if(prob > 40) colorProb = 'yellow';
                        if(prob > 70) colorProb = 'emerald';

                        resultContainer.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Oportunidad de Cierre</span>
                                    <span class="text-xs font-bold text-${colorProb}-600">${prob}%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-${colorProb}-500 h-full rounded-full transition-all duration-1000" style="width: ${prob}%"></div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <div class="flex justify-between items-center mb-1">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase">RESUMEN</p>
                                        <span class="text-[9px] bg-teal-100 text-teal-600 px-2 py-0.5 rounded font-bold uppercase tracking-wider">${analisisObj.rubro_detectado || 'General'}</span>
                                    </div>
                                    <p class="text-xs text-slate-700 font-medium leading-tight">${analisisObj.resumen_una_linea || '...'}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">PSICOLOG√çA & ESTRATEGIA</p>
                                    <p class="text-[10px] text-slate-600 mb-1">${analisisObj.perfil_psicologico || '...'}</p>
                                    <p class="text-[10px] text-cyan-600 font-bold"><i class="fa-solid fa-bolt mr-1"></i> Acci√≥n: ${analisisObj.accion_sugerida || '...'}</p>
                                </div>
                                <div class="bg-teal-50 p-3 rounded-xl border border-teal-100">
                                    <div class="flex justify-between items-center mb-2">
                                        <p class="text-[10px] font-bold text-teal-500 uppercase">RESPUESTA DETALLADA</p>
                                        <button onclick="navigator.clipboard.writeText('${(analisisObj.texto_cierre || '').replace(/'/g, "\\'")}')" class="text-[10px] text-teal-600 hover:text-teal-800 font-bold"><i class="fa-regular fa-copy"></i> Copiar</button>
                                    </div>
                                    <p class="text-xs text-teal-900 italic leading-relaxed">"${analisisObj.texto_cierre}"</p>
                                </div>
                                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                                  <div class="flex justify-between items-center mb-2">
                                        <p class="text-[10px] font-bold text-emerald-600 uppercase">RESPUESTA R√ÅPIDA (3 L√çNEAS)</p>
                                        <div class="flex gap-2">
                                            <button onclick="navigator.clipboard.writeText('${(analisisObj.texto_cierre_corto || '').replace(/'/g, "\\'")}')" class="text-[10px] text-emerald-600 hover:text-emerald-800 font-bold" title="Copiar"><i class="fa-regular fa-copy"></i></button>
                                            <button onclick="window.open('https://api.whatsapp.com/send?phone=${fonoLimpio}&text=${encodeURIComponent(analisisObj.texto_cierre_corto || '').replace(/'/g, '%27')}', 'whatsapp_tab')" class="text-[10px] bg-emerald-500 text-white px-2 py-1 rounded hover:bg-emerald-600 font-bold flex items-center gap-1 shadow-sm transition-transform hover:scale-105"><i class="fa-brands fa-whatsapp"></i> Enviar</button>
                                        </div>
                                    </div>
                                    <p class="text-xs text-emerald-900 italic leading-relaxed">"${analisisObj.texto_cierre_corto || '...'}"</p>
                                </div>
                            </div>
                        `;
                        
                        resultContainer.classList.remove('hidden');
                    } catch (e) {
                        App.ui.notificar(e.message || "Error al analizar el historial.", "Error IA", "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Analizar Historial';
                    }
                },

                analizarConContexto: async (tipo, btnEl) => {
                    if (App.clienteActivoIndex === null) {
                        App.ui.notificar("Abre primero la ficha de un cliente.", "Sin cliente", "error");
                        return;
                    }
                    const lead = App.datos.leads[App.clienteActivoIndex];
                    const negocio = lead.negocio || 'el negocio';
                    const nombre = lead.nombre || 'el cliente';
                    const rubro = (lead.encuesta_data && lead.encuesta_data.rubro) || 'su rubro';
                    const temperatura = (lead.encuesta_data && lead.encuesta_data.temperatura) || 'fr√≠o';
                    const historialTexto = (lead.historial && lead.historial.length > 0)
                        ? lead.historial.map(h => `[${h.fecha}] ${h.nota}`).join('\n')
                        : 'Sin historial previo de conversaci√≥n.';

                    // Estado de carga en el bot√≥n
                    const originalHTML = btnEl.innerHTML;
                    btnEl.disabled = true;
                    btnEl.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-white text-base"></i><span class="text-[10px] font-bold text-white mt-0.5">Analizando...</span>`;

                    const resultContainer = document.getElementById('analysis-result');
                    resultContainer.classList.remove('hidden');
                    resultContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-8 gap-3">
                        <div class="w-8 h-8 border-4 border-emerald-200 border-t-emerald-500 rounded-full animate-spin"></div>
                        <p class="text-xs text-slate-400 animate-pulse font-bold">IA procesando estrategia...</p>
                    </div>`;

                    const prompts = {
                        cerrar_venta: `Act√∫a como Alexis Ferrada, director de ventas de TuSitioYa, experto en Neuroventas y t√©cnicas de cierre.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISI√ìN: Genera una estrategia de CIERRE DEFINITIVO para HOY. El cliente ya conoce el producto, necesitamos el S√ç final.

Responde SOLO en JSON estricto con estos campos exactos:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 75,
  "resumen_una_linea": "Estado actual en 15 palabras",
  "perfil_psicologico": "Tipo de comprador y dolor principal detectado",
  "accion_sugerida": "Acci√≥n t√°ctica espec√≠fica para cerrar HOY",
  "texto_cierre": "Script completo de cierre con gatillos de urgencia (escasez de cupos, oferta limitada). Incluye pregunta de cierre directa.",
  "texto_cierre_corto": "Mensaje WhatsApp de m√°ximo 3 l√≠neas para enviar AHORA. Directo, sin rodeos, con pregunta de cierre."
}`,

                        manejar_objeciones: `Act√∫a como Alexis Ferrada de TuSitioYa, experto en manejo de objeciones con t√©cnicas de Cialdini.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISI√ìN: Detecta la objeci√≥n principal del cliente y genera respuestas espec√≠ficas para superarla. Si no hay historial, prepara respuestas para las 3 objeciones m√°s comunes: precio, tiempo y competencia.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 60,
  "resumen_una_linea": "Objeci√≥n principal detectada en 15 palabras",
  "perfil_psicologico": "Tipo de objeci√≥n (Precio/Tiempo/Competencia/Desconfianza) y perfil del comprador",
  "accion_sugerida": "T√©cnica espec√≠fica para superar la objeci√≥n (reencuadre, prueba social, garant√≠a)",
  "texto_cierre": "Script detallado para manejar la objeci√≥n con empat√≠a y reencuadre. Usa prueba social y casos de √©xito de TuSitioYa.",
  "texto_cierre_corto": "Respuesta corta de WhatsApp (m√°x 3 l√≠neas) que neutraliza la objeci√≥n y mantiene la conversaci√≥n viva."
}`,

                        cliente_probable: `Act√∫a como Alexis Ferrada de TuSitioYa, analista de oportunidades de venta.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISI√ìN: Eval√∫a la probabilidad real de cierre, identifica se√±ales de compra y define el pr√≥ximo paso estrat√©gico.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 65,
  "resumen_una_linea": "Evaluaci√≥n del potencial en 15 palabras",
  "perfil_psicologico": "Se√±ales de compra detectadas y perfil de decisi√≥n (r√°pido/lento/anal√≠tico/emocional)",
  "accion_sugerida": "Pr√≥ximo paso concreto para avanzar en el funnel (demo, propuesta, seguimiento en X d√≠as)",
  "texto_cierre": "Mensaje estrat√©gico que avanza la conversaci√≥n sin presionar. Genera curiosidad y compromiso.",
  "texto_cierre_corto": "Mensaje WhatsApp de m√°x 3 l√≠neas que genera un micro-compromiso (agendar llamada, ver demo, confirmar inter√©s)."
}`,

                        primer_contacto: `Act√∫a como Alexis Ferrada de TuSitioYa, experto en apertura de conversaciones de venta.
CLIENTE POTENCIAL: ${nombre} de "${negocio}" (${rubro}).
CONTEXTO: Es el primer contacto. El cliente no nos conoce a√∫n.

MISI√ìN: Genera el mensaje de apertura perfecto que genere inter√©s inmediato, sin parecer spam ni vendedor agresivo.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "${rubro}",
  "probabilidad_cierre": 40,
  "resumen_una_linea": "Estrategia de primer contacto para ${negocio}",
  "perfil_psicologico": "Dolor probable del negocio basado en su rubro y la falta de presencia digital",
  "accion_sugerida": "Enviar mensaje de apertura personalizado con gancho espec√≠fico del rubro",
  "texto_cierre": "Script completo de primer contacto: saludo personalizado, gancho con dolor espec√≠fico del rubro, propuesta de valor de TuSitioYa, beneficios clave y pregunta de apertura. Tono cercano y profesional.",
  "texto_cierre_corto": "Mensaje WhatsApp de apertura de m√°x 3 l√≠neas. Personalizado para ${negocio}. Termina con pregunta abierta."
}`,

                        negociar_precio: `Act√∫a como Alexis Ferrada de TuSitioYa, experto en negociaci√≥n de valor y precios.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura actual: ${temperatura}.
HISTORIAL DE CONTACTO:\n${historialTexto}

MISI√ìN: El cliente considera que el precio es alto. Genera argumentos de valor irrefutables y alternativas de pago que faciliten el cierre.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 55,
  "resumen_una_linea": "Situaci√≥n de negociaci√≥n en 15 palabras",
  "perfil_psicologico": "Sensibilidad al precio y motivaci√≥n real de compra",
  "accion_sugerida": "Estrategia de negociaci√≥n: anclar valor, ofrecer plan de pago 50/50, mostrar ROI",
  "texto_cierre": "Script de negociaci√≥n que justifica el precio con ROI concreto para su rubro, compara con alternativas m√°s caras, y ofrece el plan de pago 50% inicio / 50% entrega como ventaja. Incluye urgencia de cupos limitados.",
  "texto_cierre_corto": "Mensaje WhatsApp de m√°x 3 l√≠neas que reencuadra el precio como inversi√≥n y propone el plan de pago."
}`,

                        reactivar_lead: `Act√∫a como Alexis Ferrada de TuSitioYa, experto en reactivaci√≥n de leads fr√≠os.
CLIENTE: ${nombre} de "${negocio}" (${rubro}). Temperatura: FR√çO (sin respuesta hace tiempo).
HISTORIAL DE CONTACTO:\n${historialTexto}

MISI√ìN: El cliente dej√≥ de responder. Genera un mensaje de reactivaci√≥n que genere curiosidad y rompa el silencio sin parecer desesperado.

Responde SOLO en JSON estricto:
{
  "rubro_detectado": "Rubro del negocio",
  "probabilidad_cierre": 30,
  "resumen_una_linea": "Situaci√≥n del lead fr√≠o en 15 palabras",
  "perfil_psicologico": "Raz√≥n probable del silencio (precio, timing, olvid√≥, no le convenci√≥)",
  "accion_sugerida": "T√°ctica de reactivaci√≥n: nuevo √°ngulo, FOMO, novedad o pregunta directa",
  "texto_cierre": "Script de reactivaci√≥n con un √°ngulo completamente nuevo. Puede ser: una novedad del servicio, un caso de √©xito del mismo rubro, o una pregunta directa y honesta. Evita el cl√°sico 'solo quer√≠a saber si...'",
  "texto_cierre_corto": "Mensaje WhatsApp de m√°x 3 l√≠neas que rompe el silencio con curiosidad o FOMO. Sorprendente y directo."
}`
                    };

                    const titulos = {
                        cerrar_venta:       'ü§ù Estrategia de Cierre',
                        manejar_objeciones: 'üõ°Ô∏è Manejo de Objeciones',
                        cliente_probable:   'üéØ Evaluaci√≥n de Probabilidad',
                        primer_contacto:    'üìû Script de Primer Contacto',
                        negociar_precio:    'üí∞ Negociaci√≥n de Precio',
                        reactivar_lead:     'üîÑ Reactivaci√≥n de Lead Fr√≠o'
                    };

                    try {
                        const systemPrompt = prompts[tipo] || prompts.cerrar_venta;
                        const model = document.getElementById('model-selector').value;

                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: systemPrompt, model: model })
                        });

                        if (!res.ok) {
                            const errorData = await res.json().catch(() => ({}));
                            throw new Error(errorData.error || `Error de la API: ${res.statusText}`);
                        }

                        const data = await res.json();
                        if (!data || !data.analisis) throw new Error("La IA no devolvi√≥ un an√°lisis v√°lido.");

                        let analisisObj = {};
                        try {
                            const cleanJson = data.analisis.replace(/```json/g, '').replace(/```/g, '').trim();
                            analisisObj = JSON.parse(cleanJson);
                        } catch (e) {
                            analisisObj = {
                                texto_cierre: data.analisis,
                                probabilidad_cierre: 50,
                                resumen_una_linea: "An√°lisis generado",
                                perfil_psicologico: "Ver texto completo abajo",
                                accion_sugerida: "Revisar respuesta de la IA"
                            };
                        }

                        const prob = parseInt(analisisObj.probabilidad_cierre) || 0;
                        let colorProb = 'red';
                        if (prob > 40) colorProb = 'yellow';
                        if (prob > 70) colorProb = 'emerald';

                        const modelShort = model.split('/').pop();

                        resultContainer.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex items-center justify-between pb-2 border-b border-slate-100">
                                    <span class="text-xs font-bold text-slate-700">${titulos[tipo] || 'An√°lisis IA'}</span>
                                    <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-mono">${modelShort}</span>
                                </div>

                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Probabilidad de Cierre</span>
                                    <span class="text-sm font-bold text-${colorProb}-600">${prob}%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                    <div class="bg-${colorProb}-500 h-full rounded-full transition-all duration-1000" style="width:${prob}%"></div>
                                </div>

                                <div class="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                    <div class="flex justify-between items-center mb-1">
                                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">RESUMEN</p>
                                        <span class="text-[9px] bg-teal-100 text-teal-600 px-2 py-0.5 rounded font-bold uppercase">${analisisObj.rubro_detectado || 'General'}</span>
                                    </div>
                                    <p class="text-xs text-slate-700 font-medium leading-snug">${analisisObj.resumen_una_linea || '...'}</p>
                                </div>

                                <div class="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">PSICOLOG√çA & PERFIL</p>
                                    <p class="text-[10px] text-slate-600 leading-snug">${analisisObj.perfil_psicologico || '...'}</p>
                                </div>

                                <div class="bg-cyan-50 p-2.5 rounded-lg border border-cyan-100">
                                    <p class="text-[9px] font-bold text-cyan-400 uppercase tracking-wider mb-1"><i class="fa-solid fa-bolt mr-1"></i>ACCI√ìN SUGERIDA</p>
                                    <p class="text-[10px] text-cyan-700 font-semibold leading-snug">${analisisObj.accion_sugerida || '...'}</p>
                                </div>

                                <div class="bg-emerald-50 p-2.5 rounded-lg border border-emerald-100">
                                    <p class="text-[9px] font-bold text-emerald-500 uppercase tracking-wider mb-1.5"><i class="fa-solid fa-comment-dots mr-1"></i>SCRIPT COMPLETO</p>
                                    <p class="text-[10px] text-slate-700 leading-relaxed whitespace-pre-wrap">${analisisObj.texto_cierre || '...'}</p>
                                </div>

                                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-3 rounded-xl shadow-md shadow-emerald-500/20">
                                    <div class="flex items-center justify-between mb-1.5">
                                        <p class="text-[9px] font-bold text-emerald-100 uppercase tracking-wider"><i class="fa-brands fa-whatsapp mr-1"></i>MENSAJE WHATSAPP</p>
                                        <button onclick="navigator.clipboard.writeText(this.closest('.bg-gradient-to-br').querySelector('p.text-white').innerText).then(()=>App.ui.notificar('Copiado al portapapeles','OK','exito'))" class="text-[9px] bg-white/20 hover:bg-white/30 text-white px-2 py-0.5 rounded font-bold transition-colors flex items-center gap-1">
                                            <i class="fa-solid fa-copy"></i> Copiar
                                        </button>
                                    </div>
                                    <p class="text-white text-xs font-medium leading-relaxed whitespace-pre-wrap">${analisisObj.texto_cierre_corto || '...'}</p>
                                </div>
                            </div>`;

                    } catch (err) {
                        resultContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-6 gap-2 text-center">
                            <i class="fa-solid fa-triangle-exclamation text-red-400 text-2xl"></i>
                            <p class="text-xs font-bold text-red-600">Error al analizar</p>
                            <p class="text-[10px] text-slate-400">${err.message}</p>
                        </div>`;
                        App.ui.notificar(err.message || "Error al analizar.", "Error IA", "error");
                    } finally {
                        btnEl.disabled = false;
                        btnEl.innerHTML = originalHTML;
                    }
                },

                guardarManual: async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const rut = formData.get('rut');

                    const nuevoLead = {
                        negocio: formData.get('negocio'),
                        nombre: formData.get('nombre'),
                        whatsapp: formData.get('whatsapp'),
                        propuesta_text: formData.get('propuesta'),
                        monto_total: 72000,
                        dominio: formData.get('dominio').toLowerCase(),
                        rut: rut,
                        email: formData.get('email'),
                        rubro: formData.get('rubro'),
                        url: formData.get('url')
                    };

                    try {
                        const res = await fetch('/api/clientes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(nuevoLead)
                        });
                        
                        if (res.ok) {
                            try {
                                const leadGuardado = await res.json();
                                leadGuardado.estado = 'nuevos';
                                leadGuardado.propuesta = leadGuardado.propuesta_text || 'Cliente creado manualmente.';
                                
                                // 1. Agregar al inicio de la lista
                                App.datos.leads.unshift(leadGuardado);
                                // 2. Renderizar para que aparezca en el DOM
                                try { App.ui.renderizarListas(); } catch(err) { console.error("Error renderizando listas:", err); }
                                
                                // 3. Cerrar modal de creaci√≥n
                                App.ui.toggleModal('modal-nuevo-cliente', false);
                                // 4. ABRIR LA FICHA INMEDIATAMENTE (√çndice 0 porque hicimos unshift)
                                setTimeout(() => App.cliente.abrir(0), 100);
                                
                                e.target.reset();
                            } catch (innerErr) {
                                console.error("Error post-guardado (UI):", innerErr);
                                // No mostramos error al usuario porque el guardado fue exitoso
                            }
                        } else {
                            const errData = await res.json();
                            throw new Error(errData.error || "Error desconocido al guardar.");
                        }
                    } catch (err) {
                        console.error("Error guardando lead manual:", err);
                        App.ui.notificar(err.message, "Error al Guardar", "error");
                    }
                }
            },
            
            discador: {
                activo: false,
                pausado: false,
                cola: [],
                indiceActual: 0,
                iniciar: async () => {
                    // Autom√°ticamente buscar leads agendados para HOY o ANTES (Pendientes)
                    const hoy = App.util.fechaHoy();
                    const candidatos = App.datos.leads.filter(l => {
                        if (!l.fecha_agendada || l.estado === 'descartados' || l.estado === 'cerrados') return false;
                        return l.fecha_agendada.split('T')[0] <= hoy; // Incluye hoy y atrasados
                    });

                    if (candidatos.length === 0) {
                        App.ui.notificar("No hay leads agendados pendientes.", "Todo al d√≠a", "exito");
                        return;
                    }
                    
                    // Mover leads al estado 'discador'
                    for (const lead of candidatos) {
                        if (lead.estado !== 'discador') {
                            lead.estado = 'discador';
                            fetch(`/api/clientes/${lead.id}/estado`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ estado: 'discador' })
                            }).catch(console.error);
                        }
                    }
                    
                    App.discador.activo = true;
                    App.discador.cola = candidatos.sort((a, b) => new Date(a.fecha_agendada) - new Date(b.fecha_agendada));
                    App.ui.renderizarListas();
                    
                    App.discador.indiceActual = 0;
                    App.ui.notificar(`Iniciando cola con ${App.discador.cola.length} leads.`, "Discador Activo", "exito");
                    App.discador.cargarActual();
                },
                cargarActual: async () => {
                    // Verificar si se acab√≥ la cola
                    if (App.discador.indiceActual >= App.discador.cola.length) {
                        App.discador.detener();
                        App.ui.notificar("¬°Has terminado todos los pendientes!", "Discador Finalizado", "exito");
                        return;
                    }
                    const lead = App.discador.cola[App.discador.indiceActual];
                    const realIndex = App.datos.leads.indexOf(lead);
                    App.cliente.abrir(realIndex, true); // forceOpen = true para saltar el modal interceptor
                },
                togglePausa: (estado) => {
                    if (!App.discador.activo) return;
                    App.discador.pausado = estado;
                    const bar = document.getElementById('ficha-discador-bar');
                    const label = bar.querySelector('span');
                    
                    if (estado) {
                        bar.classList.replace('bg-emerald-600', 'bg-amber-600');
                        if(!bar.dataset.original) bar.dataset.original = label.innerHTML;
                        label.innerHTML = '<i class="fa-solid fa-pen-nib animate-bounce"></i> Escribiendo... (Pausado)';
                    } else {
                        bar.classList.replace('bg-amber-600', 'bg-emerald-600');
                        if(bar.dataset.original) label.innerHTML = bar.dataset.original;
                    }
                },
                siguiente: () => {
                    App.discador.indiceActual++;
                    App.discador.cargarActual();
                },
                posponer: async () => {
                    if (!App.discador.activo || App.discador.indiceActual >= App.discador.cola.length) return;
                    
                    const lead = App.discador.cola[App.discador.indiceActual];
                    
                    // Mover al final de la cola (Mochila)
                    App.discador.cola.splice(App.discador.indiceActual, 1);
                    App.discador.cola.push(lead);
                    
                    // Calcular nueva hora (Ahora + 1 hora)
                    const now = new Date();
                    now.setHours(now.getHours() + 1);
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Ajuste zona horaria
                    const nuevaFecha = now.toISOString().slice(0, 16);

                    lead.fecha_agendada = nuevaFecha;
                    App.cliente.agregarNotaHistorial(`‚è±Ô∏è Pospuesto (Mochila) para el final de la cola.`);

                    try {
                        await fetch(`/api/clientes/${lead.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fecha_agendada: nuevaFecha })
                        });
                        App.ui.notificar("Lead movido al final de la cola.", "Pospuesto", "info");
                    } catch (e) { console.error(e); }

                    // Cargar el siguiente (que ahora ocupa el indice actual tras el splice)
                    App.discador.cargarActual();
                },
                detener: () => {
                    App.discador.activo = false;
                    App.ui.toggleModal('modal-ficha-cliente', false);
                    App.ui.renderizarListas();
                }
            },

            agenda: {
                abrir: () => {
                    const lista = document.getElementById('agenda-lista');
                    lista.innerHTML = '';
                    const agendados = App.datos.leads.filter(l => l.estado === 'seguimiento');
                    if (agendados.length === 0) { lista.innerHTML = '<div class="text-center py-10 text-slate-400">Nada pendiente hoy.</div>'; } 
                    else {
                        const elConteo = document.getElementById('conteo-lead-Discador');
                        if(elConteo) elConteo.innerText = agendados.length;
                        agendados.forEach((lead) => {
                            const realIndex = App.datos.leads.indexOf(lead);
                            const item = document.createElement('div');
                            item.className = "bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm mb-2";
                            item.innerHTML = `<div><h4 class="font-bold text-slate-800">${lead.negocio}</h4><p class="text-xs text-blue-500 font-bold">${lead.fecha_agendada ? 'üìÖ '+lead.fecha_agendada : 'En contacto'}</p></div><button onclick="App.cliente.abrir(${realIndex})" class="px-4 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg">Ver</button>`;
                            lista.appendChild(item);
                        });
                    }
                    App.ui.toggleModal('modal-agenda', true);
                }
            },

            calendario: {
                fechaActual: new Date(),
                abrir: () => {
                    App.calendario.fechaActual = new Date();
                    App.calendario.renderizar();
                    App.ui.toggleModal('modal-calendario', true);
                },
                cambiarMes: (delta) => {
                    App.calendario.fechaActual.setMonth(App.calendario.fechaActual.getMonth() + delta);
                    App.calendario.renderizar();
                },
                renderizar: () => {
                    const fecha = App.calendario.fechaActual;
                    const mes = fecha.getMonth();
                    const anio = fecha.getFullYear();
                    
                    const opciones = { month: 'long', year: 'numeric' };
                    document.getElementById('calendario-titulo').innerText = fecha.toLocaleDateString('es-ES', opciones);

                    const grid = document.getElementById('calendario-grid');
                    grid.innerHTML = '';

                    const primerDia = new Date(anio, mes, 1);
                    const ultimoDia = new Date(anio, mes + 1, 0);
                    const diasEnMes = ultimoDia.getDate();
                    const diaInicio = primerDia.getDay(); 

                    for (let i = 0; i < diaInicio; i++) {
                        grid.innerHTML += `<div class="bg-slate-100/50 rounded-lg min-h-[80px]"></div>`;
                    }

                    for (let dia = 1; dia <= diasEnMes; dia++) {
                        const fechaStr = `${anio}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                        const leadsDia = App.datos.leads.filter(l => l.fecha_agendada === fechaStr);
                        
                        let contenidoLeads = '';
                        if (leadsDia.length > 0) {
                            contenidoLeads = leadsDia.map(l => {
                                const realIndex = App.datos.leads.indexOf(l);
                                return `<div onclick="App.cliente.abrir(${realIndex})" class="text-[9px] bg-purple-100 text-purple-700 px-1 py-0.5 rounded mb-1 truncate cursor-pointer hover:bg-purple-200 font-bold border border-purple-200" title="${l.negocio}">${l.negocio}</div>`;
                            }).join('');
                        }

                        const esHoy = new Date().toISOString().split('T')[0] === fechaStr ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50' : 'border-slate-200 bg-white';

                        grid.innerHTML += `
                            <div class="border ${esHoy} rounded-lg p-1 min-h-[80px] flex flex-col transition-all hover:shadow-md">
                                <span class="text-xs font-bold text-slate-400 mb-1 text-right block pr-1">${dia}</span>
                                <div class="flex-1 overflow-y-auto custom-scroll space-y-1">
                                    ${contenidoLeads}
                                </div>
                            </div>
                        `;
                    }
                }
            },

            prospectorIA: {
                abrir: () => {
                    document.getElementById('ia-prompt-area').value = PROMPT_TEMPLATE;
                    const modelName = document.getElementById('model-selector').value;
                    document.getElementById('ia-model-name-btn').innerText = modelName;

                    App.ui.toggleModal('modal-ia-generador', true);
                    document.getElementById('ia-empty-state').classList.remove('hidden');
                    document.getElementById('ia-results-container').classList.add('hidden');
                    document.getElementById('ia-results-container').innerHTML = '';
                    document.getElementById('ia-loading').classList.add('hidden');
                    document.getElementById('btn-ia-guardar').classList.add('hidden');
                    App.tempLeads = [];
                },
                cerrar: () => App.ui.toggleModal('modal-ia-generador', false),
                copiarPrompt: () => {
                    const promptArea = document.getElementById('ia-prompt-area');
                    let finalPrompt = promptArea.value;
                    const rubro = document.getElementById('ia-rubro').value || 'negocios';
                    const ciudad = document.getElementById('ia-ciudad').value || 'Chile';
                    const cantidad = document.getElementById('ia-cantidad').value || 5;
                    finalPrompt = finalPrompt.replace(/{rubro}/g, rubro).replace(/{ciudad}/g, ciudad).replace(/{cantidad}/g, cantidad);
                    navigator.clipboard.writeText(finalPrompt).then(() => App.ui.notificar('El prompt de prospecci√≥n ha sido copiado.', 'Copiado', 'exito'));
                },
                renderResultados: () => {
                    const container = document.getElementById('ia-results-container');
                    if (App.tempLeads.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-400 text-xs py-4">Sin resultados.</p>';
                        return;
                    }
                    container.innerHTML = App.tempLeads.map((l, index) => `
                        <div class="bg-white p-3 rounded border border-slate-200 mb-2 shadow-sm flex justify-between items-center group hover:border-red-200 transition-colors">
                            <div class="flex-1">
                                <p class="font-bold text-sm text-slate-700">${l.negocio}</p>
                                <p class="text-xs text-slate-500 font-mono">${l.whatsapp}</p>
                            </div>
                            <button onclick="App.prospectorIA.marcarInvalido(${index})" class="text-slate-300 hover:text-red-500 transition-colors p-2" title="N√∫mero no v√°lido (Agregar a Excepciones)">
                                <i class="fa-solid fa-ban"></i>
                            </button>
                        </div>
                    `).join('');
                },
                marcarInvalido: (index) => {
                    const lead = App.tempLeads[index];
                    if (!lead) return;
                    
                    // Agregar a blacklist
                    const modelInfo = lead._model ? ` | Model: ${lead._model}` : '';
                    App.datos.blacklist.push(`${lead.whatsapp} (${lead.negocio})${modelInfo}`);
                    localStorage.setItem('blacklist', JSON.stringify(App.datos.blacklist));
                    App.ui.actualizarBlacklistCount();
                    
                    // Remover de tempLeads
                    App.tempLeads.splice(index, 1);
                    
                    // Re-renderizar
                    App.prospectorIA.renderResultados();
                    // Eliminaci√≥n silenciosa para mayor velocidad (sin modal)
                },
                buscar: async () => {
                    const rubro = document.getElementById('ia-rubro').value;
                    if (!rubro) return App.ui.notificar("Debes especificar un rubro para iniciar la b√∫squeda.", "Campo Requerido", "error");

                    document.getElementById('ia-empty-state').classList.add('hidden');
                    document.getElementById('ia-loading').classList.remove('hidden');
                    document.getElementById('ia-loading').style.display = 'flex';
                    document.getElementById('ia-results-container').classList.add('hidden');

                    const ciudad = document.getElementById('ia-ciudad').value;
                    const cantidad = document.getElementById('ia-cantidad').value;
                    const model = document.getElementById('model-selector').value;
                    let prompt = document.getElementById('ia-prompt-area').value;
                    prompt = prompt.replace(/{rubro}/g, rubro).replace(/{ciudad}/g, ciudad).replace(/{cantidad}/g, cantidad);

                    try {
                        const res = await fetch('/api/prospectar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt, ciudad, model })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Error en el servidor');

                        // 1. Deduplicar resultados de la IA (por si alucina repetidos)
                        const uniqueData = [];
                        const seen = new Set();
                        data.forEach(l => {
                            const fonoLimpio = App.util.limpiarTelefono(l.whatsapp);
                            if (fonoLimpio && !seen.has(fonoLimpio)) {
                                seen.add(fonoLimpio);
                                l.whatsapp = '+' + fonoLimpio; // Formato visual +569...
                                uniqueData.push(l);
                            }
                        });

                        // Asignar modelo a los resultados
                        uniqueData.forEach(l => l._model = model);

                        // Filtrar leads que ya est√°n en la blacklist
                        const leadsLimpios = uniqueData.filter(l => !App.datos.blacklist.some(blItem => l.whatsapp && blItem.includes(l.whatsapp.replace('+','')))); // Comparar sin el + si es necesario
                        const invalidos = uniqueData.length - leadsLimpios.length;

                        App.tempLeads = leadsLimpios;

                        // --- AN√ÅLISIS R√ÅPIDO ---
                        const total = uniqueData.length;
                        
                        App.ui.notificar(`Total √önicos: ${total}\nEn Blacklist: ${invalidos}\nDisponibles: ${leadsLimpios.length}`, "Reporte IA", "info");
                        setTimeout(() => App.ui.cerrarNotificacion(), 2000); // 2 segundos para leer
                        // --- FIN AN√ÅLISIS ---

                        App.prospectorIA.renderResultados();
                        document.getElementById('ia-results-container').classList.remove('hidden');
                        document.getElementById('btn-ia-guardar').classList.remove('hidden');
                    } catch (e) {
                        App.ui.notificar(e.message, "Error de la IA", "error");
                        document.getElementById('ia-empty-state').classList.remove('hidden');
                    } finally {
                        document.getElementById('ia-loading').classList.add('hidden');
                        document.getElementById('ia-loading').style.display = 'none';
                    }
                },
                guardar: async () => {
                    if (App.tempLeads.length === 0) return App.ui.notificar("No se encontraron prospectos para guardar.", "Vac√≠o", "error");

                    // 1. Filtrar Blacklist
                    let leadsParaProcesar = App.tempLeads.filter(l => !App.datos.blacklist.some(blItem => l.whatsapp && blItem.includes(l.whatsapp.replace('+',''))));
                    
                    // 2. Verificar duplicados por DOMINIO
                    const leadsNuevos = [];
                    const leadsExistentes = [];

                    for (const l of leadsParaProcesar) {
                        const existe = App.datos.leads.find(dbLead => dbLead.dominio && l.dominio_sugerido && dbLead.dominio.toLowerCase() === l.dominio_sugerido.toLowerCase());
                        if (existe) {
                            leadsExistentes.push({ nuevo: l, original: existe });
                        } else {
                            leadsNuevos.push(l);
                        }
                    }

                    if (leadsNuevos.length === 0 && leadsExistentes.length === 0) {
                        return App.ui.notificar("No hay prospectos nuevos para guardar.", "Filtrado", "error");
                    }

                    // 3. Manejo de Duplicados
                    let actualizarDuplicados = false;
                    if (leadsExistentes.length > 0) {
                        actualizarDuplicados = await App.ui.confirmar(`Se encontraron ${leadsExistentes.length} dominios ya registrados.\n\n¬øDeseas ACTUALIZAR sus datos con la nueva informaci√≥n de la IA?`, "Duplicados Detectados");
                        
                        if (actualizarDuplicados) {
                            for (const item of leadsExistentes) {
                                try {
                                    await fetch(`/api/clientes/${item.original.id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            ...item.nuevo, // Enviar todos los datos nuevos
                                            dominio: item.nuevo.dominio_sugerido // Mapear correctamente
                                        })
                                    });
                                } catch (e) { console.error(e); }
                            }
                        }
                    }

                    if (leadsNuevos.length === 0) { App.prospectorIA.cerrar(); return await App.init(); }

                    if (!await App.ui.confirmar(`¬øGuardar ${leadsNuevos.length} nuevos prospectos?`)) return;
                    
                    await fetch('/api/prospectos/bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prospects: leadsNuevos, ciudad: document.getElementById('ia-ciudad').value })
                    });
                    
                    // 5. Finalizar
                    App.prospectorIA.cerrar();
                    await App.init(); // Recargar todo al final
                }
            },

            importar: {
                procesarJSON: async () => {
                    const area = document.getElementById('import-json-area');
                    const raw = area.value.trim();
                    if (!raw) return App.ui.notificar("El √°rea de texto est√° vac√≠a. Pega el c√≥digo JSON para importar.", "Campo Vac√≠o", "error");

                    try {
                        const data = JSON.parse(raw);
                        const prospects = Array.isArray(data) ? data : (data.prospectos || []);
                        
                        if (prospects.length === 0) throw new Error("No se encontraron prospectos en el JSON.");

                        // 1. Filtrar Blacklist (Igual que IA)
                        let leadsParaProcesar = prospects.filter(l => !App.datos.blacklist.some(blItem => l.whatsapp && blItem.includes(l.whatsapp)));
                        const descartadosBlacklist = prospects.length - leadsParaProcesar.length;

                        // 2. Verificar duplicados por DOMINIO
                        const leadsNuevos = [];
                        const leadsExistentes = [];

                        for (const l of leadsParaProcesar) {
                            // Normalizar dominio si existe
                            const dom = l.dominio_sugerido || l.dominio || '';
                            const existe = App.datos.leads.find(dbLead => dbLead.dominio && dom && dbLead.dominio.toLowerCase() === dom.toLowerCase());
                            if (existe) {
                                leadsExistentes.push({ nuevo: l, original: existe });
                            } else {
                                leadsNuevos.push(l);
                            }
                        }

                        if (leadsNuevos.length === 0 && leadsExistentes.length === 0) {
                            return App.ui.notificar(`Todos los prospectos (${descartadosBlacklist}) fueron descartados por estar en la Lista Negra.`, "Filtrado Estricto", "error");
                        }

                        // 3. Manejo de Duplicados
                        let actualizarDuplicados = false;
                        if (leadsExistentes.length > 0) {
                            actualizarDuplicados = await App.ui.confirmar(`Se encontraron ${leadsExistentes.length} dominios ya registrados en la importaci√≥n.\n\n¬øDeseas ACTUALIZAR sus datos?`, "Duplicados Detectados");
                            
                            if (actualizarDuplicados) {
                                for (const item of leadsExistentes) {
                                    try {
                                        await fetch(`/api/clientes/${item.original.id}`, {
                                            method: 'PUT',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ 
                                                ...item.nuevo, 
                                                dominio: item.nuevo.dominio_sugerido || item.nuevo.dominio 
                                            })
                                        });
                                    } catch (e) { console.error(e); }
                                }
                                App.ui.notificar(`${leadsExistentes.length} clientes actualizados.`, "Actualizaci√≥n", "exito");
                            }
                        }

                        if (leadsNuevos.length === 0) {
                            area.value = '';
                            App.ui.toggleModal('modal-prospectos', false);
                            return await App.init();
                        }

                        let msg = `¬øImportar ${leadsNuevos.length} nuevos prospectos?`;
                        if (descartadosBlacklist > 0) msg += `\n(Se omitieron ${descartadosBlacklist} por Lista Negra)`;

                        if (await App.ui.confirmar(msg)) {
                            const res = await fetch('/api/prospectos/bulk', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ prospects: leadsNuevos, ciudad: 'Importaci√≥n Manual' })
                            });
                            const responseData = await res.json();

                            if (res.ok) {
                                App.ui.notificar(responseData.message || `${leadsLimpios.length} prospectos fueron importados.`, "Importaci√≥n Completa", "exito");
                                area.value = '';
                                App.ui.toggleModal('modal-prospectos', false);
                                await App.init(); // Recargar la lista desde la DB
                            } else {
                                let errorMessage = responseData.error || 'Error del servidor al importar.';
                                if (responseData.detalles) {
                                    const detallesFormateados = responseData.detalles.map(d => `-> ${d.prospecto}: ${d.error}`).join('\n');
                                    errorMessage += `\n\nDetalles:\n${detallesFormateados}`;
                                }
                                throw new Error(errorMessage);
                            }
                        }
                    } catch (e) {
                        App.ui.notificar(e.message, "Error al Procesar JSON", "error");
                    }
                }
            },

            monitor: {
                staticSites: [
                    { url: 'www.entradasya.cl', name: 'EntradasYa', status: 'pending' },
                    { url: 'www.turbopos.cl', name: 'TurboPOS', status: 'pending' },
                    { url: 'https://tusitioya.onrender.com/', name: 'TuSitioYa App', status: 'pending' }
                ],
                sites: [],
                timerId: null,
                alertasSilenciadas: false,
                init: () => {
                    const guardado = localStorage.getItem('monitorIntervalo') || '60000';
                    document.getElementById('monitor-intervalo').value = guardado;

                    App.ui.verificarPermisoNotificaciones();
    
                    const muted = localStorage.getItem('monitorAlertsMuted') === 'true';
                    App.monitor.alertasSilenciadas = muted;
                    App.monitor.actualizarBotonMute();

                    App.monitor.sincronizar();
                    App.monitor.checkAll();
                    App.monitor.cambiarIntervalo(guardado, true);
                },
                toggleMute: () => {
                    App.monitor.alertasSilenciadas = !App.monitor.alertasSilenciadas;
                    localStorage.setItem('monitorAlertsMuted', App.monitor.alertasSilenciadas);
                    App.monitor.actualizarBotonMute();
                    const estado = App.monitor.alertasSilenciadas ? 'silenciadas' : 'activadas';
                    App.ui.notificar(`Alertas del monitor ${estado}.`, "Monitor", "info");
                },
                actualizarBotonMute: () => {
                    const btn = document.getElementById('monitor-mute-btn');
                    if (!btn) return;
                    if (App.monitor.alertasSilenciadas) {
                        btn.innerHTML = '<i class="fa-solid fa-bell-slash"></i>';
                        btn.title = "Activar alertas";
                        btn.classList.add('text-red-500', 'bg-red-50');
                    } else {
                        btn.innerHTML = '<i class="fa-solid fa-bell"></i>';
                        btn.title = "Silenciar alertas";
                        btn.classList.remove('text-red-500', 'bg-red-50');
                    }
                },
                cambiarIntervalo: (ms, silent = false) => {
                    if (App.monitor.timerId) clearInterval(App.monitor.timerId);
                    
                    const milisegundos = parseInt(ms);
                    App.monitor.timerId = setInterval(App.monitor.checkAll, milisegundos);
                    localStorage.setItem('monitorIntervalo', milisegundos);
                    
                    if (!silent) {
                        const texto = milisegundos < 60000 ? `${milisegundos/1000}s` : `${milisegundos/60000}m`;
                        App.ui.notificar(`Intervalo de refresco cambiado a ${texto}.`, "Monitor", "info");
                    }
                },
                sincronizar: () => {
                    // Obtener clientes activos con dominio (incluir varios estados posibles)
                    const clientesActivos = App.datos.leads.filter(l => {
                        const esCliente = l.estado === 'cerrados' || l.estado === 'cliente' || l.estado === 'activo';
                        const tieneDominio = l.dominio && l.dominio.trim() !== '';
                        return esCliente && tieneDominio;
                    });
                    
                    console.log(`[Monitor] Clientes activos con dominio: ${clientesActivos.length}`, clientesActivos.map(c => ({ nombre: c.negocio, dominio: c.dominio })));
                    
                    const sitiosClientes = clientesActivos.map(c => ({
                        url: c.dominio,
                        name: c.negocio || 'Sin nombre',
                        status: 'pending'
                    }));

                    // Preservar estado de sitios ya chequeados para no reiniciar a 'pending' visualmente
                    const estadoActual = new Map(App.monitor.sites.map(s => [s.url, s.status]));
                    
                    App.monitor.sites = [...App.monitor.staticSites, ...sitiosClientes].map(s => ({
                        ...s,
                        status: estadoActual.get(s.url) || 'pending'
                    }));
                    
                    App.monitor.render();
                },
                render: () => {
                    const container = document.getElementById('monitor-sites-list');
                    const countEl = document.getElementById('monitor-count');
                    if (!container) return;
                    
                    // Actualizar contador
                    if (countEl) {
                        const clientesCount = App.monitor.sites.filter(s => !App.monitor.staticSites.some(static => static.url === s.url)).length;
                        countEl.textContent = clientesCount > 0 ? `(${clientesCount} clientes)` : '';
                    }
                    
                    // Verificar si hay sitios para mostrar
                    if (App.monitor.sites.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-10 text-slate-400">
                                <i class="fa-solid fa-server text-4xl mb-3 opacity-30"></i>
                                <p class="text-sm">No hay sitios para monitorear</p>
                                <p class="text-xs mt-1">Los clientes activos con dominio aparecer√°n aqu√≠</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = App.monitor.sites.map(site => {
                        let statusClass = 'bg-slate-100 border-slate-200 text-slate-400';
                        let statusVisual = '<i class="fa-solid fa-circle-notch fa-spin text-lg mb-1"></i>';
                        let statusLabel = 'Verificando...';
                        let extraCardClass = '';

                        if (site.status === 'online') {
                            statusClass = 'bg-emerald-50 border-emerald-200 text-emerald-600';
                            statusVisual = `
                                <svg width="40" height="24" viewBox="0 0 40 24" class="mb-1">
                                    <path class="ekg-line" d="M0 12 H 5 L 10 6 L 15 18 L 20 12 H 25 L 30 9 L 35 15 L 40 12" stroke="#10b981" stroke-width="2" fill="none"/>
                                </svg>
                            `;
                            statusLabel = 'ONLINE';
                        } else if (site.status === 'offline') {
                            statusClass = 'bg-red-50 border-red-200 text-red-600';
                            statusVisual = '<i class="fa-solid fa-circle-xmark text-lg mb-1"></i>';
                            statusLabel = 'OFFLINE';
                            extraCardClass = 'monitor-offline-bg';
                        }
                        return `
                            <div class="relative p-3 rounded-xl border ${statusClass} flex items-center justify-between shadow-sm bg-white/80 backdrop-blur-sm transition-all hover:scale-[1.02] ${extraCardClass}">
                                <div class="flex items-center gap-3 min-w-0">
                                    <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center shadow-sm border border-slate-100 text-slate-600 flex-shrink-0">
                                        <i class="fa-solid fa-globe"></i>
                                    </div>
                                    <div class="overflow-hidden">
                                        <h4 class="font-bold text-xs text-slate-700 truncate">${site.name}</h4>
                                        <a href="${site.url.startsWith('http') ? site.url : 'https://' + site.url}" target="_blank" class="text-[9px] text-slate-400 hover:text-blue-500 truncate block">${site.url}</a>
                                    </div>
                                </div>
                                <div class="text-right pl-2 flex-shrink-0 flex flex-col items-end">
                                    ${statusVisual}
                                    <p class="text-[8px] font-black tracking-widest">${statusLabel}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                },
                checkAll: async () => {
                    const ahora = new Date();
                    const hora = ahora.getHours();
                    const esNoche = hora >= 22 || hora < 8; // 10 PM a 8 AM

                    for (let i = 0; i < App.monitor.sites.length; i++) {
                        const site = App.monitor.sites[i];
                        const oldStatus = site.status;
                        const snoozeKey = `snooze_${site.url}`;

                        // L√≥gica de Snooze/Recordatorio
                        const lastSnooze = localStorage.getItem(snoozeKey);
                        if (lastSnooze) {
                            const tresHoras = 3 * 60 * 60 * 1000;
                            if (Date.now() - parseInt(lastSnooze) > tresHoras) {
                                if (!esNoche && oldStatus === 'offline') {
                                    const title = `‚è∞ Recordatorio: Sitio Ca√≠do`;
                                    const body = `El sitio "${site.name}" sigue OFFLINE.`;
                                    if (Notification.permission === 'granted') {
                                        new Notification(title, { body: body, icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>' });
                                    }
                                    localStorage.setItem(snoozeKey, Date.now().toString()); // Actualizar timestamp
                                }
                            }
                        }

                        try {
                            const res = await fetch('/api/check-site', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: site.url })
                            });
                            const data = await res.json();
                            const newStatus = data.status;
                            App.monitor.sites[i].status = newStatus;

                            if (oldStatus !== 'offline' && newStatus === 'offline') {
                                App.monitor.notificarCaida(site);
                            }
                            if (oldStatus === 'offline' && newStatus === 'online') {
                                localStorage.removeItem(snoozeKey);
                            }

                        } catch (e) {
                            const newStatus = 'offline';
                            if (oldStatus !== 'offline') {
                                App.monitor.notificarCaida(site);
                            }
                            App.monitor.sites[i].status = newStatus;
                        }
                    }
                    App.monitor.render(); // Renderizar una vez al final
                },
                notificarCaida: (site) => {
                    if (App.monitor.alertasSilenciadas) {
                        const snoozeKey = `snooze_${site.url}`;
                        if (!localStorage.getItem(snoozeKey)) {
                            localStorage.setItem(snoozeKey, Date.now().toString());
                            console.log(`Sitio ${site.name} ca√≠do. Alertas silenciadas, iniciando snooze.`);
                        }
                        return;
                    }

                    const title = `üö® ¬°Sitio Ca√≠do!`;
                    const body = `El sitio "${site.name}" (${site.url}) est√° OFFLINE.`;
                    
                    if (Notification.permission === 'granted') {
                        new Notification(title, { body: body, icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>' });
                    }

                    const sound = document.getElementById('alert-sound');
                    if (sound) {
                        sound.play().catch(e => console.warn("No se pudo reproducir el sonido de alerta:", e));
                    }
                }
            },

            conversion: {
                periodo: 'hoy',
                init: function() {
                    this.render();
                },
                cambiarPeriodo: function(nuevoPeriodo) {
                    this.periodo = nuevoPeriodo;
                    document.querySelectorAll('#conversion-filtros button').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`#conversion-filtros button[onclick="App.conversion.cambiarPeriodo('${nuevoPeriodo}')"]`).classList.add('active');
                    this.render();
                },
                render: function() {
                    const safeSetText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };

                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    let startDate, endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);

                    switch (this.periodo) {
                        case 'hoy': startDate = hoy; break;
                        case 'ayer':
                            startDate = new Date(hoy); startDate.setDate(hoy.getDate() - 1);
                            endDate = new Date(hoy); endDate.setDate(hoy.getDate() - 1); endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'semana':
                            startDate = new Date(hoy);
                            const diaSemana = hoy.getDay();
                            const diff = hoy.getDate() - diaSemana + (diaSemana === 0 ? -6 : 1);
                            startDate.setDate(diff);
                            break;
                        case 'mes':
                            startDate = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                            break;
                    }

                    const leadsPeriodo = App.datos.leads.filter(l => l.created_at && new Date(l.created_at) >= startDate && new Date(l.created_at) <= endDate);
                    const nuevosEnPeriodo = leadsPeriodo.length;
                    const cerradosEnPeriodo = leadsPeriodo.filter(l => l.estado === 'cerrados').length;

                    const efectividadTotal = (nuevosEnPeriodo > 0) ? Math.round((cerradosEnPeriodo / nuevosEnPeriodo) * 100) : 0;
                    const elTotal = document.getElementById('conv-vs-total');
                    if (elTotal) {
                        elTotal.innerText = `${efectividadTotal}%`;
                        // Alerta visual si es menor al 3%
                        if (efectividadTotal < 3) elTotal.className = "text-lg font-black text-red-500";
                        else elTotal.className = "text-lg font-black text-emerald-600";
                    }
                    
                    safeSetText('conv-vs-total-detalle', `${cerradosEnPeriodo} cerrados de ${nuevosEnPeriodo} nuevos`);

                    // NUEVA M√âTRICA: % Programados vs Recibidos Hoy
                    const hoyISO = new Date().toISOString().split('T')[0];
                    const recibidosHoy = App.datos.leads.filter(l => l.created_at && l.created_at.startsWith(hoyISO)).length;
                    const programadosHoy = App.datos.leads.filter(l => l.fecha_agendada && l.fecha_agendada.startsWith(hoyISO)).length;
                    const porcProgramados = recibidosHoy > 0 ? Math.round((programadosHoy / recibidosHoy) * 100) : 0;

                    safeSetText('conv-vs-programados', `${porcProgramados}%`);
                    safeSetText('conv-vs-programados-detalle', `${programadosHoy} programados de ${recibidosHoy} recibidos hoy`);

                    const mesActual = new Date().getMonth(); const anioActual = new Date().getFullYear();
                    const metaMes = 3 + (mesActual - 1); // Meta 3 para Febrero (mes 1), 4 para Marzo, etc.
                    const cerradosEsteMes = App.datos.leads.filter(l => l.estado === 'cerrados' && l.created_at && new Date(l.created_at).getMonth() === mesActual && new Date(l.created_at).getFullYear() === anioActual).length;
                    const efectividadMeta = (metaMes > 0) ? Math.round((cerradosEsteMes / metaMes) * 100) : 0;
                    safeSetText('conv-vs-meta', `${efectividadMeta}%`);
                    safeSetText('conv-vs-meta-detalle', `${cerradosEsteMes} cerrados de ${metaMes} este mes`);
                }
            },

            logros: {
                hitos: [
                    { id: 'first_blood', cantidad: 1, icono: 'fa-medal', color: 'text-amber-600', titulo: 'Primera Venta' },
                    { id: 'bronze', cantidad: 5, icono: 'fa-trophy', color: 'text-orange-400', titulo: 'Vendedor Bronce' },
                    { id: 'silver', cantidad: 10, icono: 'fa-trophy', color: 'text-slate-400', titulo: 'Vendedor Plata' },
                    { id: 'gold', cantidad: 20, icono: 'fa-trophy', color: 'text-yellow-400', titulo: 'Vendedor Oro' },
                    { id: 'diamond', cantidad: 50, icono: 'fa-gem', color: 'text-blue-400', titulo: 'Leyenda' }
                ],
                
                // Metas mensuales en $ basadas en investigaci√≥n de agencias chilenas
                // An√°lisis: TuSitioYa tiene planes de $72k-$280k. Meta realista para agencia peque√±a en Chile
                // Crece progresivamente seg√∫n estacionalidad del negocio digital
                metasMensuales: {
                    // Meses 0-11 (Enero=0, Diciembre=11)
                    0: { meta: 150000, nombre: 'A√±o Nuevo - Renovemos Energ√≠as' },    // Enero: Post-navidad, bajo
                    1: { meta: 250000, nombre: 'Vuelta al Trabajo' },                // Febrero: Recuperaci√≥n
                    2: { meta: 350000, nombre: 'Mes del Emprendedor' },              // Marzo: Peak pymes
                    3: { meta: 400000, nombre: 'Impuestos Listos' },                 // Abril: Plata disponible
                    4: { meta: 500000, nombre: 'D√≠a de la Madre' },                  // Mayo: Comercio activo
                    5: { meta: 550000, nombre: 'Cierre Semestre' },                  // Junio: Peak 1er semestre
                    6: { meta: 300000, nombre: 'Vacaciones de Invierno' },           // Julio: Baja estacional
                    7: { meta: 450000, nombre: 'Mes del Emprendedor' },              // Agosto: Reactivaci√≥n
                    8: { meta: 600000, nombre: 'Fiestas Patrias' },                  // Septiembre: Consumo alto
                    9: { meta: 650000, nombre: 'CyberDay / Hot Sale' },              // Octubre: E-commerce
                    10: { meta: 800000, nombre: 'Black Friday' },                    // Noviembre: Peak m√°ximo
                    11: { meta: 500000, nombre: 'Navidad Web' }                      // Diciembre: Medio (corta)
                },
                
                getMetaMes: function() {
                    const mes = new Date().getMonth();
                    return this.metasMensuales[mes];
                },
                
                calcularVentasMes: function() {
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    
                    // Sumar monto_pagado de leads con pago real (monto_pagado > 0)
                    // Considerar cualquier estado siempre que haya un pago registrado
                    return App.datos.leads.reduce((total, lead) => {
                        const monto = parseInt(lead.monto_pagado) || parseInt(lead.pagado) || 0;
                        
                        // Solo contar si hay un monto pagado > 0
                        if (monto > 0) {
                            // Determinar fecha del pago
                            const fechaLead = lead.created_at ? new Date(lead.created_at) : null;
                            const fechaPago = lead.fecha_pago ? new Date(lead.fecha_pago) : fechaLead;
                            const fechaActualizacion = lead.updated_at ? new Date(lead.updated_at) : null;
                            
                            // Usar la primera fecha v√°lida disponible
                            const fechaReferencia = fechaPago || fechaActualizacion || fechaLead;
                            
                            if (fechaReferencia && fechaReferencia.getMonth() === mesActual && fechaReferencia.getFullYear() === anioActual) {
                                return total + monto;
                            }
                        }
                        return total;
                    }, 0);
                },
                
                calcularDiasRestantes: function() {
                    const hoy = new Date();
                    const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
                    return Math.ceil((finMes - hoy) / (1000 * 60 * 60 * 24));
                },
                
                actualizarMetaMensual: function() {
                    const metaData = this.getMetaMes();
                    const metaMonto = metaData.meta;
                    const ventasActuales = this.calcularVentasMes();
                    const porcentaje = Math.min(Math.round((ventasActuales / metaMonto) * 100), 100);
                    const diasRestantes = this.calcularDiasRestantes();
                    
                    // Actualizar DOM
                    const elMeta = document.getElementById('meta-monto-objetivo');
                    const elActual = document.getElementById('meta-monto-actual');
                    const elPorcentaje = document.getElementById('meta-porcentaje');
                    const elCirculo = document.getElementById('meta-circulo-progreso');
                    const elDias = document.getElementById('meta-dias-restantes');
                    const elEstado = document.getElementById('meta-estado');
                    
                    if (elMeta) elMeta.textContent = metaMonto.toLocaleString();
                    if (elActual) elActual.textContent = ventasActuales.toLocaleString();
                    if (elPorcentaje) elPorcentaje.textContent = porcentaje + '%';
                    if (elDias) elDias.textContent = diasRestantes;
                    
                    // Actualizar c√≠rculo SVG (stroke-dasharray: valor, 100)
                    if (elCirculo) {
                        elCirculo.setAttribute('stroke-dasharray', `${porcentaje}, 100`);
                    }
                    
                    // Estado animado
                    if (elEstado) {
                        if (porcentaje >= 100) {
                            elEstado.innerHTML = 'üéâ ¬°META LOGRADA!';
                            elEstado.className = 'text-[9px] font-bold px-2 py-0.5 rounded-full bg-emerald-500 text-white';
                        } else if (porcentaje >= 75) {
                            elEstado.innerHTML = 'üî• Casi llegas';
                            elEstado.className = 'text-[9px] font-bold px-2 py-0.5 rounded-full bg-orange-500/30 text-orange-300';
                        } else if (porcentaje >= 50) {
                            elEstado.innerHTML = '‚ö° M√°s de la mitad';
                            elEstado.className = 'text-[9px] font-bold px-2 py-0.5 rounded-full bg-blue-500/30 text-blue-300';
                        } else {
                            elEstado.innerHTML = 'üî• En marcha';
                            elEstado.className = 'text-[9px] font-bold px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-300';
                        }
                    }
                    
                    // Notificaci√≥n especial al alcanzar meta
                    const metaAlcanzadaKey = `meta_alcanzada_${new Date().getMonth()}_${new Date().getFullYear()}`;
                    if (porcentaje >= 100 && !sessionStorage.getItem(metaAlcanzadaKey)) {
                        sessionStorage.setItem(metaAlcanzadaKey, 'true');
                        App.ui.notificar(`¬°Felicidades! Meta de $${metaMonto.toLocaleString()} alcanzada este mes üéâ`, 'Meta Mensual Lograda', 'exito');
                        App.ui.lanzarConfeti();
                    }
                },
                
                verificar: () => {
                    const ventas = App.datos.leads.filter(l => l.estado === 'cerrados').length;
                    const container = document.getElementById('logros-container');
                    if(!container) return;
                    
                    container.innerHTML = App.logros.hitos.map(hito => {
                        const desbloqueado = ventas >= hito.cantidad;
                        const opacity = desbloqueado ? 'opacity-100 scale-110' : 'opacity-20 grayscale';
                        return `<div class="flex flex-col items-center gap-1 group/icon relative" title="${hito.titulo} (${hito.cantidad} ventas)"><i class="fa-solid ${hito.icono} ${hito.color} text-xl transition-all duration-500 ${opacity}"></i>${desbloqueado ? '<div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>' : ''}</div>`;
                    }).join('');
                    
                    // Actualizar meta mensual en $
                    App.logros.actualizarMetaMensual();
                    
                    const lastCount = parseInt(localStorage.getItem('last_sales_count') || 0);
                    if (ventas > lastCount) {
                        const newUnlock = App.logros.hitos.find(h => h.cantidad === ventas);
                        if (newUnlock) {
                            App.ui.notificar(`¬°Has desbloqueado: ${newUnlock.titulo}!`, "üèÜ Logro Desbloqueado", "exito");
                            App.ui.lanzarConfeti();
                        }
                        localStorage.setItem('last_sales_count', ventas);
                    }
                }
            },

            ui: {
                toggleAccordion: (id) => { document.getElementById(`list-${id}`).classList.toggle('open'); },
                toggleModal: (id, show) => { const el = document.getElementById(id); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); },
                actualizarBlacklistCount: () => {
                    const elCount = document.getElementById('blacklist-count');
                    if(elCount) elCount.innerText = App.datos.blacklist.length;
                    const elExcepciones = document.getElementById('metric-excepciones');
                    if (elExcepciones) elExcepciones.innerText = App.datos.blacklist.length;
                    
                    // Calcular peor modelo
                    const modelCounts = {};
                    App.datos.blacklist.forEach(item => {
                        if (item.includes('| Model:')) {
                            const model = item.split('| Model:')[1].trim();
                            modelCounts[model] = (modelCounts[model] || 0) + 1;
                        }
                    });
                    
                    let worstModel = '';
                    let maxCount = 0;
                    for (const [model, c] of Object.entries(modelCounts)) {
                        if (c > maxCount) { maxCount = c; worstModel = model; }
                    }
                    
                    const worstEl = document.getElementById('blacklist-worst-model');
                    if (worstEl) {
                        if (worstModel) { worstEl.innerText = `Peor: ${worstModel} (${maxCount})`; worstEl.classList.remove('hidden'); } else { worstEl.classList.add('hidden'); }
                    }

                },
                mostrarEntregasHoy: () => {
                    const hoyISO = new Date().toISOString().split('T')[0];
                    const lista = document.getElementById('entregas-hoy-lista');
                    lista.innerHTML = '';
                    
                    const entregas = App.datos.leads.filter(l => {
                        const fechaEntrega = l.fecha_proximo_pago ? l.fecha_proximo_pago.split('T')[0] : null;
                        return l.estado === 'cerrados' && fechaEntrega === hoyISO;
                    });

                    if (entregas.length === 0) {
                        lista.innerHTML = '<div class="text-center py-10 text-slate-400">No hay entregas programadas para hoy.</div>';
                    } else {
                        entregas.forEach((lead) => {
                            const realIndex = App.datos.leads.indexOf(lead);
                            const deuda = Math.max(0, (lead.monto_total || 0) - (lead.monto_pagado || 0));
                            const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
                            
                            const item = document.createElement('div');
                            item.className = "bg-white p-4 rounded-xl border border-blue-100 flex justify-between items-center shadow-sm mb-2 hover:border-blue-300 transition-colors";
                            item.innerHTML = `
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm">${lead.negocio}</h4>
                                    <p class="text-xs text-slate-500">${lead.nombre || 'Sin contacto'}</p>
                                    <p class="text-[10px] font-bold text-red-500 mt-1">Por cobrar: ${formatter.format(deuda)}</p>
                                </div>
                                <button onclick="App.cliente.abrir(${realIndex}); App.ui.toggleModal('modal-entregas-hoy', false);" class="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg hover:bg-blue-100">Ver Ficha</button>
                            `;
                            lista.appendChild(item);
                        });
                    }
                    App.ui.toggleModal('modal-entregas-hoy', true);
                },
                buscar: (termino) => {
                    if (typeof termino !== 'string') termino = '';
                    App.filtroBusqueda = termino.toLowerCase().trim();
                    App.ui.renderizarListas();
                },
                buscarExacto: (termino) => {
                    if (!termino) return;
                    const term = termino.toLowerCase().trim();
                    
                    // 1. B√∫squeda Exacta (Prioridad: Dominio, C√≥digo, ID)
                    const exactMatchIndex = App.datos.leads.findIndex(l => {
                        const dom = (l.dominio || '').toLowerCase();
                        const cod = (l.codigo_seguimiento || '').toLowerCase();
                        const id = String(l.id);
                        return dom === term || cod === term || id === term;
                    });

                    if (exactMatchIndex !== -1) {
                        App.cliente.abrir(exactMatchIndex);
                        document.getElementById('buscador-global').value = '';
                        App.ui.buscar('');
                        return;
                    }

                    // 2. B√∫squeda Aproximada (Si hay un solo resultado visible)
                    const resultados = App.datos.leads.filter(lead => {
                        const dataString = `${lead.negocio || ''} ${lead.nombre || ''} ${lead.whatsapp || ''} ${lead.dominio || ''} ${lead.codigo_seguimiento || ''}`.toLowerCase();
                        return dataString.includes(term);
                    });

                    if (resultados.length === 1) {
                        const realIndex = App.datos.leads.indexOf(resultados[0]);
                        App.cliente.abrir(realIndex);
                        document.getElementById('buscador-global').value = '';
                        App.ui.buscar('');
                    } else if (resultados.length > 1) {
                        App.ui.notificar(`Hay ${resultados.length} coincidencias. S√© m√°s espec√≠fico.`, "M√∫ltiples Resultados", "info");
                    } else {
                        App.ui.notificar(`No se encontr√≥ ning√∫n cliente con: "${termino}"`, "Sin Resultados", "error");
                    }
                },
                renderizarListas: () => {
                    try {
                        if (!Array.isArray(App.datos.leads)) {
                            console.warn("App.datos.leads no es un array, inicializando...");
                            App.datos.leads = [];
                        }

                        const estados = ['discador', 'nuevos', 'whatsapp_enviado', 'sin_respuesta', 'seguimiento', 'cerrados']; 
                    const contadores = { discador: 0, nuevos: 0, whatsapp_enviado: 0, sin_respuesta: 0, seguimiento: 0, agendados: 0, cerrados: 0, descartados: 0 };
                    
                    // Limpiar contenedores
                    estados.forEach(id => {
                        const el = document.getElementById(`list-${id}`);
                        if(el) el.innerHTML = '';
                    });

                    // Filtrar leads seg√∫n b√∫squeda
                    const leadsFiltrados = App.datos.leads.filter(lead => {
                        if (!App.filtroBusqueda) return true;
                        const term = App.filtroBusqueda;
                        // B√∫squeda potente: concatena todo para buscar
                        const dataString = `${lead.negocio || ''} ${lead.nombre || ''} ${lead.whatsapp || ''} ${lead.dominio || ''}`.toLowerCase();
                        return dataString.includes(term);
                    });

                    leadsFiltrados.forEach((lead) => {
                        // IMPORTANTE: Usamos el √≠ndice original para que al hacer click abra el lead correcto
                        const originalIndex = App.datos.leads.indexOf(lead);

                        // Determinar estado UI
                        let estadoUI = lead.estado || 'nuevos';
                        if (!contadores.hasOwnProperty(estadoUI)) estadoUI = 'nuevos';

                        // Contar agendados para m√©tricas, pero visualmente se quedan en su estado original (ej: seguimiento)
                        if (lead.fecha_agendada) {
                            contadores.agendados++;
                        }

                        if (contadores[estadoUI] !== undefined) {
                            contadores[estadoUI]++;
                            
                            let extraInfo = '<i class="fa-solid fa-chevron-right text-[9px] text-slate-400"></i>';
                            if (lead.fecha_agendada && estadoUI === 'agendados') extraInfo = `<span class="text-[9px] font-bold text-purple-500 bg-purple-50 px-1 rounded">${lead.fecha_agendada.slice(5)}</span>`;

                            const itemHTML = `<div onclick="App.cliente.abrir(${originalIndex})" class="p-3 mb-2 bg-white border border-emerald-100 rounded-xl hover:shadow-md hover:border-emerald-300 transition-all cursor-pointer group flex justify-between items-center"><div><span class="block text-xs font-bold text-slate-800 group-hover:text-teal-600 truncate max-w-[150px]">${lead.negocio}</span><span class="text-[9px] text-slate-500 font-mono">${lead.whatsapp}</span><span class="block text-[9px] text-teal-400 font-bold truncate max-w-[140px]">${lead.dominio || ''}</span></div>${extraInfo}</div>`;
                            const listEl = document.getElementById(`list-${estadoUI}`);
                            if(listEl) listEl.insertAdjacentHTML('beforeend', itemHTML);
                        }
                    });
                    
                    // Actualizar badges (incluyendo descartados que no tiene lista)
                    Object.keys(contadores).forEach(key => { 
                        const el = document.getElementById(`badge-${key}`); 
                        if(el) {
                            el.innerText = contadores[key];
                            
                            // Parpadeo para Cola Discador si hay pendientes y no est√° activo
                            if (key === 'discador') {
                                // Calcular pendientes reales (Hoy o Atrasados + En Cola)
                                const hoy = App.util.fechaHoy();
                                const pendientesReales = App.datos.leads.filter(l => (l.estado === 'discador') || (l.fecha_agendada && l.fecha_agendada.split('T')[0] <= hoy && l.estado !== 'descartados' && l.estado !== 'cerrados')).length;
                                el.innerText = pendientesReales;

                                if (pendientesReales > 0 && !App.discador.activo) {
                                    el.classList.add('animate-pulse', 'bg-red-600', 'text-white');
                                    el.classList.remove('bg-teal-100', 'text-teal-700');
                                } else {
                                    el.classList.remove('animate-pulse', 'bg-red-600', 'text-white');
                                    el.classList.add('bg-teal-100', 'text-teal-700');
                                }
                            }
                        }
                    });
                    
                    const elMetricTotal = document.getElementById('metric-total');
                    if (elMetricTotal) elMetricTotal.innerText = App.datos.leads.length;
                    const elMetricValidos = document.getElementById('metric-validos');
                    if (elMetricValidos) elMetricValidos.innerText = contadores.seguimiento + contadores.agendados; 

                    // Actualizar contador en el bot√≥n de Modo Focus (Total global de agendados)
                    const hoy = App.util.fechaHoy();
                    const totalProgramados = App.datos.leads.filter(l => l.fecha_agendada && l.estado !== 'descartados' && l.estado !== 'cerrados').length;
                    const pendientesHoy = App.datos.leads.filter(l => l.fecha_agendada && l.fecha_agendada.split('T')[0] <= hoy && l.estado !== 'descartados' && l.estado !== 'cerrados').length;
                    
                    const elBtnCount = document.getElementById('btn-discador-count');
                    if(elBtnCount) {
                        elBtnCount.innerText = totalProgramados;
                        if (pendientesHoy > 0) {
                            elBtnCount.className = "ml-1 bg-red-600 text-white px-2 py-0.5 rounded text-[10px] animate-pulse shadow-lg shadow-red-500/50";
                        } else {
                            elBtnCount.className = "ml-1 bg-white/20 px-1.5 py-0.5 rounded text-[10px]";
                        }
                    }

                        // Si hay b√∫squeda activa, abrir autom√°ticamente los acordeones que tengan resultados
                        if (App.filtroBusqueda !== '') {
                            estados.forEach(id => {
                                if (contadores[id] > 0) {
                                    const elList = document.getElementById(`list-${id}`);
                                    if(elList) elList.classList.add('open');
                                }
                            });
                        }

                        try { App.ui.actualizarMetas(); } catch(e) { console.warn("Error metas:", e); }
                        try { App.ui.actualizarFinanzas(); } catch(e) { console.warn("Error finanzas:", e); }
                        try { App.conversion.render(); } catch(e) { console.warn("Error conversion:", e); }
                        try { App.logros.verificar(); } catch(e) { console.warn("Error logros:", e); }
                    
                    } catch (e) {
                        console.error("Error fatal en renderizarListas:", e);
                    }
                },
                actualizarMetas: () => {
                    try {
                    const hoyISO = new Date().toISOString().split('T')[0];
                    const hoyLocale = new Date().toLocaleDateString();
                    
                    // 1. Leads Nuevos Hoy
                    const leadsHoy = App.datos.leads.filter(l => l.created_at && l.created_at.startsWith(hoyISO)).length;
                    const metaLeads = 10; // Meta configurable
                    
                    const elMetaLeadsActual = document.getElementById('meta-leads-actual');
                    if (elMetaLeadsActual) {
                        elMetaLeadsActual.innerText = leadsHoy;
                        const elTotal = document.getElementById('meta-leads-total');
                        if (elTotal) elTotal.innerText = metaLeads;
                        const elBarra = document.getElementById('barra-meta-leads');
                        if (elBarra) elBarra.style.width = `${Math.min((leadsHoy/metaLeads)*100, 100)}%`;
                    }

                    // 2. Ventas Hoy (Estado 'cerrados' y (creado hoy O historial venta hoy))
                    let ventasHoy = 0;
                    App.datos.leads.forEach(l => {
                        if (l.estado === 'cerrados') {
                            const ventaEnHistorial = l.historial && l.historial.some(h => h.nota.includes('VENTA CERRADA') && h.fecha.includes(hoyLocale));
                            const creadoYcerradoHoy = l.created_at && l.created_at.startsWith(hoyISO);
                            if (ventaEnHistorial || creadoYcerradoHoy) ventasHoy++;
                        }
                    });
                    
                    const metaVentas = 3; // Meta configurable
                    const elMetaVentasActual = document.getElementById('meta-ventas-actual');
                    if (elMetaVentasActual) {
                        elMetaVentasActual.innerText = ventasHoy;
                        const elTotalVentas = document.getElementById('meta-ventas-total');
                        if (elTotalVentas) elTotalVentas.innerText = metaVentas;
                        const elBarraVentas = document.getElementById('barra-meta-ventas');
                        if (elBarraVentas) elBarraVentas.style.width = `${Math.min((ventasHoy/metaVentas)*100, 100)}%`;
                    }

                    // Verificar si se cumplieron ambas metas para lanzar confeti
                    if (leadsHoy >= metaLeads && ventasHoy >= metaVentas) {
                        App.ui.lanzarConfeti();
                    }
                    } catch(e) { console.error("Error en actualizarMetas:", e); }
                },
                actualizarFinanzas: () => {
                    try {
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    const hoyISO = hoy.toISOString().split('T')[0];
                    const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });

                    let totalVentasMes = 0; // Total Contratado (Mes)
                    let totalRecaudadoMes = 0; // Total Pagado (Mes)
                    let totalProyeccion = 0; // Deuda Acumulada (Global)
                    let totalHistoricoVentas = 0;
                    let countVentasMes = 0;
                    let countHistoricoVentas = 0;
                    let countEntregasHoy = 0;

                    App.datos.leads.forEach(l => {
                        const montoTotal = Number(l.monto_total) || 0;
                        const montoPagado = Number(l.monto_pagado) || 0;
                        const deuda = Math.max(0, montoTotal - montoPagado);

                        const fechaCreacion = new Date(l.created_at || new Date());
                        const esMesActual = fechaCreacion.getMonth() === mesActual && fechaCreacion.getFullYear() === anioActual;
                        const fechaEntrega = l.fecha_proximo_pago ? l.fecha_proximo_pago.split('T')[0] : null;

                        if (l.estado === 'cerrados') {
                            // Proyecci√≥n (Deuda Global - Pasa de mes)
                            totalProyeccion += deuda;

                            // Entregas Hoy
                            if (fechaEntrega === hoyISO) {
                                countEntregasHoy++;
                            }

                            // M√©tricas del Mes
                            if (esMesActual) {
                                totalVentasMes += montoTotal;
                                totalRecaudadoMes += montoPagado;
                                countVentasMes++;
                            }
                            // Ticket Promedio
                            totalHistoricoVentas += montoTotal;
                            countHistoricoVentas++;
                        }
                    });

                    const safeSetText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };

                    safeSetText('finanza-ventas-mes', formatter.format(totalVentasMes));
                    safeSetText('count-ventas-mes', countVentasMes);
                    safeSetText('finanza-proyeccion', formatter.format(totalProyeccion));
                    safeSetText('finanza-entregas-hoy', countEntregasHoy);
                    safeSetText('finanza-caja-real', formatter.format(totalRecaudadoMes));
                    safeSetText('finanza-ticket', formatter.format(countHistoricoVentas > 0 ? totalHistoricoVentas / countHistoricoVentas : 0));
                    } catch(e) { console.error("Error en actualizarFinanzas:", e); }
                },
                lanzarConfeti: () => {
                    const container = document.getElementById('confetti-container');
                    if (!container || container.children.length > 0) return; // Evitar spam

                    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                    for (let i = 0; i < 40; i++) {
                        const el = document.createElement('div');
                        el.className = 'confetti';
                        el.style.left = Math.random() * 100 + '%';
                        el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        el.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        el.style.animationDelay = (Math.random() * 1) + 's';
                        container.appendChild(el);
                    }
                    // Limpiar despu√©s de la animaci√≥n
                    setTimeout(() => { container.innerHTML = ''; }, 5000);
                },
                renderSparkline: (id, data, color) => {
                    const container = document.getElementById(id);
                    if (!container) return;
                    
                    const width = 100;
                    const height = 30;
                    const max = Math.max(...data, 1);
                    const min = 0;
                    
                    const points = data.map((val, i) => {
                        const x = (i / (data.length - 1)) * width;
                        const y = height - ((val - min) / (max - min)) * height;
                        return `${x},${y}`;
                    }).join(' ');

                    container.innerHTML = `<svg viewBox="0 0 ${width} ${height}" class="w-full h-full overflow-visible"><polyline fill="none" stroke="${color}" stroke-width="2" points="${points}" stroke-linecap="round" stroke-linejoin="round" vector-effect="non-scaling-stroke" /><circle cx="${points.split(' ').pop().split(',')[0]}" cy="${points.split(' ').pop().split(',')[1]}" r="3" fill="${color}" /></svg>`;
                },
                notificar: (mensaje, titulo = "Notificaci√≥n", tipo = "info", duracion = 0) => {
                    const modal = document.getElementById('modal-notificacion');
                    document.getElementById('notificacion-titulo').innerText = titulo;
                    document.getElementById('notificacion-mensaje').innerText = mensaje;
                    const iconoContainer = document.getElementById('notificacion-icono');
                    const btn = document.getElementById('notificacion-btn-ok');
                    
                    let icono, color;
                    switch(tipo) {
                        case 'exito': icono = '<i class="fa-solid fa-check"></i>'; color = 'emerald'; break;
                        case 'error': icono = '<i class="fa-solid fa-xmark"></i>'; color = 'red'; break;
                        default: icono = '<i class="fa-solid fa-info"></i>'; color = 'blue';
                    }
                    iconoContainer.innerHTML = icono;
                    iconoContainer.className = `mx-auto mb-4 w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-${color}-100 text-${color}-500`;
                    btn.className = `w-full py-2.5 font-bold rounded-lg text-white bg-${color}-500 hover:bg-${color}-600`;
                    
                    modal.classList.remove('hidden');

                    if (duracion > 0) {
                        setTimeout(() => { modal.classList.add('hidden'); }, duracion);
                    }
                },
                cerrarNotificacion: () => {
                    document.getElementById('modal-notificacion').classList.add('hidden');
                },
                confirmar: (mensaje, titulo = "¬øEst√°s seguro?") => {
                    return new Promise((resolve) => {
                        const modal = document.getElementById('modal-confirmacion');
                        document.getElementById('confirmacion-titulo').innerText = titulo;
                        document.getElementById('confirmacion-mensaje').innerText = mensaje;
                        
                        const btnOk = document.getElementById('confirmacion-btn-ok');
                        const btnCancel = document.getElementById('confirmacion-btn-cancel');

                        const cleanup = () => {
                            btnOk.removeEventListener('click', okListener);
                            btnCancel.removeEventListener('click', cancelListener);
                        };

                        const okListener = () => { modal.classList.add('hidden'); cleanup(); resolve(true); };
                        const cancelListener = () => { modal.classList.add('hidden'); cleanup(); resolve(false); };

                        btnOk.addEventListener('click', okListener, { once: true });
                        btnCancel.addEventListener('click', cancelListener, { once: true });

                        modal.classList.remove('hidden');
                    });
                },
                prompt: (mensaje, titulo = "Ingresar Dato", defaultValue = "", type = "text") => {
                    return new Promise((resolve) => {
                        const modal = document.getElementById('modal-prompt');
                        document.getElementById('prompt-titulo').innerText = titulo;
                        document.getElementById('prompt-mensaje').innerText = mensaje;
                        const input = document.getElementById('prompt-input');
                        input.type = type;
                        input.value = defaultValue;
                        
                        const btnOk = document.getElementById('prompt-btn-ok');
                        const btnCancel = document.getElementById('prompt-btn-cancel');

                        const cleanup = () => { btnOk.removeEventListener('click', okListener); btnCancel.removeEventListener('click', cancelListener); };
                        const okListener = () => { modal.classList.add('hidden'); cleanup(); resolve(input.value); };
                        const cancelListener = () => { modal.classList.add('hidden'); cleanup(); resolve(null); };

                        btnOk.addEventListener('click', okListener, { once: true });
                        btnCancel.addEventListener('click', cancelListener, { once: true });

                        modal.classList.remove('hidden');
                        input.focus(); 
                        if (type === 'text') input.select();
                    });
                },
                toggleDashboard: () => {
                    const content = document.getElementById('dashboard-content');
                    const icon = document.getElementById('dashboard-chevron');
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden'); content.classList.add('flex'); icon.classList.remove('rotate-180');
                    } else {
                        content.classList.add('hidden'); content.classList.remove('flex'); icon.classList.add('rotate-180');
                    }
                },
                verificarPermisoNotificaciones: () => {
                    if (!("Notification" in window)) {
                        console.warn("Este navegador no soporta notificaciones de escritorio.");
                        return;
                    }
                    if (Notification.permission === 'default') {
                        document.getElementById('notification-permission-banner').classList.remove('hidden');
                    }
                },
                solicitarPermisoNotificaciones: () => {
                    Notification.requestPermission().then(permission => {
                        document.getElementById('notification-permission-banner').classList.add('hidden');
                        if (permission === 'granted') {
                            App.ui.notificar("¬°Genial! Recibir√°s alertas de sitios ca√≠dos.", "Notificaciones Activadas", "exito");
                        } else {
                            App.ui.notificar("No se han activado las notificaciones.", "Permiso Denegado", "info");
                        }
                    });
                },
                toggleZenMode: () => {
                    document.body.classList.toggle('zen-mode');
                },
                configurarPrompt: () => {
                    const currentPrompt = localStorage.getItem('analysis_prompt') || DEFAULT_ANALYSIS_PROMPT;
                    document.getElementById('config-prompt-input').value = currentPrompt;
                    App.ui.toggleModal('modal-config-prompt', true);
                },
                guardarPrompt: () => {
                    const newPrompt = document.getElementById('config-prompt-input').value;
                    localStorage.setItem('analysis_prompt', newPrompt);
                    App.ui.toggleModal('modal-config-prompt', false);
                    App.ui.notificar("Prompt de IA actualizado correctamente.", "Guardado", "exito");
                },
                restaurarPrompt: () => {
                    document.getElementById('config-prompt-input').value = DEFAULT_ANALYSIS_PROMPT;
                },
                probarPrompt: async () => {
                    const promptInput = document.getElementById('config-prompt-input').value;
                    const resultContainer = document.getElementById('config-prompt-test-result');
                    const output = document.getElementById('test-output');
                    const selectedExample = document.getElementById('config-prompt-example-select').value;
                    
                    resultContainer.classList.remove('hidden');
                    output.innerHTML = '<span class="animate-pulse text-yellow-400">‚è≥ Enviando a IA para an√°lisis...</span>';
                    
                    try {
                        const fullPrompt = `${promptInput}\n\nCONVERSACI√ìN DE EJEMPLO:\n"${EXAMPLE_CONVERSATIONS[selectedExample]}"`;
                        const model = document.getElementById('model-selector').value;
                        
                        const res = await fetch('/api/analizar-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: fullPrompt, model: model })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) throw new Error(data.error);
                        
                        // Intentar formatear JSON para que se vea bonito
                        try {
                            const json = JSON.parse(data.analisis.replace(/```json/g, '').replace(/```/g, '').trim());
                            output.innerHTML = `<span class="text-emerald-400">${JSON.stringify(json, null, 2)}</span>`;
                        } catch (e) {
                            output.innerText = data.analisis;
                        }
                    } catch (e) {
                        output.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
                    }
                }
            },
            
            // SISTEMA FINANCIERO
            finanzas: {
                data: {
                    gastos: [],
                    ultimoGasto: null
                },
                
                init: async function() {
                    await this.cargarDatos();
                    this.renderizar();
                    const hoy = new Date().toISOString().split('T')[0];
                    const fechaInput = document.getElementById('gasto-fecha');
                    if (fechaInput) fechaInput.value = hoy;
                },
                
                cargarDatos: async function() {
                    try {
                        const res = await fetch('/api/transacciones');
                        if (res.ok) {
                            this.data.gastos = await res.json();
                        }
                    } catch (e) {
                        console.error("Error cargando gastos:", e);
                    }
                },
                
                calcularIngresosDesdeClientes: function() {
                    const leads = App.datos.leads || [];
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    
                    let totalIngresos = 0;
                    let totalHistorico = 0;
                    let transaccionesMes = [];
                    
                    leads.forEach(cliente => {
                        // Solo contar clientes que tienen un pago real (> 0)
                        // Buscar en monto_pagado primero, luego en pagado
                        let montoPagado = parseInt(cliente.monto_pagado) || 0;
                        if (montoPagado === 0) {
                            montoPagado = parseInt(cliente.pagado) || 0;
                        }
                        
                        // Solo procesar si hay un pago real
                        if (montoPagado > 0) {
                            totalHistorico += montoPagado;
                            
                            // Determinar la fecha del pago
                            // Prioridad: fecha_pago > updated_at > fecha_proximo_pago > created_at > HOY (fallback)
                            let fechaPago = cliente.fecha_pago || cliente.updated_at || cliente.fecha_proximo_pago || cliente.created_at;
                            
                            // Si no hay ninguna fecha, asumir que el pago es de hoy (para registros legacy)
                            if (!fechaPago) {
                                fechaPago = new Date().toISOString();
                            }
                            
                            const fecha = new Date(fechaPago);
                            
                            // Verificar si es del mes actual
                            if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
                                totalIngresos += montoPagado;
                                transaccionesMes.push({
                                    concepto: `Pago ${cliente.negocio || cliente.nombre || 'Cliente'}`,
                                    monto: montoPagado,
                                    fecha: fechaPago,
                                    cliente: cliente.nombre,
                                    tipo: 'ingreso'
                                });
                            }
                        }
                    });
                    
                    return { totalIngresos, totalHistorico, transaccionesMes };
                },
                
                renderizar: function() {
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    
                    const ingresosData = this.calcularIngresosDesdeClientes();
                    const totalIngresosMes = ingresosData.totalIngresos;
                    
                    const gastosMes = this.data.gastos.filter(g => {
                        const d = new Date(g.fecha);
                        return d.getMonth() === mesActual && d.getFullYear() === anioActual;
                    });
                    
                    const totalGastosMes = gastosMes.reduce((sum, g) => sum + g.monto, 0);
                    const totalGastosHist = this.data.gastos.reduce((sum, g) => sum + g.monto, 0);
                    
                    const balanceMes = totalIngresosMes - totalGastosMes;
                    const balanceTotal = ingresosData.totalHistorico - totalGastosHist;
                    
                    // Actualizar dashboard
                    const ingresosEl = document.getElementById('finanza-ingresos-mes');
                    if (ingresosEl) ingresosEl.textContent = `$${totalIngresosMes.toLocaleString()}`;
                    
                    const ingresosCount = document.getElementById('finanza-ingresos-count');
                    if (ingresosCount) ingresosCount.textContent = `${ingresosData.transaccionesMes.length} pagos`;
                    
                    const gastosEl = document.getElementById('finanza-gastos-mes');
                    if (gastosEl) gastosEl.textContent = `$${totalGastosMes.toLocaleString()}`;
                    
                    const gastosCount = document.getElementById('finanza-gastos-count');
                    if (gastosCount) gastosCount.textContent = `${gastosMes.length} transacciones`;
                    
                    const balanceEl = document.getElementById('finanza-balance-mes');
                    if (balanceEl) {
                        balanceEl.textContent = `$${balanceMes.toLocaleString()}`;
                        balanceEl.className = `text-2xl font-bold relative z-10 ${balanceMes >= 0 ? 'text-blue-900' : 'text-red-900'}`;
                    }
                    
                    const margen = totalIngresosMes > 0 ? Math.round((balanceMes / totalIngresosMes) * 100) : 0;
                    const margenEl = document.getElementById('finanza-balance-porcentaje');
                    if (margenEl) margenEl.textContent = `${margen}% margen`;
                    
                    const badge = document.getElementById('balance-badge');
                    if (badge) {
                        badge.textContent = `Balance: $${balanceMes.toLocaleString()}`;
                        badge.className = `px-3 py-1 rounded-full text-xs font-bold border ${balanceMes >= 0 ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-red-100 text-red-700 border-red-200'}`;
                    }
                    
                    const cajaEl = document.getElementById('finanza-caja-total');
                    if (cajaEl) cajaEl.textContent = `$${balanceTotal.toLocaleString()}`;
                    
                    // Actualizar mini gr√°fico comparativo
                    this.actualizarGraficoComparativo(totalIngresosMes, totalGastosMes);
                    
                    this.renderizarUltimoServicio();
                    this.renderizarUltimoAds();
                    this.actualizarMovimientosOperativos(gastosMes, ingresosData.transaccionesMes);
                },
                
                renderizarUltimoServicio: function() {
                    const container = document.getElementById('lista-servicios');
                    const totalEl = document.getElementById('total-servicios');
                    if (!container || !totalEl) return;
                    
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    
                    const gastosServicios = this.data.gastos.filter(g => {
                        const d = new Date(g.fecha);
                        return g.tipo === 'servicio' && d.getMonth() === mesActual && d.getFullYear() === anioActual;
                    });
                    
                    const total = gastosServicios.reduce((sum, g) => sum + g.monto, 0);
                    totalEl.textContent = `$${total.toLocaleString()}/mes`;
                    
                    if (gastosServicios.length === 0) {
                        container.innerHTML = `<p class="text-xs text-slate-400 text-center italic">No hay gastos</p>`;
                        return;
                    }
                    
                    // Ordenar por fecha descendente (m√°s reciente primero)
                    gastosServicios.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    container.innerHTML = gastosServicios.map(g => {
                        const fecha = new Date(g.fecha).toLocaleDateString('es-CL');
                        return `
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg border border-slate-200 mb-2 group">
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-slate-700">${g.concepto}</p>
                                    <p class="text-[10px] text-slate-400">${fecha}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-red-600">-$${g.monto.toLocaleString()}</span>
                                    <button onclick="App.finanzas.eliminarGasto(${g.id})" class="w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 text-red-500 flex items-center justify-center transition-colors" title="Eliminar gasto">
                                        <i class="fa-solid fa-trash text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                },
                
                renderizarUltimoAds: function() {
                    const container = document.getElementById('lista-ads');
                    const totalEl = document.getElementById('total-ads');
                    if (!container || !totalEl) return;
                    
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();
                    
                    const gastosAds = this.data.gastos.filter(g => {
                        const d = new Date(g.fecha);
                        return g.tipo === 'ads' && d.getMonth() === mesActual && d.getFullYear() === anioActual;
                    });
                    
                    const total = gastosAds.reduce((sum, g) => sum + g.monto, 0);
                    totalEl.textContent = `$${total.toLocaleString()}/mes`;
                    
                    if (gastosAds.length === 0) {
                        container.innerHTML = `<p class="text-xs text-orange-400 text-center italic">No hay gastos</p>`;
                        return;
                    }
                    
                    // Ordenar por fecha descendente (m√°s reciente primero)
                    gastosAds.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    container.innerHTML = gastosAds.map(g => {
                        const fecha = new Date(g.fecha).toLocaleDateString('es-CL');
                        return `
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg border border-orange-200 mb-2 group">
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-slate-700">${g.concepto}</p>
                                    <p class="text-[10px] text-slate-400">${fecha}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-red-600">-$${g.monto.toLocaleString()}</span>
                                    <button onclick="App.finanzas.eliminarGasto(${g.id})" class="w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 text-red-500 flex items-center justify-center transition-colors" title="Eliminar gasto">
                                        <i class="fa-solid fa-trash text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                },
                
                actualizarMovimientosOperativos: function(gastos, ingresos) {
                    const container = document.getElementById('activity-log-container');
                    if (!container) return;
                    
                    let items = [...ingresos.map(i => ({...i, tipoDisplay: 'ingreso'})), ...gastos.map(g => ({...g, tipoDisplay: 'gasto'}))];
                    
                    // Ordenar por fecha descendente (m√°s reciente primero)
                    items.sort((a, b) => {
                        const fechaA = a.timestamp ? new Date(a.timestamp) : new Date(a.fecha);
                        const fechaB = b.timestamp ? new Date(b.timestamp) : new Date(b.fecha);
                        return fechaB - fechaA;
                    });
                    
                    items = items.slice(0, 10);
                    
                    if (items.length === 0) {
                        container.innerHTML = `<p class="text-[10px] text-slate-400 text-center italic mt-4">No hay movimientos recientes.</p>`;
                        return;
                    }
                    
                    container.innerHTML = items.map(item => {
                        const esIngreso = item.tipoDisplay === 'ingreso';
                        const fechaObj = item.timestamp ? new Date(item.timestamp) : new Date(item.fecha);
                        const fecha = fechaObj.toLocaleDateString('es-CL', { day: '2-digit', month: 'short' });
                        return `
                            <div class="flex items-center gap-2 p-2 rounded-lg ${esIngreso ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'} border">
                                <div class="w-6 h-6 rounded-full ${esIngreso ? 'bg-emerald-200 text-emerald-700' : 'bg-red-200 text-red-700'} flex items-center justify-center text-xs">
                                    <i class="fa-solid ${esIngreso ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] font-bold text-slate-700 truncate">${item.concepto}</p>
                                    <p class="text-[9px] text-slate-400">${fecha}</p>
                                </div>
                                <span class="text-[10px] font-bold ${esIngreso ? 'text-emerald-600' : 'text-red-600'}">${esIngreso ? '+' : '-'}$${item.monto.toLocaleString()}</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Scroll al inicio para mostrar el m√°s reciente
                    container.scrollTop = 0;
                },
                
                mostrarInputServicio: function() {
                    const select = document.getElementById('select-servicio');
                    const container = document.getElementById('input-servicio-container');
                    const inputOtro = document.getElementById('input-servicio-otro');
                    if (!select || !container) return;
                    
                    if (select.value) {
                        container.classList.remove('hidden');
                        if (select.value === 'otro') {
                            inputOtro.classList.remove('hidden');
                            inputOtro.focus();
                        } else {
                            inputOtro.classList.add('hidden');
                            document.getElementById('input-servicio-monto').focus();
                        }
                    } else {
                        container.classList.add('hidden');
                    }
                },
                
                agregarGastoServicio: async function() {
                    const select = document.getElementById('select-servicio');
                    const inputOtro = document.getElementById('input-servicio-otro');
                    const inputMonto = document.getElementById('input-servicio-monto');
                    
                    const concepto = select.value === 'otro' ? inputOtro.value : select.value;
                    const monto = parseFloat(inputMonto.value);
                    
                    if (!concepto || !monto) { alert('Completa todos los campos'); return; }
                    
                    const fecha = new Date().toISOString();
                    
                    try {
                        const res = await fetch('/api/transacciones', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tipo: 'servicio', concepto, monto, fecha })
                        });
                        
                        if (res.ok) {
                            const gasto = await res.json();
                            this.data.gastos.push(gasto);
                            this.renderizar();
                            
                            select.value = ''; inputOtro.value = ''; inputMonto.value = '';
                            document.getElementById('input-servicio-container').classList.add('hidden');
                            
                            App.ui.notificar(`Gasto: ${concepto} -$${monto.toLocaleString()}`, 'Gasto Registrado', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        App.ui.notificar('Error al guardar gasto', 'Error', 'error');
                    }
                },
                
                mostrarInputAds: function() {
                    const select = document.getElementById('select-ads');
                    const container = document.getElementById('input-ads-container');
                    const inputOtro = document.getElementById('input-ads-otro');
                    if (!select || !container) return;
                    
                    if (select.value) {
                        container.classList.remove('hidden');
                        if (select.value === 'otro') {
                            inputOtro.classList.remove('hidden');
                            inputOtro.focus();
                        } else {
                            inputOtro.classList.add('hidden');
                            document.getElementById('input-ads-monto').focus();
                        }
                    } else {
                        container.classList.add('hidden');
                    }
                },
                
                agregarGastoAds: async function() {
                    const select = document.getElementById('select-ads');
                    const inputOtro = document.getElementById('input-ads-otro');
                    const inputMonto = document.getElementById('input-ads-monto');
                    
                    const concepto = select.value === 'otro' ? inputOtro.value : select.value;
                    const monto = parseFloat(inputMonto.value);
                    
                    if (!concepto || !monto) { alert('Completa todos los campos'); return; }
                    
                    const fecha = new Date().toISOString();
                    
                    try {
                        const res = await fetch('/api/transacciones', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tipo: 'ads', concepto, monto, fecha })
                        });
                        
                        if (res.ok) {
                            const gasto = await res.json();
                            this.data.gastos.push(gasto);
                            this.renderizar();
                            
                            select.value = ''; inputOtro.value = ''; inputMonto.value = '';
                            document.getElementById('input-ads-container').classList.add('hidden');
                            
                            App.ui.notificar(`Publicidad: ${concepto} -$${monto.toLocaleString()}`, 'Gasto Registrado', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        App.ui.notificar('Error al guardar gasto', 'Error', 'error');
                    }
                },
                
                abrirModalGasto: function(tipo = 'otro') {
                    const modal = document.getElementById('modal-gasto');
                    if (modal) modal.classList.remove('hidden');
                    const fechaInput = document.getElementById('gasto-fecha');
                    if (fechaInput) fechaInput.value = new Date().toISOString().split('T')[0];
                    this.actualizarOpcionesGasto();
                },
                
                cerrarModalGasto: function() {
                    const modal = document.getElementById('modal-gasto');
                    if (modal) modal.classList.add('hidden');
                },
                
                actualizarOpcionesGasto: function() {
                    const tipo = document.getElementById('gasto-tipo');
                    const select = document.getElementById('gasto-concepto');
                    if (!tipo || !select) return;
                    
                    select.innerHTML = '';
                    
                    if (tipo.value === 'servicio') {
                        ['Render', 'Vercel Pro', 'Cloudflare Pro', 'Neon Database', 'NIC.cl', 'Kimi AI', 'Groq API', 'Gemini API', 'OpenRouter', 'GitHub Copilot'].forEach(s => {
                            const opt = document.createElement('option'); opt.value = s; opt.textContent = s; select.appendChild(opt);
                        });
                    } else if (tipo.value === 'ads') {
                        ['Facebook Ads', 'Instagram Ads', 'Google Search', 'Google Display', 'YouTube Ads', 'LinkedIn Ads', 'TikTok Ads'].forEach(a => {
                            const opt = document.createElement('option'); opt.value = a; opt.textContent = a; select.appendChild(opt);
                        });
                    } else {
                        ['Sueldos', 'Impuestos', 'Servicios', 'Oficina', 'Otros'].forEach(o => {
                            const opt = document.createElement('option'); opt.value = o; opt.textContent = o; select.appendChild(opt);
                        });
                    }
                    const otro = document.createElement('option'); otro.value = 'otro'; otro.textContent = '+ Otro...'; select.appendChild(otro);
                },
                
                guardarGasto: async function() {
                    const tipo = document.getElementById('gasto-tipo');
                    const conceptoSelect = document.getElementById('gasto-concepto');
                    const conceptoOtro = document.getElementById('gasto-concepto-otro');
                    const montoInput = document.getElementById('gasto-monto');
                    const fechaInput = document.getElementById('gasto-fecha');
                    
                    const concepto = conceptoSelect.value === 'otro' ? conceptoOtro.value : conceptoSelect.value;
                    const monto = parseFloat(montoInput.value);
                    const fecha = fechaInput.value;
                    
                    if (!concepto || !monto || !fecha) { alert('Completa todos los campos'); return; }
                    
                    try {
                        const res = await fetch('/api/transacciones', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tipo: tipo.value, concepto, monto, fecha })
                        });
                        
                        if (res.ok) {
                            const gasto = await res.json();
                            this.data.gastos.push(gasto);
                            this.renderizar();
                            this.cerrarModalGasto();
                            
                            App.ui.notificar(`Gasto: ${concepto} -$${monto.toLocaleString()}`, 'Gasto Registrado', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        App.ui.notificar('Error al guardar gasto', 'Error', 'error');
                    }
                },
                
                eliminarGasto: async function(id) {
                    if (!confirm('¬øEst√°s seguro de eliminar este gasto?')) return;
                    
                    try {
                        const res = await fetch(`/api/transacciones/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            const gastoIndex = this.data.gastos.findIndex(g => g.id === id);
                            if (gastoIndex !== -1) {
                                const gastoEliminado = this.data.gastos[gastoIndex];
                                this.data.gastos.splice(gastoIndex, 1);
                                this.renderizar();
                                if (App.logros) App.logros.actualizarMetaMensual();
                                App.ui.notificar(`Gasto eliminado: ${gastoEliminado.concepto}`, 'Gasto Eliminado', 'exito');
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        App.ui.notificar('Error al eliminar gasto', 'Error', 'error');
                    }
                },
                
                actualizarDesdeClientes: function() {
                    this.renderizar();
                    // Actualizar tambi√©n la meta mensual de ventas en $
                    if (App.logros) App.logros.actualizarMetaMensual();
                },
                
                actualizarGraficoComparativo: function(ingresos, gastos) {
                    const barraIngreso = document.getElementById('barra-ingreso');
                    const barraGasto = document.getElementById('barra-gasto');
                    if (!barraIngreso || !barraGasto) return;
                    
                    const maximo = Math.max(ingresos, gastos, 1); // Evitar divisi√≥n por cero
                    const alturaIngreso = Math.min((ingresos / maximo) * 100, 100);
                    const alturaGasto = Math.min((gastos / maximo) * 100, 100);
                    
                    barraIngreso.style.height = `${alturaIngreso}%`;
                    barraGasto.style.height = `${alturaGasto}%`;
                    
                    // Cambiar color si el gasto es mayor que el ingreso
                    if (gastos > ingresos) {
                        barraGasto.classList.remove('bg-red-400');
                        barraGasto.classList.add('bg-red-600');
                    } else {
                        barraGasto.classList.remove('bg-red-600');
                        barraGasto.classList.add('bg-red-400');
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.init();
            if (App.finanzas) App.finanzas.init();
            
            // Forzar scroll al inicio al cargar la p√°gina
            window.scrollTo(0, 0);
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        });
        
        // Forzar scroll al inicio cuando la p√°gina termine de cargar completamente
        window.onload = function() {
            window.scrollTo(0, 0);
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
            
            // Tambi√©n cuando se muestra la app despu√©s del login
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.target.id === 'login-screen' && mutation.target.style.display === 'none') {
                        window.scrollTo(0, 0);
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;
                    }
                });
            });
            
            const loginScreen = document.getElementById('login-screen');
            if (loginScreen) {
                observer.observe(loginScreen, { attributes: true, attributeFilter: ['style'] });
            }
        };

        // Verificaci√≥n de integridad
        if (typeof App === 'undefined') {
            alert("‚ùå Error Cr√≠tico: La aplicaci√≥n no se carg√≥ correctamente. Revisa la consola (F12) para ver errores de sintaxis.");
        }
    </script>
</body>
</html>
